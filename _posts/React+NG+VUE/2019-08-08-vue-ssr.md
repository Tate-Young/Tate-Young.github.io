---
layout: blog
front: true
comments: True
flag: Vue
background: green
category: å‰ç«¯
title:  Vue SSR
date:   2019-08-13 17:11:00 GMT+0800 (CST)
background-image: /style/images/smms/vue.jpg
tags:
- Vue
---
# {{ page.title }}

## æœåŠ¡ç«¯æ¸²æŸ“å’Œå®¢æˆ·ç«¯æ¸²æŸ“

ä¸ä¼ ç»Ÿ **SPA (å•é¡µåº”ç”¨ç¨‹åº (Single-Page Application))** ç›¸æ¯”ï¼Œ**æœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR)** çš„ä¼˜åŠ¿ä¸»è¦åœ¨äº:

1. æ›´å¥½çš„ **SEO** - æœç´¢å¼•æ“çˆ¬è™«æŠ“å–å·¥å…·å¯ä»¥ç›´æ¥æŸ¥çœ‹å®Œå…¨æ¸²æŸ“çš„é¡µé¢
2. æ›´å¿«çš„**å†…å®¹åˆ°è¾¾æ—¶é—´ (time-to-content)** - ç‰¹åˆ«æ˜¯å¯¹äºç¼“æ…¢çš„ç½‘ç»œæƒ…å†µæˆ–è¿è¡Œç¼“æ…¢çš„è®¾å¤‡ã€‚æ— éœ€ç­‰å¾…æ‰€æœ‰çš„ JavaScript éƒ½å®Œæˆä¸‹è½½å¹¶æ‰§è¡Œï¼Œæ‰æ˜¾ç¤ºæœåŠ¡å™¨æ¸²æŸ“çš„æ ‡è®°ï¼Œæ‰€ä»¥ä½ çš„ç”¨æˆ·å°†ä¼šæ›´å¿«é€Ÿåœ°çœ‹åˆ°å®Œæ•´æ¸²æŸ“çš„é¡µé¢ã€‚

è€ŒåŠ£åŠ¿åœ¨äº:

1. å¼€å‘æ¡ä»¶æ‰€é™ã€‚æµè§ˆå™¨ç‰¹å®šçš„ä»£ç ï¼Œåªèƒ½åœ¨æŸäº›ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•° (lifecycle hook) ä¸­ä½¿ç”¨ï¼›ä¸€äº›å¤–éƒ¨æ‰©å±•åº“ (external library) å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œæ‰èƒ½åœ¨æœåŠ¡å™¨æ¸²æŸ“åº”ç”¨ç¨‹åºä¸­è¿è¡Œ
2. æ¶‰åŠæ„å»ºè®¾ç½®å’Œéƒ¨ç½²çš„æ›´å¤šè¦æ±‚ã€‚ä¸å¯ä»¥éƒ¨ç½²åœ¨ä»»ä½•é™æ€æ–‡ä»¶æœåŠ¡å™¨ä¸Šçš„å®Œå…¨é™æ€å•é¡µé¢åº”ç”¨ç¨‹åº (SPA) ä¸åŒï¼ŒæœåŠ¡å™¨æ¸²æŸ“åº”ç”¨ç¨‹åºï¼Œéœ€è¦å¤„äº Node.js server è¿è¡Œç¯å¢ƒ
3. æ›´å¤šçš„æœåŠ¡å™¨ç«¯è´Ÿè½½ã€‚åœ¨ Node.js ä¸­æ¸²æŸ“å®Œæ•´çš„åº”ç”¨ç¨‹åºï¼Œæ˜¾ç„¶ä¼šæ¯”ä»…ä»…æä¾›é™æ€æ–‡ä»¶çš„ server æ›´åŠ å¤§é‡å ç”¨ CPU èµ„æº

## Vue SSR

Vue æ˜¯æ„å»ºå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºçš„æ¡†æ¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¾“å‡º Vue ç»„ä»¶ï¼Œè¿›è¡Œç”Ÿæˆ DOM å’Œæ“ä½œ DOMã€‚ç„¶è€Œï¼Œä¹Ÿå¯ä»¥å°†åŒä¸€ä¸ªç»„ä»¶æ¸²æŸ“ä¸ºæœåŠ¡å™¨ç«¯çš„ HTML å­—ç¬¦ä¸²ï¼Œå°†å®ƒä»¬ç›´æ¥å‘é€åˆ°æµè§ˆå™¨ï¼Œæœ€åå°†è¿™äº›é™æ€æ ‡è®°"æ¿€æ´»"ä¸ºå®¢æˆ·ç«¯ä¸Šå®Œå…¨å¯äº¤äº’çš„åº”ç”¨ç¨‹åºï¼Œå³æœåŠ¡ç«¯æ¸²æŸ“ã€‚æˆ‘ä»¬éœ€è¦æ³¨æ„çš„å‡ ä¸ªé—®é¢˜æ˜¯:

1. æœåŠ¡å™¨ä¸Šçš„æ•°æ®å“åº” - åœ¨çº¯å®¢æˆ·ç«¯åº”ç”¨ç¨‹åº (client-only app) ä¸­ï¼Œæ¯ä¸ªç”¨æˆ·ä¼šåœ¨ä»–ä»¬å„è‡ªçš„æµè§ˆå™¨ä¸­ä½¿ç”¨æ–°çš„åº”ç”¨ç¨‹åºå®ä¾‹ã€‚å¯¹äºæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›å¦‚æ­¤ï¼šæ¯ä¸ªè¯·æ±‚åº”è¯¥éƒ½æ˜¯å…¨æ–°çš„ã€ç‹¬ç«‹çš„åº”ç”¨ç¨‹åºå®ä¾‹ï¼Œä»¥ä¾¿ä¸ä¼šæœ‰**äº¤å‰è¯·æ±‚é€ æˆçš„çŠ¶æ€æ±¡æŸ“ (cross-request state pollution)**
2. ç»„ä»¶ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•° - ç”±äºæ²¡æœ‰åŠ¨æ€æ›´æ–°ï¼Œæ‰€æœ‰çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ä¸­ï¼Œåªæœ‰ **beforeCreate** å’Œ **created** ä¼šåœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR) è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œä½†ä¸èƒ½åœ¨è¯¥ç”Ÿå‘½å‘¨æœŸä¸­ä½¿ç”¨å…¨å±€å‰¯ä½œç”¨çš„ä»£ç ï¼Œä¾‹å¦‚ setIntervalï¼ŒSSR æœŸé—´å¹¶ä¸ä¼šè°ƒç”¨é”€æ¯é’©å­å‡½æ•°
3. è®¿é—®ç‰¹å®šå¹³å°(Platform-Specific) API - é€šç”¨ä»£ç ä¸å¯æ¥å—ç‰¹å®šå¹³å°çš„ APIï¼Œå› æ­¤å¦‚æœä½ çš„ä»£ç ä¸­ï¼Œç›´æ¥ä½¿ç”¨äº†åƒ `window` æˆ– `document`ï¼Œè¿™ç§ä»…æµè§ˆå™¨å¯ç”¨çš„å…¨å±€å˜é‡ï¼Œåˆ™ä¼šåœ¨ Node.js ä¸­æ‰§è¡Œæ—¶æŠ›å‡ºé”™è¯¯

![webpack](https://cloud.githubusercontent.com/assets/499550/17607895/786a415a-5fee-11e6-9c11-45a2cfdf085c.png)

webpack æ„å»ºæ­¥éª¤å¦‚ä¸Šï¼Œå¯¹äºå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå’ŒæœåŠ¡å™¨åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éƒ½è¦ä½¿ç”¨ webpack æ‰“åŒ… - æœåŠ¡å™¨éœ€è¦ã€ŒæœåŠ¡å™¨ bundleã€ç„¶åç”¨äºæœåŠ¡å™¨ç«¯æ¸²æŸ“(SSR)ï¼Œè€Œã€Œå®¢æˆ·ç«¯ bundleã€ä¼šå‘é€ç»™æµè§ˆå™¨ï¼Œç”¨äºæ··åˆé™æ€æ ‡è®°ã€‚ä¸€ä¸ªåŸºæœ¬çš„é¡¹ç›®ç»“æ„å¯å‚è€ƒå¦‚ä¸‹:

```TEXT
config
â”œâ”€â”€ setup-dev-server.js # è®¾ç½®å¼€å‘æ¨¡å¼ä¸­é—´ä»¶ï¼Œæ¯”å¦‚çƒ­é‡è½½ï¼Œé€šè¿‡è¯»å–æ›´æ–°åçš„ bundleï¼Œç„¶åé‡æ–°åˆ›å»º renderer å®ä¾‹ï¼ˆéœ€è¦ webpack.client.config.js / webpack.server.config.jsï¼‰
â”œâ”€â”€ webpack.base.config.js # webpack åŸºç¡€å…¬å…±é…ç½®
â”œâ”€â”€ webpack.client.config.js # å®¢æˆ·ç«¯é…ç½®ï¼Œç”Ÿæˆ clientManifestï¼ˆéœ€è¦ entry-client.jsï¼‰
â”œâ”€â”€ webpack.server.config.js # æœåŠ¡ç«¯é…ç½®ï¼Œç”¨äºç”Ÿæˆä¼ é€’ç»™ createBundleRenderer çš„ server bundleï¼ˆéœ€è¦ entry-server.jsï¼‰
src
â”œâ”€â”€ components
â”‚   â”œâ”€â”€ Foo.vue
â”‚   â””â”€â”€ Bar.vue
â”œâ”€â”€ App.vue
â”œâ”€â”€ app.js # é€šç”¨ entryï¼Œæš´éœ²ä¸€ä¸ªå¯ä»¥é‡å¤æ‰§è¡Œçš„å·¥å‚å‡½æ•°åˆ›å»º vue å®ä¾‹
â”œâ”€â”€ entry-client.js # ä»…è¿è¡Œäºæµè§ˆå™¨ï¼Œä¸»è¦å¤„ç†å®¢æˆ·ç«¯æ•°æ®é¢„å–å’ŒæŒ‚è½½ DOMï¼ˆéœ€è¦ app.jsï¼‰
â””â”€â”€ entry-server.js # ä»…è¿è¡ŒäºæœåŠ¡å™¨ã€‚ä¸»è¦å¤„ç†æœåŠ¡ç«¯è·¯ç”±åŒ¹é…å’Œæ•°æ®é¢„å–ï¼ˆéœ€è¦ app.jsï¼‰
server.js # åˆ©ç”¨ Bundle Renderer è¿›è¡ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆéœ€è¦ server bundle / clientManifest / setup-dev-server.jsï¼‰
```

### app.js

ä¸Šé¢æˆ‘ä»¬å·²ç»è®¨è®ºè¿‡ï¼Œæˆ‘ä»¬è¦ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„æ ¹ Vue å®ä¾‹ï¼Œå› æ­¤æš´éœ²ä¸€ä¸ªå¯ä»¥é‡å¤æ‰§è¡Œçš„å·¥å‚å‡½æ•° `createApp`:

```JS
import { sync } from 'vuex-router-sync'

// Expose a factory function that creates a fresh set of store, router,
// app instances on each call (which is called for each SSR request)
export function createApp () {
  // create store and router instances
  const store = createStore()
  const router = createRouter()

  // sync the router with the vuex store.
  // this registers `store.state.route`
  sync(store, router)

  // create the app instance.
  // here we inject the router, store and ssr context to all child components,
  // making them available everywhere as `this.$router` and `this.$store`.
  const app = new Vue({
    router,
    store,
    render: h => h(App)
  })

  // expose the app, the router and the store.
  // note we are not mounting the app here, since bootstrapping will be
  // different depending on whether we are in a browser or on the server.
  return { app, router, store }
}
```

åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“(SSR)æœŸé—´ï¼Œæˆ‘ä»¬æœ¬è´¨ä¸Šæ˜¯åœ¨æ¸²æŸ“æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„"å¿«ç…§"ï¼Œæ‰€ä»¥å¦‚æœåº”ç”¨ç¨‹åºä¾èµ–äºä¸€äº›å¼‚æ­¥æ•°æ®ï¼Œé‚£ä¹ˆåœ¨å¼€å§‹æ¸²æŸ“è¿‡ç¨‹ä¹‹å‰ï¼Œéœ€è¦å…ˆé¢„å–å’Œè§£æå¥½è¿™äº›æ•°æ®ã€‚å¦ä¸€ä¸ªéœ€è¦å…³æ³¨çš„é—®é¢˜æ˜¯åœ¨å®¢æˆ·ç«¯ï¼Œåœ¨æŒ‚è½½ (mount) åˆ°å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¹‹å‰ï¼Œéœ€è¦è·å–åˆ°ä¸æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºå®Œå…¨ç›¸åŒçš„æ•°æ® - å¦åˆ™ï¼Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¼šå› ä¸ºä½¿ç”¨ä¸æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºä¸åŒçš„çŠ¶æ€ï¼Œç„¶åå¯¼è‡´æ··åˆå¤±è´¥ã€‚å› æ­¤é‡‡ç”¨å®˜æ–¹çš„ [Vuex çŠ¶æ€ç®¡ç†åº“]( {{site.url}}/2019/08/06/vuex-profile.html )ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨å“ªé‡Œæ”¾ç½®ã€Œdispatch æ•°æ®é¢„å– actionã€çš„ä»£ç å‘¢ï¼Ÿ

æˆ‘ä»¬åœ¨è·¯ç”±ç»„ä»¶ä¸Šæš´éœ²å‡ºä¸€ä¸ªè‡ªå®šä¹‰é™æ€å‡½æ•° `asyncData`ã€‚æ³¨æ„ï¼Œç”±äºæ­¤å‡½æ•°ä¼šåœ¨ç»„ä»¶å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ï¼Œæ‰€ä»¥å®ƒæ— æ³•è®¿é—® thisã€‚éœ€è¦å°† store å’Œè·¯ç”±ä¿¡æ¯ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»:

```JS
// Item.vue
export default {
  asyncData ({ store, route }) {
    // è§¦å‘ action åï¼Œä¼šè¿”å› Promise
    return store.dispatch('fetchItem', route.params.id)
  },
  computed: {
    // ä» store çš„ state å¯¹è±¡ä¸­çš„è·å– itemã€‚
    item () {
      return this.$store.state.items[this.$route.params.id]
    }
  }
}
```

### entry-server.js

æœåŠ¡å™¨ entry ä½¿ç”¨ `default export` å¯¼å‡ºå‡½æ•°ï¼Œå¹¶åœ¨æ¯æ¬¡æ¸²æŸ“ä¸­é‡å¤è°ƒç”¨æ­¤å‡½æ•°ã€‚ä¸»è¦æ‰§è¡Œ**æœåŠ¡å™¨ç«¯è·¯ç”±åŒ¹é… (server-side route matching)** å’Œ**æ•°æ®é¢„å–é€»è¾‘ (data pre-fetching logic)**ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è·¯ç”±è·å¾—ä¸ `router.getMatchedComponents()` ç›¸åŒ¹é…çš„ç»„ä»¶ï¼Œå¦‚æœç»„ä»¶æš´éœ²å‡º `asyncData`ï¼Œæˆ‘ä»¬å°±è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚ç„¶åæˆ‘ä»¬éœ€è¦å°†è§£æå®Œæˆçš„çŠ¶æ€ï¼Œé™„åŠ åˆ°æ¸²æŸ“ä¸Šä¸‹æ–‡(render context)ä¸­:

```JS
import { createApp } from './app'

// This exported function will be called by `bundleRenderer`.
// This is where we perform data-prefetching to determine the
// state of our application before actually rendering it.
// Since data fetching is async, this function is expected to
// return a Promise that resolves to the app instance.
export default context => {
  return new Promise((resolve, reject) => {
    const { app, router, store } = createApp()

    // è®¾ç½®æœåŠ¡å™¨ç«¯ router çš„ä½ç½®
    router.push(context.url)

    // ç­‰åˆ° router å°†å¯èƒ½çš„å¼‚æ­¥ç»„ä»¶å’Œé’©å­å‡½æ•°è§£æå®Œ
    router.onReady(() => {
      const matchedComponents = router.getMatchedComponents()
      // åŒ¹é…ä¸åˆ°çš„è·¯ç”±ï¼Œæ‰§è¡Œ reject å‡½æ•°ï¼Œå¹¶è¿”å› 404
      if (!matchedComponents.length) {
        return reject({ code: 404 })
      }

      // å¯¹æ‰€æœ‰åŒ¹é…çš„è·¯ç”±ç»„ä»¶è°ƒç”¨ `asyncData()`
      Promise.all(matchedComponents.map(Component => {
        if (Component.asyncData) {
          return Component.asyncData({
            store,
            route: router.currentRoute
          })
        }
      })).then(() => {
        // åœ¨æ‰€æœ‰é¢„å–é’©å­(preFetch hook) resolve åï¼Œ
        // æˆ‘ä»¬çš„ store ç°åœ¨å·²ç»å¡«å……å…¥æ¸²æŸ“åº”ç”¨ç¨‹åºæ‰€éœ€çš„çŠ¶æ€ã€‚
        // å½“æˆ‘ä»¬å°†çŠ¶æ€é™„åŠ åˆ°ä¸Šä¸‹æ–‡ï¼Œ
        // å¹¶ä¸” `template` é€‰é¡¹ç”¨äº renderer æ—¶ï¼Œ
        // çŠ¶æ€å°†è‡ªåŠ¨åºåˆ—åŒ–ä¸º `window.__INITIAL_STATE__`ï¼Œå¹¶æ³¨å…¥ HTMLã€‚
        context.state = store.state

        // Promise åº”è¯¥ resolve åº”ç”¨ç¨‹åºå®ä¾‹ï¼Œä»¥ä¾¿å®ƒå¯ä»¥æ¸²æŸ“
        resolve(app)
      }).catch(reject)
    }, reject)
  })
}
```

### entry-client.js

å®¢æˆ·ç«¯ entry åªéœ€åˆ›å»ºåº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”å°†å…¶æŒ‚è½½åˆ° DOM ä¸­:

```JS
import { createApp } from './app'

const { app, router } = createApp()

// éœ€è¦åœ¨æŒ‚è½½ app ä¹‹å‰è°ƒç”¨ router.onReadyï¼Œå› ä¸ºè·¯ç”±å™¨å¿…é¡»è¦æå‰è§£æè·¯ç”±é…ç½®ä¸­çš„å¼‚æ­¥ç»„ä»¶ï¼Œæ‰èƒ½æ­£ç¡®åœ°è°ƒç”¨ç»„ä»¶ä¸­å¯èƒ½å­˜åœ¨çš„è·¯ç”±é’©å­
router.onReady(() => {
  app.$mount('#app')
})
```

å®¢æˆ·ç«¯æ•°æ®é¢„å– (Client Data Fetching) ä¸€èˆ¬æœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼:

* **åœ¨è·¯ç”±å¯¼èˆªä¹‹å‰è§£ææ•°æ®** - ä½¿ç”¨æ­¤ç­–ç•¥ï¼Œåº”ç”¨ç¨‹åºä¼šç­‰å¾…è§†å›¾æ‰€éœ€æ•°æ®å…¨éƒ¨è§£æä¹‹åï¼Œå†ä¼ å…¥æ•°æ®å¹¶å¤„ç†å½“å‰è§†å›¾ã€‚å¥½å¤„åœ¨äºï¼Œå¯ä»¥ç›´æ¥åœ¨æ•°æ®å‡†å¤‡å°±ç»ªæ—¶ï¼Œä¼ å…¥è§†å›¾æ¸²æŸ“å®Œæ•´å†…å®¹ï¼Œä½†æ˜¯å¦‚æœæ•°æ®é¢„å–éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œç”¨æˆ·åœ¨å½“å‰è§†å›¾ä¼šæ„Ÿå—åˆ°"æ˜æ˜¾å¡é¡¿"
* **åŒ¹é…è¦æ¸²æŸ“çš„è§†å›¾åï¼Œå†è·å–æ•°æ®** - æ­¤ç­–ç•¥å°†å®¢æˆ·ç«¯æ•°æ®é¢„å–é€»è¾‘ï¼Œæ”¾åœ¨è§†å›¾ç»„ä»¶çš„ `beforeMount` å‡½æ•°ä¸­ã€‚å½“è·¯ç”±å¯¼èˆªè¢«è§¦å‘æ—¶ï¼Œå¯ä»¥ç«‹å³åˆ‡æ¢è§†å›¾ï¼Œå› æ­¤åº”ç”¨ç¨‹åºå…·æœ‰æ›´å¿«çš„å“åº”é€Ÿåº¦ã€‚ç„¶è€Œï¼Œä¼ å…¥è§†å›¾åœ¨æ¸²æŸ“æ—¶ä¸ä¼šæœ‰å®Œæ•´çš„å¯ç”¨æ•°æ®ã€‚å› æ­¤ï¼Œå¯¹äºä½¿ç”¨æ­¤ç­–ç•¥çš„æ¯ä¸ªè§†å›¾ç»„ä»¶ï¼Œéƒ½éœ€è¦å…·æœ‰æ¡ä»¶åŠ è½½çŠ¶æ€

1ã€åœ¨è·¯ç”±å¯¼èˆªä¹‹å‰è§£ææ•°æ®

```JS
router.onReady(() => {
  // æ·»åŠ è·¯ç”±é’©å­å‡½æ•°ï¼Œç”¨äºå¤„ç† asyncData.
  // åœ¨åˆå§‹è·¯ç”± resolve åæ‰§è¡Œï¼Œ
  // ä»¥ä¾¿æˆ‘ä»¬ä¸ä¼šäºŒæ¬¡é¢„å–(double-fetch)å·²æœ‰çš„æ•°æ®ã€‚
  // ä½¿ç”¨ `router.beforeResolve()`ï¼Œä»¥ä¾¿ç¡®ä¿æ‰€æœ‰å¼‚æ­¥ç»„ä»¶éƒ½ resolveã€‚
  router.beforeResolve((to, from, next) => {
    const matched = router.getMatchedComponents(to)
    const prevMatched = router.getMatchedComponents(from)

    // æˆ‘ä»¬åªå…³å¿ƒéé¢„æ¸²æŸ“çš„ç»„ä»¶
    // æ‰€ä»¥æˆ‘ä»¬å¯¹æ¯”å®ƒä»¬ï¼Œæ‰¾å‡ºä¸¤ä¸ªåŒ¹é…åˆ—è¡¨çš„å·®å¼‚ç»„ä»¶
    let diffed = false
    const activated = matched.filter((c, i) => {
      return diffed || (diffed = (prevMatched[i] !== c))
    })

    if (!activated.length) {
      return next()
    }

    // è¿™é‡Œå¦‚æœæœ‰åŠ è½½æŒ‡ç¤ºå™¨ (loading indicator)ï¼Œå°±è§¦å‘

    Promise.all(activated.map(c => {
      if (c.asyncData) {
        return c.asyncData({ store, route: to })
      }
    })).then(() => {

      // åœæ­¢åŠ è½½æŒ‡ç¤ºå™¨(loading indicator)

      next()
    }).catch(next)
  })

  app.$mount('#app')
})
```

2ã€åŒ¹é…è¦æ¸²æŸ“çš„è§†å›¾åï¼Œå†è·å–æ•°æ®

```JS
// å…¨å±€ mixin
Vue.mixin({
  beforeMount () {
    const { asyncData } = this.$options
    if (asyncData) {
      // å°†è·å–æ•°æ®æ“ä½œåˆ†é…ç»™ promise
      // ä»¥ä¾¿åœ¨ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ•°æ®å‡†å¤‡å°±ç»ªå
      // é€šè¿‡è¿è¡Œ `this.dataPromise.then(...)` æ¥æ‰§è¡Œå…¶ä»–ä»»åŠ¡
      this.dataPromise = asyncData({
        store: this.$store,
        route: this.$route
      })
    }
  }
})
```

è¿™ä¸¤ç§ç­–ç•¥æ˜¯æ ¹æœ¬ä¸Šä¸åŒçš„ç”¨æˆ·ä½“éªŒå†³ç­–ï¼Œåº”è¯¥æ ¹æ®ä½ åˆ›å»ºçš„åº”ç”¨ç¨‹åºçš„å®é™…ä½¿ç”¨åœºæ™¯è¿›è¡ŒæŒ‘é€‰ã€‚ä½†æ˜¯æ— è®ºä½ é€‰æ‹©å“ªç§ç­–ç•¥ï¼Œå½“è·¯ç”±ç»„ä»¶é‡ç”¨ï¼ˆåŒä¸€è·¯ç”±ï¼Œä½†æ˜¯ params æˆ– query å·²æ›´æ”¹ï¼Œä¾‹å¦‚ï¼Œä» user/1 åˆ° user/2ï¼‰æ—¶ï¼Œä¹Ÿåº”è¯¥è°ƒç”¨ `asyncData` å‡½æ•°ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡çº¯å®¢æˆ·ç«¯ (client-only) çš„å…¨å±€ mixin æ¥å¤„ç†è¿™ä¸ªé—®é¢˜:

```JS
Vue.mixin({
  beforeRouteUpdate (to, from, next) {
    const { asyncData } = this.$options
    if (asyncData) {
      asyncData({
        store: this.$store,
        route: to
      }).then(next).catch(next)
    } else {
      next()
    }
  }
})
```

### server.js

**vue-server-renderer** æä¾›ä¸€ä¸ªåä¸º `createBundleRenderer` çš„ APIï¼Œé€šè¿‡ä½¿ç”¨ webpack çš„è‡ªå®šä¹‰æ’ä»¶ï¼Œ`server bundle` å°†ç”Ÿæˆä¸ºå¯ä¼ é€’åˆ° `bundle renderer` çš„ç‰¹æ®Š JSON æ–‡ä»¶ã€‚æ‰€åˆ›å»ºçš„ `bundle renderer`ï¼Œç”¨æ³•å’Œæ™®é€š renderer ç›¸åŒï¼Œä½†æ˜¯ `bundle renderer` æä¾›ä»¥ä¸‹ä¼˜ç‚¹:

1. å†…ç½®çš„ `source map` æ”¯æŒï¼ˆåœ¨ webpack é…ç½®ä¸­ä½¿ç”¨ `devtool: 'source-map'`ï¼‰
2. åœ¨å¼€å‘ç¯å¢ƒç”šè‡³éƒ¨ç½²è¿‡ç¨‹ä¸­çƒ­é‡è½½ï¼ˆé€šè¿‡è¯»å–æ›´æ–°åçš„ bundleï¼Œç„¶åé‡æ–°åˆ›å»º renderer å®ä¾‹ï¼‰
3. å…³é”® `CSS(critical CSS)` æ³¨å…¥ï¼ˆåœ¨ä½¿ç”¨ *.vue æ–‡ä»¶æ—¶ï¼‰ï¼šè‡ªåŠ¨å†…è”åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ç”¨åˆ°çš„ç»„ä»¶æ‰€éœ€çš„CSS
4. ä½¿ç”¨ `clientManifest` è¿›è¡Œèµ„æºæ³¨å…¥ï¼šè‡ªåŠ¨æ¨æ–­å‡ºæœ€ä½³çš„é¢„åŠ è½½(preload)å’Œé¢„å–(prefetch)æŒ‡ä»¤ï¼Œä»¥åŠåˆå§‹æ¸²æŸ“æ‰€éœ€çš„ä»£ç åˆ†å‰² chunk

`bundle renderer` åœ¨è°ƒç”¨ `renderToString` æ—¶ï¼Œå®ƒå°†è‡ªåŠ¨æ‰§è¡Œã€Œç”± bundle åˆ›å»ºçš„åº”ç”¨ç¨‹åºå®ä¾‹ã€æ‰€å¯¼å‡ºçš„å‡½æ•°ï¼ˆä¼ å…¥ä¸Šä¸‹æ–‡ä½œä¸ºå‚æ•°ï¼‰ï¼Œç„¶åæ¸²æŸ“å®ƒ:

```JS
const { createBundleRenderer } = require('vue-server-renderer')

function createRenderer (bundle, options) {
  // https://github.com/vuejs/vue/blob/dev/packages/vue-server-renderer/README.md#why-use-bundlerenderer
  return createBundleRenderer(bundle, Object.assign(options, {
    // for component caching
    cache: LRU({
      max: 1000,
      maxAge: 1000 * 60 * 15
    }),
    // this is only needed when vue-server-renderer is npm-linked
    basedir: resolve('./dist'),
    // recommended for performance, default value is true
    runInNewContext: false
  }))
}

let renderer
let readyPromise
const templatePath = resolve('./src/index.template.html')
if (isProd) {
  // In production: create server renderer using template and built server bundle.
  // The server bundle is generated by vue-ssr-webpack-plugin.
  const template = fs.readFileSync(templatePath, 'utf-8')
  const bundle = require('./dist/vue-ssr-server-bundle.json')
  // The client manifests are optional, but it allows the renderer
  // to automatically infer preload/prefetch links and directly add <script>
  // tags for any async chunks used during render, avoiding waterfall requests.
  const clientManifest = require('./dist/vue-ssr-client-manifest.json')
  renderer = createRenderer(bundle, {
    template, // ï¼ˆå¯é€‰ï¼‰é¡µé¢æ¨¡æ¿
    clientManifest // ï¼ˆå¯é€‰ï¼‰å®¢æˆ·ç«¯æ„å»º manifest
  })
} else {
  // In development: setup the dev server with watch and hot-reload,
  // and create a new renderer on bundle / index template update.
  readyPromise = require('./build/setup-dev-server')(
    app,
    templatePath,
    (bundle, options) => {
      renderer = createRenderer(bundle, options)
    }
  )
}

function render (req, res) {
  const s = Date.now()

  res.setHeader("Content-Type", "text/html")
  res.setHeader("Server", serverInfo)

  const handleError = err => {
    if (err.url) {
      res.redirect(err.url)
    } else if(err.code === 404) {
      res.status(404).send('404 | Page Not Found')
    } else {
      // Render Error Page or Redirect
      res.status(500).send('500 | Internal Server Error')
      console.error(`error during render : ${req.url}`)
      console.error(err.stack)
    }
  }

  const context = {
    title: 'Vue HN 2.0', // default title
    url: req.url
  }
  renderer.renderToString(context, (err, html) => {
    if (err) {
      return handleError(err)
    }
    res.send(html)
    if (!isProd) {
      console.log(`whole request: ${Date.now() - s}ms`)
    }
  })
}

app.get('*', isProd ? render : (req, res) => {
  readyPromise.then(() => render(req, res))
})
```

> ä¸€èˆ¬æƒ…å†µä¸‹éœ€è¦åœ¨ `createApp` ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œå¹¶ä»æ ¹ Vue å®ä¾‹æ³¨å…¥ã€‚åœ¨ä½¿ç”¨å¸¦æœ‰ `{ runInNewContext: true }` çš„ `bundle renderer` æ—¶ï¼Œå¯ä»¥æ¶ˆé™¤æ­¤çº¦æŸï¼Œä½†æ˜¯ç”±äºéœ€è¦ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡å¹¶é‡æ–°æ‰§è¡Œæ•´ä¸ª bundleï¼Œå› æ­¤ä¼´éšæœ‰ä¸€äº›æ˜¾è‘—æ€§èƒ½å¼€é”€ã€‚å› æ­¤å»ºè®®æ˜¾ç¤ºè®¾ç½®ä¸º `{ runInNewContext: false }`


> [**template**](https://ssr.vuejs.org/zh/api/#template) ä¸ºæ•´ä¸ªé¡µé¢çš„ HTML æä¾›ä¸€ä¸ªæ¨¡æ¿ã€‚æ­¤æ¨¡æ¿åº”åŒ…å«æ³¨é‡Š `<!--vue-ssr-outlet-->`ï¼Œä½œä¸ºæ¸²æŸ“åº”ç”¨ç¨‹åºå†…å®¹çš„å ä½ç¬¦ã€‚æ›´å¤š Renderer é…ç½®é¡¹[å¯å‚è€ƒè¿™é‡Œ](https://ssr.vuejs.org/zh/api/#cache) ğŸ‘ˆ

### store æ‹†åˆ†

å¯¹äºå„æ¨¡å—ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œstate å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä»¥ä¾¿åˆ›å»ºå¤šä¸ªå®ä¾‹åŒ–è¯¥æ¨¡å—:

```JS
// store/modules/foo.js
export default {
  namespaced: true,
  // é‡è¦ä¿¡æ¯ï¼šstate å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå› æ­¤å¯ä»¥åˆ›å»ºå¤šä¸ªå®ä¾‹åŒ–è¯¥æ¨¡å—
  state: () => ({
    count: 0
  }),
  actions: {
    inc: ({ commit }) => commit('inc')
  },
  mutations: {
    inc: state => state.count++
  }
}
```

æˆ‘ä»¬å¯ä»¥åœ¨è·¯ç”±ç»„ä»¶çš„ `asyncData` é’©å­å‡½æ•°ä¸­ï¼Œä½¿ç”¨ `store.registerModule` æƒ°æ€§æ³¨å†Œ(lazy-register)è¿™ä¸ªæ¨¡å—:

```JS
import fooStoreModule from '../store/modules/foo' // å¯¼å…¥æ¨¡å—

export default {
  asyncData ({ store }) {
    store.registerModule('foo', fooStoreModule)
    return store.dispatch('foo/inc')
  },

  // é‡è¦ä¿¡æ¯ï¼šå½“å¤šæ¬¡è®¿é—®è·¯ç”±æ—¶ï¼Œé¿å…åœ¨å®¢æˆ·ç«¯é‡å¤æ³¨å†Œæ¨¡å—ã€‚
  destroyed () {
    this.$store.unregisterModule('foo')
  },

  computed: {
    fooCount () {
      return this.$store.state.foo.count
    }
  }
}
```

### å®¢æˆ·ç«¯æ¿€æ´»(client-side hydration)

æ‰€è°“**å®¢æˆ·ç«¯æ¿€æ´»**ï¼ŒæŒ‡çš„æ˜¯ Vue åœ¨æµè§ˆå™¨ç«¯æ¥ç®¡ç”±æœåŠ¡ç«¯å‘é€çš„é™æ€ HTMLï¼Œä½¿å…¶å˜ä¸ºç”± Vue ç®¡ç†çš„åŠ¨æ€ DOM çš„è¿‡ç¨‹ã€‚åœ¨ `entry-client.js` ä¸­ï¼Œæˆ‘ä»¬ç”¨ä¸‹é¢è¿™è¡ŒæŒ‚è½½(mount)åº”ç”¨ç¨‹åº:

```JS
// è¿™é‡Œå‡å®š App.vue template æ ¹å…ƒç´ çš„ `id="app"`
app.$mount('#app')
```

åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼ŒVue å°†æ¨æ–­å®¢æˆ·ç«¯ç”Ÿæˆçš„è™šæ‹Ÿ DOM æ ‘ (virtual DOM tree)ï¼Œæ˜¯å¦ä¸ä»æœåŠ¡å™¨æ¸²æŸ“çš„ DOM ç»“æ„ (DOM structure) åŒ¹é…ã€‚å¦‚æœæ— æ³•åŒ¹é…ï¼Œå®ƒå°†é€€å‡ºæ··åˆæ¨¡å¼ï¼Œä¸¢å¼ƒç°æœ‰çš„ DOM å¹¶ä»å¤´å¼€å§‹æ¸²æŸ“ã€‚åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œæ­¤æ£€æµ‹ä¼šè¢«è·³è¿‡ï¼Œä»¥é¿å…æ€§èƒ½æŸè€—ã€‚

ä½¿ç”¨ã€ŒSSR + å®¢æˆ·ç«¯æ··åˆã€æ—¶ï¼Œéœ€è¦äº†è§£çš„ä¸€ä»¶äº‹æ˜¯ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šæ›´æ”¹çš„ä¸€äº›ç‰¹æ®Šçš„ HTML ç»“æ„ã€‚ä¾‹å¦‚ï¼Œå½“ä½ åœ¨ Vue æ¨¡æ¿ä¸­å†™å…¥:

```HTML
<table>
  <tr><td>hi</td></tr>
</table>
```

æµè§ˆå™¨ä¼šåœ¨ <table> å†…éƒ¨è‡ªåŠ¨æ³¨å…¥ <tbody>ï¼Œç„¶è€Œï¼Œç”±äº Vue ç”Ÿæˆçš„è™šæ‹Ÿ DOM (virtual DOM) ä¸åŒ…å« <tbody>ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´æ— æ³•åŒ¹é…ã€‚ä¸ºèƒ½å¤Ÿæ­£ç¡®åŒ¹é…ï¼Œè¯·ç¡®ä¿åœ¨æ¨¡æ¿ä¸­å†™å…¥æœ‰æ•ˆçš„ HTMLã€‚
å¦‚æœæƒ³é¿å…åœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œå¯åˆ©ç”¨ `vue-no-ssr` ç­‰ä¸€äº›åº“æ¥å®ç°:

```HTML
<template>
  <div id="app">
    <h1>My Website</h1>
    <no-ssr>
      <!-- this component will only be rendered on client-side -->
      <comments />
    </no-ssr>
  </div>
</template>
 ```

```JS
  import NoSSR from 'vue-no-ssr'

  export default {
    components: {
      'no-ssr': NoSSR
    }
  }
```

### æ„å»ºé…ç½®

å»ºè®®å°†é…ç½®åˆ†ä¸ºä¸‰ä¸ªæ–‡ä»¶ï¼š`base`, `client` å’Œ `server`ã€‚åŸºæœ¬é…ç½® (base config) åŒ…å«åœ¨ä¸¤ä¸ªç¯å¢ƒå…±äº«çš„é…ç½®ï¼Œä¾‹å¦‚ï¼Œè¾“å‡ºè·¯å¾„ (output path)ï¼Œåˆ«å (alias) å’Œ loaderã€‚æœåŠ¡å™¨é…ç½® (server config) å’Œå®¢æˆ·ç«¯é…ç½® (client config)ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ `webpack-merge` æ¥ç®€å•åœ°æ‰©å±•åŸºæœ¬é…ç½®ã€‚

#### æœåŠ¡å™¨é…ç½® (Server Config)

æœåŠ¡å™¨é…ç½®ï¼Œæ˜¯ç”¨äºç”Ÿæˆä¼ é€’ç»™ `createBundleRenderer` çš„ `server bundle`:

```js
const merge = require('webpack-merge')
const nodeExternals = require('webpack-node-externals')
const baseConfig = require('./webpack.base.config.js')
const VueSSRServerPlugin = require('vue-server-renderer/server-plugin')

module.exports = merge(baseConfig, {
  // å°† entry æŒ‡å‘åº”ç”¨ç¨‹åºçš„ server entry æ–‡ä»¶
  entry: '/path/to/entry-server.js',

  // è¿™å…è®¸ webpack ä»¥ Node é€‚ç”¨æ–¹å¼(Node-appropriate fashion)å¤„ç†åŠ¨æ€å¯¼å…¥(dynamic import)ï¼Œ
  // å¹¶ä¸”è¿˜ä¼šåœ¨ç¼–è¯‘ Vue ç»„ä»¶æ—¶ï¼Œ
  // å‘ŠçŸ¥ `vue-loader` è¾“é€é¢å‘æœåŠ¡å™¨ä»£ç (server-oriented code)ã€‚
  target: 'node',

  // å¯¹ bundle renderer æä¾› source map æ”¯æŒ
  devtool: 'source-map',

  // æ­¤å¤„å‘ŠçŸ¥ server bundle ä½¿ç”¨ Node é£æ ¼å¯¼å‡ºæ¨¡å—(Node-style exports)
  output: {
    path: path.resolve(__dirname, 'public', 'dist'),
    filename: 'server-bundle.js',
    libraryTarget: 'commonjs2'
  },

  // https://webpack.js.org/configuration/externals/#function
  // https://github.com/liady/webpack-node-externals
  // å¤–ç½®åŒ–åº”ç”¨ç¨‹åºä¾èµ–æ¨¡å—ã€‚å¯ä»¥ä½¿æœåŠ¡å™¨æ„å»ºé€Ÿåº¦æ›´å¿«ï¼Œå¹¶ç”Ÿæˆè¾ƒå°çš„ bundle æ–‡ä»¶ã€‚
  externals: nodeExternals({
    // do not externalize CSS files in case we need to import it from a dep
    whitelist: /\.css$/
  }),

  // è¿™æ˜¯å°†æœåŠ¡å™¨çš„æ•´ä¸ªè¾“å‡º
  // æ„å»ºä¸ºå•ä¸ª JSON æ–‡ä»¶çš„æ’ä»¶ã€‚
  // é»˜è®¤æ–‡ä»¶åä¸º `vue-ssr-server-bundle.json`
  plugins: [
    new webpack.DefinePlugin({
      'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV || 'development'),
      'process.env.VUE_ENV': '"server"'
    }),
    new VueSSRServerPlugin()
  ]
})
```

åœ¨ç”Ÿæˆ `vue-ssr-server-bundle.json` ä¹‹åï¼Œåªéœ€å°†æ–‡ä»¶è·¯å¾„ä¼ é€’ç»™ `createBundleRenderer`:

```JS
onst { createBundleRenderer } = require('vue-server-renderer')
const renderer = createBundleRenderer('/path/to/vue-ssr-server-bundle.json', {
  // â€¦â€¦renderer çš„å…¶ä»–é€‰é¡¹
})
```

#### å®¢æˆ·ç«¯é…ç½® (Client Config)

æˆ‘ä»¬è¿˜å¯ä»¥ç”Ÿæˆ**å®¢æˆ·ç«¯æ„å»ºæ¸…å• (client build manifest)**ã€‚ä½¿ç”¨å®¢æˆ·ç«¯æ¸…å• (client manifest) å’ŒæœåŠ¡å™¨ bundle(server bundle)ï¼Œrenderer ç°åœ¨å…·æœ‰äº†æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„æ„å»ºä¿¡æ¯ï¼Œå› æ­¤å®ƒå¯ä»¥è‡ªåŠ¨æ¨æ–­å’Œæ³¨å…¥èµ„æºé¢„åŠ è½½ / æ•°æ®é¢„å–æŒ‡ä»¤(preload / prefetch directive)ï¼Œä»¥åŠ css é“¾æ¥ / script æ ‡ç­¾åˆ°æ‰€æ¸²æŸ“çš„ HTML:

```JS
const webpack = require('webpack')
const merge = require('webpack-merge')
const base = require('./webpack.base.config')
const SWPrecachePlugin = require('sw-precache-webpack-plugin')
// ç”Ÿæˆä¸€ä¸ªå®¢æˆ·ç«¯æ„å»º manifest å¯¹è±¡ï¼ŒåŒ…å«äº† webpack æ•´ä¸ªæ„å»ºè¿‡ç¨‹çš„ä¿¡æ¯ï¼Œä»è€Œå¯ä»¥è®© bundle renderer è‡ªåŠ¨æ¨å¯¼éœ€è¦åœ¨ HTML æ¨¡æ¿ä¸­æ³¨å…¥çš„å†…å®¹
const VueSSRClientPlugin = require('vue-server-renderer/client-plugin')

const config = merge(base, {
  entry: {
    app: '/path/to/entry-client.js'
  },
  resolve: {
    alias: {
      'create-api': './create-api-client.js'
    }
  },
  plugins: [
    // strip dev-only code in Vue source
    new webpack.DefinePlugin({
      'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV || 'development'),
      'process.env.VUE_ENV': '"client"'
    }),
    // extract vendor chunks for better caching
    new webpack.optimize.CommonsChunkPlugin({
      name: 'vendor',
      minChunks: function (module) {
        // a module is extracted into the vendor chunk if...
        return (
          // it's inside node_modules
          /node_modules/.test(module.context) &&
          // and not a CSS file (due to extract-text-webpack-plugin limitation)
          !/\.css$/.test(module.request)
        )
      }
    }),
    // extract webpack runtime & manifest to avoid vendor chunk hash changing
    // on every build.
    new webpack.optimize.CommonsChunkPlugin({
      name: 'manifest'
    }),
    new VueSSRClientPlugin()
  ]
})

if (process.env.NODE_ENV === 'production') {
  config.plugins.push(
    // auto generate service worker
    new SWPrecachePlugin({
      cacheId: 'vue-hn',
      filename: 'service-worker.js',
      minify: true,
      dontCacheBustUrlsMatching: /./,
      staticFileGlobsIgnorePatterns: [/\.map$/, /\.json$/],
      runtimeCaching: [
        {
          urlPattern: '/',
          handler: 'networkFirst'
        },
        {
          urlPattern: /\/(top|new|show|ask|jobs)/,
          handler: 'networkFirst'
        },
        {
          urlPattern: '/item/:id',
          handler: 'networkFirst'
        },
        {
          urlPattern: '/user/:id',
          handler: 'networkFirst'
        }
      ]
    })
  )
}

module.exports = config
```

#### å¼€å‘ç¯å¢ƒé…ç½®

ä¸»è¦æ˜¯è®¾ç½®å¼€å‘æ¨¡å¼ä¸­é—´ä»¶ï¼Œæ¯”å¦‚çƒ­é‡è½½ï¼Œé€šè¿‡è¯»å–æ›´æ–°åçš„ bundleï¼Œç„¶åé‡æ–°åˆ›å»º renderer å®ä¾‹ã€‚ç”Ÿäº§æ¨¡å¼ç”±äºæ€§èƒ½é—®é¢˜ä¸å»ºè®®å¼€å¯:

```JS
// setup-dev-server.js
const fs = require('fs')
const path = require('path')
const MFS = require('memory-fs')
const webpack = require('webpack')
const chokidar = require('chokidar')
const clientConfig = require('./webpack.client.config')
const serverConfig = require('./webpack.server.config')

const readFile = (fs, file) => {
  try {
    return fs.readFileSync(path.join(clientConfig.output.path, file), 'utf-8')
  } catch (e) {}
}

module.exports = function setupDevServer (app, templatePath, cb) {
  let bundle
  let template
  let clientManifest

  let ready
  const readyPromise = new Promise(r => { ready = r })
  const update = () => {
    if (bundle && clientManifest) {
      ready()
      cb(bundle, {
        template,
        clientManifest
      })
    }
  }

  // read template from disk and watch
  template = fs.readFileSync(templatePath, 'utf-8')
  chokidar.watch(templatePath).on('change', () => {
    template = fs.readFileSync(templatePath, 'utf-8')
    console.log('index.html template updated.')
    update()
  })

  // modify client config to work with hot middleware
  clientConfig.entry.app = ['webpack-hot-middleware/client', clientConfig.entry.app]
  clientConfig.output.filename = '[name].js'
  clientConfig.plugins.push(
    new webpack.HotModuleReplacementPlugin(),
    new webpack.NoEmitOnErrorsPlugin()
  )

  // dev middleware
  const clientCompiler = webpack(clientConfig)
  const devMiddleware = require('webpack-dev-middleware')(clientCompiler, {
    publicPath: clientConfig.output.publicPath,
    noInfo: true
  })
  app.use(devMiddleware)
  clientCompiler.plugin('done', stats => {
    stats = stats.toJson()
    stats.errors.forEach(err => console.error(err))
    stats.warnings.forEach(err => console.warn(err))
    if (stats.errors.length) return
    clientManifest = JSON.parse(readFile(
      devMiddleware.fileSystem,
      'vue-ssr-client-manifest.json'
    ))
    update()
  })

  // hot middleware
  app.use(require('webpack-hot-middleware')(clientCompiler, { heartbeat: 5000 }))

  // watch and update server renderer
  const serverCompiler = webpack(serverConfig)
  const mfs = new MFS()
  serverCompiler.outputFileSystem = mfs
  serverCompiler.watch({}, (err, stats) => {
    if (err) throw err
    stats = stats.toJson()
    if (stats.errors.length) return

    // read bundle generated by vue-ssr-webpack-plugin
    bundle = JSON.parse(readFile(mfs, 'vue-ssr-server-bundle.json'))
    update()
  })

  return readyPromise
}
```

### ç¼“å­˜

#### é¡µé¢çº§åˆ«ç¼“å­˜

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨åä¸º [**micro-caching**](https://www.nginx.com/blog/benefits-of-microcaching-nginx/) çš„ç¼“å­˜ç­–ç•¥ï¼Œæ¥å¤§å¹…åº¦æé«˜åº”ç”¨ç¨‹åºå¤„ç†é«˜æµé‡çš„èƒ½åŠ›:

```JS
// https://github.com/isaacs/node-lru-cache
const LRU = require('lru-cache')
const microCache = LRU({
  max: 100,
  maxAge: 1000 // é‡è¦æç¤ºï¼šæ¡ç›®åœ¨ 1 ç§’åè¿‡æœŸã€‚
})

const isCacheable = req => {
  // å®ç°é€»è¾‘ä¸ºï¼Œæ£€æŸ¥è¯·æ±‚æ˜¯å¦æ˜¯ç”¨æˆ·ç‰¹å®š(user-specific)ã€‚
  // åªæœ‰éç”¨æˆ·ç‰¹å®š (non-user-specific) é¡µé¢æ‰ä¼šç¼“å­˜
}

server.get('*', (req, res) => {
  const cacheable = isCacheable(req)
  if (cacheable) {
    const hit = microCache.get(req.url)
    if (hit) {
      return res.end(hit)
    }
  }

  renderer.renderToString((err, html) => {
    res.end(html)
    if (cacheable) {
      microCache.set(req.url, html)
    }
  })
})
```

#### ç»„ä»¶çº§åˆ«ç¼“å­˜

```JS
// server.js
function createRenderer (bundle, options) {
  // https://github.com/vuejs/vue/blob/dev/packages/vue-server-renderer/README.md#why-use-bundlerenderer
  return createBundleRenderer(bundle, Object.assign(options, {
    // for component caching
    cache: LRU({
      max: 1000,
      maxAge: 1000 * 60 * 15
    }),
    // this is only needed when vue-server-renderer is npm-linked
    basedir: resolve('./dist'),
    // recommended for performance
    runInNewContext: false
  }))
}
```

ç„¶åï¼Œä½ å¯ä»¥é€šè¿‡å®ç° `serverCacheKey` å‡½æ•°æ¥ç¼“å­˜ç»„ä»¶:

```JS
export default {
  name: 'item', // å¿…å¡«é€‰é¡¹
  props: ['item'],
  serverCacheKey: props => props.item.id,
  render (h) {
    return h('div', this.item.id)
  }
}
```

é€‚ç”¨äºç¼“å­˜çš„æœ€å¸¸è§ç±»å‹çš„ç»„ä»¶ï¼Œæ˜¯åœ¨å¤§çš„ v-for åˆ—è¡¨ä¸­é‡å¤å‡ºç°çš„ç»„ä»¶ã€‚ç”±äºè¿™äº›ç»„ä»¶é€šå¸¸ç”±æ•°æ®åº“é›†åˆ(database collection)ä¸­çš„å¯¹è±¡é©±åŠ¨ï¼Œå®ƒä»¬å¯ä»¥ä½¿ç”¨ç®€å•çš„ç¼“å­˜ç­–ç•¥ï¼šä½¿ç”¨å…¶å”¯ä¸€ idï¼Œå†åŠ ä¸Šæœ€åæ›´æ–°çš„æ—¶é—´æˆ³ï¼Œæ¥ç”Ÿæˆå…¶ç¼“å­˜é”®(cache key):

```JS
serverCacheKey: props => props.item.id + '::' + props.item.last_updated
```

## Nuxt

[**Nuxt**](https://zh.nuxtjs.org/guide/installation) æ˜¯ä¸€ä¸ªåŸºäº Vue.js çš„é€šç”¨åº”ç”¨æ¡†æ¶ï¼Œé¢„è®¾äº†åˆ©ç”¨ Vue.js å¼€å‘æœåŠ¡ç«¯æ¸²æŸ“çš„åº”ç”¨æ‰€éœ€è¦çš„å„ç§é…ç½®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æä¾›äº†ä¸€ç§å‘½ä»¤å«ï¼š`nuxt generate` ï¼Œä¸ºåŸºäº Vue.js çš„åº”ç”¨æä¾›ç”Ÿæˆå¯¹åº”çš„é™æ€ç«™ç‚¹çš„åŠŸèƒ½ã€‚æˆ‘ä»¬ç›¸ä¿¡è¿™ä¸ªå‘½ä»¤æ‰€æä¾›çš„åŠŸèƒ½ï¼Œæ˜¯å‘å¼€å‘é›†æˆå„ç§å¾®æœåŠ¡ï¼ˆMicroservicesï¼‰çš„ Web åº”ç”¨è¿ˆå¼€çš„æ–°ä¸€æ­¥:

![Nuxt.js](https://zh.nuxtjs.org/nuxt-schema.svg)

> è‡³äºæœåŠ¡ç«¯æ¸²æŸ“ï¼Œç›®å‰å®è·µçš„å…¶å®ä¸å¤šï¼ŒTo be continued
