---
layout: blog
front: true
comments: True
flag: NPM
background: green
category: å‰ç«¯
title: pnpm & Monorepo
date: 2021-03-25 16:16:00 GMT+0800 (CST)
update: 2022-02-22 14:16:00 GMT+0800 (CST)
description: add æ‰å¹³åŒ–å¦‚ä½•å¤„ç†ä¸åŒç‰ˆæœ¬çš„ä¾èµ–
background-image: https://camo.githubusercontent.com/15249b13cd482f77ff1e9f74952f1a01892912af0c5cab22f73f26d595b2f0bf/68747470733a2f2f692e696d6775722e636f6d2f716c57316545472e706e67

tags:
- NPM
---
# {{ page.title }}

## ä»€ä¹ˆæ˜¯ pnpm

[**pnpm**](https://github.com/pnpm/pnpm) å°±æ˜¯åŒ…ç®¡ç†å™¨ï¼Œç±»ä¼¼çš„æœ‰ npm å’Œ yarnã€‚é‚£ä¹ˆ pnpm ä¸ºä»€ä¹ˆè€Œå­˜åœ¨ï¼Œæ‘˜è‡ªå®˜æ–¹çš„è§£é‡Š:

```TEXT
Fast, disk space efficient package manager
```

1. Fast. Up to 2x faster than the alternatives (see [benchmark](https://github.com/pnpm/benchmarks-of-javascript-package-managers)).
2. Efficient. Files inside node_modules are linked from a single **content-addressable storage**.
3. Great for **monorepos**.
4. Strict. A package can access only dependencies that are specified in its package.json.
5. Deterministic. Has a lockfile called `pnpm-lock.yaml`.
6. Works everywhere. Supports Windows, Linux, and macOS.
7. Battle-tested. Used in production by teams of all sizes since 2016.

pnpm å¸¦æ¥äº†ä¸¤ä¸ªé‡è¦çš„æå‡:

ä¸€ã€ **èŠ‚çº¦ç£ç›˜ç©ºé—´å¹¶æå‡å®‰è£…é€Ÿåº¦**

åœ¨ä½¿ç”¨ npm æˆ– Yarn æ—¶ï¼Œå¦‚æœä½ æœ‰ 100 ä¸ªé¡¹ç›®ä½¿ç”¨äº†ä¾èµ–ï¼Œä½ å°±ä¼šåœ¨ç¡¬ç›˜ä¸Šå­˜å‚¨ 100 ä¸ªä¾èµ–çš„å‰¯æœ¬ã€‚åœ¨ä½¿ç”¨ pnpm æ—¶ï¼Œä¾èµ–ä¼šè¢«å­˜å‚¨åœ¨å†…å®¹å¯å¯»å€çš„åœ°æ–¹ï¼Œæ‰€ä»¥:

1. å¦‚æœä½ ä¾èµ–äºä¸åŒç‰ˆæœ¬çš„ä¾èµ–ï¼Œé‚£ä¹ˆåªéœ€å°†å·®å¼‚çš„æ–‡ä»¶æ·»åŠ åˆ°å­˜å‚¨ä¸­å¿ƒã€‚ä¾‹å¦‚ï¼Œå¦‚æœå®ƒæœ‰ 100 ä¸ªæ–‡ä»¶ï¼Œè€Œæ–°ç‰ˆæœ¬åªæ”¹å˜äº†å…¶ä¸­ 1 ä¸ªæ–‡ä»¶ã€‚é‚£ä¹ˆ `pnpm update` åªä¼šå‘å­˜å‚¨ä¸­å¿ƒæ·»åŠ  1 ä¸ªæ–°æ–‡ä»¶ï¼Œä¸ä¼šä»…ä»…å› ä¸ºå•ä¸€çš„æ”¹å˜è€Œå…‹éš†æ•´ä¸ªä¾èµ–ã€‚
2. æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šå­˜å‚¨åœ¨ç¡¬ç›˜ä¸Šçš„åŒä¸€ä½ç½®ã€‚å½“å¤šä¸ªåŒ…è¢«å®‰è£…æ—¶ï¼Œæ‰€æœ‰æ–‡ä»¶éƒ½ä¼šä»åŒä¸€ä½ç½®åˆ›å»º**ç¡¬é“¾æ¥**ï¼Œä¸ä¼šå ç”¨é¢å¤–çš„ç£ç›˜ç©ºé—´ã€‚è¿™å…è®¸ä½ è·¨é¡¹ç›®åœ°å…±äº«åŒä¸€ç‰ˆæœ¬çš„ä¾èµ–ã€‚æœ€ç»ˆä½ èŠ‚çœäº†å¤§é‡ä¸é¡¹ç›®å’Œä¾èµ–æˆæ¯”ä¾‹çš„ç¡¬ç›˜ç©ºé—´ï¼Œå¹¶ä¸”æ‹¥æœ‰æ›´å¿«çš„å®‰è£…é€Ÿåº¦ï¼

![saving disk space](https://pnpm.io/assets/images/cafs-illustration-7be6bd97e43ba11a031b099869321deb.jpg)

äºŒã€ **åˆ›å»ºéæ‰å¹³åŒ–çš„ node_modules æ–‡ä»¶å¤¹**

å½“ä½¿ç”¨ pnpm å®‰è£…ä¾èµ–æ—¶ï¼Œæ‰€æœ‰çš„åŒ…ä¼šè¢«æå‡æˆ–æ‰“å¹³åˆ°æ¨¡å—çš„æ ¹ç›®å½•ã€‚å› æ­¤ï¼Œé¡¹ç›®è¿˜æ˜¯å¯ä»¥è®¿é—®åˆ°æœªè¢«ç›´æ¥æ·»åŠ è¿›æ¥çš„ä¾èµ–ã€‚pnpm ä½¿ç”¨**è½¯é“¾æ¥(symlink)**çš„æ–¹å¼å°†é¡¹ç›®çš„ç›´æ¥ä¾èµ–æ·»åŠ è¿›æ¨¡å—æ–‡ä»¶å¤¹çš„æ ¹ç›®å½•ï¼Œæé«˜äº†å®‰å…¨æ€§ã€‚å…·ä½“åé¢ä¼šè®¨è®ºï¼Œå¯ä»¥å‚è€ƒ[æ­¤æ–‡ç« ](https://pnpm.js.org/blog/2020/05/27/flat-node-modules-is-not-the-only-way/)

![flat node_modules](https://pnpm.io/assets/images/node-modules-structure-8ab301ddaed3b7530858b233f5b3be57.jpg)

## pnpm å®‰è£…ä¸ä½¿ç”¨

pnpm çš„å®‰è£…å’Œä½¿ç”¨ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå…·ä½“å‘½ä»¤å¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://pnpm.js.org/zh/cli/add):

```SHELL
# å®‰è£…åŠæ›´æ–°
npm install -g pnpm
# ä¸€æ—¦ä½ å®‰è£…äº† pnpmï¼Œå°±æ— éœ€å†ä½¿ç”¨å…¶ä»–è½¯ä»¶åŒ…ç®¡ç†å™¨è¿›è¡Œå‡çº§ã€‚ ä½ å¯ä»¥ä½¿ç”¨ pnpm å‡çº§è‡ªå·±
pnpm add -g pnpm

## å®‰è£…ä¾èµ– add
pnpm install
pnpm add express
pnpm add -D express # devDependencies

## æ›´æ–°ä¾èµ– update
pnpm up
pnpm up --latest
pnpm up foo@2
pnpm up "@babel/*" # Updates all dependencies under the @babel scope

# ç±»ä¼¼äº npx
pnpx create-react-app my-project
```

## Benchmark å¤§ä¹±æ–—

| æ“ä½œ        |   cache   | lockfile | node_modules | npm | pnpm | yarn | yarnPnP |
| ------------ | ------- | --- | --- | --- | --- | --- | --- |
| install |  |  |  | 51s | 14.4s | 39.1s | 29.1s |
| install | âœ” | âœ” | âœ” | 5.4s | 1.3s | 707ms | n/a |
| install | âœ” | âœ” |  | 10.9s | 3.9s | 11s | 1.8s |
| install | âœ” |  |  | 33.4s | 6.5s | 26.5s | 17.2s |
| install |  | âœ” |  | 28.3s | 11.8s | 23.3s | 14.2s |
| install | âœ” |  | âœ” | 4.6s | 1.7s | 22.1s | n/a |
| install |  | âœ” | âœ” | 6.5s | 1.3s | 713ms | n/a |
| install |  |  | âœ” | 6.1s | 5.4s | 41.1s | n/a |
| update | n/a | n/a | n/a | 5.1s | 10.7s | 35.4s | 28.3s |

> å‚ä¸å®éªŒçš„åŒ…åŒ…ä»¬[ä¼ é€é—¨](https://github.com/pnpm/benchmarks-of-javascript-package-managers/blob/main/fixtures/alotta-files/package.json) ğŸ‘ˆ

ä¸€äº›æ“ä½œçš„æè¿°:

1. clean install - How long it takes to run a totally fresh install: no lockfile present, no packages in the cache, no node_modules folder.
2. with cache, with lockfile, with node_modules - After the first install is done, the install command is run again.
3. with cache, with lockfile - When a repo is fetched by a developer and installation is first run.
4. with cache - Same as the one above, but the package manager doesn't have a lockfile to work from.
5. with lockfile - When an installation runs on a CI server.
6. with cache, with node_modules - The lockfile is deleted and the install command is run again.
7. with node_modules, with lockfile - The package cache is deleted and the install command is run again.
8. with node_modules - The package cache and the lockfile is deleted and the install command is run again.
9. update - Updating your dependencies by changing the version in the package.json and running the install command again.

![benchmark](https://camo.githubusercontent.com/62e3ddc800e2764a97e8fe09c986e78b251e633010bee5646cd99a9c407a5cef/68747470733a2f2f63646e2e7261776769742e636f6d2f706e706d2f62656e63686d61726b732d6f662d6a6176617363726970742d7061636b6167652d6d616e61676572732f343332393239362f726573756c74732f696d67732f616c6f7474612d66696c65732e737667)

## yarn PnP

å¯¹äº npm å’Œ yarn å®‰è£…ä¾èµ–è€Œè¨€ï¼Œä¸€èˆ¬ä¼šéµå¾ªä»¥ä¸‹å‡ ä¸ªæ­¥éª¤:

1. å°†ä¾èµ–åŒ…çš„ç‰ˆæœ¬åŒºé—´è§£æä¸ºæŸä¸ªå…·ä½“çš„ç‰ˆæœ¬å·
1. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬ä¾èµ–çš„ tar åŒ…åˆ°æœ¬åœ°ç¦»çº¿é•œåƒ
1. å°†ä¾èµ–ä»ç¦»çº¿é•œåƒè§£å‹åˆ°æœ¬åœ°ç¼“å­˜
1. å°†ä¾èµ–ä»ç¼“å­˜æ‹·è´åˆ°å½“å‰ç›®å½•çš„ node_modules ç›®å½•

å…¶ä¸­ç¬¬ 4 æ­¥æ¶‰åŠå¤§é‡çš„æ–‡ä»¶ I/Oï¼Œå¯¼è‡´å®‰è£…ä¾èµ–æ—¶æ•ˆç‡ä¸é«˜ã€‚ç„¶å Node æŒ‰ç…§å®ƒçš„æ¨¡å—æŸ¥æ‰¾è§„åˆ™åœ¨ node_modules ç›®å½•ä¸­æŸ¥æ‰¾ã€‚ä½†å®é™…ä¸Š Node å¹¶ä¸çŸ¥é“è¿™ä¸ªæ¨¡å—æ˜¯ä»€ä¹ˆ, å®ƒåœ¨ node_modules æŸ¥æ‰¾, æ²¡æ‰¾åˆ°å°±åœ¨çˆ¶ç›®å½•çš„ node_modules æŸ¥æ‰¾, ä»¥æ­¤ç±»æ¨ï¼Œè¿™ä¸ªæ•ˆç‡æ˜¯éå¸¸ä½ä¸‹çš„ã€‚

ä½†æ˜¯ Yarn ä½œä¸ºä¸€ä¸ªåŒ…ç®¡ç†å™¨, å®ƒçŸ¥é“ä½ çš„é¡¹ç›®çš„ä¾èµ–æ ‘ï¼Œé‚£èƒ½ä¸èƒ½è®© Yarn å‘Šè¯‰ Node? è®©å®ƒç›´æ¥åˆ°æŸä¸ªç›®å½•å»åŠ è½½æ¨¡å—ã€‚è¿™æ ·å³å¯ä»¥æé«˜ Node æ¨¡å—çš„æŸ¥æ‰¾æ•ˆç‡, ä¹Ÿå¯ä»¥å‡å°‘ node_modules æ–‡ä»¶çš„æ‹·è´ï¼Œè¿™å°±æ˜¯ [**Plug'n'Play**](https://classic.yarnpkg.com/en/docs/pnp) å³æ’å³ç”¨çš„åŸºæœ¬åŸç†ã€‚Yarn ä¼šç»´æŠ¤ä¸€å¼ é™æ€æ˜ å°„è¡¨ï¼Œè¯¥è¡¨ä¸­åŒ…å«äº†ä»¥ä¸‹ä¿¡æ¯:

1. å½“å‰ä¾èµ–æ ‘ä¸­åŒ…å«äº†å“ªäº›ä¾èµ–åŒ…çš„å“ªäº›ç‰ˆæœ¬
1. è¿™äº›ä¾èµ–åŒ…æ˜¯å¦‚ä½•äº’ç›¸å…³è”çš„
1. è¿™äº›ä¾èµ–åŒ…åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å…·ä½“ä½ç½®

è¿™ä¸ªæ˜ å°„è¡¨çš„å®ç°åˆ™å¯¹åº”é¡¹ç›®ç›®å½•ä¸­çš„ `.pnp.js` æ–‡ä»¶ï¼Œåœ¨å®‰è£…ä¾èµ–æ—¶ï¼Œåœ¨ç¬¬ 3 æ­¥å®Œæˆä¹‹åï¼ŒYarn å¹¶ä¸ä¼šæ‹·è´ä¾èµ–åˆ° node_modules ç›®å½•ï¼Œè€Œæ˜¯ä¼šåœ¨ `.pnp.js` ä¸­è®°å½•ä¸‹è¯¥ä¾èµ–åœ¨ç¼“å­˜ä¸­çš„å…·ä½“ä½ç½®ã€‚è¿™æ ·å°±é¿å…äº†å¤§é‡çš„ I/O æ“ä½œåŒæ—¶é¡¹ç›®ç›®å½•ä¹Ÿä¸ä¼šæœ‰ node_modules ç›®å½•ç”Ÿæˆã€‚åŒæ—¶ `.pnp.js` è¿˜åŒ…å«äº†ä¸€ä¸ªç‰¹æ®Šçš„ **resolver**ï¼ŒYarn ä¼šåˆ©ç”¨è¿™ä¸ªç‰¹æ®Šçš„ resolver æ¥å¤„ç† require() è¯·æ±‚ï¼Œè¯¥ resolver ä¼šæ ¹æ® `.pnp.js` æ–‡ä»¶ä¸­åŒ…å«çš„é™æ€æ˜ å°„è¡¨ç›´æ¥ç¡®å®šä¾èµ–åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å…·ä½“ä½ç½®ã€‚

> éœ€è¦ç•™æ„çš„æ˜¯ `.pnp.js` è¦æ·»åŠ åˆ° `.gitignore`

è¿™é‡Œå†ä»‹ç»ä¸€ä¸‹ä¿®æ”¹ node_modules ç›®å½•ä¸‹ä¾èµ–æ¥è¿›è¡Œè°ƒè¯•çš„åœºæ™¯ï¼Œå¾ˆæ˜¾ç„¶åœ¨ pnp æ¨¡å¼ä¸‹æ˜¯æ²¡æœ‰ node_modules çš„ï¼Œä½†æ˜¯ Yarn æä¾›äº† `yarn unplug packageName` æ¥å°†æŸä¸ªæŒ‡å®šä¾èµ–æ‹·è´åˆ°é¡¹ç›®ä¸­çš„ `.pnp/unplugged` ç›®å½•ä¸‹ã€‚ä¹‹å `.pnp.js` ä¸­çš„ resolver å°±ä¼šè‡ªåŠ¨åŠ è½½è¿™ä¸ª unplug çš„ç‰ˆæœ¬ã€‚è°ƒè¯•å®Œæ¯•åï¼Œå†æ‰§è¡Œ `yarn unplug --clear packageName` å³å¯ç§»é™¤æœ¬åœ°çš„å¯¹åº”ä¾èµ–ã€‚

ç›®å‰ pnp åœ¨ä½¿ç”¨ä¸Šè¿˜æœ‰ä¸€å®šé£é™©ï¼Œéœ€è¦æœ‰è‰¯å¥½çš„é›†æˆï¼Œæ— éå°±æ˜¯é‡æ–°å®ç°ç°æœ‰å·¥å…·çš„æ¨¡å—æŸ¥æ‰¾æœºåˆ¶ã€‚æ¯”å¦‚ Webpack ä½¿ç”¨çš„æ¨¡å—æŸ¥æ‰¾å™¨æ˜¯ enhanced-resolve, å¯ä»¥é€šè¿‡ [pnp-webpack-plugin](https://github.com/arcanis/pnp-webpack-plugin) æ’ä»¶æ¥è¿›è¡Œæ‰©å±•:

```JS
const PnpWebpackPlugin = require(`pnp-webpack-plugin`)

module.exports = {
  resolve: {
    plugins: [
      PnpWebpackPlugin,
    ],
  },
  resolveLoader: {
    plugins: [
      PnpWebpackPlugin.moduleLoader(module),
    ],
  },
}
```

å¼€å¯ pnp çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œåœ¨ package.json ä¸­é…ç½®æˆ–è€…ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œ:

```JSON
// package.json
// ä¹‹åè¿è¡Œ yarn install å³å¯ç”Ÿæˆ .pnp.js
{
  "installConfig": {
    "pnp": true
  }
}
```

```SHELL
# ä¹Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä¸Šè¿° installConfig é…ç½®
yarn --pnp
```

## ä¸ºä»€ä¹ˆåˆ›å»ºéæ‰å¹³åŒ–çš„ node_modules

![node_modules](https://miro.medium.com/max/4096/1*zQqMzqeJN_bsMXDSTxh1sQ.png)

é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹ npm å’Œ yarn æ˜¯æ€ä¹ˆç®¡ç†ä¾èµ–çš„ï¼Œåœ¨ npm@3 ä¹‹å‰ï¼Œnode_modules çš„ç»“æ„æ˜¯å¾ˆæ¸…æ™°çš„:

```TEXT
node_modules
â””â”€ foo
   â”œâ”€ index.js
   â”œâ”€ package.json
   â””â”€ node_modules
      â””â”€ bar
         â”œâ”€ index.js
         â””â”€ package.json
```

ä½†æ˜¯è¿™æ ·ä¼šå­˜åœ¨ä¸¤ä¸ªä¸¥é‡çš„é—®é¢˜:

1. ä¾èµ–å±‚çº§å¤ªæ·±ï¼Œä¼šå¯¼è‡´æ–‡ä»¶è·¯å¾„è¿‡é•¿çš„é—®é¢˜ï¼Œå°¤å…¶åœ¨ window ç³»ç»Ÿä¸‹ã€‚å¤§é‡é‡å¤çš„åŒ…è¢«å®‰è£…ï¼Œæ–‡ä»¶ä½“ç§¯è¶…çº§å¤§ã€‚æ¯”å¦‚è·Ÿ foo åŒçº§ç›®å½•ä¸‹æœ‰ä¸€ä¸ª bazï¼Œä¸¤è€…éƒ½ä¾èµ–äºåŒä¸€ä¸ªç‰ˆæœ¬çš„ lodashï¼Œé‚£ä¹ˆ lodash ä¼šåˆ†åˆ«åœ¨ä¸¤è€…çš„ node_modules ä¸­è¢«å®‰è£…ï¼Œä¹Ÿå°±æ˜¯é‡å¤å®‰è£…ã€‚
2. æ¨¡å—å®ä¾‹ä¸èƒ½å…±äº«ã€‚æ¯”å¦‚ React æœ‰ä¸€äº›å†…éƒ¨å˜é‡ï¼Œåœ¨ä¸¤ä¸ªä¸åŒåŒ…å¼•å…¥çš„ React ä¸æ˜¯åŒä¸€ä¸ªæ¨¡å—å®ä¾‹ï¼Œå› æ­¤æ— æ³•å…±äº«å†…éƒ¨å˜é‡ï¼Œå¯¼è‡´ä¸€äº›ä¸å¯é¢„çŸ¥çš„ bugã€‚

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œä» npm3 å¼€å§‹ï¼ŒåŒ…æ‹¬ yarnï¼Œéƒ½ç€æ‰‹æ¥é€šè¿‡æ‰å¹³åŒ–ä¾èµ–çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜:

```TEXT
node_modules
â”œâ”€ foo
|  â”œâ”€ index.js
|  â””â”€ package.json
â””â”€ bar
   â”œâ”€ index.js
   â””â”€ package.json
```

è¿™æ ·çœ‹æ¥ä¸å†æœ‰å¾ˆæ·±å±‚æ¬¡çš„åµŒå¥—å…³ç³»ã€‚å®‰è£…æ–°çš„åŒ…æ—¶ï¼Œæ ¹æ® node require æœºåˆ¶ï¼Œä¼šä¸åœå¾€ä¸Šçº§çš„ node_modules å½“ä¸­å»æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°ç›¸åŒç‰ˆæœ¬çš„åŒ…å°±ä¸ä¼šé‡æ–°å®‰è£…ï¼Œè§£å†³äº†å¤§é‡åŒ…é‡å¤å®‰è£…çš„é—®é¢˜ï¼Œè€Œä¸”ä¾èµ–å±‚çº§ä¹Ÿä¸ä¼šå¤ªæ·±ã€‚ä¹‹å‰çš„é—®é¢˜æ˜¯è§£å†³äº†ï¼Œä½†ä»”ç»†æƒ³æƒ³è¿™ç§æ‰å¹³åŒ–çš„å¤„ç†æ–¹å¼ï¼Œå®ƒçœŸçš„å°±æ˜¯æ— æ‡ˆå¯å‡»å—ï¼Ÿå¹¶ä¸æ˜¯ã€‚å®ƒç…§æ ·å­˜åœ¨è¯¸å¤šé—®é¢˜ï¼Œæ¢³ç†ä¸€ä¸‹:

1. ä¾èµ–ç»“æ„çš„ä¸ç¡®å®šæ€§
2. æ‰å¹³åŒ–ç®—æ³•æœ¬èº«çš„å¤æ‚æ€§å¾ˆé«˜ï¼Œè€—æ—¶è¾ƒé•¿
3. é¡¹ç›®ä¸­ä»ç„¶å¯ä»¥éæ³•è®¿é—®æ²¡æœ‰å£°æ˜è¿‡ä¾èµ–çš„åŒ…

æ¯”å¦‚ foo å’Œ bar éƒ½ä¾èµ–äº aï¼Œä½†æ˜¯ä¸¤è€…ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå‰è€…ä¸º a@1.0.0ï¼Œè€Œåè€…ä¸º a@1.1.0ã€‚é‚£ä¹ˆåœ¨æ‰“å¹³çš„è¿‡ç¨‹ä¸­ï¼Œä¾èµ–çš„ç»“æ„å¹¶ä¸æ˜¯ç¡®å®šçš„ï¼Œå’Œ package.json ä¸­ä¾èµ–ç”³è¯·çš„å…ˆåé¡ºåºä¹Ÿæœ‰å…³ï¼Œè¿™ä¹Ÿæ˜¯é”æ–‡ä»¶è¯ç”Ÿçš„åŸå› ï¼Œå³åªè¦ä½ ç›®å½•ä¸‹æœ‰ lock æ–‡ä»¶ï¼Œé‚£ä¹ˆä½ æ¯æ¬¡æ‰§è¡Œ `npm install` åç”Ÿæˆçš„ node_modules ç›®å½•ç»“æ„ä¸€å®šæ˜¯å®Œå…¨ç›¸åŒçš„ã€‚

> `package-lock.json` ä¸­åŒæ—¶å·²ç»ç¼“å­˜äº†æ¯ä¸ªåŒ…çš„å…·ä½“ç‰ˆæœ¬å’Œä¸‹è½½é“¾æ¥ï¼Œä¸éœ€è¦å†å»è¿œç¨‹ä»“åº“è¿›è¡ŒæŸ¥è¯¢ï¼Œç„¶åç›´æ¥è¿›å…¥æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒç¯èŠ‚ï¼Œå³æ ¡éªŒ hash å€¼ï¼Œå‡å°‘äº†å¤§é‡ç½‘ç»œè¯·æ±‚

pnpm åˆ™æ˜¯åœ¨ npm@2 çš„åŸºç¡€ä¸Šå°è¯•å»åšæ”¹å˜ï¼Œæ‰€æœ‰çš„åŒ…ä¼šæŠŠä»–ä»¬çš„ä¾èµ–ç»„åˆåˆ°ä¸€èµ·ï¼Œä½†æ˜¯å±‚çº§ä¸ä¼šåƒ npm ä¸€æ ·å¤ªæ·±ï¼Œå› ä¸º pnpm ä¼šé€šè¿‡ symlinks è½¯é“¾æ¥æ¥è¿›è¡Œç»„åˆï¼Œæ¡ˆä¾‹å¯ä»¥[å‚è€ƒè¿™é‡Œ](https://github.com/pnpm/sample-project):

```TEXT
-> - a symlink (or junction on Windows)

node_modules
â”œâ”€ foo -> .pnpm/foo/1.0.0/node_modules/foo
â””â”€ .pnpm
   â”œâ”€ foo/1.0.0/node_modules
   |  â”œâ”€ bar -> ../../bar/2.0.0/node_modules/bar
   |  â””â”€ foo
   |     â”œâ”€ index.js
   |     â””â”€ package.json
   â””â”€ bar/2.0.0/node_modules
      â””â”€ bar
         â”œâ”€ index.js
```

é€šè¿‡æŸ¥çœ‹æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å¯èƒ½è§‰å¾—ç»“æ„ä¼šæ¯”è¾ƒå¤æ‚ï¼Œä½†å¯¹äºå¤§å‹é¡¹ç›®è€Œè¨€ï¼Œå…¶ç»“æ„çœ‹èµ·æ¥æ¯” npm åˆ›å»ºçš„ç»“æ„æ›´å¥½ã€‚é¦–å…ˆï¼Œnode_modules æ ¹ç›®å½•ä¸­çš„è½¯ä»¶åŒ…åªæ˜¯ä¸€ä¸ª symlink ç¬¦å·é“¾æ¥ï¼ŒNode.js ä¼šå¿½ç•¥å®ƒå¹¶æ‰§è¡ŒçœŸæ­£è·¯å¾„ä¸‹çš„æ–‡ä»¶ã€‚ å› æ­¤ requireï¼ˆ'foo'ï¼‰ å°†æ‰§è¡Œ `node_modules/.registry.npmjs.org/foo/1.0.0/node_modules/foo/index.js` ä¸­çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ `node_modules/foo/index.js` ä¸­çš„æ–‡ä»¶ã€‚

å…¶æ¬¡ï¼Œæ‰€æœ‰å·²å®‰è£…çš„è½¯ä»¶åŒ…åœ¨å…¶ç›®å½•å†…éƒ½æ²¡æœ‰å…¶è‡ªå·±çš„ node_modules æ–‡ä»¶å¤¹ï¼Œé‚£ä¹ˆ foo å¦‚ä½•å¼•å…¥ bar çš„å‘¢ï¼Ÿè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹åŒ…å« foo åŒ…çš„æ–‡ä»¶å¤¹ç»“æ„:

```TEXT
node_modules/.pnpm/foo/1.0.0/node_modules
â”œâ”€ bar -> ../../bar/2.0.0/node_modules/bar
â””â”€ foo
   â”œâ”€ index.js
   â””â”€ package.json
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° foo çš„ä¾èµ–é¡¹ bar å·²å®‰è£…ï¼Œä½†ç›®å½•ç»“æ„ä¸­çš„ä¾èµ–é¡¹æ˜¯ä¸Šä¸€çº§çš„ã€‚è¿™ä¸¤ä¸ªè½¯ä»¶åŒ…éƒ½åœ¨ä¸€ä¸ªåä¸º node_modules çš„æ–‡ä»¶å¤¹ä¸­ï¼Œé‚£ä¹ˆä¾ç„¶æ ¹æ® node require æœºåˆ¶ï¼Œä¼šä¸åœå¾€ä¸Šçº§çš„ node_modules å½“ä¸­å»æ‰¾ï¼Œå½“ç„¶å¯ä»¥æ‰¾åˆ° barã€‚å¥½å®¶ä¼™ï¼Œ.pnpm ç›®å½•è¿™é‡Œå…¶å®è¿˜æ˜¯åšäº†æ‰å¹³åŒ–å¤„ç†ï¼Œå–å…¶ç²¾åï¼Œè¿™æ ·å­ä¹‹åï¼Œåœ¨æ•´ä¸ª node_modules æ–‡ä»¶ç»“æ„æ¥çœ‹å°±ååˆ†æ¸…æ™°äº†ã€‚

æˆ‘ä»¬æœ€ç»ˆä¸å¦¨è¿˜æ˜¯ä»¥å®‰è£… express ä¸ºä¾‹ï¼Œnode_modules çš„ç»“æ„å¯¹æ¯”å¦‚ä¸‹:

```TEXT
<!-- npm -->
.bin
accepts
array-flatten
body-parser
bytes
content-disposition
cookie-signature
cookie
debug
depd
destroy
ee-first
encodeurl
escape-html
etag
express
```

```TEXT
<!-- pnpm -->
.pnpm
.modules.yaml
express
```

## æ‰å¹³åŒ–æ€ä¹ˆå¤„ç†ä¸åŒç‰ˆæœ¬çš„ä¾èµ–

è§„åˆ™ï¼š**å½“å®‰è£…åˆ°ç›¸åŒæ¨¡å—æ—¶ï¼Œåˆ¤æ–­å·²å®‰è£…çš„æ¨¡å—ç‰ˆæœ¬æ˜¯å¦ç¬¦åˆæ–°æ¨¡å—çš„ç‰ˆæœ¬èŒƒå›´ï¼Œå¦‚æœç¬¦åˆåˆ™è·³è¿‡ï¼Œä¸ç¬¦åˆåˆ™åœ¨å½“å‰æ¨¡å—çš„ node_modules ä¸‹å®‰è£…è¯¥æ¨¡å—ã€‚**ã€‚ä»¥ä¸‹é¢çš„ base64-js ä¸ºä¾‹å­ï¼š

![pnpm-node-modules]( {{site.url}}/style/images/smms/pnpm-node-modules.webp )

> å¦‚æœå­˜åœ¨å¤šä¸ªä¸åŒç‰ˆæœ¬çš„å­ä¾èµ–ï¼Œ**å“ªä¸ªç‰ˆæœ¬æ‰“å¹³åœ¨æ ¹ç›®å½•åˆ™å¯èƒ½å–å†³äº package.json çš„æ”¾ç½®é¡ºåº**ã€‚å…ˆæ”¾ç½®çš„ä¼šæå–åˆ°æ ¹ç›®å½•ä¸‹ï¼Œåæ”¾ç½®çš„åˆ™åªèƒ½åœ¨å½“å‰æ¨¡å—ä¸‹å®‰è£…ã€‚

## ä¸€äº›å®‰å…¨é—®é¢˜

pnpm é‡‡ç”¨äº† npm@2 é‚£ä¸€å¥—ä¾èµ–ç®¡ç†æœºåˆ¶ï¼Œå…¶å®ä¹Ÿè§„é¿äº†éæ³•è®¿é—®ä¾èµ–çš„é—®é¢˜ã€‚ä¸å¦¨æ¥ä¸¾ä¸€äº›ä¾‹å­:

åœºæ™¯ä¸€ï¼šå¦‚æœ A ä¾èµ– Bï¼Œ B ä¾èµ– Cï¼Œé‚£ä¹ˆ A å°±ç®—æ²¡æœ‰å£°æ˜ C çš„ä¾èµ–ï¼Œä½†æ˜¯ C è¢«æ‰“å¹³åˆ°äº† A çš„ node_modules é‡Œé¢ï¼Œé‚£æˆ‘åœ¨ A é‡Œé¢è¿˜æ˜¯å¯ä»¥å¼•ç”¨ Cï¼Œé‚£è¿™æ ·ä¼šæœ‰å•¥å®‰å…¨é—®é¢˜å‘¢ï¼Ÿ

1. ä½ è¦çŸ¥é“ B çš„ç‰ˆæœ¬æ˜¯å¯èƒ½éšæ—¶å˜åŒ–çš„ï¼Œå‡å¦‚ä¹‹å‰ä¾èµ–çš„æ˜¯ C@1.0.1ï¼Œç°åœ¨å‘äº†æ–°ç‰ˆï¼Œæ–°ç‰ˆæœ¬çš„ B ä¾èµ– C@2.0.1ï¼Œé‚£ä¹ˆåœ¨é¡¹ç›® A å½“ä¸­ npm/yarn install ä¹‹åï¼Œè£…ä¸Šçš„æ˜¯ 2.0.1 ç‰ˆæœ¬çš„ Cï¼Œè€Œ A å½“ä¸­ç”¨çš„è¿˜æ˜¯ C å½“ä¸­æ—§ç‰ˆçš„ APIï¼Œå¯èƒ½å°±ç›´æ¥æŠ¥é”™äº†
2. å¦‚æœ B æ›´æ–°ä¹‹åï¼Œå¯èƒ½ä¸éœ€è¦ C äº†ï¼Œé‚£ä¹ˆå®‰è£…ä¾èµ–çš„æ—¶å€™ï¼ŒC éƒ½ä¸ä¼šè£…åˆ° node_modules é‡Œé¢ï¼ŒA å½“ä¸­å¼•ç”¨ C çš„ä»£ç ç›´æ¥æŠ¥é”™

åœºæ™¯äºŒï¼šåœ¨ monorepo é¡¹ç›®ä¸­ï¼Œå¦‚æœ A ä¾èµ– Xï¼ŒB ä¾èµ– Xï¼Œè¿˜æœ‰ä¸€ä¸ª Cï¼Œå®ƒä¸ä¾èµ– Xï¼Œä½†å®ƒä»£ç é‡Œé¢ç”¨åˆ°äº† Xã€‚ç”±äºä¾èµ–æå‡çš„å­˜åœ¨ï¼Œnpm/yarn ä¼šæŠŠ X æ”¾åˆ°æ ¹ç›®å½•çš„ node_modules ä¸­ï¼Œè¿™æ · C åœ¨æœ¬åœ°æ˜¯èƒ½å¤Ÿè·‘èµ·æ¥çš„ï¼Œå› ä¸ºæ ¹æ® node çš„åŒ…åŠ è½½æœºåˆ¶ï¼Œå®ƒèƒ½å¤ŸåŠ è½½åˆ° monorepo é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ node_modules ä¸­çš„ Xã€‚ä½†è¯•æƒ³ä¸€ä¸‹ï¼Œä¸€æ—¦ C å•ç‹¬å‘åŒ…å‡ºå»ï¼Œç”¨æˆ·å•ç‹¬å®‰è£… Cï¼Œé‚£ä¹ˆå°±æ‰¾ä¸åˆ° X äº†ï¼Œæ‰§è¡Œåˆ°å¼•ç”¨ X çš„ä»£ç æ—¶å°±ç›´æ¥æŠ¥é”™äº†ã€‚

è¿™äº›éƒ½æ˜¯ä¾èµ–æå‡æ½œåœ¨çš„ bugã€‚å¦‚æœæ˜¯è‡ªå·±çš„ä¸šåŠ¡ä»£ç è¿˜å¥½ï¼Œè¯•æƒ³ä¸€ä¸‹å¦‚æœæ˜¯ç»™å¾ˆå¤šå¼€å‘è€…ç”¨çš„å·¥å…·åŒ…ï¼Œé‚£å±å®³å°±éå¸¸ä¸¥é‡äº†ã€‚npm ä¹Ÿæœ‰æƒ³è¿‡å»è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒæŒ‡å®š `--global-style` å‚æ•°å³å¯ç¦æ­¢å˜é‡æå‡ï¼Œä½†è¿™æ ·åšç›¸å½“äºå›åˆ°äº†å½“å¹´åµŒå¥—ä¾èµ–çš„æ—¶ä»£ï¼Œä¸€å¤œå›åˆ°è§£æ”¾å‰ï¼Œå‰é¢æåˆ°çš„åµŒå¥—ä¾èµ–çš„ç¼ºç‚¹ä»ç„¶æš´éœ²æ— é—ã€‚

npm/yarn æœ¬èº«å»è§£å†³ä¾èµ–æå‡çš„é—®é¢˜è²Œä¼¼å¾ˆéš¾å®Œæˆï¼Œä¸è¿‡ç¤¾åŒºé’ˆå¯¹è¿™ä¸ªé—®é¢˜ä¹Ÿå·²ç»æœ‰ç‰¹å®šçš„è§£å†³æ–¹æ¡ˆ: [dependency-check](https://github.com/dependency-check-team/dependency-check)ï¼Œä½†ä¸å¯å¦è®¤çš„æ˜¯ï¼Œpnpm åšçš„æ›´åŠ å½»åº•ï¼Œç‹¬åˆ›çš„ä¸€å¥—ä¾èµ–ç®¡ç†æ–¹å¼ä¸ä»…è§£å†³äº†ä¾èµ–æå‡çš„å®‰å…¨é—®é¢˜ï¼Œè¿˜å¤§å¤§ä¼˜åŒ–äº†æ—¶é—´å’Œç©ºé—´ä¸Šçš„æ€§èƒ½ã€‚

## Monorepo vs Multirepo

**multirepo** æ˜¯æˆ‘ä»¬ç›®å‰é‡‡ç”¨æœ€é¢‘ç¹çš„é¡¹ç›®ç»“æ„ï¼Œé’ˆå¯¹äºä¸åŒä¸šåŠ¡æ¨¡å—æˆ–åŠŸèƒ½ä¼šæ‹†åˆ†æˆå¤šä¸ªé¡¹ç›®è¿›è¡Œç®¡ç†ã€‚ä½†æ˜¯å¯¹äºä¸€äº›å¼€æºé¡¹ç›®æˆ–è€…å·¥å…·åº“ï¼Œ**monorepo** æ˜¾ç„¶æ˜¯ä¸€ç§æ¯”è¾ƒå¥½çš„é¡¹ç›®ç®¡ç†æ–¹å¼ï¼Œå³æŠŠæ‰€æœ‰çš„ç›¸å…³é¡¹ç›®éƒ½æ”¾åœ¨ä¸€ä¸ªä»“åº“ä¸­ã€‚ä¸šç•Œä¸­æœ‰å¾ˆå¤šä¼˜ç§€æ¡ˆä¾‹å¯ä»¥å‚è€ƒï¼Œæ¯”å¦‚ [react-router](https://github.com/ReactTraining/react-router/tree/master/packages)ã€[babel](https://github.com/babel/babel/tree/main/packages) ã€[Jest](https://github.com/facebook/jest/tree/master/packages)ç­‰:

```TEXT
package.json
packages
â”œâ”€ react-router-config
|  â”œâ”€ index.js
|  â””â”€ package.json
â”œâ”€ react-router-dom
|  â”œâ”€ index.js
|  â””â”€ package.json
â”œâ”€ react-router-native
|  â”œâ”€ index.js
|  â””â”€ package.json
â””â”€ react-router
   â”œâ”€ index.js
   â””â”€ package.json
```

è¦æ˜¯ç”¨ monorepo ä»ç„¶è¦é¢ä¸´ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚:

1. é¡¹ç›®è¶Šæ¥è¶Šåºå¤§ï¼Œå¯¹äºç‰ˆæœ¬æ§åˆ¶æŠ€æœ¯ä¼šæœ‰å¾ˆå¤§çš„æŒ‘æˆ˜ã€‚å› ä¸º Git ç¤¾åŒºå»ºè®®çš„æ˜¯ä½¿ç”¨æ›´å¤šæ›´å°çš„ä»£ç åº“ï¼ŒGit æœ¬èº«å¹¶ä¸é€‚åˆå•ä¸ªå·¨å¤§çš„ä»£ç åº“
2. å› ä¸ºæ‰€æœ‰çš„ä»£ç éƒ½æ”¾åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥ä½ éœ€è¦æ—¶åˆ»ä¿æŒè­¦æƒ•ï¼Œä»¥ä¿æŒè‰¯å¥½çš„é¡¹ç›®ç»“æ„å’Œæäº¤æµ‹è¯•
3. ä¸é€‚åˆé¡¹ç›®æƒé™çš„åˆ†é…

### lerna init

åœ¨ç®¡ç† monorepo é¡¹ç›®æ—¶ï¼Œè¿™é‡Œæ¨èä½¿ç”¨ [**lerna**](https://github.com/lerna/lerna)ã€‚å®ƒæ˜¯ä¸€ç§å·¥å…·ï¼Œå¯ä»¥ä¼˜åŒ–ä½¿ç”¨ git å’Œ npm ç®¡ç†å¤šåŒ…å­˜å‚¨åº“çš„å·¥ä½œæµç¨‹ï¼›è¿˜å¯ä»¥å‡å°‘å¼€å‘å’Œæ„å»ºç¯å¢ƒä¸­å¤§é‡è½¯ä»¶åŒ…å‰¯æœ¬çš„æ—¶é—´å’Œç©ºé—´è¦æ±‚ï¼Œè¿™é€šå¸¸æ˜¯å°†é¡¹ç›®åˆ†æˆè®¸å¤šå•ç‹¬çš„ npm è½¯ä»¶åŒ…çš„ç¼ºç‚¹ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹åœ¨é¡¹ç›®ä¸­å¦‚ä½•ä½¿ç”¨:

```SHELL
# é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶å¤¹
mkdir monorepo-test && cd monorepo-test
# åˆå§‹åŒ–
lerna init
```

åˆå§‹åŒ–æ—¶ä¼šç”Ÿæˆä¸€ä¸ª `lerna.json` æ–‡ä»¶ï¼Œç»“æ„è§£è¯»å¦‚ä¸‹:

* version - é¡¹ç›®å½“å‰ç‰ˆæœ¬å·ï¼Œç‹¬ç«‹(independent)æ¨¡å¼ä¸‹å€¼ä¸º independent
* npmClient - ç”¨äºæŒ‡å®šè¦è¿è¡Œå‘½ä»¤çš„ç‰¹å®šå®¢æˆ·ç«¯ï¼Œæ¯”å¦‚ yarn
* command.publish.ignoreChanges - lerna changed/publish å¿½ç•¥çš„æ–‡ä»¶æ”¹åŠ¨ï¼Œæ¯”å¦‚ README.md
* command.publish.message - å‘å¸ƒçš„æäº¤æè¿°
* command.publish.registry - è®¾ç½®å‘å¸ƒçš„ registry
* command.bootstrap.ignore - æ‰§è¡Œ `lerna bootstrap` å¯åŠ¨æ—¶å¿½ç•¥çš„æ–‡ä»¶
* command.bootstrap.npmClientArgs - åœ¨ `lerna bootstrap` å‘½ä»¤æœŸé—´ï¼Œå°†ä½œä¸ºå‚æ•°ç›´æ¥ä¼ é€’ç»™ `npm install` çš„å­—ç¬¦ä¸²æ•°ç»„
* command.bootstrap.scope - ç”¨äºé™åˆ¶åœ¨è¿è¡Œ `lerna bootstrap` å‘½ä»¤æ—¶å°†å¼•å¯¼å“ªäº›è½¯ä»¶åŒ…
* packages - é¡¹ç›® packages ä»“åº“å­˜æ”¾çš„è·¯å¾„ï¼Œæ¨èä¸º ["packages/*"]

```JSON
// lerna.json
{
  "version": "1.1.3",
  "npmClient": "npm",
  "command": {
    "publish": {
      "ignoreChanges": ["ignored-file", "*.md"],
      "message": "chore(release): publish",
      "registry": "https://npm.pkg.github.com"
    },
    "bootstrap": {
      "ignore": "component-*",
      "npmClientArgs": ["--no-package-lock"]
    }
  },
  "packages": ["packages/*"]
}
```

```JSON
// package.json
{
  "name": "root",
  "private": true,
  "devDependencies": {
    "lerna": "^4.0.0"
  }
}
```

`lerna init` åˆå§‹åŒ–æ—¶æœ‰ä¸¤ç§æ¨¡å¼å¯ä»¥é€‰æ‹©:

* **Fixed/Locked mode** - å³æ‰€æœ‰åŒ…çš„ç‰ˆæœ¬éƒ½æ˜¯ç»Ÿä¸€çš„ï¼Œä½“ç°åœ¨ `lerna.json` çš„ version é…ç½®ä¸Šã€‚å½“è¿è¡Œ `lerna publish` æ—¶ï¼Œå¦‚æœæŸä¸ªæ¨¡å—è‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥å·²è¢«æ›´æ–°ï¼Œåˆ™å®ƒå°†è¢«æ›´æ–°ä¸ºè¦å‘å¸ƒçš„æ–°ç‰ˆæœ¬
* **independent mode** - ç‹¬ç«‹æ¨¡å¼ Lerna é¡¹ç›®å…è®¸ç»´æŠ¤è€…å½¼æ­¤ç‹¬ç«‹åœ°å¢åŠ è½¯ä»¶åŒ…çš„ç‰ˆæœ¬ã€‚æ¯æ¬¡å‘å¸ƒæ—¶ï¼Œéƒ½ä¼šæç¤ºå·²æ›´æ”¹çš„æ¯ä¸ªè½¯ä»¶åŒ…ï¼Œä»¥æŒ‡å®šæ˜¯ patch, minor, major è¿˜æ˜¯è‡ªå®šä¹‰æ›´æ”¹

è¿˜æœ‰ä¸€ç‚¹æˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ package.json çš„ private å±æ€§è¢«è®¾ç½®ä¸ºäº† `private: true`ï¼Œè¿™æ˜¯å› ä¸º monorepo æœ¬èº«çš„è¿™ä¸ª Git ä»“åº“å¹¶ä¸æ˜¯ä¸€ä¸ªé¡¹ç›®ï¼Œä»–æ˜¯å¤šä¸ªé¡¹ç›®ï¼Œæ‰€ä»¥ä»–è‡ªå·±ä¸èƒ½ç›´æ¥å‘å¸ƒï¼Œå‘å¸ƒçš„åº”è¯¥æ˜¯ `packages/` ä¸‹é¢çš„å„ä¸ªå­é¡¹ç›®ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åˆ›å»º packageï¼Œå¯ä»¥æ‰‹åŠ¨ä¹Ÿå¯ä»¥é€šè¿‡ `lerna create` åˆ›å»º:

```SHELL
lerna create packageA
```

åˆ›å»ºå®Œåï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é»˜è®¤çš„ç›®å½•å¦‚ä¸‹:

```TEXT
â””â”€â”€ packageA
   â”œâ”€â”€ __tests__
   â”œâ”€â”€ lib
   â”œâ”€â”€ package.json
   â””â”€â”€ README.md
```

> æ¯ä¸ªå­é¡¹ç›®çš„ package.json é‡Œçš„ name æ¨èè®¾ç½®ä¸º `@scope/é¡¹ç›®å` çš„æ ¼å¼ï¼Œæ¯”å¦‚ `@monorepo-test/packageA`

### lerna bootstrap

æˆ‘ä»¬å†é€šè¿‡ `create-react-app` åˆ›å»ºå¦å¤–ä¸¤ä¸ªå­é¡¹ç›®ï¼Œåˆ†åˆ«ä¸º my-app å’Œ my-app-2ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œ`packages/` ä¸‹é¢çš„æ¯ä¸ªå­é¡¹ç›®æœ‰è‡ªå·±çš„ node_modulesï¼Œå¦‚æœå°†å®ƒæ‰“å¼€ï¼Œä¼šå‘ç°å¾ˆå¤šé‡å¤çš„ä¾èµ–åŒ…ï¼Œè¿™ä¼šå ç”¨æˆ‘ä»¬å¤§é‡çš„ç¡¬ç›˜ç©ºé—´ã€‚lerna æä¾›äº†å¦ä¸€ä¸ªå¼ºå¤§çš„åŠŸèƒ½ï¼šå°†å­é¡¹ç›®çš„ä¾èµ–åŒ…éƒ½æå–åˆ°æœ€é¡¶å±‚:

```SHELL
# åˆ é™¤å·²ç»å®‰è£…çš„å­é¡¹ç›® node_modulesã€‚å¯ä»¥æ‰‹åŠ¨åˆ ï¼Œä¹Ÿå¯ä»¥ç”¨ clean å‘½ä»¤
lerna clean

lerna bootstrap --hoist
```

`lerna bootstrap` å®é™…æ‰§è¡Œçš„æ“ä½œå¦‚ä¸‹ï¼Œå®ç°æœºåˆ¶å¯ä»¥[å‚è€ƒè¿™é‡Œ](https://github.com/lerna/lerna/blob/main/doc/hoist.md):

1. npm install å®‰è£…æ¯ä¸ªè½¯ä»¶åŒ…çš„æ‰€æœ‰å¤–éƒ¨ä¾èµ–é¡¹
2. å°†æ‰€æœ‰ç›¸äº’ä¾èµ–çš„ Lerna å­é¡¹ç›®è½¯é“¾æ¥(symlink)åœ¨ä¸€èµ·
3. åœ¨æ‰€æœ‰å¼•å¯¼ç¨‹åºåŒ…ä¸­è¿è¡Œ npm run prepublishï¼ˆé™¤éä¼ é€’ --ignore-prepublishï¼‰
4. åœ¨æ‰€æœ‰å¼•å¯¼ç¨‹åºåŒ…ä¸­è¿è¡Œ npm run prepare

è¯¥å‘½ä»¤å¯ä»¥æ”¯æŒä¼ é€’å‚æ•°åˆ° npm å‘½ä»¤ä¸­ï¼Œæˆ–è€…åœ¨ `lerna.json` ä¸­çš„ `command.bootstrap.npmClientArgs` è¿›è¡Œé…ç½®:

```SHELL
lerna bootstrap -- --production --no-optional
```

> è¿™é‡Œå†æ¨èä¸€äº›å¥½ç”¨çš„ [monorepo å·¥å…·é›†åˆ](https://github.com/korfuri/awesome-monorepo) ğŸ‘ˆ

### yarn workspace vs pnpm workspace

ä¸Šè¿°æåˆ°ï¼Œ`lerna bootstrap --hoist` è™½ç„¶å¯ä»¥å°†å­é¡¹ç›®çš„ä¾èµ–æå‡åˆ°é¡¶å±‚ï¼Œä½†æ˜¯ä»–çš„æ–¹å¼æ¯”è¾ƒç²—æš´ï¼šå…ˆåœ¨æ¯ä¸ªå­é¡¹ç›®è¿è¡Œ npm installï¼Œç­‰æ‰€æœ‰ä¾èµ–éƒ½å®‰è£…å¥½åï¼Œå°†ä»–ä»¬ç§»åŠ¨åˆ°é¡¶å±‚çš„ node_modulesã€‚è¿™ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå¤šä¸ªå­é¡¹ç›®ä¾èµ–åŒä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œä½†æ˜¯ç‰ˆæœ¬ä¸åŒæ€ä¹ˆåŠï¼Ÿå®˜æ–¹çš„è§£é‡Šæ˜¯:

> **If packages depend on different versions of an external dependency, the most commonly used version will be hoisted, and a warning will be emitted.**

ä½†æ˜¯è¿™æ ·çš„åšæ³•å¾ˆæ˜æ˜¾è¿˜å­˜åœ¨é—®é¢˜ï¼Œè™½ç„¶ç»Ÿä¸€äº†ç¬¬ä¸‰æ–¹åº“çš„ç‰ˆæœ¬ï¼Œä½†æ˜¯æŸä¸ªå­é¡¹ç›®å°±æ˜¯ä½¿ç”¨çš„æ—§ç‰ˆæœ¬ api å’‹åŠï¼Œè‚¯å®šä¼šæŠ¥é”™çš„ã€‚è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ **yarn workspace** åŠŸèƒ½ï¼ŒæŒ‰ç…§å·¥ä½œåŒºé—´æ¥å†³å®šå¼•ç”¨ç¬¬ä¸‰æ–¹åº“çš„ç‰ˆæœ¬ã€‚æˆ‘ä»¬éœ€è¦ä¿®æ”¹ package.json å’Œ `lerna.json`:

```JSON
// package.json
{
  "workspaces": [
    "packages/*"
  ]
}
```

```JSON
// lerna.json
{
  "npmClient": "yarn",
  "useWorkspaces": true
}
```

ä½¿ç”¨äº† yarn workspace åï¼Œæˆ‘ä»¬å°±ä¸ç”¨ `lerna bootstrap` æ¥å®‰è£…ä¾èµ–äº†ï¼Œè€Œæ˜¯åƒä»¥å‰ä¸€æ · `yarn install` å°±è¡Œäº†ï¼Œä»–ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æå‡ä¾èµ–ï¼Œæ— è®ºåœ¨é¡¶å±‚è¿è¡Œè¿˜æ˜¯åœ¨ä»»æ„ä¸€ä¸ªå­é¡¹ç›®è¿è¡Œæ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯éšä¹‹è€Œæ¥çš„è¿˜æ˜¯ä¸€äº›å®‰å…¨é—®é¢˜ï¼Œè¯¦ç»†çš„[å¯è§ä¸Šä¸€èŠ‚](#ä¸€äº›å®‰å…¨é—®é¢˜)ã€‚

å¥½æ¶ˆæ¯æ˜¯ [**pnpm workspace**](https://pnpm.js.org/zh/workspaces/) å·²ç»å†…ç½®å®ç°å¯¹ monorepo çš„æ”¯æŒï¼Œæˆ‘ä»¬ä¸å¦¨ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾:

1. æœ‰ä¸ª monorepo é¡¹ç›®ï¼Œå­˜åœ¨ä¸¤ä¸ªå­é¡¹ç›®ï¼Œåˆ†åˆ«æ˜¯ foo å’Œ bar
2. foo ä¾èµ– is-negative@1.0.0
3. bar ä¾èµ– is-positive@1.0.0

é¦–å…ˆæˆ‘ä»¬æŒ‰ç…§ä¸Šè¿°æ­¥éª¤é…ç½® yarn workspaceï¼Œç”Ÿæˆçš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼Œå¯ä»¥[å‚è€ƒè¿™é‡Œ](https://github.com/zkochan/comparing-monorepo-node-modules/tree/master/yarn-example):

```TEXT
â”œâ”€ foo
â”œâ”€ bar
â”œâ”€ node_modules
|  â”œâ”€ is-negative
|  â””â”€ is-positive
â””â”€  package.json
```

æ˜¾è€Œæ˜“è§ï¼Œfoo å’Œ bar éƒ½èƒ½è®¿é—® is-negative å’Œ is-positiveã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ pnpm workspace çš„é…ç½®ã€‚é¦–å…ˆæˆ‘ä»¬è¦åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªç©ºçš„ `pnpm-workspace.yaml` å’Œä¸€ä¸ª `.npmrc` æ–‡ä»¶:

```TEXT
<!-- .npmrc -->
shared-workspace-shrinkwrap = true
link-workspace-packages = true
```

æ¥ä¸‹æ¥è¾“å…¥å‘½ä»¤è¡Œ `pnpm multi install` è¿›è¡Œå·¥ä½œåŒºä¾èµ–çš„å®‰è£…ã€‚ç”Ÿæˆçš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼Œå¯ä»¥[å‚è€ƒè¿™é‡Œ](https://github.com/zkochan/comparing-monorepo-node-modules/tree/master/pnpm-example):

```TEXT
â”œâ”€ foo
|  â”œâ”€ node_modules
|  | â””â”€  is-negative(symlink)
â”œâ”€ bar
|  â”œâ”€ node_modules
|  | â””â”€  is-positive(symlink)
â”œâ”€ bar
â”œâ”€ node_modules
|  â”œâ”€ .registry.npmjs.org
|  | â”œâ”€ is-negative/1.0.0/node_modules/is-negative
|  | â””â”€ is-positive/1.0.0/node_modules/is-positive
|  â”œâ”€ .modules.yaml
|  â””â”€  .shrinkwrap.yaml
â”œâ”€ .npmrc
â”œâ”€ pnpm-workspace.yaml
â””â”€  shrinkwrap.yaml
```

pnpm è¿™é‡Œå’Œ yarn ä¸€æ ·éƒ½ç”Ÿæˆäº† node_modules æ–‡ä»¶ï¼Œä½†æ˜¯ä¸ä¸€æ ·çš„æ˜¯ï¼Œè¿™é‡Œçš„ä¾èµ–éƒ½éšè—åœ¨ `.registry.npmjs.org` ä¸­ï¼Œnode çš„æŸ¥è¯¢æœºåˆ¶å°†æ— æ³•æ‰¾åˆ°ã€‚è€Œ foo çš„ node_modules ä¸‹æœ‰ä¸ª is-negative çš„è½¯é“¾æ¥ï¼ŒæŒ‡å‘ `../../node_modules/.registry.npmjs.org/is-negative/1.0.0/node_modules/is-negative`ï¼ŒåŒç† bar ä¹Ÿæ˜¯ã€‚è¿™æ ·å­ä¹Ÿè§£å†³äº† yarn workspace å¸¦æ¥çš„å®‰å…¨é—®é¢˜ã€‚

### lerna run/add

æ¥ä¸‹æ¥æˆ‘ä»¬è¦å¯åŠ¨å­é¡¹ç›®ï¼Œå¯ä»¥å»é‚£ä¸ªç›®å½•ä¸‹è¿è¡Œ `yarn start`ï¼Œä½†æ˜¯é¢‘ç¹åˆ‡æ¢æ–‡ä»¶å¤¹å®åœ¨æ˜¯å¤ªéº»çƒ¦äº†ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ lerna è¿›è¡Œå¯åŠ¨:

```SHELL
# ç›¸å½“äºå»æ¯ä¸ªå­é¡¹ç›®ä¸‹é¢éƒ½å»æ‰§è¡Œ yarn run start
lerna run [script]

# é€šè¿‡ --scope æŒ‡å®šå­é¡¹ç›®
lerna run --scope @monorepo-test/packageA test
```

å¦‚æœæˆ‘ä»¬è¦ä¸ºæŸä¸ªå­é¡¹ç›®æ·»åŠ ä¾èµ–ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨å¯¹åº” package.json æ‰‹åŠ¨æ”¹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå®ç°:

```SHELL
lerna add @a/dependence --scope @monorepo-test/packageA
```

### lerna publish

æˆ‘ä»¬æ‰§è¡Œå‘å¸ƒçš„æ—¶å€™ï¼Œå¦‚æœæ¨¡å¼é€‰æ‹©çš„æ˜¯é»˜è®¤ï¼Œåˆ™ä¼šç»™ä½ é€‰æ‹©ä¸€ä¸ªç»Ÿä¸€çš„ç‰ˆæœ¬å·ï¼›å¦‚æœæ˜¯ independent æ¨¡å¼åˆ™ä¼šåˆ†åˆ«é€‰æ‹©å­é¡¹ç›®çš„ç‰ˆæœ¬:

```SHELL
lerna publish
# info cli using local version of lerna
# lerna notice cli v4.0.0
# lerna info versioning independent
# lerna info Assuming all packages changed
# ? Select a new version for my-app-2 (currently 0.1.0) Patch (0.1.1)
# ? Select a new version for my-app (currently 0.1.0) Major (1.0.0)
```

å½“ç„¶å‰ææ˜¯æˆ‘ä»¬çš„å­é¡¹ç›®å·²ç»ç›‘æµ‹åˆ°äº†ä¿®æ”¹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤æ¥æŸ¥çœ‹:

```SHELL
lerna changed                                                                                                                           master 
# info cli using local version of lerna
# lerna notice cli v4.0.0
# lerna info versioning independent
# lerna info Looking for changed packages since my-app-2@0.1.3
# my-app-2
# lerna success found 1 package ready to publish
```

å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå­é¡¹ç›® package.json é‡Œ private è®¾ç½®ä¸º true çš„è¯ï¼Œæ˜¯æ²¡åŠæ³•å‘å¸ƒåˆ°å¯¹åº”ç§æœçš„ï¼Œä¼šæç¤º:

```TEXT
npm ERR! This package has been marked as private
npm ERR! Remove the 'private' field from the package.json to publish it.
```

å®Œæ•´çš„æ‰“å°å¦‚ä¸‹:

```SHELL
[my-app-2] lerna publish                                                                                                                           master 
# info cli using local version of lerna
# lerna notice cli v4.0.0
# lerna info versioning independent
# lerna info Looking for changed packages since my-app-2@0.1.2
# ? Select a new version for my-app-2 (currently 0.1.2) Patch (0.1.3)
# 
# Changes:
#  - my-app-2: 0.1.2 => 0.1.3
# 
# ? Are you sure you want to publish these packages? Yes
# lerna info execute Skipping releases
# lerna info git Pushing tags...
# lerna info publish Publishing packages to npm...
# lerna notice Skipping all user and access validation due to third-party registry
# lerna notice Make sure you're authenticated properly Â¯\_(ãƒ„)_/Â¯
# lerna WARN ENOLICENSE Package my-app-2 is missing a license.
# lerna WARN ENOLICENSE One way to fix this is to add a LICENSE.md file to the root of this repository.
# lerna WARN ENOLICENSE See https://choosealicense.com for additional guidance.
# lerna http fetch PUT 201 http://localhost:4873/my-app-2 68ms
# lerna success published my-app-2 0.1.3
# lerna notice 
# lerna notice ğŸ“¦  my-app-2@0.1.3
# lerna notice === Tarball Contents === 
# lerna notice 564B  src/App.css           
# lerna notice 366B  src/index.css         
# lerna notice 1.7kB public/index.html     
# lerna notice 3.9kB public/favicon.ico    
# lerna notice 532B  src/App.js            
# lerna notice 246B  src/App.test.js       
# lerna notice 500B  src/index.js          
# lerna notice 362B  src/reportWebVitals.js
# lerna notice 241B  src/setupTests.js     
# lerna notice 492B  public/manifest.json  
# lerna notice 916B  package.json          
# lerna notice 3.4kB README.md             
# lerna notice 5.3kB public/logo192.png    
# lerna notice 9.7kB public/logo512.png    
# lerna notice 2.6kB src/logo.svg          
# lerna notice 67B   public/robots.txt     
# lerna notice === Tarball Details === 
# lerna notice name:          my-app-2                                
# lerna notice version:       0.1.3                                   
# lerna notice filename:      my-app-2-0.1.3.tgz                      
# lerna notice package size:  25.1 kB                                 
# lerna notice unpacked size: 30.9 kB                                 
# lerna notice shasum:        4723436ec58197c91534699763d02ef35aa3930c
# lerna notice integrity:     sha512-losmxDXqWBxgA[...]bAud2srazQltg==
# lerna notice total files:   16                                      
# lerna notice 
# Successfully published:
#  - my-app-2@0.1.3
# lerna success published 1 package
```

> å®Œæ•´ demo å¯ä»¥[å‚è€ƒä¸‹è¿™é‡Œ](https://github.com/dennis-jiang/mono-repo-demo) ğŸ‘ˆ

### lerna version

[**lerna version**](https://github.com/lerna/lerna/tree/main/commands/version#--conventional-commits) ä¸»è¦çš„å·¥ä½œä¸ºæ ‡è¯†å‡ºåœ¨ä¸Šä¸€ä¸ª tag ç‰ˆæœ¬ä»¥æ¥æ›´æ–°çš„ monorepo packageï¼Œç„¶åä¸ºè¿™äº›åŒ… prompt å‡ºç‰ˆæœ¬ï¼Œåœ¨ç”¨æˆ·å®Œæˆé€‰æ‹©ä¹‹åä¿®æ”¹ç›¸å…³åŒ…çš„ç‰ˆæœ¬ä¿¡æ¯å¹¶ä¸”å°†ç›¸å…³çš„å˜åŠ¨ commit ç„¶åæ‰“ä¸Š tag æ¨é€åˆ° git remote:

1. Identifies packages that have been updated since the previous tagged release.
1. Prompts for a new version.
1. Modifies package metadata to reflect new release, running appropriate lifecycle scripts in root and 1. per-package.
1. Commits those changes and tags the commit.
1. Pushes to the git remote.

```shell
lerna version 1.0.1 # explicit
lerna version [major | minor | patch | premajor | preminor | prepatch | prerelease] # semver keyword
lerna version       # select from prompt(s)
```

åŒæ—¶ä¹Ÿæ”¯æŒè¯¸å¤š optionsï¼Œå…·ä½“æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://github.com/lerna/lerna/tree/main/commands/version#--conventional-commits)ï¼š

```shell
# --conventional-commits - will use the Conventional Commits Specification to determine the version bump and generate CHANGELOG.md files.
# --yes - will skip all confirmation prompts. 
lerna version --conventional-commits  --yes
```

### lifecycle scripts

Lerna will run npm lifecycle scripts during lerna version in the following order:

1. Detect changed packages, choose version bump(s)
2. Run preversion lifecycle in root
3. For each changed package, in topological order (all dependencies before dependents):
   1. Run preversion lifecycle
   2. Update version in package.json
   3. Run version lifecycle
4. Run version lifecycle in root
5. Add changed files to index, if enabled
6. Create commit and tag(s), if enabled
7. For each changed package, in lexical order (alphabetical according to directory structure):
   1. Run postversion lifecycle
8. Run postversion lifecycle in root
9. Push commit and tag(s) to remote, if enabled
10. Create release, if enabled

## å…¶ä»–ç§‘æ™®

### ç¡¬é“¾æ¥ã€è½¯é“¾æ¥ã€å¤åˆ¶

1. ç¡¬é“¾æ¥ - ç¡¬é“¾æ¥å®é™…ä¸Šæ˜¯ä¸ºæ–‡ä»¶å»ºä¸€ä¸ªåˆ«åï¼Œé“¾æ¥æ–‡ä»¶å’ŒåŸæ–‡ä»¶å®é™…ä¸Šæ˜¯åŒä¸€ä¸ªæ–‡ä»¶ã€‚é€šè¿‡ ls -i æ¥æŸ¥çœ‹çš„è¯ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶çš„ inode å·æ˜¯åŒä¸€ä¸ªï¼Œå³å±äºåŒä¸€ä¸ªæ–‡ä»¶
2. è½¯é“¾æ¥ - ç›¸å½“äºåŸæ–‡ä»¶çš„å¿«æ·æ–¹å¼ã€‚å…·ä½“ç†è§£çš„è¯ï¼Œé“¾æ¥æ–‡ä»¶å†…å­˜å‚¨çš„æ˜¯åŸæ–‡ä»¶çš„ inodeï¼Œä¹Ÿå°±æ˜¯è¯´æ˜¯ç”¨æ¥æŒ‡å‘åŸæ–‡ä»¶æ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶çš„ inode æ˜¯ä¸ä¸€æ ·çš„
3. å¤åˆ¶ - ç›¸å½“äºå°†åŸæ–‡ä»¶è¿›è¡Œä¸€ä¸ªæ‹·è´ï¼Œä¸ºå¦ä¸€ä¸ªå…¨æ–°çš„æ–‡ä»¶ã€‚ä¿®æ”¹ä»»ä½•ä¸€ä¸ªéƒ½ä¸ä¼šå½±å“å¦ä¸€ä¸ª

```SHELL
# ç¡¬é“¾æ¥
ln source source1 
# è½¯é“¾æ¥
ln -s source source1 
# å¤åˆ¶
cp source source1
```

## å‚è€ƒé“¾æ¥

1. [Flat node_modules is not the only way - pnpm](https://pnpm.js.org/blog/2020/05/27/flat-node-modules-is-not-the-only-way/) by Zoltan Kochan
2. [å…³äºç°ä»£åŒ…ç®¡ç†å™¨çš„æ·±åº¦æ€è€ƒâ€”â€”ä¸ºä»€ä¹ˆç°åœ¨æˆ‘æ›´æ¨è pnpm è€Œä¸æ˜¯ npm/yarn?](https://juejin.cn/post/6932046455733485575) by ç¥ä¸‰å…ƒ
3. [npm install åŸç†åˆ†æ](https://cloud.tencent.com/developer/article/1556014?from=article.detail.1546863) by ConardLi
4. [Yarn çš„ Plug'n'Play ç‰¹æ€§](https://loveky.github.io/2019/02/11/yarn-pnp/) by loveky
5. [Yarn Plug'n'Playå¯å¦åŠ©ä½ è„±ç¦»node_modulesè‹¦æµ·?](https://juejin.cn/post/6844903814038831118) by è’å±±
6. [ä½¿ç”¨ mono-repo å®ç°è·¨é¡¹ç›®ç»„ä»¶å…±äº«](https://www.cnblogs.com/dennisj/p/14230178.html) by _è’‹é¹é£
7. [æ·±å…¥ lerna å‘åŒ…æœºåˆ¶ â€”â€” lerna version](https://zhuanlan.zhihu.com/p/354649322) by zoomdong
