---
layout: blog
front: true
comments: True
background: green
category: å‰ç«¯
title: Vite
date: 2022-02-22 16:42:00 GMT+0800 (CST)
update: 2022-06-06 14:38:00 GMT+0800 (CST)
description: add Dependency pre-bundling
background-image: https://cn.vitejs.dev/logo.svg
---

# {{ page.title }}

## ä»€ä¹ˆæ˜¯ Vite

æ—¶è¿‡å¢ƒè¿ï¼Œæˆ‘ä»¬è§è¯äº†è¯¸å¦‚ webpackã€Rollup å’Œ Parcel ç­‰å·¥å…·çš„å˜è¿ï¼Œå®ƒä»¬æå¤§åœ°æ”¹å–„äº†å‰ç«¯å¼€å‘è€…çš„å¼€å‘ä½“éªŒã€‚ç„¶è€Œï¼Œå½“æˆ‘ä»¬å¼€å§‹æ„å»ºè¶Šæ¥è¶Šå¤§å‹çš„åº”ç”¨æ—¶ï¼Œéœ€è¦å¤„ç†çš„ JavaScript ä»£ç é‡ä¹Ÿå‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚åŒ…å«æ•°åƒä¸ªæ¨¡å—çš„å¤§å‹é¡¹ç›®ç›¸å½“æ™®éã€‚æˆ‘ä»¬å¼€å§‹é‡åˆ°æ€§èƒ½ç“¶é¢ˆ â€”â€” ä½¿ç”¨ JavaScript å¼€å‘çš„å·¥å…·é€šå¸¸éœ€è¦å¾ˆé•¿æ—¶é—´ï¼ˆç”šè‡³æ˜¯å‡ åˆ†é’Ÿï¼ï¼‰æ‰èƒ½å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼Œå³ä½¿ä½¿ç”¨ HMRï¼Œæ–‡ä»¶ä¿®æ”¹åçš„æ•ˆæœä¹Ÿéœ€è¦å‡ ç§’é’Ÿæ‰èƒ½åœ¨æµè§ˆå™¨ä¸­åæ˜ å‡ºæ¥ã€‚å¦‚æ­¤å¾ªç¯å¾€å¤ï¼Œè¿Ÿé’çš„åé¦ˆä¼šæå¤§åœ°å½±å“å¼€å‘è€…çš„å¼€å‘æ•ˆç‡å’Œå¹¸ç¦æ„Ÿã€‚

[**Vite**](https://cn.vitejs.dev/guide/) æ˜¯å°¤å¤§åœ¨æ›´æ–° vue3 ä¹‹åï¼Œå†æ¬¡å¼€å‘çš„ä¸€ä¸ªæ–°çš„æ„å»ºå·¥å…·ã€‚ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªå¼€ç®±å³ç”¨çš„`å¼€å‘æœåŠ¡å™¨ + æ‰“åŒ…å·¥å…·`çš„ç»„åˆï¼Œä½†æ˜¯æ›´è½»æ›´å¿«ã€‚Vite åˆ©ç”¨æµè§ˆå™¨[åŸç”Ÿçš„ ES Modules](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Modules)æ”¯æŒå’Œç”¨ç¼–è¯‘åˆ°åŸç”Ÿçš„è¯­è¨€å¼€å‘çš„å·¥å…·ï¼ˆå¦‚ esbuildï¼‰æ¥æä¾›ä¸€ä¸ªå¿«é€Ÿä¸”ç°ä»£çš„å¼€å‘ä½“éªŒã€‚

> æµè§ˆå™¨å¯¹äº ES Modules çš„åŸç”Ÿæ”¯æŒä½¿å¾—å¯¹äºç¬¬ä¸‰æ–¹çš„æ¨¡å—ï¼Œå¯ä»¥ä¸ç”¨ç±»ä¼¼ webpack ä¸€æ ·æ‰“åŒ…åˆå¹¶ï¼Œè€Œæ˜¯é€šè¿‡ import è¿™ç§æ–¹å¼å»å‘èµ· http è¯·æ±‚æ¥è·å–ä»£ç ã€‚è¿™ä¹Ÿæ˜¯ Vite çš„æ ¸å¿ƒæ€è·¯ã€‚**ES Modules ä¸‹é¢ç®€ç§° ESM**ã€‚

> esbuild ä½¿ç”¨ Go ç¼–å†™ï¼Œå¹¶ä¸”æ¯”ä»¥ JavaScript ç¼–å†™çš„æ‰“åŒ…å™¨é¢„æ„å»ºä¾èµ–å¿« 10-100 å€ã€‚

Vite çš„ä¸‰å¤§ç‰¹ç‚¹:

1. å¿«é€Ÿçš„å†·å¯åŠ¨åœ¨å¼€å‘é¢„è§ˆä¸­ï¼Œå®ƒæ˜¯ä¸è¿›è¡Œæ‰“åŒ…çš„
2. å³æ—¶çƒ­æ¨¡å—æ›´æ–°ï¼ˆHMRï¼ŒHot Module Replacementï¼‰
3. çœŸæ­£æŒ‰éœ€è¿›è¡ŒåŠ è½½

> **ä¸ºä»€ä¹ˆè¯´ Vite æ˜¯çœŸæ­£çš„æŒ‰éœ€åŠ è½½ï¼Ÿ**ï¼Œè™½ç„¶ webpack å¯ä»¥ç”Ÿæˆ chunkï¼Œå¹¶åœ¨åˆé€‚çš„æ—¶å€™å»åŠ è½½ import ä¸­çš„å†…å®¹ï¼Œä½†ä¸ç®¡æˆ‘ä»¬è¿™æ®µ import çš„ä»£ç ä½•æ—¶æ‰§è¡Œï¼Œæˆ‘ä»¬éƒ½éœ€è¦å¯¹å®ƒè¿›è¡Œä¸€å®šçš„æ‰“åŒ…ã€‚è€Œ Vite åªæœ‰åœ¨çœŸæ­£åŠ è½½çš„æ—¶å€™ï¼Œæµè§ˆå™¨æ‰ä¼šå‘é€è¯·æ±‚æ–‡ä»¶å†…å®¹

å½“ç„¶ç›®å‰ Vite ä¹Ÿæœ‰ä¸€å®šçš„é—®é¢˜ï¼š

1. ç”Ÿæ€è¿˜ä¸å¤Ÿå®Œå–„
2. **åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹ä»ç„¶éœ€è¦æ‰“åŒ…**ã€‚å°½ç®¡åŸç”Ÿ ESM ç°åœ¨å¾—åˆ°äº†å¹¿æ³›æ”¯æŒï¼Œä½†ç”±äºåµŒå¥—å¯¼å…¥ä¼šå¯¼è‡´é¢å¤–çš„ç½‘ç»œå¾€è¿”ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å‘å¸ƒæœªæ‰“åŒ…çš„ ESM ä»ç„¶æ•ˆç‡ä½ä¸‹ï¼ˆå³ä½¿ä½¿ç”¨ HTTP/2ï¼‰ã€‚ä¸ºäº†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è·å¾—æœ€ä½³çš„åŠ è½½æ€§èƒ½ï¼Œæœ€å¥½è¿˜æ˜¯å°†ä»£ç è¿›è¡Œ tree-shakingã€æ‡’åŠ è½½å’Œ chunk åˆ†å‰²ï¼ˆä»¥è·å¾—æ›´å¥½çš„ç¼“å­˜ï¼‰ã€‚

## webpack å·¥ä½œæµ

webpack ä¸€ç›´æ˜¯è¿‘å‡ å¹´ä¸»æµçš„æ„å»ºå·¥å…·ï¼Œå½“ webpack å¤„ç†åº”ç”¨ç¨‹åºæ—¶ï¼Œå®ƒä¼šåœ¨å†…éƒ¨æ„å»ºä¸€ä¸ªä¾èµ–å›¾(dependency graph)ï¼Œæ­¤ä¾èµ–å›¾å¯¹åº”æ˜ å°„åˆ°é¡¹ç›®æ‰€éœ€çš„æ¯ä¸ªæ¨¡å—ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ª bundleï¼š

![bundle-based dev server](https://cn.vitejs.dev/assets/bundler.37740380.png)

ä»å›¾ä¸­æˆ‘ä»¬å¤§è‡´å¯ä»¥çœ‹å‡º webpack æ‰“åŒ…åˆ†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. æŸ¥æ‰¾å…¥å£æ–‡ä»¶ - ä» webpack çš„é…ç½®æ–‡ä»¶ä¸­æŸ¥æ‰¾ entry çš„é…ç½®ï¼Œä»è€Œæ‰¾åˆ°å…¥å£æ–‡ä»¶
2. åˆ†æä¾èµ–å…³ç³» - ä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œåˆ†æå…¥å£æ–‡ä»¶ä¸­ä¾èµ–äº†å“ªäº›æ–‡ä»¶ï¼Œå¹¶ä¸”è¿™äº›ä¾èµ–çš„æ–‡ä»¶ä¸­è¿˜å¯èƒ½ä¾èµ–åˆ«çš„æ–‡ä»¶ï¼Œå°±è¿™ä¹ˆé€’å½’çš„æ‰¾ä¸‹å»
3. æ¨¡å—å‡½æ•° - æ‰¾åˆ°ä¾èµ–ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼ŒæŠŠè¿™äº›æ–‡ä»¶è½¬åŒ–æˆæ¨¡å—çš„å‡½æ•°ï¼Œä¸ºäº†æ–¹ä¾¿åé¢ webpack è¿›è¡Œè°ƒç”¨
4. æ‰“åŒ… - æ‰“åŒ…å®Œæ¯•çš„æ–‡ä»¶å¯ä»¥äº§å‡ºåˆ°é…ç½®æ–‡ä»¶çš„ output æŒ‡å®šè·¯å¾„é‡Œï¼Œç”Ÿæˆä¸€ä¸ª bundle
5. å¯åŠ¨æœåŠ¡ - node åˆ›å»ºæœ¬åœ°æœåŠ¡å™¨å¹¶å¯åŠ¨é™æ€é¡µé¢

## Vite å·¥ä½œæµ

![Native ESM-based dev server](https://cn.vitejs.dev/assets/esm.3070012d.png)

1. å¯åŠ¨ä¸€ä¸ªé™æ€èµ„æºæœåŠ¡å™¨
2. æ‰¾åˆ°é¡¹ç›®çš„å…¥å£ï¼Œå¼€å§‹åŠ è½½å…¥å£æ–‡ä»¶
3. å½“å£°æ˜ä¸€ä¸ª script æ ‡ç­¾ç±»å‹ä¸º module æ—¶ï¼Œæµè§ˆå™¨å°±ä¼šåƒæœåŠ¡å™¨å‘èµ·ä¸€ä¸ª GET è¯·æ±‚
4. Vite é€šè¿‡åŠ«æŒæµè§ˆå™¨çš„è¿™äº›è¯·æ±‚ï¼Œå¹¶åœ¨åç«¯è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œå°†é¡¹ç›®ä¸­ä½¿ç”¨çš„æ–‡ä»¶é€šè¿‡ç®€å•çš„åˆ†è§£ä¸æ•´åˆï¼Œç„¶åå†è¿”å›ç»™æµè§ˆå™¨ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ**Vite åœ¨å¯åŠ¨äº†ä¸€ä¸ªé™æ€èµ„æºæœåŠ¡å™¨åï¼Œåªéœ€è¦åœ¨æµè§ˆå™¨è¯·æ±‚æºç æ—¶è¿›è¡Œè½¬æ¢å¹¶æŒ‰éœ€æä¾›æºç **ã€‚æ ¹æ®æƒ…æ™¯åŠ¨æ€å¯¼å…¥ä»£ç ï¼Œå³åªåœ¨å½“å‰å±å¹•ä¸Šå®é™…ä½¿ç”¨æ—¶æ‰ä¼šè¢«å¤„ç†ã€‚Vite æ•´ä¸ªè¿‡ç¨‹ä¸­æ²¡æœ‰å¯¹æ–‡ä»¶è¿›è¡Œæ‰“åŒ…ç¼–è¯‘ï¼Œè‡³äºå…¶ä»–åŠ è½½çš„å·¥ä½œå°±äº¤ç»™äº†æµè§ˆå™¨ï¼Œæ‰€ä»¥å…¶è¿è¡Œé€Ÿåº¦æ¯”åŸå§‹çš„ webpack å¼€å‘ç¼–è¯‘é€Ÿåº¦å¿«å‡ºè®¸å¤šã€‚

## esbuild

esbuild ä¸ºå•¥æ„å»ºé€Ÿåº¦è¿™ä¹ˆå¿«ï¼Œæ¥è‡ª[å®˜ç½‘çš„è§£é‡Š](https://esbuild.github.io/faq/#why-is-esbuild-fast)ï¼šå³ä½¿ç”¨ Go ç¼–å†™ï¼Œå¹¶ä¸”ç¼–è¯‘æˆäº†æœºå™¨ç ã€‚

ç°åœ¨çš„æ„å»ºå·¥å…·ä¸€èˆ¬éƒ½æ˜¯ç”¨ JavaScript è¿›è¡Œç¼–å†™çš„ï¼Œå¯¹äºè¿™ç§è§£é‡Šå‹è¯­è¨€ï¼ˆåŠ¨æ€è¯­è¨€ï¼‰æ¥è¯´ï¼Œåœ¨å‘½ä»¤è¡Œä¸‹çš„æ€§èƒ½éå¸¸ç³Ÿç³•ã€‚å› ä¸ºæ¯æ¬¡è¿è¡Œç¼–è¯‘çš„æ—¶å€™ V8 å¼•æ“éƒ½æ˜¯ç¬¬ä¸€æ¬¡é‡è§ä»£ç ï¼Œæ— æ³•è¿›è¡Œä»»ä½•ä¼˜åŒ–æªæ–½ã€‚è€Œ esbuild ä½¿ç”¨ Go è¿™ç§ç¼–è¯‘å‹è¯­è¨€ï¼ˆé™æ€è¯­è¨€ï¼‰ç¼–å†™è€Œæˆï¼Œå·²ç»ç¼–è¯‘æˆäº†æœºå™¨å¯ä»¥ç›´æ¥æ‰§è¡Œçš„æœºå™¨ç ã€‚å½“ esbuild åœ¨ç¼–è¯‘ä½ çš„ javaScript ä»£ç çš„æ—¶å€™ï¼Œå¯èƒ½ Node è¿˜åœ¨å¿™ç€è§£æä½ çš„æ„å»ºå·¥å…·çš„ä»£ç ã€‚

å½“ç„¶è¿˜æœ‰å…¶ä»–æ–¹é¢çš„å¤„ç†ï¼Œå¦‚æ›´æœ‰æ•ˆåˆ©ç”¨å†…å­˜ã€å¤§é‡ä½¿ç”¨å¹¶è¡Œç®—æ³•ã€ä»ä¸€å¼€å§‹å°±è€ƒè™‘åˆ°æ€§èƒ½çš„ä»é›¶å¼€å§‹ç¼–å†™ç­‰ã€‚This benchmark approximates a large JavaScript codebase by duplicating the three.js library 10 times and building a single bundle from scratch, without any caches. The benchmark can be run with make bench-three in the esbuild repoï¼š

| Bundler | Time | Relative slowdown | Absolute speed | Output size |
| -- | -- | -- | -- | --|
| esbuild | 0.33s | 1x | 1658.9 kloc/s | 5.80mb |
| parcel 2 | 32.48s | 98x | 16.9 kloc/s | 5.87mb |
| rollup + terser | 34.95s | 106x | 15.7 kloc/s | 5.81mb |
| webpack 5 | 41.53s | 126x | 13.2 kloc/s | 5.84mb |

## å…³äº HMR çƒ­é‡è½½

åŸºäºæ‰“åŒ…å™¨å¯åŠ¨æ—¶ï¼Œé‡å»ºæ•´ä¸ªåŒ…çš„æ•ˆç‡å¾ˆä½ã€‚åŸå› æ˜¾è€Œæ˜“è§ï¼šå› ä¸ºè¿™æ ·æ›´æ–°é€Ÿåº¦ä¼šéšç€åº”ç”¨ä½“ç§¯å¢é•¿è€Œç›´çº¿ä¸‹é™ã€‚

ä¸€äº›æ‰“åŒ…å™¨çš„å¼€å‘æœåŠ¡å™¨å°†æ„å»ºå†…å®¹å­˜å…¥å†…å­˜ï¼Œè¿™æ ·å®ƒä»¬åªéœ€è¦åœ¨æ–‡ä»¶æ›´æ”¹æ—¶ä½¿æ¨¡å—å›¾çš„ä¸€éƒ¨åˆ†å¤±æ´»ï¼Œä½†å®ƒä¹Ÿä»éœ€è¦æ•´ä¸ªé‡æ–°æ„å»ºå¹¶é‡è½½é¡µé¢ã€‚è¿™æ ·ä»£ä»·å¾ˆé«˜ï¼Œå¹¶ä¸”é‡æ–°åŠ è½½é¡µé¢ä¼šæ¶ˆé™¤åº”ç”¨çš„å½“å‰çŠ¶æ€ï¼Œæ‰€ä»¥æ‰“åŒ…å™¨æ”¯æŒäº†**åŠ¨æ€æ¨¡å—çƒ­é‡è½½ï¼ˆHMRï¼‰**ï¼šå…è®¸ä¸€ä¸ªæ¨¡å— â€œçƒ­æ›¿æ¢â€ å®ƒè‡ªå·±ï¼Œè€Œä¸ä¼šå½±å“é¡µé¢å…¶ä½™éƒ¨åˆ†ã€‚è¿™å¤§å¤§æ”¹è¿›äº†å¼€å‘ä½“éªŒ â€”â€” ç„¶è€Œï¼Œåœ¨å®è·µä¸­æˆ‘ä»¬å‘ç°ï¼Œå³ä½¿é‡‡ç”¨äº† HMR æ¨¡å¼ï¼Œå…¶çƒ­æ›´æ–°é€Ÿåº¦ä¹Ÿä¼šéšç€åº”ç”¨è§„æ¨¡çš„å¢é•¿è€Œæ˜¾è‘—ä¸‹é™ã€‚

Vite é€šè¿‡åœ¨ä¸€å¼€å§‹å°†åº”ç”¨ä¸­çš„æ¨¡å—åŒºåˆ†ä¸º**ä¾èµ–**å’Œ**æºç **ä¸¤ç±»ï¼Œæ”¹è¿›äº†å¼€å‘æœåŠ¡å™¨å¯åŠ¨æ—¶é—´:

* ä¾èµ– - å¤§å¤šä¸ºåœ¨å¼€å‘æ—¶ä¸ä¼šå˜åŠ¨çš„çº¯ JavaScriptã€‚ä¸€äº›è¾ƒå¤§çš„ä¾èµ–ï¼ˆä¾‹å¦‚æœ‰ä¸Šç™¾ä¸ªæ¨¡å—çš„ç»„ä»¶åº“ï¼‰å¤„ç†çš„ä»£ä»·ä¹Ÿå¾ˆé«˜ã€‚ä¾èµ–ä¹Ÿé€šå¸¸ä¼šå­˜åœ¨å¤šç§æ¨¡å—åŒ–æ ¼å¼ï¼ˆä¾‹å¦‚ ESM æˆ–è€… CommonJSï¼‰ã€‚
* æºç  - é€šå¸¸åŒ…å«ä¸€äº›å¹¶éç›´æ¥æ˜¯ JavaScript çš„æ–‡ä»¶ï¼Œéœ€è¦è½¬æ¢ï¼ˆä¾‹å¦‚ JSXï¼ŒCSS æˆ–è€… Vue/Svelte ç»„ä»¶ï¼‰ï¼Œæ—¶å¸¸ä¼šè¢«ç¼–è¾‘ã€‚åŒæ—¶ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„æºç éƒ½éœ€è¦åŒæ—¶è¢«åŠ è½½ï¼ˆä¾‹å¦‚åŸºäºè·¯ç”±æ‹†åˆ†çš„ä»£ç æ¨¡å—ï¼‰ã€‚

åœ¨ Vite ä¸­ï¼ŒHMR æ˜¯åœ¨åŸç”Ÿ ESM ä¸Šæ‰§è¡Œçš„ã€‚å½“ç¼–è¾‘ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼ŒVite åªéœ€è¦ç²¾ç¡®åœ°ä½¿å·²ç¼–è¾‘çš„æ¨¡å—ä¸å…¶æœ€è¿‘çš„ HMR è¾¹ç•Œä¹‹é—´çš„é“¾å¤±æ´»ï¼ˆå¤§å¤šæ•°æ—¶å€™åªæ˜¯æ¨¡å—æœ¬èº«ï¼‰ï¼Œä½¿å¾—æ— è®ºåº”ç”¨å¤§å°å¦‚ä½•ï¼ŒHMR å§‹ç»ˆèƒ½ä¿æŒå¿«é€Ÿæ›´æ–°ã€‚

Vite åŒæ—¶åˆ©ç”¨ HTTP å¤´æ¥åŠ é€Ÿæ•´ä¸ªé¡µé¢çš„é‡æ–°åŠ è½½ï¼ˆå†æ¬¡è®©æµè§ˆå™¨ä¸ºæˆ‘ä»¬åšæ›´å¤šäº‹æƒ…ï¼‰ï¼šæºç æ¨¡å—çš„è¯·æ±‚ä¼šæ ¹æ® `304 Not Modified` è¿›è¡Œåå•†ç¼“å­˜ï¼Œè€Œä¾èµ–æ¨¡å—è¯·æ±‚åˆ™ä¼šé€šè¿‡ `Cache-Control: max-age=31536000,immutable` è¿›è¡Œå¼ºç¼“å­˜ï¼Œå› æ­¤ä¸€æ—¦è¢«ç¼“å­˜å®ƒä»¬å°†ä¸éœ€è¦å†æ¬¡è¯·æ±‚ã€‚

## Dependency pre-bundling

vite **ä¾èµ–é¢„æ„å»º(Dependency pre-bundling)** çš„ç›®çš„æœ‰ä¸¤ä¸ª:

1. CommonJS å’Œ UMD å…¼å®¹æ€§: å¼€å‘é˜¶æ®µä¸­ï¼ŒVite çš„å¼€å‘æœåŠ¡å™¨å°†æ‰€æœ‰ä»£ç è§†ä¸ºåŸç”Ÿ ES æ¨¡å—ã€‚å› æ­¤ï¼ŒVite å¿…é¡»å…ˆå°†ä½œä¸º CommonJS æˆ– UMD å‘å¸ƒçš„ä¾èµ–é¡¹è½¬æ¢ä¸º ESMã€‚
2. æ€§èƒ½ï¼š Vite å°†æœ‰è®¸å¤šå†…éƒ¨æ¨¡å—çš„ ESM ä¾èµ–å…³ç³»è½¬æ¢ä¸ºå•ä¸ªæ¨¡å—ï¼Œä»¥æé«˜åç»­é¡µé¢åŠ è½½æ€§èƒ½ã€‚

é’ˆå¯¹ç¬¬äºŒç‚¹ï¼Œä¸€äº›åŒ…å°†å®ƒä»¬çš„ ES æ¨¡å—æ„å»ºä½œä¸ºè®¸å¤šå•ç‹¬çš„æ–‡ä»¶ç›¸äº’å¯¼å…¥ã€‚ä¾‹å¦‚ï¼Œlodash-es æœ‰è¶…è¿‡ 600 ä¸ªå†…ç½®æ¨¡å—ï¼å½“æˆ‘ä»¬æ‰§è¡Œ `import { debounce } from 'lodash-es'` æ—¶ï¼Œæµè§ˆå™¨åŒæ—¶å‘å‡º 600 å¤šä¸ª HTTP è¯·æ±‚ï¼å°½ç®¡æœåŠ¡å™¨åœ¨å¤„ç†è¿™äº›è¯·æ±‚æ—¶æ²¡æœ‰é—®é¢˜ï¼Œä½†å¤§é‡çš„è¯·æ±‚ä¼šåœ¨æµè§ˆå™¨ç«¯é€ æˆç½‘ç»œæ‹¥å¡ï¼Œå¯¼è‡´é¡µé¢çš„åŠ è½½é€Ÿåº¦ç›¸å½“æ…¢ã€‚è€Œé€šè¿‡é¢„æ„å»º lodash-es æˆä¸ºä¸€ä¸ªæ¨¡å—ï¼Œæˆ‘ä»¬å°±åªéœ€è¦ä¸€ä¸ª HTTP è¯·æ±‚äº†ï¼

> ä¾èµ–é¢„æ„å»ºä»…ä¼šåœ¨å¼€å‘æ¨¡å¼ä¸‹åº”ç”¨ï¼Œå¹¶ä¼šä½¿ç”¨ esbuild å°†ä¾èµ–è½¬ä¸º ESM æ¨¡å—ã€‚åœ¨ç”Ÿäº§æ„å»ºä¸­åˆ™ä¼šä½¿ç”¨ `@rollup/plugin-commonjs`ã€‚

å¦‚æœä½ æƒ³è¦æ˜¾å¼åœ°ä»åˆ—è¡¨ä¸­åŒ…å« / æ’é™¤ä¾èµ–é¡¹çš„æƒ…å†µä¸‹, è¯·ä½¿ç”¨ `optimizeDeps` é…ç½®é¡¹ã€‚ä¾‹å¦‚ï¼Œimport å¯èƒ½æ˜¯æ’ä»¶è½¬æ¢çš„ç»“æœã€‚è¿™æ„å‘³ç€ Vite æ— æ³•åœ¨åˆå§‹æ‰«ææ—¶å‘ç° import â€”â€” å®ƒåªèƒ½åœ¨æµè§ˆå™¨è¯·æ±‚æ–‡ä»¶æ—¶è½¬æ¢åæ‰èƒ½å‘ç°ã€‚è¿™å°†å¯¼è‡´æœåŠ¡å™¨åœ¨å¯åŠ¨åç«‹å³é‡æ–°æ‰“åŒ…ã€‚include å’Œ exclude éƒ½å¯ä»¥ç”¨æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœä¾èµ–é¡¹å¾ˆå¤§ï¼ˆåŒ…å«å¾ˆå¤šå†…éƒ¨æ¨¡å—ï¼‰æˆ–è€…æ˜¯ CommonJSï¼Œé‚£ä¹ˆä½ åº”è¯¥åŒ…å«å®ƒï¼›å¦‚æœä¾èµ–é¡¹å¾ˆå°ï¼Œå¹¶ä¸”å·²ç»æ˜¯æœ‰æ•ˆçš„ ESMï¼Œåˆ™å¯ä»¥æ’é™¤å®ƒï¼Œè®©æµè§ˆå™¨ç›´æ¥åŠ è½½å®ƒã€‚

CommonJS çš„ä¾èµ–ä¸åº”è¯¥æ’é™¤åœ¨ä¼˜åŒ–å¤–ã€‚å¦‚æœä¸€ä¸ª ESM ä¾èµ–è¢«æ’é™¤åœ¨ä¼˜åŒ–å¤–ï¼Œä½†æ˜¯å´æœ‰ä¸€ä¸ªåµŒå¥—çš„ CommonJS ä¾èµ–ï¼Œåˆ™åº”è¯¥ä¸ºè¯¥ CommonJS ä¾èµ–æ·»åŠ  `optimizeDeps.include`ã€‚ä¾‹å¦‚ï¼š

```js
export default defineConfig({
  optimizeDeps: {
    include: ['esm-dep > cjs-dep']
  }
})
```

Vite ä¼šå°†é¢„æ„å»ºçš„ä¾èµ–ç¼“å­˜åˆ° `node_modules/.vite`ã€‚å®ƒæ ¹æ®å‡ ä¸ªæºæ¥å†³å®šæ˜¯å¦éœ€è¦é‡æ–°è¿è¡Œé¢„æ„å»ºæ­¥éª¤:

1. package.json ä¸­çš„ dependencies åˆ—è¡¨
2. åŒ…ç®¡ç†å™¨çš„ lockfile
3. å¯èƒ½åœ¨ vite.config.js ç›¸å…³å­—æ®µä¸­é…ç½®è¿‡çš„

åªæœ‰åœ¨ä¸Šè¿°å…¶ä¸­ä¸€é¡¹å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œæ‰éœ€è¦é‡æ–°è¿è¡Œé¢„æ„å»ºã€‚å¦‚æœå‡ºäºæŸäº›åŸå› ï¼Œä½ æƒ³è¦å¼ºåˆ¶ Vite é‡æ–°æ„å»ºä¾èµ–ï¼Œä½ å¯ä»¥ç”¨ `--force` å‘½ä»¤è¡Œé€‰é¡¹å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼Œæˆ–è€…æ‰‹åŠ¨åˆ é™¤ `node_modules/.vite` ç›®å½•ã€‚

## å¯¹ TS çš„æ”¯æŒ

Vite å¤©ç„¶æ”¯æŒå¼•å…¥ .ts æ–‡ä»¶ã€‚**Vite ä»…æ‰§è¡Œ .ts æ–‡ä»¶çš„è½¬è¯‘å·¥ä½œï¼Œå¹¶ä¸æ‰§è¡Œä»»ä½•ç±»å‹æ£€æŸ¥**ã€‚å¹¶å‡è®¾ç±»å‹æ£€æŸ¥å·²ç»è¢«ä½ çš„ IDE æˆ–æ„å»ºè¿‡ç¨‹æ¥ç®¡äº†ï¼ˆä½ å¯ä»¥åœ¨æ„å»ºè„šæœ¬ä¸­è¿è¡Œ tsc --noEmit æˆ–è€…å®‰è£… vue-tsc ç„¶åè¿è¡Œ vue-tsc --noEmit æ¥å¯¹ä½ çš„ *.vue æ–‡ä»¶åšç±»å‹æ£€æŸ¥ï¼‰ã€‚

> Vite ä½¿ç”¨ esbuild å°† TypeScript è½¬è¯‘åˆ° JavaScriptï¼Œçº¦æ˜¯ tsc é€Ÿåº¦çš„ 20~30 å€ï¼ŒåŒæ—¶ HMR æ›´æ–°åæ˜ åˆ°æµè§ˆå™¨çš„æ—¶é—´å°äº 50msã€‚

ä½¿ç”¨ä»…å«ç±»å‹çš„å¯¼å…¥å’Œå¯¼å‡ºå½¢å¼çš„è¯­æ³•å¯ä»¥é¿å…æ½œåœ¨çš„ â€œä»…å«ç±»å‹çš„å¯¼å…¥è¢«ä¸æ­£ç¡®æ‰“åŒ…â€ çš„é—®é¢˜ï¼Œå†™æ³•ç¤ºä¾‹å¦‚ä¸‹ï¼Œè¯¦ç»†[è§è¿™é‡Œ](https://cn.vitejs.dev/guide/features.html)ï¼š

```js
import type { T } from 'only/types'
export type { T }
```

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¿…é¡»åœ¨ tsconfig.json ä¸­çš„ compilerOptions ä¸‹è®¾ç½® `"isolatedModules": true`ã€‚å¦‚æ­¤åšï¼ŒTS ä¼šè­¦å‘Šä½ ä¸è¦ä½¿ç”¨éš”ç¦»ï¼ˆisolatedï¼‰è½¬è¯‘çš„åŠŸèƒ½ã€‚è¿™æ˜¯å› ä¸º esbuild åªæ‰§è¡Œæ²¡æœ‰ç±»å‹ä¿¡æ¯çš„è½¬è¯‘ï¼Œå®ƒå¹¶ä¸æ”¯æŒæŸäº›ç‰¹æ€§ï¼Œå¦‚ const enum å’Œéšå¼ç±»å‹å¯¼å…¥ã€‚

## åŸºäº Vite åˆ›å»ºé¡¹ç›®

å¯ä»¥ç›´æ¥é€šè¿‡ `pnpm create vite` åˆ›å»ºï¼Œä¹Ÿå¯ä»¥é€šè¿‡é™„åŠ çš„å‘½ä»¤è¡Œé€‰é¡¹ç›´æ¥æŒ‡å®šé¡¹ç›®åç§°å’Œä½ æƒ³è¦ä½¿ç”¨çš„æ¨¡æ¿ï¼š

```shell
# npm 6.x
npm create vite@latest my-vue-app --template vue

# npm 7+, extra double-dash is needed:
npm create vite@latest my-vue-app -- --template vue

# yarn
yarn create vite my-vue-app --template vue

# pnpm
pnpm create vite my-vue-app -- --template vue
```

> æ›´å¤šå¯ä»¥å‚è€ƒ [**awesome-vite**](https://github.com/vitejs/awesome-vite) ğŸ‘ˆ

## vite.config.js

å½“ä»¥å‘½ä»¤è¡Œæ–¹å¼è¿è¡Œ Vite æ—¶ï¼ŒVite ä¼šè‡ªåŠ¨è§£æé¡¹ç›®æ ¹ç›®å½•ä¸‹åä¸º `vite.config.js` çš„æ–‡ä»¶ã€‚æ³¨æ„å³ä½¿é¡¹ç›®æ²¡æœ‰åœ¨ package.json ä¸­å¼€å¯ `type: "module"`ï¼ŒVite ä¹Ÿæ”¯æŒåœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ ESM è¯­æ³•ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œé…ç½®æ–‡ä»¶ä¼šåœ¨è¢«åŠ è½½å‰è‡ªåŠ¨è¿›è¡Œé¢„å¤„ç†ã€‚

å¦‚æœé…ç½®æ–‡ä»¶éœ€è¦åŸºäºï¼ˆdev/serve æˆ– buildï¼‰å‘½ä»¤æˆ–è€…ä¸åŒçš„æ¨¡å¼æ¥å†³å®šé€‰é¡¹ï¼Œåˆ™å¯ä»¥é€‰æ‹©å¯¼å‡ºè¿™æ ·ä¸€ä¸ªå‡½æ•°ã€‚å…·ä½“é…ç½®å¯[æŸ¥é˜…å®˜ç½‘](https://cn.vitejs.dev/config/#define)ï¼š

```js
export default defineConfig(({ command, mode }) => {
  if (command === 'serve') {
    return {
      // dev ç‹¬æœ‰é…ç½®
    }
  } else {
    // command === 'build'
    return {
      // build ç‹¬æœ‰é…ç½®
    }
  }
})
```

## å‚è€ƒé“¾æ¥

1. [vite ä¸‹ä¸€ä»£å‰ç«¯å¼€å‘ä¸æ„å»ºå·¥å…·(ä¸€)](https://juejin.cn/post/6983587446541778957) By è–›å®šè°”çš„çŒ«_
2. [[Vite æ€»ç»“] å¸…å°ä¼™èŠ±äº†ä¸€ä¸ªæœˆæ—¶é—´æ€»ç»“çš„ Vite çŸ¥è¯†ç‚¹å’Œè¿ç§»æ–¹æ¡ˆ](https://juejin.cn/post/6988704825450397709) By å¢¨ç—•m
