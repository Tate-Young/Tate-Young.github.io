---
layout: blog
front: true
comments: True
flag: Server
background: gray
category: åç«¯
title: PM2 è‡ªåŠ¨åŒ–éƒ¨ç½²
date:  2020-01-19 17:47:00 GMT+0800 (CST)
background-image: https://pm2.keymetrics.io/assets/header-graphic.png
tags:
- Server
---
# {{ page.title }}

## ä»€ä¹ˆæ˜¯ PM2

[**PM2**](https://pm2.keymetrics.io/docs/usage/pm2-doc-single-page/) æ˜¯ä¸€ä¸ª node åå°è¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œä½ å¯ä»¥å¯¹è¿›ç¨‹è¿›è¡Œ startã€stopã€restart æˆ–è€… delete ç­‰æ“ä½œï¼Œè¿˜å¯ä»¥æ”¯æŒæ€§èƒ½ç›‘æ§ã€è´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½ï¼ŒåŒç±»å‹çš„è¿˜æœ‰ [**forever**](https://github.com/foreversd/forever) ç­‰:

```SHELL
npm install pm2 -g
```

| Feature | Forever | PM2 |
|:--------------|:---------|:---------|
| Keep Alive | âœ” | âœ” |
| Coffeescript | âœ” |  |
| Log aggregation |  | âœ” |
| API |  | âœ” |
| Terminal monitoring |  | âœ” |
| Clustering |  | âœ” |
| JSON configuration |  | âœ” |

> PM2 is daemon process manager that will help you manage and keep your application online âœ…

## å¸¸ç”¨å‘½ä»¤

```SHELL
# å¯åŠ¨ä¸€ä¸ª node ç¨‹åº
pm2 start index.js
# å¯åŠ¨å¹¶å–åˆ«å
pm2 start app_h5/bin/www --name application1
# åœ¨æ–‡ä»¶æ”¹å˜çš„æ—¶å€™ä¼šé‡æ–°å¯åŠ¨ç¨‹åº
pm2 start index.js --watch

# ä¸­æ­¢è¿›ç¨‹ï¼ŒæŒ‡å®šè¿›ç¨‹ id æˆ–åç§°ï¼Œ
pm2 stop 0

# åˆ é™¤è¿›ç¨‹ï¼Œall åˆ™åˆ é™¤æ‰€æœ‰
pm2 delete 0

# æŸ¥çœ‹è¯¦æƒ…
pm2 describe 0

# æŸ¥çœ‹è¿›ç¨‹çš„èµ„æºæ¶ˆè€—æƒ…å†µ
pm2 monit

# é‡å¯è¿›ç¨‹ï¼Œä¹Ÿå¯ç”¨ restart
# Use reload instead of restart for 0-seconds downtime reloads
# restart æ˜¯å…ˆ kill ç„¶åé‡å¯ï¼Œè€Œ reload åä¹‹ï¼Œæ•…ä¸ä¼šåœæœº
pm2 reload 0

# æŸ¥çœ‹æ—¥å¿—
pm2 logs 0

# é›†ç¾¤ cluster å¯åŠ¨ - è´Ÿè½½å‡è¡¡
# -i è¡¨ç¤º number-instances å®ä¾‹æ•°é‡
# max è¡¨ç¤º PM2 å°†è‡ªåŠ¨æ£€æµ‹å¯ç”¨ CPU çš„æ•°é‡ å¯ä»¥è‡ªå·±æŒ‡å®šæ•°é‡
pm2 start start.js -i max

# æŸ¥çœ‹ç›‘æ§ç•Œé¢ï¼Œå³ pm2 list
pm2 l
```

![pm2](https://raw.githubusercontent.com/unitech/pm2/master/pres/pm2-list.png)

æ›´æ–° pm2 çš„æ–¹æ³•:

```SHELL
# ä¿å­˜å½“å‰è¿›ç¨‹çŠ¶æ€
pm2 save
# å…¨å±€å®‰è£…
npm i -g pm2
# pm2 update is necessary in order to refresh the PM2 daemon
pm2 update
```

> å…³äº `pm2 save` çš„ç”¨æ³•: pm2 save takes a snapshot of your currently running Node applications. You can then restore these applications using `pm2 resurrect`. This is useful because it means you don't have to manually restart each application when you restart pm2 (such as a machine reboot). Instead, you can just have a script that calls pm2 resurrect and it'll start up all the Node apps.

## è‡ªåŠ¨åŒ–éƒ¨ç½²

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é¡¹ç›®éƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šï¼Œä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ¯æ¬¡è¦æ›´æ–°çš„è¯å¿…é¡»åœ¨æœåŠ¡å™¨ä¸Šå»æ“ä½œï¼Œç„¶å `pm2 reload` é‡å¯è¯¥è¿›ç¨‹ï¼Œè¿™æ ·æ˜¾ç„¶æ¯”è¾ƒéº»çƒ¦ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å€ŸåŠ© `pm2 deploy` æ¥è¿›è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚å…·ä½“å¯ä»¥å‚ç…§ pm2 å®˜æ–¹æ–‡æ¡£ [Deployment ä¸€èŠ‚](https://pm2.keymetrics.io/docs/usage/deployment/)ã€‚

1ã€ Generate a sample `ecosystem.json` file that lists the processes and the deployment environment.

```SHELL
pm2 ecosystem
```

è‡ªåŠ¨ä¼šåˆ›å»º `ecosystem.json` æ–‡ä»¶ï¼Œå½“ç„¶ä¹Ÿæ”¯æŒ yaml é…ç½®æ–‡ä»¶ï¼Œç„¶ååœ¨å¯¹åº”ä½ç½®è‡ªå®šä¹‰å³å¯:

```JS
{
  // Applications part
  "apps" : [{
    "name"      : "API",
    "script"    : "app.js",
    "env": {
      "COMMON_VARIABLE": "true"
    },
    // Environment variables injected when starting with --env production
    // http://pm2.keymetrics.io/docs/usage/application-declaration/#switching-to-different-environments
    "env_production" : {
      "NODE_ENV": "production"
    }
  },{
    "name"      : "WEB",
    "script"    : "web.js"
  }],
  // Deployment part
  // Here you describe each environment
  "deploy" : {
    "production" : {
      "user" : "node",
      // Multi host is possible, just by passing IPs/hostname as an array
      "host" : ["212.83.163.1", "212.83.163.2", "212.83.163.3"],
      // Branch
      "ref"  : "origin/master",
      // Git repository to clone
      "repo" : "git@github.com:repo.git",
      // Path of the application on target servers
      "path" : "/var/www/production",
      // Can be used to give options in the format used in the configura-
      // tion file.  This is useful for specifying options for which there
      // is no separate command-line flag, see 'man ssh'
      // can be either a single string or an array of strings
      "ssh_options": "StrictHostKeyChecking=no",
      // To prepare the host by installing required software (eg: git)
      // even before the setup process starts
      // can be multiple commands separated by the character ";"
      // or path to a script on your local machine
      "pre-setup" : "apt-get install git",
      // Commands / path to a script on the host machine
      // This will be executed on the host after cloning the repository
      // eg: placing configurations in the shared dir etc
      "post-setup": "ls -la",
      // Commands to execute locally (on the same machine you deploy things)
      // Can be multiple commands separated by the character ";"
      "pre-deploy-local" : "echo 'This is a local executed command'"
      // Commands to be executed on the server after the repo has been cloned
      "post-deploy" : "npm install && pm2 startOrRestart ecosystem.json --env production"
      // Environment variables that must be injected in all applications on this env
      "env"  : {
        "NODE_ENV": "production"
      }
    },
    "staging" : {
      "user" : "node", // ç™»å½•ç”¨æˆ·å
      "host" : "212.83.163.1", // è¦éƒ¨ç½²çš„ç›®æ ‡æœåŠ¡å™¨ ip/åŸŸå
      "ref"  : "origin/master", // ç”¨äºéƒ¨ç½²ä»£ç æ—¶çš„åˆ†æ”¯
      "repo" : "git@github.com:repo.git", // git ä»“åº“åœ°å€
      "path" : "/var/www/development", // åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šéƒ¨ç½²çš„æ–‡ä»¶ç›®å½•åœ°å€
      "ssh_options": ["StrictHostKeyChecking=no", "PasswordAuthentication=no"],
      "post-deploy" : "pm2 startOrRestart ecosystem.json --env dev", // éƒ¨ç½²åå¯åŠ¨çš„è„šæœ¬
      "env"  : {
        "NODE_ENV": "staging"
      }
    }
  }
}
```

2ã€Be sure that you have the public **ssh key** on your local machine

```SHELL
ssh-keygen -t rsa
ssh-copy-id node@myserver.com
```

> `ssh-keygen` è‡ªåŠ¨ç”Ÿæˆå…¬é’¥å’Œç§é’¥ï¼Œ`ssh-copy-id` å‘½ä»¤å°†å…¬é’¥ä¼ é€åˆ°è¿œç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥æŸ¥çœ‹[ä¹‹å‰è¿™ç¯‡åšå®¢]( {{site.url}}/2019/02/03/linux-ssh-rz-sz.html#èº«ä»½è®¤è¯ ) ğŸ‘ˆ

3ã€Now initialize the remote folder with:

```SHELL
# é¦–æ¬¡éƒ¨ç½²ï¼Œè¯¥å‘½ä»¤ä¼šåœ¨è¿œç«¯æœåŠ¡å™¨ä¸Šåˆ›å»ºæ–‡ä»¶ç›®å½•
pm2 deploy <configuration_file> <environment> setup

# demo
pm2 deploy ecosystem.json production setup
```

4ã€Deploy your code

```SHELL
# å†æ¬¡éƒ¨ç½²ï¼Œä¼šä¸Šä¼ é¡¹ç›®ä»£ç ï¼Œå¹¶ç”¨ PM2 å¯åŠ¨
# ä»¥åéƒ½ç”¨æ­¤å‘½ä»¤è¿›è¡Œæ›´æ–°ä»£ç å’Œéƒ¨ç½²å³å¯
pm2 deploy ecosystem.json production
```

> æ³¨æ„ï¼šæœ¬åœ°å’ŒæœåŠ¡å™¨ç¡®ä¿éƒ½å®‰è£… PM2

å½“ç„¶ deploy å‘½ä»¤ä¹Ÿæ”¯æŒå…¶ä»–ä¸€äº›å‚æ•°:

```TEXT
# pm2 deploy help

setup                run remote setup commands
update               update deploy to the latest release
revert [n]           revert to [n]th last deployment or 1
curr[ent]            output current release commit
prev[ious]           output previous release commit
exec|run <cmd>       execute the given <cmd>
list                 list previous deploy commits
[ref]                deploy to [ref], the "ref" setting, or latest tag
```

```SHELL
# Update remote version
pm2 deploy production update

# Revert to -1 deployment
pm2 deploy production revert 1

# execute command on remote machines
pm2 deploy production exec "pm2 reload all"
```

## ä¸ Nginx çš„é…åˆä½¿ç”¨

ä¸‹é¢æ˜¯ä¸€ä¸ªå®˜ç½‘çš„ demoï¼ŒNginx å°† 80 ç«¯å£ä»£ç†åˆ° 3001 ç«¯å£ï¼Œæ›´å¤šå¯ä»¥å‚ç…§ [Nginx è¿™ç¯‡åšå®¢]( {{site.url}}/2019/01/30/nginx.html ):

```TEXT
upstream my_nodejs_upstream {
  server 127.0.0.1:3001;
  keepalive 64;
}

server {
  listen 443 ssl;

  server_name www.my-website.com;
  ssl_certificate_key /etc/ssl/main.key;
  ssl_certificate     /etc/ssl/main.crt;

  location / {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $http_host;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_pass http://my_nodejs_upstream/;
    proxy_redirect off;
    proxy_read_timeout 240s;
  }
}
```

## nodemon / supervisor

ä¸¤ç§å¸¸ç”¨äºå¼€å‘ç¯å¢ƒç›‘å¬æ–‡ä»¶æ”¹åŠ¨å¹¶é‡å¯æœåŠ¡çš„æ–¹å¼ï¼Œè¿˜å¯ä»¥æ­é… **[Browsersync](https://browsersync.io/)** å®ç°å®¢æˆ·ç«¯è‡ªåŠ¨åˆ·æ–°:

* **[nodemon](https://github.com/remy/nodemon)** - å ç”¨å†…å­˜æ›´å°‘ï¼Œæ˜“æ‰©å±•
* **[supervisor](https://github.com/Supervisor/supervisor)**

```SHELL
nodemon index.js

# ä¹Ÿå¯çœç•¥å†™æ³•ï¼Œé»˜è®¤æ‰¾ index.js
nodemon
```
