---
layout: blog
back: true
comments: True
flag: Server
background: green
category: 前端
title: Nginx 简介
date: 2019-01-29 14:41:00 GMT+0800 (CST)
background-image: https://i.loli.net/2019/01/28/5c4ea7dbcf6f9.png
tags:
- Other
---
# {{ page.title }}

## 什么是 Nginx

**Nginx** 是异步框架的 `Web 服务器`，也可以用作[`反向代理`](https://zh.wikipedia.org/wiki/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86)，[`负载平衡器`](https://zh.wikipedia.org/wiki/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1) 和 `HTTP 缓存`，Nginx 的编写有一个明确目标就是超越 Apache Web 服务器的性能。 Nginx 提供开箱即用的静态文件，使用的内存比 Apache 少得多，每秒可以处理大约四倍于 Apache 的请求。在高并发下 Nginx 能保持低资源低消耗高性能。还有高度模块化的设计，模块编写简单。配置文件简洁。

**反向代理**是代理服务器的一种。服务器根据客户端的请求，从其关系的一组或多组后端服务器(如 Web 服务器)上获取资源，然后再将这些资源返回给客户端，客户端只会得知反向代理的 IP 地址，而不知道在代理服务器后面的服务器簇的存在。

## 模块

Nginx 将各功能模块组织成一条链，当有请求到达的时候，请求依次经过这条链上的部分或者全部模块，进行处理。每个模块实现特定的功能。例如，实现对请求解压缩的模块，实现 SSI 的模块，实现与上游服务器进行通讯的模块，实现与 FastCGI 服务进行通讯的模块。

Nginx 的模块根据其功能基本上可以分为以下几种类型(摘自[极客学院](http://wiki.jikexueyuan.com/project/nginx/model-architecture.html)):

| 模块 | 描述 |
|:--------------|:---------|
| event module | 搭建了独立于操作系统的事件处理机制的框架，及提供了各具体事件的处理。包括 ngx_events_module， ngx_event_core_module 和 ngx_epoll_module 等。Nginx 具体使用何种事件处理模块，这依赖于具体的操作系统和编译选项 |
| phase handler | 此类型的模块也被直接称为 handler 模块。主要负责处理客户端请求并产生待响应内容，比如 ngx_http_static_module 模块，负责客户端的静态页面请求处理并将对应的磁盘文件准备为响应内容输出 |
| output filter | 也称为 filter 模块，主要是负责对输出的内容进行处理，可以对输出进行修改。例如，可以实现对输出的所有 html 页面增加预定义的 footbar 一类的工作，或者对输出的图片的 URL 进行替换之类的工作 |
| **upstream** | upstream 模块实现反向代理的功能，将真正的请求转发到后端服务器上，并从后端服务器上读取响应，发回客户端。upstream 模块是一种特殊的 handler，只不过响应内容不是真正由自己产生的，而是从后端服务器上读取的 |
| load-balancer | 负载均衡模块，实现特定的算法，在众多的后端服务器中，选择一个服务器出来作为某个请求的转发服务器 |

## 配置

Nginx 的配置系统由一个主配置文件和其他一些辅助的配置文件构成。这些配置文件均是纯文本文件，全部位于 Nginx 安装目录下的 `conf` 目录下。`nginx.conf` 中的配置信息，根据其逻辑上的意义，对它们进行了分类，称之为配置指令上下文。不同的作用域含有一个或者多个配置项。当前 Nginx 支持的几个指令上下文:

| 指令 | 描述 |
|:--------------|:---------|
| main | nginx 在运行时与具体业务功能(比如 http 服务或者 email 服务代理)无关的一些参数，比如工作进程数，运行的身份等 |
| http | 与提供 http 服务相关的一些配置参数。例如：是否使用 keepalive、gzip 进行压缩等 |
| server | http 服务上支持若干虚拟主机。每个虚拟主机一个对应的 server 配置项，配置项里面包含该虚拟主机相关的配置。在提供 mail 服务的代理时，也可以建立若干 server，每个 server 通过监听的地址来区分 |
| location | http 服务中，某些特定的 URL 对应的一系列配置项 |
| mail | 实现 email 相关的 SMTP/IMAP/POP3 代理时，共享的一些配置项(因为可能实现多个代理，工作在多个监听地址上) |

举个配置的例子(摘自掘进):

```TEXT
// nginx.conf, 每次修改都要重启才能生效
worker_processes 1; // 工作进程数，和 CPU 核数相同
events {
  worker_connections 1024; // 每个进程允许的最大连接数
}
http {
  upstream firstdemo { // upstream name {} 负载均衡
    ip_hash; // 记录首次访问的信息，之后再访问都是该服务器
    server 39.106.145.33;
    server 47.93.6.93;
  }
  server { // 反向代理
    listen 8080;
    server_name  m1.shein.com; // 访问的域名
    location / {
      proxy_pass http://firstdemo; // 项目的开发机地址
      proxy_set_header Host $host;
      proxy_redirect off;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_connect_timeout 60;
      proxy_read_timeout 600;
      proxy_send_timeout 600;
    }
  }
}
include vhost/*.conf; // 引入其他的配置文件
```

## 常用命令

* stop — fast shutdown
* quit — graceful shutdown
* reload — reloading the configuration file
* reopen — reopening the log files

```SHELL
nginx -s reload
# 使用 -c 的参数指定 nginx.conf 文件的位置
nginx -c /usr/local/nginx/conf/nginx.conf -s reload
```

## 参考链接

1. [Nginx 官方文档](http://nginx.org/en/docs/)
2. [Nginx 入门指南 - 极客学院](http://wiki.jikexueyuan.com/project/nginx/)
3. [谁说前端不需要懂-Nginx反向代理与负载均衡](https://juejin.im/post/5b01336af265da0b8a67e5c9) By chenhongdong
