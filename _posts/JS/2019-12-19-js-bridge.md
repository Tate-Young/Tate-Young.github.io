---
layout: blog
front: true
comments: True
flag: JS
background: blue
category: å‰ç«¯
title:  JSBridge
date:   2019-12-19 19:53:00 GMT+0800 (CST)
background-image: /style/images/js.png
tags:
- JavaScript
---
# {{ page.title }}

## ä»€ä¹ˆæ˜¯ JSBridge

æƒ³å½“å¹´æœ€å¼€å§‹å·¥ä½œçš„æ—¶å€™ï¼Œå°±æ˜¯åšçš„ç§»åŠ¨ç«¯ hybrid æ··åˆå¼å¼€å‘ï¼Œé‡Œé¢å¾ˆé‡è¦çš„ä¸€ç¯å°±æ˜¯ JS ä¸åŸç”Ÿ Native çš„ç›¸äº’é€šä¿¡ï¼Œè€Œå®ƒå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦ä»‹ç»çš„ä¸»äººç¿ - **JSBridge**ã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒä½œä¸ºä¸€åº§æ¡¥æ¢ï¼Œè¿æ¥äº† JS ä¸ Nativeï¼Œè®©å‰ç«¯å¯ä»¥æ–¹ä¾¿åœ°è°ƒç”¨åŸç”Ÿçš„æ‘„åƒå¤´ã€è§†é¢‘ç­‰ï¼Œè€ŒåŸç”Ÿä¹Ÿå¯ä»¥æ¥æ”¶å‰ç«¯å‘å‡ºçš„ä¿¡æ¯è€Œä½œå‡ºç›¸åº”çš„å¤„ç†ã€‚åœ¨ä»‹ç» JSBridge åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ä¼ ç»Ÿæ–¹å¼æ˜¯æ€ä¹ˆæ¥ä½¿ç”¨çš„ã€‚ä»¥ä¸‹ä¸»è¦[æ‘˜è‡ªæ·±åº¦è§£æ JSBridge è¿™ç¯‡åšå®¢](https://medium.com/@Alibaba_Cloud/in-depth-profiling-of-jsbridge-63dc797f8c77):

## ä¼ ç»Ÿæ–¹å¼ - æ³¨å…¥ API

### JS è°ƒç”¨ Native

æ³¨å…¥ API æ–¹å¼çš„ä¸»è¦åŸç†æ˜¯ï¼Œé€šè¿‡ WebView æä¾›çš„æ¥å£ï¼Œå‘ JS çš„ Context(window) ä¸­æ³¨å…¥å¯¹è±¡æˆ–è€…æ–¹æ³•ï¼Œè®© JS è°ƒç”¨æ—¶ï¼Œç›´æ¥æ‰§è¡Œç›¸åº”çš„ Native ä»£ç é€»è¾‘ï¼Œè¿™é‡Œä¹Ÿå¯¹åº”ä¸‰ä¸ªä¸åŒå¹³å°è¿›è¡Œåˆ†æ:

#### IOS(UIWebView)

```JS
// Native ä¸­é€šè¿‡å¼•å…¥å®˜æ–¹æä¾›çš„ JavaScriptCore åº“(iOS7 ä»¥ä¸Š),ç„¶åå¯ä»¥å°† api ç»‘å®šåˆ° JSContext ä¸Š
// import <JavaScriptCore/JavaScriptCore.h>

JSContext *context = [uiWebView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"];

// æ³¨å†Œæ–¹æ³•ä¸º postBridgeMessage
context[@"postBridgeMessage"] = ^(NSArray<NSArray *> *calls) {
  // Native é€»è¾‘
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢æ³¨å†Œäº†ä¸€ä¸ªåä¸º `postBridgeMessage` çš„æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨å‰ç«¯è¿›è¡Œè°ƒç”¨:

```JS
window.postBridgeMessage(message)
```

> iOS7 æ‰å‡ºç°è¿™ç§æ–¹å¼ï¼Œåœ¨è¿™ä¹‹å‰ï¼ŒJS æ— æ³•ç›´æ¥è°ƒç”¨ Nativeï¼Œåªèƒ½é€šè¿‡ JSBridge æ–¹å¼é—´æ¥è°ƒç”¨

#### IOS(WKWebView)

é¦–å…ˆï¼Œ**WKWebView** æ˜¯ ios8 ä¹‹åæ¨è¡Œçš„ï¼Œå¯ä»¥æ›¿ä»£ä¹‹å‰çš„ **UIWebView** æ§ä»¶ï¼Œè§£å†³äº†å¾ˆå¤šæ€§èƒ½å’Œå…¼å®¹ä¸Šçš„é—®é¢˜ï¼Œé‚£ä¹ˆå®ƒåˆæ˜¯æ€ä¹ˆä½¿ç”¨çš„å‘¢:

```JS
@interface WKWebVIewVC ()<WKScriptMessageHandler>

@implementation WKWebVIewVC

- (void)viewDidLoad {
  [super viewDidLoad];

  WKWebViewConfiguration* configuration = [[WKWebViewConfiguration alloc] init];
  configuration.userContentController = [[WKUserContentController alloc] init];
  WKUserContentController *userCC = configuration.userContentController;
  // æ³¨å…¥å¯¹è±¡ nativeBridge
  [userCC addScriptMessageHandler:self name:@"nativeBridge"];

  WKWebView wkWebView = [[WKWebView alloc] initWithFrame:self.view.frame configuration:configuration];
  // ...
}

- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message {
  if ([message.name isEqualToString:@"nativeBridge"]) {
    NSLog(@"å‰ç«¯ä¼ é€’çš„æ•°æ® %@: ", message.body);
    // Native é€»è¾‘
  }
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢æ³¨å†Œäº†ä¸€ä¸ªåä¸º `nativeBridge` çš„å¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨å‰ç«¯è¿›è¡Œè°ƒç”¨:

```JS
window.webkit.messageHandlers.nativeBridge.postMessage(message)
```

#### Android

```JS
public class JavaScriptInterfaceDemoActivity extends Activity {
  private WebView Wv;

  @Override
  publicvoidonCreate(Bundle savedInstanceState){
    super.onCreate(savedInstanceState);

    Wv = (WebView)findViewById(R.id.webView);
    final JavaScriptInterface myJavaScriptInterface = new JavaScriptInterface(this);

    // Android å®¹å™¨å…è®¸ JS è„šæœ¬
    Wv.getSettings().setJavaScriptEnabled(true);
    // Android å®¹å™¨è®¾ç½®ä¾¨è¿å¯¹è±¡
    Wv.addJavascriptInterface(myJavaScriptInterface, "nativeBridge");
    // ...
  }

  public class JavaScriptInterface {
    Context mContext;

    JavaScriptInterface(Context c) {
      mContext = c;
    }

    // æš´éœ²å‡ºçš„æ¥å£
    @JavascriptInterface
    public void postMessage(String webMessage){
      // Native é€»è¾‘
    }
  }
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢ç”¨ `nativeBridge` è®¾ç½®äº†ä¾¨è¿å¯¹è±¡ï¼Œå¹¶ä¸”æš´éœ²å‡ºäº† `postMessage` æ¥å£ï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡ä¸‹é¢æ–¹å¼è®¿é—®å³å¯:

```JS
// å‰ç«¯è°ƒç”¨ nativeBridge
window.nativeBridge.postMessage(message)
```

> åœ¨ Android4.2(API17) ä»¥ä¸Šç‰ˆæœ¬ï¼Œæš´éœ²çš„æ¥å£è¦åŠ ä¸Šæ³¨è§£ `@JavascriptInterface`ï¼Œå¦åˆ™ä¼šæ‰¾ä¸åˆ°è¯¥æ–¹æ³•

> åœ¨ API17 ä»¥å‰ï¼Œ`addJavascriptInterface` æ˜¯æœ‰é£é™©çš„ï¼Œé»‘å®¢å¯ä»¥é€šè¿‡åç¼–è¯‘è·å– Native æ³¨å†Œçš„ JS å¯¹è±¡ï¼Œç„¶ååœ¨é¡µé¢é€šè¿‡åå°„ Java çš„å†…ç½®é™æ€ç±»ï¼Œè·å–ä¸€äº›æ•æ„Ÿçš„ä¿¡æ¯å’Œç ´å

### Native è°ƒç”¨ JS

Native è°ƒç”¨ JS ç›¸å¯¹è¾ƒç®€å•ä¸€äº›ï¼Œåªç”¨å»æ‰§è¡Œ JS æš´éœ²å‡ºæ¥çš„å…¨å±€æ–¹æ³•å³å¯ã€‚

1ã€IOS(UIWebView)

```JS
[uiWebview stringByEvaluatingJavaScriptFromString:javaScriptString]
```

2ã€IOS(WKWebView)

```JS
// completionHandler ä¼šåœ¨ JS æ–¹æ³•æ‰§è¡Œå®Œåæ‰§è¡Œ
[wkWebView evaluateJavaScript:javaScriptString completionHandler:completionHandler]
```

3ã€Android

```JS
// ä½¿ç”¨ loadUrl çš„æ–¹å¼ï¼Œå¹¶ä¸èƒ½è·å– JavaScript æ‰§è¡Œåçš„ç»“æœ
webView.loadUrl("javascript:" + javaScriptString);
```

è€Œ Kitkat 4.4 ä¹‹åçš„ç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥ç”¨ `evaluateJavascript` æ–¹æ³•å®ç°:

```JS
webView.evaluateJavascript(javaScriptString, new ValueCallback<String>() {
  @Override
  public void onReceiveValue(String value){
    // å¯ä»¥æ‹¿åˆ° JS è¿”å›å€¼
  }
});
```

## JSBridge åŸç†

æœ‰äº†ä¸Šè¿°çš„åŒç«¯é€šä¿¡çš„åŸºç¡€é€šé“ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŸºäºæ­¤å»æ„å»ºä¸€å¥—æ˜“ç”¨çš„æ–¹æ³•å°è£…ã€‚åŒæ—¶ä¹Ÿè§£å†³äº†ä»¥ä¸‹å­˜åœ¨çš„ä¸€äº›é—®é¢˜:

1. Android4.2 ä»¥ä¸‹ `addJavascriptInterface` æ–¹å¼æœ‰å®‰å…¨æ¼æ‰
2. iOS7 ä»¥ä¸‹ JS æ— æ³•è°ƒç”¨ Native
3. url scheme æ–¹æ¡ˆè¾ƒä¸ºæˆç†Ÿ

![JSBridge](https://miro.medium.com/max/1400/0*i0r9tA8EGzSBwhAj.png)

### URL scheme

**url scheme** æ˜¯ä¸€ç§ç±»ä¼¼äº url çš„é“¾æ¥ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿ app ç›´æ¥äº’ç›¸è°ƒç”¨è®¾è®¡çš„ã€‚å…·ä½“æ¥è®²å¦‚æœæ˜¯ç³»ç»Ÿçš„ url schemeï¼Œåˆ™æ‰“å¼€ç³»ç»Ÿåº”ç”¨ï¼Œå¦åˆ™çœ‹æ˜¯å¦æœ‰ app æ³¨å†Œè¿™ç§ schemeï¼Œæœ‰åˆ™æ‰“å¼€å¯¹åº” appï¼Œæ³¨æ„è¿™ç§ scheme å¿…é¡»åŸç”Ÿ app æ³¨å†Œåæ‰ä¼šç”Ÿæ•ˆã€‚

è€Œåœ¨æˆ‘ä»¬å®é™…çš„å¼€å‘ä¸­ï¼Œapp ä¸ä¼šæ³¨å†Œå¯¹åº”çš„ schemeï¼Œè€Œæ˜¯ç”±å‰ç«¯é¡µé¢é€šè¿‡æŸç§æ–¹å¼è§¦å‘ scheme(å¦‚ç”¨ iframe.src)ï¼Œç„¶å Native ç”¨æŸç§æ–¹æ³•æ•è·å¯¹åº”çš„ url è§¦å‘äº‹ä»¶ï¼Œç„¶åæ‹¿åˆ°å½“å‰çš„è§¦å‘ urlï¼Œæ ¹æ®å®šä¹‰å¥½çš„åè®®ï¼Œåˆ†æå½“å‰è§¦å‘äº†å“ªç§æ–¹æ³•ã€‚

### æŠ€æœ¯å®ç°

è¦å®ç° JSBridgeï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤åˆ†æ:

1. è®¾è®¡å‡ºä¸€ä¸ª Native ä¸ JS äº¤äº’çš„å…¨å±€æ¡¥å¯¹è±¡
1. JS å¦‚ä½•è°ƒç”¨ Native
1. Native å¦‚ä½•å¾—çŸ¥ api è¢«è°ƒç”¨
1. åˆ†æ url å‚æ•°å’Œå›è°ƒçš„æ ¼å¼
1. Native å¦‚ä½•è°ƒç”¨J S
1. H5 ä¸­ api æ–¹æ³•çš„æ³¨å†Œä»¥åŠæ ¼å¼

æˆ‘ä»¬é¦–å…ˆè¦å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¹¶å®šä¹‰ä¸€äº›æ–¹æ³•:

```JS
const JSBridge = window.JSBridge || (window.JSBridge = {})
```

* registerHandler - æ³¨å†Œæœ¬åœ° JS æ–¹æ³•ï¼Œæ³¨å†Œå Native å¯é€šè¿‡ JSBridge è°ƒç”¨ã€‚è°ƒç”¨åä¼šå°†æ–¹æ³•æ³¨å†Œåˆ°æœ¬åœ°å˜é‡ `messageHandlers` ä¸­
* callHandler - JS è°ƒç”¨åŸç”Ÿå¼€æ”¾çš„ apiï¼Œè°ƒç”¨åå®é™…ä¸Šè¿˜æ˜¯æœ¬åœ°é€šè¿‡ url scheme è§¦å‘ã€‚è°ƒç”¨æ—¶ä¼šå°†å›è°ƒ id  å­˜æ”¾åˆ°æœ¬åœ°å˜é‡ `responseCallbacks` ä¸­
* _handleMessageFromNative - åŸç”Ÿè°ƒç”¨ JS æ³¨å†Œçš„æ–¹æ³•ï¼Œæˆ–è€…é€šçŸ¥å‰ç«¯é¡µé¢æ‰§è¡Œå›è°ƒæ–¹æ³•

![registerHandler](https://miro.medium.com/max/1400/0*2fFCZ2sM_3nyELgV.png)

åœ¨æ‰§è¡Œ `callHandler` æ—¶ï¼Œå®é™…æ‰§è¡Œäº†ä»¥ä¸‹æ­¥éª¤:

1. åˆ¤æ–­æ˜¯å¦æœ‰å›è°ƒå‡½æ•°ï¼Œè‹¥æœ‰ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªå›è°ƒå‡½æ•° idï¼Œå¹¶å°† id å’Œå¯¹åº”å›è°ƒæ·»åŠ è¿›å…¥å›è°ƒå‡½æ•°é›†åˆ responseCallbacks ä¸­
2. é€šè¿‡ç‰¹å®šçš„å‚æ•°è½¬æ¢æ–¹æ³•ï¼Œå°†ä¼ å…¥çš„æ•°æ®ã€æ–¹æ³•åä¸€èµ·æ‹¼æ¥æˆä¸€ä¸ª url scheme

```JS
// å®šä¹‰ url scheme
const uri = CUSTOM_PROTOCOL_SCHEME: // API_Name:callbackId/handlerName?data

// åˆ›å»ºéšè— iframe è¿‡ç¨‹
const messagingIframe = document.createElement('iframe')
messagingIframe.style.display = 'none'
document.documentElement.appendChild(messagingIframe)

// é€šè¿‡ iframe.src è§¦å‘ scheme
messagingIframe.src = uri
```

> ä¸ºä»€ä¹ˆé€‰æ‹© `iframe.src` ä¸é€‰æ‹© `locaiton.href` ï¼Ÿå› ä¸ºå¦‚æœé€šè¿‡ `location.href` è¿ç»­è°ƒç”¨ Nativeï¼Œåœ¨ Native å±‚åªèƒ½æ¥æ”¶åˆ°æœ€åä¸€æ¬¡è¯·æ±‚ï¼Œä»è€Œå¾ˆå®¹æ˜“ä¸¢å¤±ä¸€äº›è°ƒç”¨

ä¸Šä¸€æ­¥ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸåœ¨å‰ç«¯é¡µé¢ä¸­è§¦å‘ schemeï¼Œé‚£ä¹ˆ Native å¦‚ä½•æ•è· scheme è¢«è§¦å‘å‘¢ï¼Ÿå®‰å“å’Œ IOS æ•è·æ–¹å¼å¦‚ä¸‹:

```JS
// Android
public boolean shouldOverrideUrlLoading(WebView view, String url){
  // å¦‚æœè¿”å› falseï¼Œåˆ™ WebView å¤„ç†é“¾æ¥ urlï¼Œå¦‚æœè¿”å› trueï¼Œä»£è¡¨ WebView æ ¹æ®ç¨‹åºæ¥æ‰§è¡Œ url
  return true;
}
```

```JS
// ios
- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType {
  NSURL *url = [request URL];

  NSString *requestString = [[request URL] absoluteString];
```

æ—¢ç„¶ Native å·²ç»æ¥æ”¶åˆ°äº† JS è°ƒç”¨çš„æ–¹æ³•ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ï¼ŒåŸç”Ÿå°±åº”è¯¥æŒ‰ç…§å®šä¹‰å¥½çš„æ•°æ®æ ¼å¼æ¥è§£ææ•°æ®äº†ï¼ŒNative æ¥æ”¶åˆ° Url åï¼Œå¯ä»¥æŒ‰ç…§è¿™ç§æ ¼å¼å°†å›è°ƒå‚æ•° idã€api åã€å‚æ•°æå–å‡ºæ¥ï¼Œç„¶åå»æ‰§è¡Œ:

```JS
JSBridge._handleMessageFromNative(messageJSON)
```

åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»Ÿä¸€å‡ºä»¥ä¸‹æ–¹æ¡ˆæ¥é’ˆå¯¹ IOS å’Œå®‰å“:

![strategy](https://miro.medium.com/max/1400/0*gNSgNMbYQaeoFxDA.png)

> æ›´å¤šå¯ä»¥å‚è€ƒ IOS [**WebViewJavascriptBridge**](https://github.com/marcuswestin/WebViewJavascriptBridge) å’Œå®‰å“ [JsBridge](https://github.com/lzyzsd/JsBridge) çš„å®ç° ğŸ‘ˆ

## å‚è€ƒé“¾æ¥

1. [In-depth Profiling of JSBridge](https://medium.com/@Alibaba_Cloud/in-depth-profiling-of-jsbridge-63dc797f8c77) By Alibaba Cloud
