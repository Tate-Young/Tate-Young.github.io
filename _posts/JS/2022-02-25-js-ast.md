---
layout: blog
front: true
comments: True
flag: JS
background: blue
category: å‰ç«¯
title:  AST
date: 2022-02-25 17:14:00 GMT+0800 (CST)
background-image: /style/images/smms/ast-parse.png
tags:
- JavaScript
---
# {{ page.title }}

## ä»€ä¹ˆæ˜¯ AST

æˆ‘ä»¬æ—¥å¸¸ä¸­ç”¨åˆ°çš„ babelã€eslint ç­‰æ’ä»¶ï¼Œå…¶å®èƒŒååŸç†å°±æ¶‰åŠåˆ° ASTï¼Œå³**æŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼ŒASTï¼‰**ï¼Œå®ƒæ˜¯æºä»£ç è¯­æ³•ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºã€‚

æˆ‘ä»¬ç›´æ¥çœ‹ [**AST Explorer**](https://astexplorer.net) çš„é»˜è®¤æ —å­ï¼š

![ast explorer]( {{site.url}}/style/images/smms/ast-jscodeshift.png )

ä»å›¾ç‰‡å³ä¸Šè§’å¯ä»¥çœ‹å‡º AST å°±æ˜¯ä¸€ä¸ªè‡ªä¸Šè€Œä¸‹çš„æ ‘å½¢ç»“æ„ï¼Œæ¯ä¸€å±‚æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹ç”±ä¸€ä¸ª type å±æ€§è¡¨ç¤ºèŠ‚ç‚¹çš„ç±»å‹å¦‚ `FunctionDeclaration, BlockStatement, VariableDeclaration`ï¼Œä»¥åŠå…¶ä»–å±æ€§ç»„æˆï¼Œä»è€Œå½¢æˆä¸€ç§æ ‘çº§ç»“æ„ã€‚

## å¦‚ä½•æ‰‹å†™ä¸€ä¸ªç¼–è¯‘å™¨

> æ•´èŠ‚å†…å®¹å¯ä»¥å‚è€ƒè¿™é‡Œ [**the-super-tiny-compiler**](https://github.com/starkwang/the-super-tiny-compiler-cn/blob/master/super-tiny-compiler-chinese.js#L446) ğŸ‘ˆ

å¤§å¤šæ•°ç¼–è¯‘å™¨å¯ä»¥åˆ†æˆä¸‰ä¸ªé˜¶æ®µï¼š

* **è§£æ(Parse)** - å³å°†æºç è½¬æ¢ä¸º AST
* **è½¬æ¢(Transform)** - æ¥æ”¶ AST å¹¶å¯¹å…¶è¿›è¡Œéå†ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­å¯¹èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ã€æ›´æ–°åŠç§»é™¤ç­‰æ“ä½œ
* **ç”Ÿæˆ(Generate)** - æ ¹æ®æœ€ç»ˆ AST æ¥è¾“å‡ºä»£ç 

![parse]( {{site.url}}/style/images/smms/ast-parse.png )

## è¯æ³•åˆ†æ / è¯­æ³•åˆ†æ

è§£æä¸€èˆ¬æ¥è¯´ä¼šåˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼š

* **è¯æ³•åˆ†æ(Lexical Analysis)** - å°†ä»£ç è½¬æ¢ä¸ºä¸€ä¸ªè¯­æ³•ç‰‡æ®µæ•°ç»„ **Tokens**ã€‚Tokens æ˜¯ä¸€ä¸ªç”±ä»£ç è¯­å¥ç¢ç‰‡ç»„æˆçš„æ•°ç»„ï¼Œå†…éƒ¨å¯ä»¥æ˜¯æ•°å­—ã€æ ‡ç­¾ã€æ ‡ç‚¹ç¬¦å·ã€è¿ç®—ç¬¦ï¼Œæˆ–è€…å…¶å®ƒä»»ä½•ä¸œè¥¿
* **è¯­æ³•åˆ†æ(Syntactic Analysis)** - æŠŠ Tokens è½¬æ¢æˆ AST å½¢å¼

```js
// ç¤ºä¾‹æºç 
(add 2 (subtract 4 2))

// å¯èƒ½çš„ Tokens
[
  { type: 'paren',  value: '('        },
  { type: 'name',   value: 'add'      },
  { type: 'number', value: '2'        },
  { type: 'paren',  value: '('        },
  { type: 'name',   value: 'subtract' },
  { type: 'number', value: '4'        },
  { type: 'number', value: '2'        },
  { type: 'paren',  value: ')'        },
  { type: 'paren',  value: ')'        }
]

// å¯èƒ½çš„ AST
// Program ä»£è¡¨çš„æ˜¯æ ¹èŠ‚ç‚¹
{
  type: 'Program',
  body: [{
    type: 'CallExpression',
    name: 'add',
    params: [{
      type: 'NumberLiteral',
      value: '2'
    }, {
      type: 'CallExpression',
      name: 'subtract',
      params: [{
        type: 'NumberLiteral',
        value: '4'
      }, {
        type: 'NumberLiteral',
        value: '2'
      }]
    }]
  }]
}
```

## å¦‚ä½•æ‰‹å†™ä¸€ä¸ª eslint æ’ä»¶

æœ‰äº† AST å°±å¯ä»¥å¯¹å®ƒè¿›è¡Œä»ä¸Šåˆ°ä¸‹çš„é€’å½’éå†ï¼Œè¿‡ç¨‹ä¸­ä½¿ç”¨ä¸€ç§åä¸º**è®¿é—®è€…æ¨¡å¼**çš„è®¾è®¡æ¨¡å¼è®¿é—®æ ‘é‡Œçš„èŠ‚ç‚¹ã€‚è¿™ç§æ¨¡å¼é€šè¿‡åˆ›å»ºä¸€ä¸ªåŒ…å«ä¸€äº›æ–¹æ³•çš„å¯¹è±¡ visitorï¼Œåœ¨éå† AST è¿‡ç¨‹ä¸­åŒ¹é… visitor é‡Œçš„æ–¹æ³•åï¼ŒåŒ¹é…æˆåŠŸå°±è°ƒç”¨æ­¤æ–¹æ³•ã€‚é€šè¿‡è®¿é—® AST èŠ‚ç‚¹å¯ä»¥å¯¹æºç è¿›è¡Œè¯­æ³•æ£€æŸ¥ï¼ŒESLint å°±æ˜¯åŸºäºæ­¤å·¥ä½œçš„ã€‚

### é™åˆ¶å‡½æ•°å‚æ•°æ•°é‡

```js
export default function (context) {
  return {
    // è®¿é—® FunctionDeclaration èŠ‚ç‚¹
    FunctionDeclaration: (node) => {
      // åˆ¤æ–­å‡½æ•°å‚æ•°ä¸ªæ•°
      if (node.params.length > 3) {
        context.report({
          node,
          message: "å‚æ•°æœ€å¤šä¸èƒ½è¶…è¿‡3ä¸ª"
        });
      }
    }
  }
}
```

ç¨å¾®ä¿®é¥°ä¸‹ï¼š

```js
//------------------------------------------------------------------------------
// Rule Definition https://eslint.org/docs/developer-guide/working-with-rules
// createRule æ˜¯å¼•ç”¨äº† @typescript-eslint/experimental-utils é‡Œçš„ ESLintUtils.RuleCreator æ–¹æ³•
//------------------------------------------------------------------------------
import createRule from '../misc/createRule'

interface IOptions {
  maxLen: number
}

type TMessageIds = 'tooLong'

const rule = createRule<[IOptions], TMessageIds>({
  name: 'parametersmaxlength',
  meta: {
    type: 'suggestion',
    docs: {
      description: 'parameters max length',
      recommended: 'error',
    },
    messages: {
      tooLong: 'ä¸è¦è¶…è¿‡ {{maxLen}} ä¸ªå‚æ•°å“¦',
    },
    schema: [
      {
        type: 'object',
        properties: {
          maxLen: {
            type: 'number',
            default: 3,
          },
        },
        additionalProperties: false,
      },
    ],
  },
  defaultOptions: [
    {
      maxLen: 3,
    },
  ],
  create(context, [options]) {
    const { maxLen } = options
    /**
    * è·å–å‡½æ•°çš„å‚æ•°çš„å¼€å§‹ã€ç»“æŸä½ç½®
    * @param {node} node AST Node
    */
    function getFunctionParamsLoc(node) {
      const paramsLength = node.params.length
      return {
        start: node.params[0].loc.start,
        end: node.params[paramsLength - 1].loc.end,
      }
    }
    return {
      FunctionDeclaration: (node) => {
        if (node.params.length > maxLen) {
          context.report({
            // loc is an object specifying the location of the problem.
            // If both loc and node are specified, then the location is used from loc instead of node.
            loc: getFunctionParamsLoc(node),
            node,
            data: {
              maxLen,
            },
            messageId: 'tooLong',
          })
        }
      },
    }
  },
})

export default rule
```

### é™åˆ¶åµŒå¥—çš„æ¡ä»¶è¯­å¥

åŒ¹é…ç±»å‹ä¸º IfStatement çš„èŠ‚ç‚¹ï¼Œå¦‚æœå®ƒçš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹è¿˜æ˜¯ IfStatement å°±è¿›è¡Œæç¤ºï¼š

```js
export default function (context) {
  return {
    IfStatement(node) {
      const { consequent: { body = [] } } = node

      // åˆ¤æ–­ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ç±»å‹æ˜¯å¦æ˜¯ IfStatement
      if (body[0] && body[0].type === 'IfStatement') {
        context.report({
          node: body[0],
          message: 'ä¸å…è®¸åµŒå¥—çš„æ¡ä»¶è¯­å¥'
        })
      }
    }
  }
}
```

å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°ä¸­è‹±æ–‡ä¹‹é—´ä¿ç•™ç©ºæ ¼çš„è§„èŒƒç­‰ç­‰ï¼Œè¿™é‡Œå°±ä¸å±•å¼€ä»‹ç»äº†ã€‚

## å¦‚ä½•æ‰‹å†™ä¸€ä¸ª babel æ’ä»¶

Babel å°±æ˜¯ä¸€ä¸ªé€šç”¨çš„å¤šåŠŸèƒ½çš„ JavaScript ç¼–è¯‘å™¨ã€‚å…¶å·¥ä½œåŸç†å°±æ˜¯ä¿®æ”¹ä»£ç  AST ä¸Šçš„èŠ‚ç‚¹ï¼Œä»è€Œåˆ°è¾¾ä¿®æ”¹ä»£ç çš„ç›®çš„ã€‚ä¸€ä¸ª Babel æ’ä»¶æ˜¯ä¸€ä¸ªæ¥æ”¶ babel å¯¹è±¡ä½œä¸ºå‚æ•°çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå¸¦æœ‰ visitor å±æ€§çš„å¯¹è±¡ã€‚visitor å¯¹è±¡ä¸­çš„æ¯ä¸ªå‡½æ•°æ¥å— path å’Œ state å‚æ•°ã€‚è¯¦æƒ…å¯ä»¥æŸ¥é˜… [babel-handbook](https://github.com/jamiebuilds/babel-handbook) ğŸ‘ˆ

### å°† ** è¯­æ³•è½¬æ¢ä¸º Math.pow

```js
// Before
const a = 10 ** 2 
// After
const a = Math.pow(10, 2)
```

1. æ‰¾åˆ° ** è¯­æ³•æ‰€åœ¨ä½ç½®
1. è·å–å·¦å³æ“ä½œæ•°
1. åˆ›å»º Math.pow è¯­å¥ï¼Œæ›¿æ¢åŸèŠ‚ç‚¹

```js
export default function (babel) {
  const { types: t } = babel
  
  return {
    visitor: {
      // è®¿é—®äºŒå…ƒè¡¨è¾¾å¼
      BinaryExpression(path) {
        const { node } = path
        // å¦‚æœæ“ä½œç¬¦ä¸æ˜¯ ** å°±é€€å‡º
        if (node.operator !== '**') return
        const { left, right } = node
        // åˆ›å»ºè°ƒç”¨è¯­å¥
        const newNode = t.callExpression(
          t.memberExpression(t.identifier('Math'), t.identifier('pow')),
          [left, right]
        )
        // æ›¿æ¢åŸèŠ‚ç‚¹
        path.replaceWith(newNode)
      },
    }
  }
}
```

### ä¿®æ”¹å·¥å…·å‡½æ•°å¼•å…¥æ–¹å¼

```js
// Before
import { get, isFunction } from 'lodash'
// After
import get from "lodash/get"
import isFunction from "lodash/isFunction"
```

1. æ‰¾åˆ° lodash çš„ import èŠ‚ç‚¹
1. éå†æ‰€æœ‰çš„å¼•å…¥å€¼ï¼Œè·å–å¼•ç”¨çš„ name å±æ€§
1. æ’å…¥æ–°ç”Ÿæˆçš„ import èŠ‚ç‚¹
1. åˆ é™¤åŸèŠ‚ç‚¹

```js
export default function (babel) {
  const { types: t } = babel
  
  return {
    visitor: {
      // è®¿é—®å¯¼å…¥å£°æ˜
      ImportDeclaration(path) {
        let { node } = path
        if (node.source.value !== 'lodash') return
        const val = node.source.value

        node.specifiers.forEach((spec) => {
          if (t.isImportSpecifier(spec)) {
            const { local } = spec

            // æ’å…¥æ–°çš„å¯¼å…¥èŠ‚ç‚¹
            path.insertBefore(
              t.importDeclaration(
                [t.importDefaultSpecifier(local)],
                t.stringLiteral(`${val}/${local.name}`)
              )
            )
          }
        })
        // åˆ é™¤åŸèŠ‚ç‚¹
        path.remove()
      },
    }
  }
}
```

## AST å·¥å…·åº“ä»‹ç»

### jscodeshift

[**jscodeshift**](https://github.com/facebook/jscodeshift) æ˜¯ä¸€ä¸ª Facebook å¼€æºçš„åŸºäº [recast](https://github.com/benjamn/recast) å°è£…çš„ç”¨æ¥å¯¹ JavaScript æˆ–è€… TypeScript æ–‡ä»¶è¿è¡Œè½¬æ¢çš„å·¥å…·ï¼Œå®ƒçš„ç›®çš„æ˜¯æ›´æ–¹ä¾¿çš„æ‰¹é‡ä¿®æ”¹ä»£ç ã€‚å®ƒé€šè¿‡ transformer å¯¹æºç è¿›è¡Œè½¬æ¢ï¼Œä¸€ä¸ª transformer å°±æ˜¯ä¸€ä¸ªæ¥å— `fileInfo, api, options` å‚æ•°å¹¶è¿”å›æºç çš„å‡½æ•°ã€‚

MUI æ‰¹é‡ä¿®æ”¹ä»£ç çš„è„šæœ¬å°±æ˜¯åŸºäº jscode æ¥å®ç°çš„ï¼Œå³ [codemod](https://mui.com/zh/guides/migration-v4/#run-codemods)ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

```js
// boxRenameGap
import renameProps from './misc/renameProps'

/**
 * @param {import('jscodeshift').FileInfo} file
 * @param {import('jscodeshift').API} api
 */
export default function transformer(file, api, options) {
  const j = api.jscodeshift
  const root = j(file.source)

  const { printOptions } = options

  return renameProps({
    root,
    componentName: 'Box',
    props: { gridGap: 'gap', gridColumnGap: 'columnGap', gridRowGap: 'rowGap' },
  }).toSource(printOptions)
}
```

> å…·ä½“ä»£ç å¯ä»¥å‚è€ƒ github [mui-codemod](https://github.com/mui/material-ui/tree/master/packages/mui-codemod) è¿™é‡Œ ğŸ‘ˆ

### GoGoCode

GoGoCode å·ç§°å…¨ç½‘æœ€ç®€å•ï¼Œæ˜“ä¸Šæ‰‹ï¼Œå¯è¯»æ€§æœ€å¼ºï¼Œæä¾›ç±»ä¼¼äº jQuery çš„ API å’Œä¸€å¥—å’Œæ­£åˆ™è¡¨è¾¾å¼æ¥è¿‘çš„è¯­æ³•ç”¨æ¥åŒ¹é…å’Œæ›¿æ¢ä»£ç ã€‚ä¸è¿‡ç¡®å®ä¸Šæ‰‹éš¾åº¦æ¯” jscodeshift ä½å¾ˆå¤šï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒè¿›è¡Œ vue2 åˆ° vue3 çš„è¿ç§»ã€‚ç›´æ¥çœ‹ä¸ªå®˜æ–¹ä¾‹å­ï¼š

```js
// before
const a = 1;
const b = 2;

// after
const a = 1;
const b = 1;
```

```js
const $ = require('gogocode');
const script = $(source);
// æŒ‰ç…§ä½ çš„æ„å›¾ï¼Œç”¨ $_$ å½“é€šé…ç¬¦èƒ½åŒ¹é…ä»»æ„ä½ç½®çš„ AST èŠ‚ç‚¹
const aAssignment = script.find('const a = $_$');
// è·å¾—æˆ‘ä»¬åŒ¹é…çš„ AST èŠ‚ç‚¹çš„ value
const aValue = aAssignment.match?.[0]?.[0]?.value;
// å°±åƒæ›¿æ¢å­—ç¬¦ä¸²ä¸€æ ·å»æ›¿æ¢ä»£ç 
// ä½†å¯ä»¥å¿½ç•¥ç©ºæ ¼ã€ç¼©è¿›æˆ–è€…æ¢è¡Œçš„å½±å“
script.replace('const b = $_$', `const b = ${aValue}`);
// æŠŠ ast èŠ‚ç‚¹è¾“å‡ºæˆå­—ç¬¦ä¸²
const outCode = script.generate();
```

> æ›´å¤šå…³äº AST å·¥å…·å¯ä»¥å‚è€ƒ [awesome ast](https://github.com/cowchimp/awesome-ast) ğŸ‘ˆ

## å‚è€ƒé“¾æ¥

1. [Babel æ’ä»¶æ‰‹å†Œ](https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md)
2. [å­¦ä¹ æŠ½è±¡è¯­æ³•æ ‘ AST](https://juejin.cn/post/6955373675637899301) By è¥¿å±±å±…å½­äºæ™
