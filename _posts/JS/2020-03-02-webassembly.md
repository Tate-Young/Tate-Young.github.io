---
layout: blog
front: true
comments: True
flag: JS
background: blue
category: å‰ç«¯
title:  WebAssembly
date:   2020-03-02 17:02:00 GMT+0800 (CST)
background-image: https://i.loli.net/2020/03/02/GaMNXmKHgqtPdzT.png
tags:
- JavaScript
---
# {{ page.title }}

## ä»€ä¹ˆæ˜¯ WebAssembly

TLDR - å‚è€ƒ MDNï¼Œæˆ‘ä»¬å¾—çŸ¥ [**WebAssembly**](https://developer.mozilla.org/zh-CN/docs/WebAssembly) **æ˜¯ä¸€ç§æ–°çš„ç¼–ç æ–¹å¼**ï¼Œå¯ä»¥åœ¨ç°ä»£æµè§ˆå™¨ä¸­è¿è¡Œã€‚å®ƒæ˜¯ä¸€ç§ä½çº§çš„ç±»æ±‡ç¼–è¯­è¨€ï¼Œå…·æœ‰ç´§å‡‘çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œå¯ä»¥æ¥è¿‘åŸç”Ÿçš„æ€§èƒ½è¿è¡Œï¼Œå¹¶ä¸ºè¯¸å¦‚ C/C++ ç­‰è¯­è¨€æä¾›ä¸€ä¸ªç¼–è¯‘ç›®æ ‡ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨ Web ä¸Šè¿è¡Œã€‚å®ƒä¹Ÿè¢«è®¾è®¡ä¸ºå¯ä»¥ä¸ JavaScript å…±å­˜ï¼Œå…è®¸ä¸¤è€…ä¸€èµ·å·¥ä½œã€‚

## asm.js / Emscripten

é‚£ä¹ˆæœ‰åŒå­¦å°±é—®äº†ï¼Œä¸ºå•¥è¦ç¼–è¯‘ C/C++ åˆ°ç½‘é¡µä¸Šè¿è¡Œå‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ Web æŠ€æœ¯å‘å±•è¿…çŒ›ï¼Œä½†æ˜¯é’ˆå¯¹ä¸€äº›æ¸¸æˆæˆ–è€…ä½¿ç”¨è¯¥è¯­è¨€å¼€å‘çš„åº”ç”¨ï¼Œæˆ‘ä»¬ä»ç„¶æ²¡æœ‰åŠæ³•è®©ä»–ä»¬åœ¨æµè§ˆå™¨ä¸Šé«˜æ•ˆåœ°è¿è¡Œã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å°†ç¼–ç¨‹è¯­è¨€è½¬æ¢ä¸º JavaScriptã€‚[Alon Zakai](https://github.com/kripken?tab=repositories) å¤§ä½¬ä¸ºæ­¤ä¸“é—¨åšäº†ä¸€ä¸ªç¼–è¯‘å™¨é¡¹ç›® [**Emscripten**](https://emscripten.org)ã€‚è¿™ä¸ªç¼–è¯‘å™¨å¯ä»¥å°† C/C++ ä»£ç ç¼–è¯‘æˆä¸€ç§ JavaScript çš„å˜ä½“ï¼Œå³ [**asm.js**](http://asmjs.org)ã€‚

![Emscripten toolchain](https://emscripten.org/_images/EmscriptenToolchain.png)

C/C++ ç¼–è¯‘æˆ JS æœ‰ä¸¤ä¸ªæœ€å¤§çš„éš¾ç‚¹ï¼Œå³:

1. C/C++ æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œè€Œ JS æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ã€‚
2. C/C++ æ˜¯æ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼Œè€Œ JS ä¾é åƒåœ¾å›æ”¶æœºåˆ¶ã€‚

asm.js å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜è€Œè®¾è®¡çš„ï¼š**asm.js çš„å˜é‡ä¸€å¾‹éƒ½æ˜¯é™æ€ç±»å‹ï¼Œå¹¶ä¸”å–æ¶ˆåƒåœ¾å›æ”¶æœºåˆ¶**ã€‚é™¤äº†è¿™ä¸¤ç‚¹ï¼Œå®ƒä¸ JavaScript å¹¶æ— å·®å¼‚ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œasm.js æ˜¯ JavaScript çš„ä¸€ä¸ªé«˜åº¦ä¼˜åŒ–çš„å­é›†ï¼Œåªèƒ½ä½¿ç”¨åè€…çš„ä¸€éƒ¨åˆ†è¯­æ³•ã€‚å¹¶ä¸” JavaScript å¼•æ“è¿˜ä¼šé’ˆå¯¹ asm.js ä½¿ç”¨ AOT é¢„ç¼–è¯‘æ¥ä¼˜åŒ–æé€Ÿã€‚

> This specification defines asm.js, a strict subset of JavaScript that can be used as a low-level, efficient target language for compilers. This sublanguage effectively describes a sandboxed virtual machine for memory-unsafe languages like C or C++. A combination of static and dynamic validation allows JavaScript engines to employ an ahead-of-time (AOT) optimizing compilation strategy for valid asm.js code.

## WebAssembly

é‚£è¿˜æœ‰åŸå› å°±æ˜¯ JavaScript è‡ªèº«æ€§èƒ½ç“¶é¢ˆé—®é¢˜ï¼Œæˆ‘ä»¬çŸ¥é“ç¼–ç¨‹è¯­è¨€ä¸è®¡ç®—æœºçš„äº¤æµå¿…é¡»ä¾é â€œç¿»è¯‘å®˜â€ï¼Œè®©è®¡ç®—æœºæ˜ç™½ä½ è¦å¹²å˜›ã€‚è€Œè¿™ä¸ªâ€œç¿»è¯‘å®˜â€å°±æ˜¯è§£é‡Šå™¨æˆ–ç¼–è¯‘å™¨:

* **è§£é‡Šå™¨** - ä¸€è¡Œè¡Œè¯»å–æºä»£ç ï¼Œå¹¶ä¸”ç›´æ¥ç”ŸæˆæŒ‡ä»¤è®©è®¡ç®—æœºç¡¬ä»¶æ‰§è¡Œï¼Œä¸ä¼šè¾“å‡ºå¦å¤–ä¸€ç§ä»£ç ã€‚ç›¸æ¯”ä¸‹æ•ˆç‡ä¼šè¾ƒä½
* **ç¼–è¯‘å™¨** - æ‰§è¡Œå‰ç¿»è¯‘å¥½ï¼Œå°†æºä»£ç è½¬æ¢æˆå…¶ä»–çš„æ›´ä½çº§çš„ä»£ç (ä¾‹å¦‚äºŒè¿›åˆ¶ç ã€æœºå™¨ç )ï¼Œä½†æ˜¯ä¸ä¼šæ‰§è¡Œå®ƒã€‚æ‰§è¡Œçš„æ•ˆç‡ä¼šæ›´åŠ é«˜ï¼Œé¢„ç¼–è¯‘ä¼šæ¶ˆè€—ä¸€äº›æ—¶é—´ã€‚

> **ä½çº§è¯­è¨€ä»£ç (Low-Level Code)** æ˜¯ç›¸å¯¹é«˜çº§è¯­è¨€(High-Level Code)è€Œè¨€ï¼Œå°‘äº†æ›´å¤šçš„æŠ½è±¡æ¦‚å¿µï¼Œæ›´åŠ æ¥è¿‘äºæ±‡ç¼–æˆ–è€…æœºå™¨æŒ‡ä»¤

è€Œæµè§ˆå™¨æœ€å¼€å§‹ä½¿ç”¨çš„å°±æ˜¯ JavaScript è§£é‡Šå™¨ï¼Œåœ¨ 2008 å¹´ï¼Œ**å³æ—¶ç¼–è¯‘å™¨(JITs)** ä¸€ç»æ¨å‡ºï¼ŒJavaScript è¿è¡Œé€Ÿåº¦è¹­è¹­ä¸Šæ¶¨ï¼Œéšç€æ€§èƒ½çš„æ”¹è¿›ï¼Œæˆ‘ä»¬å¯ä»¥è¿ç”¨ JavaScript åšæ›´å¤šçš„äº‹æƒ…ï¼Œæ¯”å¦‚ Electron æ„å»ºè·¨å¹³å°åº”ç”¨ç¨‹åºç­‰ã€‚å¯æƒ³è€ŒçŸ¥ï¼Œéšç€ WebAssembly çš„ç››è¡Œï¼ŒWeb æŠ€æœ¯åˆå°†è¿æ¥ä¸€åœºé©æ–°ï¼Œæˆ‘ä»¬æ‹­ç›®ä»¥å¾…ã€‚

é‚£ä¹ˆ WebAssembly ç©¶ç«Ÿç»™æˆ‘ä»¬å¸¦æ¥äº†ä»€ä¹ˆå‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬çŸ¥é“ï¼Œå®ƒè·Ÿ JavaScript æ²¡æœ‰åŠæ¯›é’±å…³ç³»ï¼Œ**WebAssembly æ˜¯ç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘ä¹‹åçš„ä»£ç ï¼Œä½“ç§¯å°ã€èµ·æ­¥å¿«ã€‚åœ¨è¯­æ³•ä¸Šå®Œå…¨è„±ç¦» JavaScriptï¼ŒåŒæ—¶å…·æœ‰æ²™ç›’åŒ–çš„æ‰§è¡Œç¯å¢ƒã€‚WebAssembly åŒæ ·çš„å¼ºåˆ¶é™æ€ç±»å‹ï¼Œæ˜¯ C/C++/Rust çš„ç¼–è¯‘ç›®æ ‡**ã€‚

ç»¼ä¸Šæè¿°ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°å’Œ asm.js æœ‰å¾ˆå¤šç›¸ä¼¼ç‚¹ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¸€äº›åœ°æ–¹ä¸åŒï¼Œè€Œ Emscripten ä¹Ÿæ”¯æŒè½¬æ¢ä¸¤ç§ä¸åŒçš„è¯­è¨€ã€‚ä¸ç®¡ä½ ä½¿ç”¨çš„ä»€ä¹ˆå·¥å…·é“¾ï¼Œæœ€ç»ˆçš„ç»“æœéƒ½åº”è¯¥æ˜¯ä»¥ `.wasm` ç»“å°¾çš„æ–‡ä»¶:

1. asm.js æ˜¯æ–‡æœ¬ï¼ŒWebAssembly æ˜¯äºŒè¿›åˆ¶å­—èŠ‚ç ï¼Œå› æ­¤è¿è¡Œé€Ÿåº¦æ›´å¿«ã€ä½“ç§¯æ›´å°
2. asm.js å¯ä»¥æ”¯æŒæ‰‹å†™ï¼Œæ›´ç›´è§‚ï¼Œä¸å­˜åœ¨æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜

æ€»ä½“è€Œè¨€ï¼Œä½¿ç”¨ WebAssemblyï¼Œå¯ä»¥æ›´å¿«åœ°åœ¨ web åº”ç”¨ä¸Šè¿è¡Œä»£ç ã€‚å®ƒçš„è¿è¡Œé€Ÿåº¦æ¯” JavaScript é«˜æ•ˆçš„åŸå› æœ‰ä»¥ä¸‹å‡ ä¸ª:

1. æ–‡ä»¶åŠ è½½ - WebAssembly æ–‡ä»¶ä½“ç§¯æ›´å°ï¼Œæ‰€ä»¥ä¸‹è½½é€Ÿåº¦æ›´å¿«
2. è§£æ - è§£ç  WebAssembly æ¯”è§£æ JavaScript è¦å¿«
3. ç¼–è¯‘å’Œä¼˜åŒ– - ç¼–è¯‘å’Œä¼˜åŒ–æ‰€éœ€çš„æ—¶é—´è¾ƒå°‘ï¼Œå› ä¸ºåœ¨å°†æ–‡ä»¶æ¨é€åˆ°æœåŠ¡å™¨ä¹‹å‰å·²ç»è¿›è¡Œäº†æ›´å¤šä¼˜åŒ–ï¼ŒJavaScript éœ€è¦ä¸ºåŠ¨æ€ç±»å‹å¤šæ¬¡ç¼–è¯‘ä»£ç 
4. é‡æ–°ä¼˜åŒ– - WebAssembly ä»£ç ä¸éœ€è¦é‡æ–°ä¼˜åŒ–ï¼Œå› ä¸ºç¼–è¯‘å™¨æœ‰è¶³å¤Ÿçš„ä¿¡æ¯å¯ä»¥åœ¨ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶è·å¾—æ­£ç¡®çš„ä»£ç 
5. æ‰§è¡Œ - æ‰§è¡Œå¯ä»¥æ›´å¿«ï¼ŒWebAssembly æŒ‡ä»¤æ›´æ¥è¿‘æœºå™¨ç 
6. åƒåœ¾å›æ”¶ - ç›®å‰ WebAssembly ä¸ç›´æ¥æ”¯æŒåƒåœ¾å›æ”¶ï¼Œåƒåœ¾å›æ”¶éƒ½æ˜¯æ‰‹åŠ¨æ§åˆ¶çš„ï¼Œæ‰€ä»¥æ¯”è‡ªåŠ¨åƒåœ¾å›æ”¶æ•ˆç‡æ›´é«˜

ä¸‹å›¾æ˜¯ Unity WebGL ä½¿ç”¨ WebAssembly å’Œ asm.js çš„è¯„åˆ†ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹ï¼Œæ›´å¤šå¯¹æ¯”å¯ä»¥[å‚è€ƒè¿™é‡Œ](https://blogs.unity3d.com/2018/09/17/webassembly-load-times-and-performance/) ğŸ‘ˆ:

![WebAssembly BenchMark](https://blogs.unity3d.com/wp-content/uploads/2018/09/image3-2.png)

ç›®å‰å¸¸ç”¨çš„èƒ½æ”¯æŒç¼–è¯‘æˆ WebAssembly çš„å·¥å…·æœ‰:

* Emscripten - ä¸Šé¢å·²ç»è®²åˆ°äº†ï¼Œä¹Ÿæ”¯æŒè½¬æ¢ä¸º asm.js
* [**AssemblyScript**](https://github.com/AssemblyScript/assemblyscript) - è¯­æ³•å’Œ TypeScript å·®ä¸å¤šï¼Œå¯¹äºå‰ç«¯å­¦ä¹ æˆæœ¬è¾ƒä½
* [WABT](https://github.com/WebAssembly/wabt) - æ˜¯å°† WebAssembly åœ¨å­—èŠ‚ç å’Œæ–‡æœ¬æ ¼å¼ç›¸äº’è½¬æ¢çš„ä¸€ä¸ªå·¥å…·

> è¿™ä¸¤ç§æŠ€æœ¯è™½ç„¶éƒ½æ˜¯æé«˜æå‡ web ç¨‹åºæ€§èƒ½çš„æŠ€æœ¯ï¼Œä½†ä¸€èˆ¬å¼€å‘ä¸­ä¸ä¼šä½¿ç”¨åˆ°ï¼Œåªæœ‰åœ¨å¯†é›†å‹è®¡ç®—ã€å›¾å½¢å¤„ç†ç­‰è®¡ç®—åœºæ™¯æ‰èƒ½å‘æŒ¥å‡ºå®ƒä»¬çš„å·¨å¤§ä¼˜åŠ¿ã€‚æ¯”å¦‚ Google Earthã€‚

> å…·ä½“å®æ“çš„è¯å¯ä»¥å‚è€ƒä¸‹å®˜ç½‘çš„[å¼€å‘è€…å¼•å¯¼](https://www.wasm.com.cn/getting-started/developers-guide/) ğŸ‘ˆ

## å‚è€ƒé“¾æ¥

1. [asm.js å’Œ Emscripten å…¥é—¨æ•™ç¨‹](http://www.ruanyifeng.com/blog/2017/09/asmjs_emscripten.html) By é˜®ä¸€å³°
2. [An Abridged Cartoon Introduction To WebAssembly](https://www.smashingmagazine.com/2017/05/abridged-cartoon-introduction-webassembly/) By Lin
3. [WebAssembly å®Œå…¨å…¥é—¨ â€”â€” äº†è§£ wasm çš„å‰ä¸–ä»Šèº«](https://www.cnblogs.com/detectiveHLH/p/9928915.html) By detectiveHLH
