---
layout: blog
front: true
comments: True
flag: JS
background: blue
category: å‰ç«¯
title:  Error å¤„ç†æœºåˆ¶
date:   2018-02-06 11:28:00 GMT+0800 (CST)
update: 2019-03-15 17:25:00 GMT+0800 (CST)
background-image: http://img.zcool.cn/community/01e70755db347c6ac7251df8aed0e0.jpg@900w_1l_2o_100sh.jpg
tags:
- JavaScript
---
# {{ page.title }}

## Error ç±»å‹

é€šè¿‡ Error çš„æ„é€ å™¨å¯ä»¥åˆ›å»ºä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼Œå½“è¿è¡Œæ—¶é”™è¯¯äº§ç”Ÿæ—¶ï¼ŒError çš„å®ä¾‹å¯¹è±¡ä¼šè¢«æŠ›å‡ºã€‚é€šå¸¸ Error å®ä¾‹å¯¹è±¡æœ‰å¦‚ä¸‹å±æ€§ï¼š

| å±æ€§ | æè¿° |
|:-------------|:------------|
| message | é”™è¯¯ä¿¡æ¯ |
| name | é”™è¯¯åç§° |
| stack | é”™è¯¯å †æ ˆ(Non-standard) |

```js
var err = new Error('æˆ‘å°±æ˜¯ä¸ªé”™è¯¯');
err.message; // 'æˆ‘å°±æ˜¯ä¸ªé”™è¯¯'
err.name; // 'Error'
```

é™¤äº†é€šç”¨çš„ Error æ„é€ å‡½æ•°å¤–ï¼ŒJavaScript è¿˜æœ‰ 6 ä¸ªå…¶ä»–ç±»å‹çš„é”™è¯¯æ„é€ å‡½æ•°:

| æ´¾ç”Ÿå¯¹è±¡ | æè¿° | ä¸¾ä¸ªæ —å­ |
|:-------------|:------------||:-------------|
| ReferenceError | æ— æ•ˆå¼•ç”¨ | x; // ReferenceError: x is not defined |
| SyntaxError | è¯­æ³•è§£æé”™è¯¯ | var 1a; // SyntaxError: Invalid or unexpected token |
| RangeError | æ•°å€¼å˜é‡æˆ–å‚æ•°è¶…å‡ºå…¶æœ‰æ•ˆèŒƒå›´ | new Array(-1); // RangeError: Invalid array length |
| TypeError | å˜é‡æˆ–å‚æ•°ä¸å±äºæœ‰æ•ˆç±»å‹ | new 'Tate'; // TypeError: "Tate" is not a constructor |
| URIError | ç¼–ç æˆ–è§£ç æ—¶ä¼ é€’çš„å‚æ•°æ— æ•ˆ | decodeURI('%2'); URIError: URI malformed |
| EvalError | eval()æ‰§è¡Œé”™è¯¯ | åªä¸ºä»£ç å…¼å®¹ï¼Œå¼‚å¸¸ä¸å†æŠ›å‡º |

## é”™è¯¯å¤„ç†

### throw

**throw** è¯­å¥ä¸­æ–­ç¨‹åºæ‰§è¡Œï¼Œå¹¶æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚

```js
// throw å¯ä»¥æŠ›å‡ºä»»ä½•ç±»å‹çš„å€¼ã€‚
throw 'Tate'; // Uncaught Tate
throw 1; // Uncaught 1

var a = -1;
if (a < 0) {
  throw new Error('a å¿…é¡»ä¸ºæ­£æ•°'); // Error: a å¿…é¡»ä¸ºæ­£æ•°
}
console.log(a); // æœªæ‰§è¡Œ
```

### try / catch / finally

**try** ä»£ç å—æŠ›å‡ºçš„å¼‚å¸¸ä¼šè¢« **catch** æ•è·ï¼Œæ— è®ºæ˜¯å¦æœ‰å¼‚å¸¸ï¼Œéƒ½ä¼šæœ€åæ‰§è¡Œ **finally** ä»£ç å—ã€‚ä¸” try ä»£ç å—é‡ŒæŠ›å‡ºçš„å¼‚å¸¸ä¸ä¼šä¸­æ–­ç¨‹åºæ‰§è¡Œã€‚

```js
try {
    foo.bar();
} catch (e) {
  if (e instanceof ReferenceError) {
    console.log(e.name + ": " + e.message);
  } else if (e instanceof TypeError) {
    console.log(e.name + ": " + e.message);
}
  throw new Error('Tate') // æ­¤å¼‚å¸¸åœ¨ finally æ‰§è¡Œä¹‹åæŠ›å‡º
} finally {
  console.log('finally'); // 'finally'
}
```

### è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹

```js
// Create a new object, that prototypally inherits from the Error constructor.
function MyError(message) {
  this.name = 'MyError';
  this.message = message || 'Default Message';
  this.stack = (new Error()).stack;
}

MyError.prototype = Object.create(Error.prototype);
MyError.prototype.constructor = MyError;

try {
  throw new MyError('custom message');
} catch (e) {
  console.log(e.message);  // 'custom message'
  console.log(e.name);     // 'MyError'
}
```

## Sentry

### é…ç½®

[**Sentry**](https://sentry.io/welcome/) æ˜¯ä¸€ä¸ªå¯å®æ—¶æ•æ‰é”™è¯¯å¹¶æ±‡é›†æ—¥å¿—çš„å¹³å°ã€‚ä»¥ä¸‹çš„ç¤ºä¾‹å‚ç…§ React é¡¹ç›®:

1ã€é¦–å…ˆåœ¨ Sentry å®˜ç½‘åˆ›å»ºä¸€ä¸ª React é¡¹ç›®ï¼Œæ­¤æ—¶ä¼šè·å–è¯¥é¡¹ç›®ä¸‹çš„ **DSN**ï¼Œå®ƒç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆ:

* åè®®
* éªŒè¯ SDK çš„å…¬é’¥å’Œå¯†é’¥
* ç›®æ ‡ Sentry æœåŠ¡å™¨
* éªŒè¯ç”¨æˆ·ç»‘å®šçš„é¡¹ç›® id

```TEXT
<!--  æ ¼å¼ï¼š'{PROTOCOL}://{PUBLIC_KEY}:{SECRET_KEY}@{HOST}/{PATH}{PROJECT_ID}' -->
https://f0adb1c13dd0407fa806a1a9015daccb@sentry.io/1411582
```

![sentry-dsn.png]( {{site.url}}/style/images/smms/sentry-dsn.png )

2ã€åœ¨å®¢æˆ·ç«¯å®‰è£… **raven-js**(Official Sentry SDKs for JavaScript):

```JS
// yarn add raven-js

import createSagaMiddleware from 'redux-saga'
import Raven from 'raven-js'
import createRavenMiddleware from 'raven-for-redux'

const sagaMiddleware = createSagaMiddleware({
  onError(error) {
    // Capturing Errors / Exceptions
    Raven.captureException(error)
  },
})
const middlewares = [sagaMiddleware]
// å¿…é¡»é…ç½® Raven.js ä½¿ç”¨ Sentry DSN
if (process.env.NODE_ENV === 'production') {
  const RAVEN_DSN = 'https://f0adb1c13dd0407fa806a1a9015daccb@sentry.io/1411582'
  Raven.config(RAVEN_DSN).install()

  middlewares.push(createRavenMiddleware(Raven))
}
```

> config ä¹Ÿæ”¯æŒå…¶ä»–ä¸€äº›å‚æ•°çš„è‡ªå®šä¹‰ï¼Œ[è¯¦ç»†è¯·çœ‹è¿™é‡Œ](https://docs.sentry.io/clients/javascript/config/) ğŸ‘ˆ

raven-js æ˜¯æ—§çš„ SDKï¼Œç›®å‰æ–°çš„ä¸º `@sentry/browser`(Sentryâ€™s browser JavaScript SDK))ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹:

```JS
// yarn add @sentry/browser

import { init, captureMessage } from '@sentry/browser'

// init ä¹Ÿæ”¯æŒå¤šç§ options
init({
  dsn: '__DSN__',
  beforeSend(event) {
    // Modify the event here
    if (event.user) {
      // Don't send user's email address
      delete event.user.email;
    }
    return event;
  }
  // ...
})
// Capturing Messages
captureMessage('Hello, world!')
```

3ã€åœ¨ React ç»„ä»¶ä¸­å¯ä»¥é€šè¿‡ `componentDidCatch` æ•è· error:

```JS
// è¿™ä¸ªç”Ÿå‘½å‘¨æœŸè¢«è°ƒç”¨æ˜¯åœ¨æŸä¸ªåä»£ç»„ä»¶å·²ç»æŠ›å‡ºä¸€ä¸ªé”™è¯¯ä¹‹å
// error æ˜¯è¢«æŠ›å‡ºçš„é”™è¯¯
// info æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¸¦æœ‰ä¸€ä¸ª componentStack é”®
componentDidCatch(error, errorInfo) {
  Raven.captureException(error, { extra: errorInfo });
}
```

> JS è¿è¡ŒæœŸé—´ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ä¸”é”™è¯¯æ²¡æœ‰è¢« `try catch` ç­‰æ•æ‰ï¼Œå°±ä¼šå†’æ³¡åˆ° windowï¼Œè§¦å‘ `onError` äº‹ä»¶ã€‚å½“ç„¶èµ„æºåŠ è½½å¤±è´¥ï¼Œæ¯”å¦‚ `img`ã€`script` åªä¼šæ‰§è¡Œè¯¥å…ƒç´  `onerror`ï¼Œè€Œä¸ä¼šå†’æ³¡åˆ° `window.onerror`

è®©æˆ‘ä»¬æ¥çœ‹ä¸ªæ —å­:

```JS
Raven.captureMessage('sentry test from activity')
```

![sentry-capture-message.png]( {{site.url}}/style/images/smms/sentry-capture-message.png )

åŒæ—¶é»˜è®¤ç»‘å®šçš„é‚®ç®±ä¹Ÿä¼šæ”¶åˆ°é€šçŸ¥:

![sentry-email.png]( {{site.url}}/style/images/smms/sentry-email.png )

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨ä¸‹æ–¹çš„ JS è°ƒç”¨å †æ ˆä¸­ï¼Œå¯¹åº”çš„æ˜¯å‹ç¼©å JS æ–‡ä»¶ä½ç½®ï¼Œå’Œæˆ‘ä»¬æºä»£ç æ— æ³•å¯¹åº”ä¸Šï¼Œæ— æ³•ç›´æ¥çš„å¸®åŠ©æˆ‘ä»¬æ’æŸ¥å’Œå®šä½é—®é¢˜ã€‚è¿™æ—¶æˆ‘ä»¬éœ€è¦ä¸Šä¼ å¯¹åº”æ–‡ä»¶çš„ `sourcemap`ã€‚

### sourcemap

ä¸€èˆ¬æƒ…å†µæºç éœ€è¦ç»è¿‡è½¬æ¢(å¦‚ç¼–è¯‘ã€å‹ç¼©ã€æ··æ·†ç­‰)ï¼Œæ‰èƒ½æŠ•å…¥åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œæ­¤æ—¶ debug çš„æ—¶å€™æ— æ³•å®šä½ï¼Œ**sourcemap** å°±æ´¾ä¸Šäº†ç”¨åœºã€‚å®ƒæ˜¯ä¸€ä¸ªä¿¡æ¯æ–‡ä»¶ï¼Œé‡Œé¢å‚¨å­˜ç€ä½ç½®ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè½¬æ¢åçš„ä»£ç çš„æ¯ä¸€ä¸ªä½ç½®ï¼Œéƒ½å¯¹åº”ç€è½¬æ¢å‰çš„ä½ç½®ã€‚

#### æ‰‹åŠ¨ä¸Šä¼ 

1ã€é¦–å…ˆéœ€è¦å®‰å“å®¢æˆ·ç«¯:

```SHELL
yga sentry-cli-binary
```

2ã€ç„¶åé€šè¿‡ `sentry-cli` å‘½ä»¤ç™»é™† Sentry:

```SHELL
sentry-cli login
```

3ã€ç™»é™†æ—¶ä¼šæç¤ºè¾“å…¥ `token`ï¼Œå¯ä»¥åœ¨å¹³å°ç›´æ¥ç”Ÿæˆ:

![sentry-auth-token.png]( {{site.url}}/style/images/smms/sentry-auth-token.png )

4ã€ç„¶åä¼šæœ‰ç”Ÿæˆæ–‡ä»¶ `.sentryclirc` çš„æç¤ºï¼Œå†…å®¹å¦‚ä¸‹:

```TEXT
[auth]
token=61e48843a1224f20a662afeb4b8182984c02d61420ef4d38a6b70b369c0e28f7

[defaults]
url=https://sentry.io/
```

ä¿®æ”¹æ–‡ä»¶ï¼Œè¿½åŠ  org å’Œ project ä¿¡æ¯:

```TEXT
project=react // é¡¹ç›®å
org=orgname // ç»„ç»‡å
```

4ã€åˆ›å»º releaseï¼Œåˆ›å»ºå¥½çš„ release å¯ä»¥ä» Sentry å¹³å°ä¾§è¾¹æ çš„ `Releases` ä¸­æŸ¥çœ‹:

```SHELL
sentry-cli releases -o å›¢é˜Ÿåç§° -p é¡¹ç›®åç§° new releaseåç§°
```

5ã€åœ¨å®¢æˆ·ç«¯ Raven åˆå§‹åŒ–æ—¶è®¾ç½®å¯¹åº”çš„ release option:

```JS
Raven.config(__DSN__, {
  release: 'releaseåç§°'
}).install();
```

6ã€ä¸Šä¼  sourcemap è‡³æŒ‡å®š release:

```SHELL
# URL_PREFIX å¿…é¡»ä½ è¦ä¸ js æ–‡ä»¶è®¿é—®çš„è·¯å¾„ä¿æŒä¸€è‡´
# DIR ä¸ºæœ¬åœ° sourcemap ç›®å½•
sentry-cli releases -o å›¢é˜Ÿåç§° -p é¡¹ç›®åç§° files releaseåç§° upload-sourcemaps --url-prefix URL_PREFIX DIR
```

#### è‡ªåŠ¨ä¸Šä¼ 

ä¸Šè¿°æ‰‹åŠ¨ä¸Šä¼  sourcemap çš„è¯æœªå…æœ‰äº›éº»çƒ¦ï¼Œè¿™é‡Œä»¥ webpack æ‰“åŒ…ä¸ºä¾‹ï¼Œä»‹ç»åŠ è‡ªåŠ¨ä¸Šä¼ çš„é…ç½®æ–¹æ³•:

1ã€é¦–å…ˆå®‰è£…æ’ä»¶:

```SHELL
ya - D @sentry/webpack-plugin
```

2ã€åœ¨æ ¹ç›®å½•åˆ›å»º `.sentryclirc` æ–‡ä»¶ï¼Œå†…å®¹ä¸æ‰‹åŠ¨ç”Ÿæˆçš„æ–‡ä»¶ä¸€è‡´

3ã€åœ¨ webpack ä¸­å¼•å…¥æ’ä»¶:

```JS
// webpack.config.prod.js
const SentryPlugin = require('@sentry/webpack-plugin');

plugins: [
  new SentryPlugin({
    release: process.env.RELEASE, // è¿™é‡Œçš„ RELEASE ç¯å¢ƒå˜é‡è¦ä¸ sentry å¹³å°ä¸Šçš„ release åä¸€è‡´
    include: './build/static/js',
    ignore: ['node_modules', 'webpack.config.js'],
    configFile: 'sentry.properties',
  }),
  ...
]
```

4ã€è¿è¡Œ `yarn build` æ‰“åŒ…ï¼Œå¹¶è‡ªåŠ¨ä¸Šä¼ å¯¹åº”è·¯å¾„ä¸‹çš„ sourcemap:

![sentry-sourcemap.png]( {{site.url}}/style/images/smms/sentry-sourcemap.png )

> ä¸Šè¿°ä¸¤ç§æ–¹æ³•ä¸Šä¼ æˆåŠŸåï¼Œéƒ½å¯ä»¥å‰å¾€ `Releases --> release åç§° --> Artifacts`ä¸‹æŸ¥çœ‹:

![sentry-release.png]( {{site.url}}/style/images/smms/sentry-release.png )

## å‚è€ƒé“¾æ¥

1. [MDN - Error](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Error)
2. [é”™è¯¯å¤„ç†æœºåˆ¶](http://javascript.ruanyifeng.com/grammar/error.html#toc11) By é˜®ä¸€å³°
3. [å‰ç«¯å¼‚å¸¸æ—¥å¿—ç›‘æ§ - ä½¿ç”¨ Sentry](https://www.cnblogs.com/xakoy/p/9636393.html) By xakoy
4. [sentry ä¸Šä¼  sourcemap](https://segmentfault.com/a/1190000016975941) By jsonya
5. [JavaScript Source Map è¯¦è§£](http://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html) By é˜®ä¸€å³°
