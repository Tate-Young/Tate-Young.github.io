---
layout: blog
front: true
comments: True
flag: JS
background: blue
category: å‰ç«¯
title:  Error å¤„ç†æœºåˆ¶
date:   2018-02-06 11:28:00 GMT+0800 (CST)
background-image: http://img.zcool.cn/community/01e70755db347c6ac7251df8aed0e0.jpg@900w_1l_2o_100sh.jpg
tags:
- JavaScript
---
# {{ page.title }}

## Error ç±»å‹

é€šè¿‡ Error çš„æ„é€ å™¨å¯ä»¥åˆ›å»ºä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼Œå½“è¿è¡Œæ—¶é”™è¯¯äº§ç”Ÿæ—¶ï¼ŒError çš„å®ä¾‹å¯¹è±¡ä¼šè¢«æŠ›å‡ºã€‚é€šå¸¸ Error å®ä¾‹å¯¹è±¡æœ‰å¦‚ä¸‹å±æ€§ï¼š

| å±æ€§ | æè¿° |
|:-------------|:------------|
| message | é”™è¯¯ä¿¡æ¯ |
| name | é”™è¯¯åç§° |
| stack | é”™è¯¯å †æ ˆ(Non-standard) |

```js
var err = new Error('æˆ‘å°±æ˜¯ä¸ªé”™è¯¯');
err.message; // 'æˆ‘å°±æ˜¯ä¸ªé”™è¯¯'
err.name; // 'Error'
```

é™¤äº†é€šç”¨çš„ Error æ„é€ å‡½æ•°å¤–ï¼ŒJavaScript è¿˜æœ‰ 6 ä¸ªå…¶ä»–ç±»å‹çš„é”™è¯¯æ„é€ å‡½æ•°:

| æ´¾ç”Ÿå¯¹è±¡ | æè¿° | ä¸¾ä¸ªæ —å­ |
|:-------------|:------------||:-------------|
| ReferenceError | æ— æ•ˆå¼•ç”¨ | x; // ReferenceError: x is not defined |
| SyntaxError | è¯­æ³•è§£æé”™è¯¯ | var 1a; // SyntaxError: Invalid or unexpected token |
| RangeError | æ•°å€¼å˜é‡æˆ–å‚æ•°è¶…å‡ºå…¶æœ‰æ•ˆèŒƒå›´ | new Array(-1); // RangeError: Invalid array length |
| TypeError | å˜é‡æˆ–å‚æ•°ä¸å±äºæœ‰æ•ˆç±»å‹ | new 'Tate'; // TypeError: "Tate" is not a constructor |
| URIError | ç¼–ç æˆ–è§£ç æ—¶ä¼ é€’çš„å‚æ•°æ— æ•ˆ | decodeURI('%2'); URIError: URI malformed |
| EvalError | eval()æ‰§è¡Œé”™è¯¯ | åªä¸ºä»£ç å…¼å®¹ï¼Œå¼‚å¸¸ä¸å†æŠ›å‡º |

## é”™è¯¯å¤„ç†

### throw

**throw** è¯­å¥ä¸­æ–­ç¨‹åºæ‰§è¡Œï¼Œå¹¶æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚

```js
// throw å¯ä»¥æŠ›å‡ºä»»ä½•ç±»å‹çš„å€¼ã€‚
throw 'Tate'; // Uncaught Tate
throw 1; // Uncaught 1

var a = -1;
if (a < 0) {
  throw new Error('a å¿…é¡»ä¸ºæ­£æ•°'); // Error: a å¿…é¡»ä¸ºæ­£æ•°
}
console.log(a); // æœªæ‰§è¡Œ
```

### try / catch / finally

**try** ä»£ç å—æŠ›å‡ºçš„å¼‚å¸¸ä¼šè¢« **catch** æ•è·ï¼Œæ— è®ºæ˜¯å¦æœ‰å¼‚å¸¸ï¼Œéƒ½ä¼šæœ€åæ‰§è¡Œ **finally** ä»£ç å—ã€‚ä¸” try ä»£ç å—é‡ŒæŠ›å‡ºçš„å¼‚å¸¸ä¸ä¼šä¸­æ–­ç¨‹åºæ‰§è¡Œã€‚

```js
try {
    foo.bar();
} catch (e) {
  if (e instanceof ReferenceError) {
    console.log(e.name + ": " + e.message);
  } else if (e instanceof TypeError) {
    console.log(e.name + ": " + e.message);
}
  throw new Error('Tate') // æ­¤å¼‚å¸¸åœ¨ finally æ‰§è¡Œä¹‹åæŠ›å‡º
} finally {
  console.log('finally'); // 'finally'
}
```

### è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹

```js
// Create a new object, that prototypally inherits from the Error constructor.
function MyError(message) {
  this.name = 'MyError';
  this.message = message || 'Default Message';
  this.stack = (new Error()).stack;
}

MyError.prototype = Object.create(Error.prototype);
MyError.prototype.constructor = MyError;

try {
  throw new MyError('custom message');
} catch (e) {
  console.log(e.message);  // 'custom message'
  console.log(e.name);     // 'MyError'
}
```

## Sentry

[**Sentry**](https://sentry.io/welcome/) æ˜¯ä¸€ä¸ªå¯å®æ—¶æ•æ‰é”™è¯¯å¹¶æ±‡é›†æ—¥å¿—çš„å¹³å°ã€‚ä»¥ä¸‹çš„ç¤ºä¾‹å‚ç…§ React é¡¹ç›®:

1ã€é¦–å…ˆåœ¨ Sentry å®˜ç½‘åˆ›å»ºä¸€ä¸ª React é¡¹ç›®ï¼Œæ­¤æ—¶ä¼šè·å–è¯¥é¡¹ç›®ä¸‹çš„ **DSN**ï¼Œå®ƒç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆ:

* åè®®
* éªŒè¯ SDK çš„å…¬é’¥å’Œå¯†é’¥
* ç›®æ ‡ Sentry æœåŠ¡å™¨
* éªŒè¯ç”¨æˆ·ç»‘å®šçš„é¡¹ç›® id

```TEXT
<!--  æ ¼å¼ï¼š'{PROTOCOL}://{PUBLIC_KEY}:{SECRET_KEY}@{HOST}/{PATH}{PROJECT_ID}' -->
https://f0adb1c13dd0407fa806a1a9015daccb@sentry.io/1411582
```

![sentry-dsn.png](https://i.loli.net/2019/03/09/5c83ad3d084fc.png)

2ã€åœ¨å®¢æˆ·ç«¯å®‰è£… **raven-js**(Official Sentry SDKs for JavaScript):

```JS
// yarn add raven-js

import createSagaMiddleware from 'redux-saga'
import Raven from 'raven-js'
import createRavenMiddleware from 'raven-for-redux'

const sagaMiddleware = createSagaMiddleware({
  onError(error) {
    // Capturing Errors / Exceptions
    Raven.captureException(error)
  },
})
const middlewares = [sagaMiddleware]
// å¿…é¡»é…ç½® Raven.js ä½¿ç”¨ Sentry DSN
if (process.env.NODE_ENV === 'production') {
  const RAVEN_DSN = 'https://f0adb1c13dd0407fa806a1a9015daccb@sentry.io/1411582'
  Raven.config(RAVEN_DSN).install()

  middlewares.push(createRavenMiddleware(Raven))
}
```

> config ä¹Ÿæ”¯æŒå…¶ä»–ä¸€äº›å‚æ•°çš„è‡ªå®šä¹‰ï¼Œ[è¯¦ç»†è¯·çœ‹è¿™é‡Œ](https://docs.sentry.io/clients/javascript/config/) ğŸ‘ˆ

raven-js æ˜¯æ—§çš„ SDKï¼Œç›®å‰æ–°çš„ä¸º `@sentry/browser`(Sentryâ€™s browser JavaScript SDK))ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹:

```JS
// yarn add @sentry/browser

import { init, captureMessage } from '@sentry/browser'

// init ä¹Ÿæ”¯æŒå¤šç§ options
init({
  dsn: '__DSN__',
  beforeSend(event) {
    // Modify the event here
    if (event.user) {
      // Don't send user's email address
      delete event.user.email;
    }
    return event;
  }
  // ...
})
// Capturing Messages
captureMessage('Hello, world!')
```

3ã€åœ¨ React ç»„ä»¶ä¸­å¯ä»¥é€šè¿‡ `componentDidCatch` æ•è· error:

```JS
// è¿™ä¸ªç”Ÿå‘½å‘¨æœŸè¢«è°ƒç”¨æ˜¯åœ¨æŸä¸ªåä»£ç»„ä»¶å·²ç»æŠ›å‡ºä¸€ä¸ªé”™è¯¯ä¹‹å
// error æ˜¯è¢«æŠ›å‡ºçš„é”™è¯¯
// info æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¸¦æœ‰ä¸€ä¸ª componentStack é”®
componentDidCatch(error, errorInfo) {
  Raven.captureException(error, { extra: errorInfo });
}
```

> JS è¿è¡ŒæœŸé—´ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ä¸”é”™è¯¯æ²¡æœ‰è¢« `try catch` ç­‰æ•æ‰ï¼Œå°±ä¼šå†’æ³¡åˆ° windowï¼Œè§¦å‘ `onError` äº‹ä»¶ã€‚å½“ç„¶èµ„æºåŠ è½½å¤±è´¥ï¼Œæ¯”å¦‚ `img`ã€`script` åªä¼šæ‰§è¡Œè¯¥å…ƒç´  `onerror`ï¼Œè€Œä¸ä¼šå†’æ³¡åˆ° `window.onerror`

## å‚è€ƒé“¾æ¥

1. [MDN - Error](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Error)
2. [é”™è¯¯å¤„ç†æœºåˆ¶](http://javascript.ruanyifeng.com/grammar/error.html#toc11) By é˜®ä¸€å³°
3. [sentry ä½¿ç”¨å®è·µ](https://www.jianshu.com/p/66e00077fac3) By max_wwwwww
