---
layout: blog
front: true
comments: True
flag: JS
background: blue
category: å‰ç«¯
title:  æµ®ç‚¹æ•°å¤„ç†
date:   2020-05-05 17:52:00 GMT+0800 (CST)
background-image: https://camo.githubusercontent.com/bf8105e7f04644cd3537caa0f06e479e0080ba32/68747470733a2f2f696d672e616c6963646e2e636f6d2f7466732f5442317747647a584d6e44384b4a6a793158645858615a735658612d313238302d3334362e706e67
tags:
- JavaScript
---
# {{ page.title }}

<style>
  /* æœ¬æ–‡æ’å…¥ img æš‚æ—¶å®½åº¦éƒ½è°ƒæˆ 100% */
  img {
    width: 100%;
  }
</style>

## é—®é¢˜æè¿°

åœ¨æˆ‘ä»¬æ—¥å¸¸æ’¸ä»£ç çš„æ—¶å€™ï¼Œè‚¯å®šå¤šå¤šå°‘å°‘ç¢°åˆ°è¿‡ä»¥ä¸‹æµ®ç‚¹æ•°è®¡ç®—çš„é—®é¢˜:

```JS
0.1 + 0.1 // 0.2 âœ…
0.1 + 0.2 // 0.30000000000000004
0.3 - 0.2 // 0.09999999999999998
19.9 * 10 * 10 // 1990 âœ…
19.9 * 100 // 1989.9999999999998
0.3 / 0.1 // 2.9999999999999996
```

åˆšç¢°åˆ°çš„æ—¶å€™ä¸€è„¸é—®å·ï¼Œéš¾é“è¿™æ˜¯ bug â“æ¥ä¸‹æ¥å°±é’ˆå¯¹è¿™ä¸ªé—®é¢˜è§£é‡Šä¸‹ï¼Œçœ‹ä¸‹ç»“æœæ˜¯æ€ä¹ˆè®¡ç®—å‡ºæ¥çš„ï¼Œä¸ºå•¥ä¼šæœ‰è¯¯å·®ï¼Œæœ¬æ–‡ä¸»è¦[æ‘˜è‡ªè¿™é‡Œ](https://github.com/camsong/blog/issues/9)ã€‚ ğŸ‘ˆ

## IEEE 754 æ ‡å‡†

JS éµå¾ªçš„æ˜¯ç›®å‰æœ€å¹¿æ³›ä½¿ç”¨çš„æµ®ç‚¹æ•°è¿ç®— [**IEEE 754 æ ‡å‡†**](https://zh.wikipedia.org/wiki/IEEE_754)ï¼Œä½¿ç”¨ 64 ä½å›ºå®šé•¿åº¦æ¥è¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯ [**double åŒç²¾åº¦æµ®ç‚¹æ•°**](https://en.wikipedia.org/wiki/Double-precision_floating-point_format):

* ç¬¦å·ä½ S - ç¬¬ 1 ä½æ˜¯æ­£è´Ÿæ•°ç¬¦å·ä½ï¼ˆsignï¼‰ï¼Œ0 ä»£è¡¨æ­£æ•°ï¼Œ1 ä»£è¡¨è´Ÿæ•°
* æŒ‡æ•°ä½ E - ä¸­é—´çš„ 11 ä½å­˜å‚¨æŒ‡æ•°ï¼ˆexponentï¼‰ï¼Œç”¨æ¥è¡¨ç¤ºæ¬¡æ–¹æ•°ã€‚å†³å®šäº†æ•°å­—çš„å¤§å°
* å°¾æ•°ä½ M - æœ€åçš„ 52 ä½æ˜¯å°¾æ•°ï¼ˆfractionï¼‰ï¼Œè¶…å‡ºçš„éƒ¨åˆ†è‡ªåŠ¨è¿›ä¸€èˆé›¶ã€‚å†³å®šäº†æ•°å­—çš„ç²¾åº¦ã€‚

![64-bits](https://upload.wikimedia.org/wikipedia/commons/a/a9/IEEE_754_Double_Floating_Point_Format.svg)

> **æ³¨æ„ fraction ç”±äºæ•´æ•°éƒ¨åˆ†è‚¯å®šæ˜¯ 1ï¼Œæ‰€ä»¥ä¸€èˆ¬é»˜è®¤ä¸å†™ï¼Œå®é™…ä¸Šæ˜¯æœ‰ 53 ä½çš„**ã€‚æ¯”å¦‚ 0.1 è½¬æ¢æˆäºŒè¿›åˆ¶å°±æ˜¯ `0.000110011001100...`ï¼Œ[**ç§‘å­¦è®°æ•°æ³•**](https://zh.wikipedia.org/wiki/ç§‘å­¦è®°æ•°æ³•)è¡¨ç¤ºæ˜¯ `1.10011...*10^-4`ï¼Œèˆå» 1 å `M = 10011...`:

![fraction](https://camo.githubusercontent.com/61cae30c09580aba68ffbfcf3b080e9688fd7609/687474703a2f2f617461322d696d672e636e2d68616e677a686f752e696d672d7075622e616c6979756e2d696e632e636f6d2f36313561643436316130653836343166316238393837316532656666383765662e706e67)

## ç®€å•è®¡ç®—è¿‡ç¨‹

æ ‡å‡†å·²ç»æœ‰äº†ï¼Œæ¥ä¸‹æ¥åœ¨åšæµ®ç‚¹æ•°è®¡ç®—çš„æ—¶å€™ï¼Œå¤§è‡´è¦åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤:

1. æµ®ç‚¹æ•° --> äºŒè¿›åˆ¶
2. ç”¨äºŒè¿›åˆ¶ç§‘å­¦è®°æ•°æ³•è¡¨ç¤º
3. éµå¾ª IEEE 754 æ ‡å‡†è¿›è¡Œå±•ç¤º

ç¬¬ä¸€æ­¥å’Œç¬¬ä¸‰æ­¥ç”±äºè¦åšæ•°æ®è½¬æ¢ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°ç²¾åº¦ä¸¢å¤±çš„æƒ…å†µã€‚æˆ‘ä»¬ç›´æ¥æ¥åˆ†æä¸ªä¾‹å­:

```JS
// 0.1 å’Œ 0.2 éƒ½è½¬åŒ–æˆäºŒè¿›åˆ¶åå†è¿›è¡Œè¿ç®—
0.00011001100110011001100110011001100110011001100110011010 +
0.0011001100110011001100110011001100110011001100110011010 =
0.0100110011001100110011001100110011001100110011001100111

// è½¬æˆåè¿›åˆ¶åˆ™ä¸º 0.30000000000000004
```

> åœ¨çº¿çš„ demical --> binary [è½¬æ¢å·¥å…·](http://www.binaryconvert.com/convert_double.html) ğŸ‘ˆ

## æœ€å¤§å®‰å…¨æ•´æ•° MAX_SAFE_INTEGER

ç”±äº fraction å›ºå®šé•¿åº¦æ˜¯ 52 ä½ï¼Œå†åŠ ä¸Šä¸Šé¢æåˆ°çœç•¥çš„ä¸€ä½ï¼Œæœ€å¤šå¯ä»¥è¡¨ç¤ºçš„æ•°æ˜¯ `2^53=9007199254740992`ï¼Œå¯¹åº”ç§‘å­¦è®°æ•°æ³•å°¾æ•°æ˜¯ `9.007199254740992`ï¼Œè¿™ä¹Ÿæ˜¯ JS æœ€å¤šèƒ½è¡¨ç¤ºçš„ç²¾åº¦ã€‚å®ƒçš„é•¿åº¦æ˜¯ 16ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ `toPrecision(16)` æ¥åšç²¾åº¦è¿ç®—ï¼Œè¶…è¿‡çš„ç²¾åº¦ä¼šè‡ªåŠ¨åšå‡‘æ•´å¤„ç†ã€‚äºæ˜¯å°±æœ‰:

```JS
// è¿”å› 0.1000000000000000ï¼Œå»æ‰æœ«å°¾çš„é›¶åæ­£å¥½ä¸º 0.1
0.10000000000000000555.toPrecision(16)

// é‡‡ç”¨é«˜ç²¾åº¦åˆ™ä¼šæœ‰è¯¯å·®
0.1.toPrecision(21) = 0.100000000000000005551
```

JS çš„**æœ€å¤§å®‰å…¨æ•´æ•°**å³ä¸º `2^53 - 1`ï¼Œç”¨å¸¸é‡ [**Number.MAX_SAFE_INTEGER**](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER) è¡¨ç¤ºï¼Œå®‰å…¨å­˜å‚¨åŒºé—´å³ä¸º `(-2^53, 2^53)`ã€‚è¿™é‡Œå®‰å…¨å­˜å‚¨çš„æ„æ€æ˜¯æŒ‡èƒ½å¤Ÿå‡†ç¡®åŒºåˆ†ä¸¤ä¸ªä¸ç›¸åŒçš„å€¼:

```JS
Number.MAX_SAFE_INTEGER // 9007199254740991
Math.pow(2, 53) - 1     // 9007199254740991

// å®‰å…¨å­˜å‚¨çš„æ„æ€æ˜¯æŒ‡èƒ½å¤Ÿå‡†ç¡®åŒºåˆ†ä¸¤ä¸ªä¸ç›¸åŒçš„å€¼ï¼Œä»¥ä¸‹åˆ¤æ–­åœ¨æ•°å­¦ä¸Šæ˜¯é”™è¯¯çš„
Number.MAX_SAFE_INTEGER + 1 === Number.MAX_SAFE_INTEGER + 2 // true
```

> æˆ‘ä»¬å¯ä»¥é€šè¿‡ `Number.isSafeInteger()` æ–¹æ³•ç”¨æ¥åˆ¤æ–­ä¼ å…¥çš„å‚æ•°å€¼æ˜¯å¦æ˜¯ä¸€ä¸ª"å®‰å…¨æ•´æ•°"(safe integer)ã€‚

é‚£æœ‰å°ç›†å‹å°±é—®äº†ï¼Œä¸ºå•¥ `2^53` å°±ä¸æ˜¯å®‰å…¨æ•´æ•°äº†å‘¢ï¼Ÿ

`2^53` çš„ç¡®ä¸æ˜¯ä¸€ä¸ªå®‰å…¨æ•´æ•°ï¼Œå®ƒèƒ½å¤Ÿä½¿ç”¨ `IEEE 754` è¡¨ç¤ºï¼Œä½†æ˜¯ `2^53 + 1` ä¸èƒ½ä½¿ç”¨ `IEEE 754` ç›´æ¥è¡¨ç¤ºï¼Œåœ¨å°±è¿‘èˆå…¥å’Œå‘é›¶èˆå…¥ä¸­ï¼Œä¼šè¢«èˆå…¥ä¸º `2^53`ã€‚å› æ­¤ `2^53` ä¸æ˜¯å®‰å…¨æ•´æ•°ã€‚

## æœ€å¤§æ•´æ•° MAX_VALUE

JS åŒæ—¶ä¹Ÿå®šä¹‰äº†æœ€å¤§å’Œæœ€å°æ•´æ•°ï¼Œå¦‚æœæº¢å‡ºçš„è¯ä¼šè¿”å›æ— ç©·å¤§æˆ–æ— ç©·å°ï¼Œå…¨å±€å˜é‡ `Infinity` è¡¨ç¤ºæ— ç©·å¤§:

```JS
Number.MAX_VALUE // 1.7976931348623157e+308
Number.MIN_VALUE // 5e-324
Number.POSITIVE_INFINITE // Infinity
Number.NEGATIVE_INFINITE // -Infinity
```

```JS
Math.pow(2, 1023) // 8.98846567431158e+307

Math.pow(2, 1024) // Infinity
```

## toPrecision / toFixed

æˆ‘ä»¬ç»å¸¸ç”¨åˆ°çš„å°†æ•°å­—è½¬æˆå­—ç¬¦ä¸²ï¼Œé€šå¸¸æœ‰ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•:

* **toPresicion** - ä»¥æŒ‡å®šçš„ç²¾åº¦è¿”å›è¯¥æ•°å€¼å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤º
* **toFixed** - ä½¿ç”¨å®šç‚¹è¡¨ç¤ºæ³•æ¥æ ¼å¼åŒ–ä¸€ä¸ªæ•°å€¼

ä¸¤è€…éƒ½èƒ½å¯¹å¤šä½™æ•°å­—åšå‡‘æ•´å¤„ç†ï¼Œæœ‰æ—¶å€™ä¹Ÿç”¨ toFixed æ¥åšå››èˆäº”å…¥ï¼Œä½†æœ‰äº›æƒ…å†µå´æ˜¯æœ‰é—®é¢˜çš„ï¼Œä¸€å®šè¦æ³¨æ„ï¼Œæ¯”å¦‚:

```JS
1.005.toFixed(2) // 1.00, not 1.01
```

ä¸Šè¿°ç»“æœå¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœ 1.001ï¼ŒåŸå› å°±æ˜¯ 1.005 å®é™…å¯¹åº”çš„æ•°å­—æ˜¯ 1.00499999999999989ï¼Œå››èˆäº”å…¥åå°±æˆäº† 1.00ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬è¦åšæ•°æ®å±•ç¤ºçš„è¯è¿˜æ˜¯æ¨èç”¨ä»¥ä¸‹å°è£…çš„æ–¹æ³•:

```JS
const strip: (p: number, k: number) => number = (num, precision = 12) => +parseFloat(num.toPrecision(precision))

strip(1.000000001) === 1 // true
```

å¦‚æœè¦è¿›è¡Œå„ç§è¿ç®—çš„è¯ï¼Œè¿™é‡Œæ¨èä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ [number-precision](https://github.com/nefe/number-precision):

```JS
import NP from 'number-precision'
NP.strip(0.09999999999999998) // = 0.1
NP.plus(0.1, 0.2)             // = 0.3, not 0.30000000000000004
NP.plus(2.3, 2.4)             // = 4.7, not 4.699999999999999
NP.minus(1.0, 0.9)            // = 0.1, not 0.09999999999999998
NP.times(3, 0.3)              // = 0.9, not 0.8999999999999999
NP.times(0.362, 100)          // = 36.2, not 36.199999999999996
NP.divide(1.21, 1.1)          // = 1.1, not 1.0999999999999999
NP.round(0.105, 2)            // = 0.11, not 0.1
```

## å‚è€ƒé“¾æ¥

1. [JavaScript æµ®ç‚¹æ•°é™·é˜±åŠè§£æ³•](https://github.com/camsong/blog/issues/9) By camsong
