
<!DOCTYPE>
<html lang="zh-cn" data-scribe-reduced-action-queue="true">
<head>
    <meta content='Express 中间件与路由 - Tate & Snow' name='title' />
    <meta content='Express 中间件与路由 - Tate & Snow' name='og:title' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <title>Express 中间件与路由 - Tate & Snow</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Express 中间件与路由 - Tate & Snow</title>
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Express 中间件与路由 - Tate & Snow">
<meta name="twitter:keywords" content="Express 中间件与路由 - Tate & Snow" property='og:description' />
<meta property="og:type" content="article">
<meta property="og:title" content="Express 中间件与路由 - Tate & Snow">
<meta name="og:keywords" content="Express 中间件与路由 - Tate & Snow|Express 中间件与路由什么是 ExpressExpress 是一个基于 Node.js 平台的极简、灵活的 web 应用开发框架，它提供一系列强大的特性，帮助你创建各种 Web 和移动设备应用。Express 框架建立在 nod..."
  property='og:description' />
<link rel="icon" type="image/png" href="http://localhost:2333/style/favicons/favicon.ico" />
<link href="http://localhost:2333/style/favicons/favicon.ico" rel="shortcut icon" type="image/png">
<link rel="canonical" href="http://localhost:2333/">
<link rel="alternate" type="application/rss+xml" title="Liberxue" href="http://localhost:2333/feed.xml">
<meta charset="UTF-8">
<link rel="manifest" href="/manifest.json">
<link rel="shortcut icon" href="http://localhost:2333/style/favicons/favicon.ico" type="image/x-icon">
<meta name="keywords" content="Express 中间件与路由什么是 ExpressExpress 是一个基于 Node.js 平台的极简、灵活的 web 应用开发框架，它提供一系列强大的特性，帮助你创建各种 Web 和移动设备应用。Express 框架建立在 nod..." property='og:description'
/>
<meta name="description" content="Tate & Snow's Github blog" />
<link href="https://cdn.bootcss.com/highlight.js/9.10.0/styles/xcode.min.css" rel="stylesheet">
<link href="http://localhost:2333/style/theme.css" rel="stylesheet"> 
<meta content='http://localhost:2333/2018/04/10/express-middleware-route.html' property='og:url' />
<meta content="http://localhost:2333/2018/04/10/express-middleware-route.html|Express 中间件与路由什么是 ExpressExpress 是一个基于 Node.js 平台的极简、灵活的 web 应用开发框架，它提供一系列强大的特性，帮助你创建各种 Web 和移动设备应用。Express 框架建立在 nod..." property='og:description'
/>
<meta content="article" property="og:type" /> 

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-136311746-1"></script>
<!-- <script async src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>
<script>
  window.dataLayer = window.dataLayer || [];
  window.GA_TRACKING_ID = 'UA-136311746-1'
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('set', {
    'country': 'US',
    'currency': 'USD',
    'description': 'fuck',
  });
  gtag('config', GA_TRACKING_ID, {
    'custom_map': {
      'dimension1': 'post_title',
    },
    'post_title': 'test',
  });
</script>
<meta content="" property="fb:app_id" />
<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Express 中间件与路由 | Tate &amp; Snow</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Express 中间件与路由" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Express 中间件与路由" />
<meta property="og:description" content="Express 中间件与路由" />
<link rel="canonical" href="http://localhost:2333/2018/04/10/express-middleware-route.html" />
<meta property="og:url" content="http://localhost:2333/2018/04/10/express-middleware-route.html" />
<meta property="og:site_name" content="Tate &amp; Snow" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-04-10T09:55:00+08:00" />
<script type="application/ld+json">
{"description":"Express 中间件与路由","@type":"BlogPosting","url":"http://localhost:2333/2018/04/10/express-middleware-route.html","headline":"Express 中间件与路由","dateModified":"2018-04-10T09:55:00+08:00","datePublished":"2018-04-10T09:55:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:2333/2018/04/10/express-middleware-route.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<script>
  (function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s);
    js.id = id;
    js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

</head>

<body class="dark-theme" gtools_scp_screen_capture_injected="true">
    <header id="header" class="header bg-white">
        <div class="navbar-container">
            <a href="Javascript:;" onclick="onClickLogo()" title="访问 Tate & Snow" class="navbar-logo menu-logo">
                <img src="https://i.loli.net/2018/03/13/5aa74f5b4c2c7.png" alt="Tate & Snow"> </a>
            <!-- <a href="/?tate" title="访问 Tate & Snow" class="navbar-logo">Tate & Snow</a>   -->
            <div class="navbar-menu">
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('首页', '/')" title="访问 首页" data-hover="首页">首页</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('前端', '/front')" title="访问 前端" data-hover="前端">前端</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('框架', '/tool')" title="访问 框架" data-hover="框架">框架</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('后端', '/back')" title="访问 后端" data-hover="后端">后端</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('标签', '/tags')" title="访问 标签" data-hover="标签">标签</a>
                
                  <a class=" menu-item-about " href="Javascript:;" onclick="onClickMenu('关于', '/README')" title="访问 关于" data-hover="关于">关于</a>
                
            </div>
            <!-- <div class="navbar-menu">
                
                <a href="http://localhost:2333/">首页</a>
                
                <a href="http://localhost:2333/front">前端</a>
                
                <a href="http://localhost:2333/tool">框架</a>
                
                <a href="http://localhost:2333/back">后端</a>
                
                <a href="http://localhost:2333/tags">标签</a>
                
                <a href="http://localhost:2333/README">关于</a>
                
            </div> -->
            <div class="navbar-search menu-item-search" onclick="onClickSearch()">
                <span class="icon-search"></span>
                <form id="cb-search-btn" role="search">
                    <span class="search-box">
                        <input type="text" class="input" id="cb-search-content" required="true" placeholder="标题 标签..." maxlength="30" autocomplete="off">
                    </span>
                </form>
            </div>
            <div class="navbar-mobile-menu" onclick="">
                <span class="icon-menu cross">
                    <span class="middle"></span>
                </span>
                <ul>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('首页', 'http://localhost:2333/')">首页</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('前端', 'http://localhost:2333/front')">前端</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('框架', 'http://localhost:2333/tool')">框架</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('后端', 'http://localhost:2333/back')">后端</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('标签', 'http://localhost:2333/tags')">标签</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('关于', 'http://localhost:2333/README')">关于</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </header>
    <a href="#header" class="back-to-top" onclick="onClickTop('Express 中间件与路由')">⤴Top⤴</a>
    <div class="post-header-thumb bg-white}">
        <div class="post-header-thumb-op"></div>
        <div class="post-header-thumb">
            <div class="post-header-thumb-container">
                <h1 class="post-title" itemprop="name headline">
                    Express 中间件与路由</h1>
                <div class="post-data">
                    <time datetime="2018-04-10 09:55:00" itemprop="datePublished">
                      发布时间：2018-04-10 09:55:00
                      &nbsp;&nbsp;&nbsp;
                      
                    </time>
                    <a onclick="onClickCategory('后端')" href="Javascript:;" title="访问 后端" data-hover="博客分类: 后端">博客分类: 后端</a>
                    <!-- <a href="#read"> 阅读次数: comments</a>  -->
                </div>
                <div class="post-tags">
                       
                    <a class="menu-item-tags" href="Javascript:;" onclick="onClickTag('Node')" title="访问Node" data-hover="Node">
                        Node
                        <span>(8)</span>
                        
                    </a>
                       
                </div>
            </div>
        </div>
    </div>
    <article class="main-content post-page" itemscope itemtype="http://schema.org/Article">
        <div class="post-header">
            <h1 class="post-title" itemprop="name headline">
                Express 中间件与路由</h1>
            <div class="post-data">
                <time datetime="2018-04-10 09:55:00" itemprop="datePublished">2018-04-10 09:55:00</time>
            </div>
        </div>
        <div id="post-content" class="post-content" itemprop="articleBody">
            <p class="post-tags">
                   
                <a href="Javascript:;" onclick="onClickTag('Node')" title="访问Node" data-hover="Node">
                    Node
                    <span>(8)</span>
                    </a>
                   
            </p>
            <h1 id="express-中间件与路由">Express 中间件与路由</h1>

<h2 id="什么是-express">什么是 Express</h2>

<p><strong>Express</strong> 是一个基于 Node.js 平台的极简、灵活的 web 应用开发框架，它提供一系列强大的特性，帮助你创建各种 Web 和移动设备应用。Express 框架建立在 node.js 内置的 http 模块上。http 模块生成服务器的原始代码如下:</p>

<pre><code class="language-JS">var http = require('http')

var app = http.createServer(function (request, response) {
  response.writeHead(200, {'Content-Type': 'text/plain'})
  response.end('Hello world!')
});

app.listen(8000, 'localhost')
</code></pre>

<p>Express 框架的核心是对 http 模块的再包装，实际上加了一个中间层。上面的代码用 Express 改写如下:</p>

<pre><code class="language-JS">var express = require('express')
var app = express()

app.get('/', function (req, res) {
  res.send('Hello world!')
});

app.listen(3000)
</code></pre>

<p>我们可以快速去生成一个 express 项目:</p>

<pre><code class="language-SHELL"># 安装
npm install -g express-generator@4
# 创建项目
express express-demo &amp;&amp; cd express-demo
</code></pre>

<h2 id="express">express()</h2>

<p><strong>express()</strong> 用来创建一个 Express 的程序。express() 是一个由 express 模块导出的入口(top-level)函数。</p>

<pre><code class="language-JS">var express = require('expres')
var app = express()
</code></pre>

<p><strong>express.static</strong>(root, [options]) 是 Express 内置的唯一一个中间件，负责托管 Express 应用内的静态资源，假设在 public 目录下放置图片、样式等:</p>

<pre><code class="language-JS">app.use(express.static(path.join(__dirname, 'public')))
</code></pre>

<p>所有文件的路径都是相对于存放目录的，因此存放静态文件的目录名不会出现在 URL 中，访问方式如下:</p>

<pre><code class="language-TEXT">http://localhost:8000/img/darling.jpg
http://localhost:8000/css/style.css

&lt;!-- 文件结构 --&gt;
- public
  - img
    - darling.jpg
  - css
    - style.css
</code></pre>

<h2 id="application">Application</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">app 属性或方法</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>app.locals</strong></td>
      <td style="text-align: left">可以设置程序本地的变量</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>app.all()</strong></td>
      <td style="text-align: left">所有请求都必须通过该中间件</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>app.METHOD()</strong></td>
      <td style="text-align: left">包括 app.get()、app.post()，代表 HTTP 动词方法</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>app.set()</strong></td>
      <td style="text-align: left">用于指定变量的值</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>app.disable()</strong></td>
      <td style="text-align: left">将变量设为布尔值 false，反之为 app.enable()</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>app.listen()</strong></td>
      <td style="text-align: left">开启 HTTP 服务器监听连接</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>app.use()</strong></td>
      <td style="text-align: left">挂载中间件方法到路径上</td>
    </tr>
  </tbody>
</table>

<h3 id="applocals">app.locals</h3>

<p><strong>app.locals</strong> 就是程序本地的变量，各属性值将贯穿程序的整个生命周期，与其相反的是 <strong>res.locals</strong>，它只在这次请求的生命周期中有效。</p>

<pre><code class="language-JS">const pkg = require('./package')
// 设置模板全局常量，可直接访问 blog 变量
app.locals.blog = {
  title: pkg.name,
  description: pkg.description
}
</code></pre>

<h3 id="appall--appmethod">app.all() / app.METHOD()</h3>

<p><strong>app.all()</strong> 所有请求都必须通过该中间件，参数中的 “*” 表示对所有路径有效，METHOD 是 HTTP 动词方法，包括 <strong>app.get()</strong>、<strong>app.post()</strong> 等，这些方法的第一个参数，都是请求的路径。除了绝对匹配以外，Express 还允许模式匹配:</p>

<pre><code class="language-JS">app.all('*', function (req, res, next) {
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  next();
});

// 由于 get 方法的回调函数没有调用 next 方法，所以只要有一个中间件被调用了，后面的中间件就不会再被调用了
app.get('/', function (req, res) {
  res.end('Tate &amp; Snow');
});

app.get('/hello/:name', function (req, res) {
  res.end('Hello, ' + req.params.name + '.');
});
</code></pre>

<h3 id="appset">app.set()</h3>

<p>app.set() 用于指定变量的值，但如果参数是程序设置之一，它将影响到程序的行为:</p>

<pre><code class="language-JS">// 设置模板目录
app.set('views', path.join(__dirname, 'views'))
// 设置模板引擎为 ejs
app.set('view engine', 'ejs')
</code></pre>

<h3 id="appdisable--appenable">app.disable() / app.enable()</h3>

<p><strong>app.disable()</strong> 用于指定变量为布尔值 false，可通过 <strong>app.disabled()</strong> 方法进行判断，反之对应 app.enable() 和 app.enabled():</p>

<pre><code class="language-JS">app.disable('foo')
// 等价于
app.set('foo', false)

app.get('foo') // false
app.disabled('foo') // true
</code></pre>

<h3 id="applisten">app.listen()</h3>

<p><strong>app.listen</strong>(port, [hostname], [backlog], [callback]) 开启 HTTP 服务器监听连接:</p>

<pre><code class="language-JS">// 监听端口，启动程序
app.listen(config.port, function () {
  console.log(`${pkg.name} listening on port ${config.port}`)
})
</code></pre>

<h3 id="appuse">app.use()</h3>

<p><strong>app.use()</strong> 挂载中间件方法到路径上。如果路径未指定，那么默认为 “/”，具体用法<a href="#中间件">查看下面中间件</a>。</p>

<h2 id="request">Request</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">req 属性或方法</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>req.baseUrl</strong></td>
      <td style="text-align: left">一个路由实例挂载的 Url 路径</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>req.path</strong></td>
      <td style="text-align: left">包含请求 URL 的部分路径</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>req.protocol</strong></td>
      <td style="text-align: left">请求的协议</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>req.hostname</strong></td>
      <td style="text-align: left">获取主机名</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>req.ip</strong></td>
      <td style="text-align: left">获取主机 ip 地址</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>req.route</strong></td>
      <td style="text-align: left">获取当前匹配的路由</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>req.is</strong></td>
      <td style="text-align: left">判断请求头 Content-Type 的 MIME 类型</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>req.params</strong></td>
      <td style="text-align: left">一个对象，其包含了一系列的属性，这些属性和在路由中命名的参数名是一一对应的</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>req.query</strong></td>
      <td style="text-align: left">一个对象，为每一个路由中的 query string 参数都分配一个属性</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>req.body</strong></td>
      <td style="text-align: left">body-parser 等解析请求体的中间件后，会返回以 key-value 的数据</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>req.cookies</strong></td>
      <td style="text-align: left">cookie-parser/multer 解析后，会返回请求头中包含的 cookies，默认为 {}，访问签名的 cookie 为 <code>req.signedCookies</code></td>
    </tr>
  </tbody>
</table>

<h3 id="reqbaseurl--reqpath">req.baseUrl / req.path</h3>

<pre><code class="language-JS">router.get('/jp', function (req, res) {
  console.log(req.baseUrl); // greet
  res.send('Konichiwa!');
});
app.use('/greet', router);
</code></pre>

<pre><code class="language-JS">// example.com/users?sort=desc
req.path
// =&gt; "/users"
</code></pre>

<h3 id="reqparams">req.params</h3>

<p><strong>req.params</strong> 是一个对象，其包含了一系列的属性，这些属性和在路由中命名的参数名是一一对应的:</p>

<pre><code class="language-JS">router.get('/:postId', function (req, res, next) {
  const postId = req.params.postId // 获取路由 /:postId 的参数 postId
})
</code></pre>

<h3 id="reqquery">req.query</h3>

<p><strong>req.query</strong> 是一个对象，为每一个路由中的 query string 参数都分配一个属性:</p>

<pre><code class="language-JS">// GET /search?q=tobi+ferret
req.query.q // =&gt; "tobi ferret"

// GET /shoes?order=desc&amp;shoe[color]=blue&amp;shoe[type]=converse
req.query.order // =&gt; "desc"
req.query.shoe.color // =&gt; "blue"
req.query.shoe.type // =&gt; "converse"
</code></pre>

<h3 id="reqbody">req.body</h3>

<pre><code class="language-JS">// body-parser 等解析请求体的中间件后，req.body 会返回以 key-value 的数据
var bodyParser = require('body-parser');

app.use(bodyParser.json()); // for parsing application/json
app.use(bodyParser.urlencoded({ extended: true })); // for parsing application/x-www-form-urlencoded

app.post('/', function (req, res) {
  console.log(req.body);
  res.json(req.body);
})
</code></pre>

<h3 id="reqcookies--reqsignedcookies">req.cookies / req.signedCookies</h3>

<pre><code class="language-JS">// cookie-parser/multer 解析后，会返回请求头中包含的 cookies，默认为 {}
// Cookie: name=tate
req.cookies.name // 'tate'

// Cookie: user=tate.CP7AWaXDfAKIRfH49dQzKJx7sKzzSoPq7/AcBBRVwlI3
req.signedCookies.user // 'tate'
</code></pre>

<h3 id="reqip">req.ip</h3>

<p>获取主机 ip 地址，有些情况带有前缀”::ffff:”，可使用正则 <code>req.ip.match(/\d+\.\d+\.\d+\.\d+/)[0]</code>进行处理:</p>

<pre><code class="language-JS">// node 获取 ip
var ip =
  req.headers['true-client-ip'] ||
  req.headers['x-forwarded-for'] ||
  req.connection.remoteAddress ||
  req.socket.remoteAddress ||
  (req.connection.socket ? req.connection.socket.remoteAddress : null); // =&gt; "127.0.0.1"
</code></pre>

<h2 id="response">Response</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">res 属性或方法</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>res.headersSent</strong></td>
      <td style="text-align: left">布尔类型的属性，指示这个响应是否已经发送 HTTP 头部</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>res.locals</strong></td>
      <td style="text-align: left">一个对象，其包含了本次请求的响应中的变量，它的变量只提供给本次请求响应的周期内视图渲染里使用(如果有视图的话)</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>res.cookie()</strong></td>
      <td style="text-align: left">设置 cookie，反之为清除 cookie <code>res.clearCookie()</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>res.send()</strong></td>
      <td style="text-align: left">发送 HTTP 响应</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>res.json()</strong></td>
      <td style="text-align: left">发送一个 JSON 响应，如 <code>res.json({user:'tobi'})</code>，res.jsonp 可发送 JSONP 响应，效果同 send()</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>res.end()</strong></td>
      <td style="text-align: left">结束本响应的过程</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>res.redirect()</strong></td>
      <td style="text-align: left">重定向来源于指定 path 的 URL</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>res.render()</strong></td>
      <td style="text-align: left">渲染一个视图，然后将渲染得到的 HTML 文档发送给客户端</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>res.status()</strong></td>
      <td style="text-align: left">设置响应对象的 HTTP status</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>res.type()</strong></td>
      <td style="text-align: left">设置 Content-Type 的 MIME 类型</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>res.set()</strong></td>
      <td style="text-align: left">设置 HTTP header，res.header() 的别名</td>
    </tr>
  </tbody>
</table>

<h3 id="reslocals">res.locals</h3>

<p><strong>res.locals</strong> 类似于 app.locals，其包含了本次请求的响应中的变量，它的变量只提供给本次请求响应的周期内视图渲染里使用(如果有视图的话):</p>

<pre><code class="language-JS">// 添加模板必需的三个变量
app.use(function (req, res, next) {
  res.locals.user = req.session.user
  res.locals.success = req.flash('success').toString()
  res.locals.error = req.flash('error').toString()
  next()
})
</code></pre>

<h3 id="rescookie">res.cookie()</h3>

<p>通过 set-cookie 字段进行设置 cookie，反之为清除 <code>res.clearCookie()</code>。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Property</th>
      <th style="text-align: left">Type</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">domain</td>
      <td style="text-align: left">String</td>
      <td style="text-align: left">Domain name for the cookie. Defaults to the domain name of the app.</td>
    </tr>
    <tr>
      <td style="text-align: left">expires</td>
      <td style="text-align: left">Date</td>
      <td style="text-align: left">Expiry date of the cookie in GMT. If not specified or set to 0, creates a session cookie.</td>
    </tr>
    <tr>
      <td style="text-align: left">httpOnly</td>
      <td style="text-align: left">Boolean</td>
      <td style="text-align: left">Flags the cookie to be accessible only by the web server.</td>
    </tr>
    <tr>
      <td style="text-align: left">maxAge</td>
      <td style="text-align: left">String</td>
      <td style="text-align: left">Convenient option for setting the expiry time relative to the current time in milliseconds.</td>
    </tr>
    <tr>
      <td style="text-align: left">path</td>
      <td style="text-align: left">String</td>
      <td style="text-align: left">Path for the cookie. Defaults to “/”.</td>
    </tr>
    <tr>
      <td style="text-align: left">secure</td>
      <td style="text-align: left">Boolean</td>
      <td style="text-align: left">Marks the cookie to be used with HTTPS only.</td>
    </tr>
    <tr>
      <td style="text-align: left">signed</td>
      <td style="text-align: left">Boolean</td>
      <td style="text-align: left">Indicates if the cookie should be signed.</td>
    </tr>
  </tbody>
</table>

<pre><code class="language-JS">res.cookie('name', 'tate', { domain: '.example.com', path: '/admin', secure: true });

// 当使用 cookie-parser 中间件时，也可以支持 signed。res.cookie() will use the secret passed to cookieParser(secret) to sign the value
res.cookie('name', 'tate', { signed: true });
</code></pre>

<h3 id="ressend--resredirect">res.send() / res.redirect()</h3>

<pre><code class="language-JS">res.send('Hello World')
res.json({name: 'tate'}) // 同 send()，转化为 json

res.redirect(`/posts/${post._id}`)
// back 将重定向请求到 referer，当没有 referer 的时候，默认为 /
res.redirect('back')
</code></pre>

<h3 id="resrender">res.render()</h3>

<p><strong>res.render(</strong> 渲染一个视图，然后将渲染得到的 HTML 文档发送给客户端:</p>

<pre><code class="language-JS">// GET /posts/:postId 单独一篇的文章页
router.get('/:postId', function (req, res, next) {
  const postId = req.params.postId
  // 渲染 HTML 路径为 /views/post.ejs，带进去的变量为 post
  res.render('post', { post: postId })
})
</code></pre>

<h3 id="resstatus">res.status()</h3>

<p><strong>res.status()</strong> 设置响应对象的 HTTP status:</p>

<pre><code class="language-JS">// 404 page
app.use(function (req, res) {
  if (!res.headersSent) {
    res.status(404).render('404')
  }
})
</code></pre>

<h3 id="resset">res.set()</h3>

<p><strong>res.set()</strong> 是 <strong>res.header()</strong> 的别名，用来设置请求头信息:</p>

<pre><code class="language-JS">res.set('Content-Type', 'text/plain');
res.set('Cache-Control', 'no-cache, max-age=0, no-store, must-revalidate')
</code></pre>

<h2 id="中间件">中间件</h2>

<p><strong><a href="http://www.expressjs.com.cn/guide/using-middleware.html">中间件(Middleware)</a></strong> 是一个函数，它可以访问 <strong>请求对象(req)</strong>, <strong>响应对象(res)</strong> 和 web 应用中处于请求/响应循环流程中的中间件，下一个中间件函数通常由名为 <strong>next</strong> 的变量来表示。。如果当前中间件没有终结请求/响应循环，则必须调用 next() 方法将控制权交给下一个中间件，否则请求就会挂起。中间件装入顺序很重要：首先装入的中间件函数也首先被执行。</p>

<pre><code class="language-JS">// 基本的中间件结构
function myFunMiddleware(req, res, next) {
  // 对 req 和 res 作出相应操作
  // 操作完毕后返回 next() 即可转入下個中间件
  next();
}
</code></pre>

<p><img src="https://i.loli.net/2018/08/02/5b626eaba4573.png" alt="express-middleware.png" /></p>

<blockquote>
  <p>next() 函数不是 Node.js 或 Express API 的一部分，而是传递给中间件函数的第三自变量。next() 函数可以命名为任何名称，但是按约定，始终命名为 “next”。</p>
</blockquote>

<p>Express 应用可使用如下几种中间件：</p>

<ul>
  <li><strong>应用级中间件</strong></li>
  <li><strong>路由级中间件</strong></li>
  <li><strong>错误处理中间件</strong></li>
  <li><strong>内置中间件</strong></li>
  <li><strong>第三方中间件</strong></li>
</ul>

<p>1、<strong>应用级中间件</strong>绑定到 app 对象，使用 app.use() 和 app.METHOD():</p>

<pre><code class="language-JS">// 没有挂载路径的中间件，应用的每个请求都会执行该中间件
app.use(function (req, res, next) {
  console.log('Time:', Date.now());
  next();
});

// 挂载至 /user/:id 的中间件，任何指向 /user/:id 的请求都会执行它
app.use('/user/:id', function (req, res, next) {
  console.log('Request Type:', req.method);
  next();
});

// 路由和句柄函数(中间件系统)，处理指向 /user/:id 的 GET 请求
app.get('/user/:id', function (req, res, next) {
  res.send('USER');
});
</code></pre>

<p>2、<strong>路由级中间件</strong>和应用级中间件一样，只是它绑定的对象为 express.Router()，具体示例<a href="#路由">查看下面路由</a></p>

<p>3、<strong>错误处理中间件</strong>其他中间件定义类似，只是要使用 4 个参数，而不是 3 个，其签名如下: (err, req, res, next)，一般在其他 app.use() 和路由调用后，最后定义错误处理中间件:</p>

<pre><code class="language-JS">app.use(function (err, req, res, next) {
  console.error(err.stack);
  res.status(500).send('Something broke!');
});
</code></pre>

<p>4、<strong>内置中间件</strong>，即上述的 express.static</p>

<p>5、<strong>第三方中间件</strong>，如 cookie-parser、connect-flash 等</p>

<pre><code class="language-JS">const flash = require('connect-flash') // 页面通知的中间件，基于 session 实现
app.use(flash()) // flash 中间件，用来显示通知
</code></pre>

<h2 id="路由">路由</h2>

<p>每个 Express 程序有一个内建的 <a href="http://www.expressjs.com.cn/guide/routing.html">app 路由</a>。 路由自身表现为一个中间件，所以你可以使用它作为 app.use() 等方法的一个参数或者作为另一个路由的 use() 的参数。 顶层的 express 对象有一个 Router() 方法来创建一个新的 router 对象。</p>

<pre><code class="language-JS">var router = express.Router([options]);
</code></pre>

<p>options 参数可选:</p>

<ul>
  <li>caseSensitive - 是否区分大小写，默认不启用。对待 /Foo 和 /foo 一样</li>
  <li>mergeParams - 保存父路由的 res.params 。如果父路由参数和子路由参数冲突，子路由参数优先。默认 false</li>
  <li>strict - 启用严格路由。默认不启用，/foo 和 /foo/ 被路由一样对待处理</li>
</ul>

<p>路由最初的写法:</p>

<pre><code class="language-JS">var http = require('http');
http.createServer(function (req, res) {
  // Homepage
  if(req.url == '/') {
    res.writeHead(200, { 'Content-Type': 'text/html' });
    res.end('Welcome to the homepage!');
  }
  // About page
  else if (req.url == '/about') {
    res.writeHead(200, { 'Content-Type': 'text/html' });
    res.end('Welcome to the about page!');
  }
  // 404!
  else {
    res.writeHead(404, { 'Content-Type': 'text/plain' });
    res.end('404 not found');
  }
}).listen(8000, 'localhost');
</code></pre>

<p>Express 里路由的三种写法如下:</p>

<p>1、使用字符串的路由路径示例:</p>

<pre><code class="language-JS">// 匹配 /about 路径的请求
app.get('/about', function (req, res) {
  res.send('about');
});
</code></pre>

<p>2、使用字符串模式的路由路径示例:</p>

<pre><code class="language-JS">// 匹配 acd 和 abcd
app.get('/ab?cd', function (req, res) {
  res.send('ab?cd');
});
</code></pre>

<p>3、使用正则表达式的路由路径示例:</p>

<pre><code class="language-JS">// 匹配任何路径中含有 a 的路径
app.get(/a/, function (req, res) {
  res.send('/a/');
});

// 匹配 butterfly、dragonfly，不匹配 butterflyman、dragonfly man等
app.get(/.*fly$/, function (req, res) {
  res.send('/.*fly$/');
});
</code></pre>

<p>路由句柄有多种形式，可以是一个函数、一个函数数组，或者是两者混合:</p>

<pre><code class="language-JS">var cb0 = function (req, res, next) {
  console.log('CB0');
  next();
}

var cb1 = function (req, res, next) {
  console.log('CB1');
  next();
}

app.get('/example/d', [cb0, cb1], function (req, res, next) {
  console.log('response will be sent by the next function ...');
  next(); // 跳到下一个路由句柄
}, function (req, res) {
  res.send('Hello from D!');
});
</code></pre>

<p>可使用 <strong>app.route()</strong> 创建路由路径的链式路由句柄。由于路径在一个地方指定，这样做有助于创建模块化的路由，而且减少了代码冗余和拼写错误:</p>

<pre><code class="language-JS">app.route('/book')
  .get(function (req, res) {
    res.send('Get a random book');
  })
  .post(function (req, res) {
    res.send('Add a book');
  })
  .put(function (req, res) {
    res.send('Update the book');
  });
</code></pre>

<p>可使用 <strong>express.Router</strong> 类创建模块化、可挂载的路由句柄。Router 实例是一个完整的中间件和路由系统，因此常称其为一个 “mini-app”。下面的实例程序创建了一个路由模块，并加载了一个中间件，定义了一些路由，并且将它们挂载至应用的路径上:</p>

<pre><code class="language-JS">// birds.js
var express = require('express');
var router = express.Router();

// 该路由使用的中间件
router.use(function timeLog(req, res, next) {
  console.log('Time: ', Date.now());
  next();
});
// 定义网站主页的路由
router.get('/', function (req, res) {
  res.send('Birds home page');
});
// 定义 about 页面的路由
router.get('/about', function (req, res) {
  res.send('About birds');
});

module.exports = router;
</code></pre>

<p>然后在应用中加载路由模块，应用即可处理发自 /birds 和 /birds/about 的请求，并且调用为该路由指定的 timeLog 中间件:</p>

<pre><code class="language-JS">var birds = require('./birds');
...
app.use('/birds', birds);
</code></pre>

<h2 id="参考链接">参考链接</h2>

<ol>
  <li><a href="http://www.expressjs.com.cn/4x/api.html">Express 4.x API 中文手册</a></li>
  <li><a href="http://expressjs.com/zh-cn/guide/writing-middleware.html">Express - 编写中间件以用于 Express 应用程序</a></li>
  <li><a href="https://www.cnblogs.com/mq0036/p/5243312.html">nodejs 的 express 使用介绍</a></li>
  <li><a href="http://blog.jobbole.com/41325/">深入理解 Express.js</a></li>
</ol>
 
<div id="gitalk-container"></div>
<script>
    var gitalk = new Gitalk({
      enable: true,
      clientID: '020f142489f80c92b097',
      clientSecret: '1fa083372b44031cf1b8249251515c4e3d54c69d',
      repo: 'tate-young.github.io',
      owner: 'Tate-Young',
      admin: ['Tate-Young'],
      id: location.pathname,      // Ensure uniqueness and length less than 50
      distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script>
<!-- disqus -->
<!-- <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function () {
        this.page.url = 'https://tate-young.github.io/2018/04/10/express-middleware-route.html';
        this.page.identifier = '/2018/04/10/express-middleware-route';
        this.page.title = 'Express 中间件与路由';
    };

    (function () { // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document,
            s = d.createElement('script');

        s.src = '//tate.disqus.com/embed.js'; // IMPORTANT: Replace EXAMPLE with your forum shortname!

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript> -->


            <!-- <p class="post-info">
			本文由 <a href="/">liberxue</a> 创作，采用 <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external nofollow">知识共享署名4.0</a> 国际许可协议进行许可<br>本站文章除注明转载/出处外，均为本站原创或翻译，转载前请务必署名<br>最后编辑时间为:2018-04-10 09:55:00</p> -->
        </div>
    </article>

    <!-- <div class="related-post-lists">
	<div class="post-lists">
		<div class="post-lists-body">
					<div class="post-list-item">
				<div class="post-list-item-container">
					<div class="item-label">
						<div class="item-title"><a href="induction.html">归纳的随想</a></div>
						<div class="item-meta clearfix">
														<div class="item-meta-ico bg-ico-image" style="background: url('../usr/themes/pinghsu/images/bg-ico.png') no-repeat;background-size: 40px auto;"></div>
	                        							<div class="item-meta-cat"><a href="../category/thoughts/index.html">Thoughts</a></div>
						</div>
					</div>
				</div>
			</div>
				</div>
	</div>
</div> -->

    <!-- <footer class="footer bg-white">
	<div class="footer-social">
		<div class="footer-container clearfix">
			<div class="social-list">
	 <a class="social segmentfault" target="blank" href="https://segmentfault.com/u/liberxue" title="访问 LiberXue_Twitter" data-hover="Segmentfault">Segmentfault</a>
    <a class="social github" target="blank" href="https://github.com/liberxue" title="访问 LiberXue_Twitter" data-hover="GitHub">GitHub</a>
    <a class="social twitter" target="blank" href="http://twitter.com/liberxue" title="访问 LiberXue_Twitter" data-hover="Twitter">Twitter</a>
     <a class="social stackoverflow" target="blank" href="https://stackoverflow.com/users/6902190/liberxue" title="访问 LiberXue_stackoverflow" data-hover="StackOverflow">StackOverflow</a>
          <a class="social oschina" target="blank" href="https://my.oschina.net/bolanzw" title="访问 LiberXue_Oschina" data-hover="Oschina">Oschina</a>
     <a class="social rss" target="blank" href="/feed.xml"title="访问 LiberXue_RSS" data-hover="RSS">RSS</a>
	</div>
		</div>
	</div>
	<div class="footer-meta">
        <div class="footer-container">
            <div class="meta-item meta-copyright">
                <div class="meta-copyright-info">
                    <a href="/" class="info-logo">
                         <img src="http://localhost:2333/style/images/logo-liberxue.png"   title="访问 LiberXue_blog" data-hover="LiberXue_blog" alt="LiberXue_blog" /> </a>
                    <div class="info-text">
                        <p>Theme is <a href="http://www.liberxue.com/2017/08/03/Jekyllthemes.html" title="访问 Jekyll liberxue主题"  data-hover="Jekyll liberxue"target="_blank">Jekyll liberxue</a> by <a href="http://www.liberxue.com/about" target="_blank">liberxue</a></p>
                        <p>Powered by <a href="http://localhost:2333/tags/#Jekyll" title="Jekyll" data-hover="Jekyll" target="_blank" rel="nofollow">Jekyll</a></p>
                        <p>&copy; 2017 <a href="/feed.xml"  title="访问 liberxue blog RSS" data-hover="liberxue blog RSS">liberxue blog RSS</a></p>
                        <p>总计文章：篇</p>
                      <p>本blog已开源点击Fork</p><iframe src="http://ghbtns.com/github-btn.html?user=liberxue&repo=liberxue.github.io&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="95" height="20"></iframe>
                    </div>
                </div>
            </div>
            <div class="meta-item meta-posts">
                <h3 class="meta-title">置顶文章</h3>
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
            </div>
            <div class="meta-item meta-comments">
                <h3 class="meta-title">最新文章</h3>
  
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
</div>
		</div>
    </div>
</footer> -->
<script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.js"></script>
<script async src="/search/js/520.js"></script>
<script async src="/search/js/gtag.js"></script>
<script async src="/search/live2d/autoload.js"></script>
<!-- <script src="/search/js/canvas.js"></script> -->

<script>
    $(function () {
        setTimeout(function () {
            $('code').removeClass('hljs');
            $('code').removeClass('language');
        }, 90);
    });
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    <!--liberxueconnnet-menu-->
    <div id="directory-content" class="directory-content">
        <div id="directory"></div>
    </div>
    <!--liberxueconnnet-menu-->
    <script>
      const directoryContainer = document.getElementById('directory')
      const postTitle = document.getElementsByClassName('post-title')[0]
      var postDirectoryBuild = function () {
        var postChildren = function children(childNodes, reg) {
          var result = [],
              isReg = typeof reg === 'object',
              isStr = typeof reg === 'string',
              node, i, len;
          for (i = 0, len = childNodes.length; i < len; i++) {
            node = childNodes[i];
            if ((node.nodeType === 1 || node.nodeType === 9) &&
              (!reg ||
                  isReg && reg.test(node.tagName.toLowerCase()) ||
                  isStr && node.tagName.toLowerCase() === reg)) {
                result.push(node);
              }
            }
            return result;
          },
          createPostDirectory = function (article, directory, isDirNum) {
            var contentArr = [],
                titleId = [],
                levelArr, root, level,
                currentList, list, li, link, i, len;
            levelArr = (function (article, contentArr, titleId) {
                  var titleElem = postChildren(article.childNodes, /^h\d$/),
                      levelArr = [],
                      lastNum = 1,
                      lastRevNum = 1,
                      count = 0,
                      guid = 1,
                      id = 'directory' + (Math.random() + '').replace(/\D/, ''),
                      lastRevNum, num, elem;
                  while (titleElem.length) {
                      elem = titleElem.shift();
                      contentArr.push(elem.innerHTML);
                      num = +elem.tagName.match(/\d/)[0];
                      if (num > lastNum) {
                          levelArr.push(1);
                          lastRevNum += 1;
                      } else if (num === lastRevNum ||
                          num > lastRevNum && num <= lastNum) {
                          levelArr.push(0);
                          lastRevNum = lastRevNum;
                      } else if (num < lastRevNum) {
                          levelArr.push(num - lastRevNum);
                          lastRevNum = num;
                      }
                      count += levelArr[levelArr.length - 1];
                      lastNum = num;
                      elem.id = elem.id || (id + guid++);
                      titleId.push(elem.id);
                  }
                  if (count !== 0 && levelArr[0] === 1) levelArr[0] = 0;

                  return levelArr;
              })(article, contentArr, titleId);
              currentList = root = document.createElement('ul');
              dirNum = [0];
              for (i = 0, len = levelArr.length; i < len; i++) {
                  level = levelArr[i];
                  if (level === 1) {
                      list = document.createElement('ul');
                      if (!currentList.lastElementChild) {
                          currentList.appendChild(document.createElement('li'));
                      }
                      currentList.lastElementChild.appendChild(list);
                      currentList = list;
                      dirNum.push(0);
                  } else if (level < 0) {
                      level *= 2;
                      while (level++) {
                          if (level % 2) dirNum.pop();
                          currentList = currentList.parentNode;
                      }
                  }
                  dirNum[dirNum.length - 1]++;
                  li = document.createElement('li');
                  link = document.createElement('a');
                  link.name = '#' + titleId[i];
                  link.href = 'Javascript:;'
                  link.className = "post-aside-anchor"
                  link.title = '访问' + titleId[i];
                  link.innerHTML = !isDirNum ? contentArr[i] :
                      dirNum.join('.') + ' ' + contentArr[i];
                  li.appendChild(link);
                  currentList.appendChild(li);
              }
            directory.appendChild(root);
          };
        createPostDirectory(document.getElementById('post-content'), directoryContainer, true);
      };
      postDirectoryBuild();
    </script>
    <script>
      // gtag('config', GA_TRACKING_ID, {
      //   'page_title' : 'Blog',
      //   'page_path': window.location.pathname,
      //   'post_title': 'watttsdfasdf',
      // });

    </script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script>
        lang = hljs.initHighlightingOnLoad();
    </script>
</body>

</html>
