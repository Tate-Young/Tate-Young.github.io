
<!DOCTYPE>
<html lang="zh-cn" data-scribe-reduced-action-queue="true">

<head>
    <meta content='AngularJS 启动过程 - Tate & Snow' name='title' />
    <meta content='AngularJS 启动过程 - Tate & Snow' name='og:title' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <title>AngularJS 启动过程 - Tate & Snow</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>AngularJS 启动过程 - Tate & Snow</title>
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AngularJS 启动过程 - Tate & Snow">
<meta name="twitter:keywords" content="AngularJS 启动过程 - Tate & Snow" property='og:description' />
<meta property="og:type" content="article">
<meta property="og:title" content="AngularJS 启动过程 - Tate & Snow">
<meta name="og:keywords" content="AngularJS 启动过程 - Tate & Snow|AngularJS 启动过程AngularJS 是一个 JavaScript 框架，可以构建一个单一页面应用程序(SPAs：Single Page Applications)，ng-app 指令定义一个 AngularJS 应用程序，..."
  property='og:description' />
<link rel="icon" type="image/png" href="http://localhost:4000/style/favicons/favicon.ico" />
<link href="http://localhost:4000/style/favicons/favicon.ico" rel="shortcut icon" type="image/png">
<link rel="canonical" href="http://localhost:4000/">
<link rel="alternate" type="application/rss+xml" title="Liberxue" href="http://localhost:4000/feed.xml">
<meta charset="UTF-8">
<link rel="manifest" href="/manifest.json">
<link rel="shortcut icon" href="http://localhost:4000/style/favicons/favicon.ico" type="image/x-icon">
<meta name="keywords" content="AngularJS 启动过程AngularJS 是一个 JavaScript 框架，可以构建一个单一页面应用程序(SPAs：Single Page Applications)，ng-app 指令定义一个 AngularJS 应用程序，..." property='og:description'
/>
<meta name="description" content="Tate & Snow's Github blog" />
<link href="https://cdn.bootcss.com/highlight.js/9.10.0/styles/xcode.min.css" rel="stylesheet">
<link href="http://localhost:4000/style/theme.css" rel="stylesheet"> 
<meta content='http://localhost:4000/2018/04/24/ng-bootstrap.html' property='og:url' />
<meta content="http://localhost:4000/2018/04/24/ng-bootstrap.html|AngularJS 启动过程AngularJS 是一个 JavaScript 框架，可以构建一个单一页面应用程序(SPAs：Single Page Applications)，ng-app 指令定义一个 AngularJS 应用程序，..." property='og:description'
/>
<meta content="article" property="og:type" /> 

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-136311746-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  window.GA_TRACKING_ID = 'UA-136311746-1'
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('set', {
    'country': 'US',
    'currency': 'USD',
    'description': 'fuck',
  });
  gtag('config', GA_TRACKING_ID, {
    'custom_map': {
      'dimension1': 'post_title',
    },
    'post_title': 'test',
  });
</script>
<meta content="" property="fb:app_id" />
<script>
  (function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s);
    js.id = id;
    js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

</head>

<body class="" gtools_scp_screen_capture_injected="true">
    <header id="header" class="header bg-white">
        <div class="navbar-container">
            <a href="Javascript:;" onclick="onClickLogo()" title="访问 Tate & Snow" class="navbar-logo">
                <img src="https://i.loli.net/2018/03/13/5aa74f5b4c2c7.png" alt="Tate & Snow"> </a>
            <!-- <a href="/?tate" title="访问 Tate & Snow" class="navbar-logo">Tate & Snow</a>   -->
            <div class="navbar-menu">
                
                <a href="Javascript:;" onclick="onClickMenu('首页', '/')" title="访问 首页" data-hover="首页">首页</a>
                
                <a href="Javascript:;" onclick="onClickMenu('前端', '/front')" title="访问 前端" data-hover="前端">前端</a>
                
                <a href="Javascript:;" onclick="onClickMenu('框架', '/tool')" title="访问 框架" data-hover="框架">框架</a>
                
                <a href="Javascript:;" onclick="onClickMenu('后端', '/back')" title="访问 后端" data-hover="后端">后端</a>
                
                <a href="Javascript:;" onclick="onClickMenu('标签', '/tags')" title="访问 标签" data-hover="标签">标签</a>
                
                <a href="Javascript:;" onclick="onClickMenu('关于', '/README')" title="访问 关于" data-hover="关于">关于</a>
                
            </div>
            <!-- <div class="navbar-menu">
                
                <a href="http://localhost:4000/">首页</a>
                
                <a href="http://localhost:4000/front">前端</a>
                
                <a href="http://localhost:4000/tool">框架</a>
                
                <a href="http://localhost:4000/back">后端</a>
                
                <a href="http://localhost:4000/tags">标签</a>
                
                <a href="http://localhost:4000/README">关于</a>
                
            </div> -->
            <div class="navbar-search" onclick="onClickSearch()">
                <span class="icon-search"></span>
                <form id="cb-search-btn" role="search">
                    <span class="search-box">
                        <input type="text" class="input" id="cb-search-content" required="true" placeholder="标题 标签..." maxlength="30" autocomplete="off">
                    </span>
                </form>
            </div>
            <div class="navbar-mobile-menu" onclick="">
                <span class="icon-menu cross">
                    <span class="middle"></span>
                </span>
                <ul>
                    
                    <li>
                        <a href="Javascript:;" onclick="onClickMenu('首页', 'http://localhost:4000/')">首页</a>
                    </li>
                    
                    <li>
                        <a href="Javascript:;" onclick="onClickMenu('前端', 'http://localhost:4000/front')">前端</a>
                    </li>
                    
                    <li>
                        <a href="Javascript:;" onclick="onClickMenu('框架', 'http://localhost:4000/tool')">框架</a>
                    </li>
                    
                    <li>
                        <a href="Javascript:;" onclick="onClickMenu('后端', 'http://localhost:4000/back')">后端</a>
                    </li>
                    
                    <li>
                        <a href="Javascript:;" onclick="onClickMenu('标签', 'http://localhost:4000/tags')">标签</a>
                    </li>
                    
                    <li>
                        <a href="Javascript:;" onclick="onClickMenu('关于', 'http://localhost:4000/README')">关于</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </header>
    <a href="#header" class="back-to-top" onclick="onClickTop('AngularJS 启动过程')">⤴Top⤴</a>
    <div class="post-header-thumb bg-white}">
        <div class="post-header-thumb-op"></div>
        <div class="post-header-thumb">
            <div class="post-header-thumb-container">
                <h1 class="post-title" itemprop="name headline">
                    AngularJS 启动过程</h1>
                <div class="post-data">
                    <time datetime="2018-04-24 16:35:00" itemprop="datePublished">
                      发布时间：2018-04-24 16:35:00
                      &nbsp;&nbsp;&nbsp;
                      
                    </time>
                    <a onclick="onClickCategory('前端')" href="Javascript:;" title="访问 前端" data-hover="博客分类: 前端">博客分类: 前端</a>
                    <!-- <a href="#read"> 阅读次数: comments</a>  -->
                </div>
                <div class="post-tags">
                       
                    <a href="Javascript:;" onclick="onClickTag('AngularJS')" title="访问AngularJS" data-hover="AngularJS">
                        AngularJS
                        <span>(4)</span>
                        
                    </a>
                       
                </div>
            </div>
        </div>
    </div>
    <article class="main-content post-page" itemscope itemtype="http://schema.org/Article">
        <div class="post-header">
            <h1 class="post-title" itemprop="name headline">
                AngularJS 启动过程</h1>
            <div class="post-data">
                <time datetime="2018-04-24 16:35:00" itemprop="datePublished">2018-04-24 16:35:00</time>
            </div>
        </div>
        <div id="post-content" class="post-content" itemprop="articleBody">
            <p class="post-tags">
                   
                <a href="Javascript:;" onclick="onClickTag('AngularJS')" title="访问AngularJS" data-hover="AngularJS">
                    AngularJS
                    <span>(4)</span>
                    </a>
                   
            </p>
            <h1 id="angularjs-启动过程">AngularJS 启动过程</h1>

<p><strong>AngularJS</strong> 是一个 JavaScript 框架，可以构建一个单一页面应用程序(SPAs：Single Page Applications)，<strong>ng-app</strong> 指令定义一个 AngularJS 应用程序，决定整个框架的启动和作用范围。主要分为三个步骤(本文依据 AngularJS@1.6.4):</p>

<ol>
  <li><strong>bindJQuery()</strong> - 绑定 jQuery 或 jQLite;</li>
  <li><strong>publishExternalAPI(angular)</strong> - 输出 angular 对象的 API;</li>
  <li><strong>jqLite(function(){ angularInit(window.document, bootstrap) })</strong> - DOM 解析完毕后，初始化并启动。</li>
</ol>

<pre><code class="language-JS">angular = window.angular || (window.angular = {})

if (window.angular.bootstrap) { // 判断 angular 是否已启动
  // AngularJS is already loaded, so we can return here...
  if (window.console) {
    console.log('WARNING: Tried to load angular more than once.');
  }
  return;
}
bindJQuery(); // 绑定 jQuery，默认为 jQLite
publishExternalAPI(angular);// 输出 angular 对象的 API
jqLite(function() { // 初始化和启动 angular
  angularInit(window.document, bootstrap);
});
</code></pre>

<p>这里引用作者城池的一张图:</p>

<p><img src="https://i.loli.net/2018/04/24/5adef95123f4f.jpg" alt="angularInit" /></p>

<h2 id="bindjquery">bindJQuery()</h2>

<p><strong>bindJQuery()</strong> 用于绑定 jQuery，默认为更轻量级的 <a href="https://docs.angularjs.org/api/ng/function/angular.element">jQLite</a>。</p>

<pre><code class="language-JS">if (jQuery &amp;&amp; jQuery.fn.on) {
    jqLite = jQuery;
    /* ... */
  } else {
    jqLite = JQLite;
  }

  angular.element = jqLite;

  // Prevent double-proxying.
  bindJQueryFired = true;
}
</code></pre>

<p><strong>angular.element()</strong> 与 jQuery 的 <strong>$()</strong> 类似，但只支持 DOM 元素或类似 html 元素的字符串，而不支持选择器:</p>

<pre><code class="language-JS">angular.element('&lt;div&gt;');
angular.element(document.getElementById(‘myId’));

// angular.element('#myId'); // 错误的写法
</code></pre>

<h2 id="publishexternalapi">publishExternalAPI()</h2>

<p><strong>publishExternalAPI()</strong> 接受一个 angular 对象，用来输出对象上定义的接口。这一过程分为以下几个步骤:</p>

<ol>
  <li>将工具函数拷贝到 angular 全局对象中;</li>
  <li>调用 setupModuleLoader 方法创建模块定义和加载工具;</li>
  <li>构建内置模块 ng;</li>
  <li>创建 ng 内置的 directive 和 provider，包括 $parse 和 $rootScope 等。</li>
</ol>

<pre><code class="language-JS">function publishExternalAPI(angular) {
  extend(angular, { // 将工具函数拷贝到 angular 全局对象中
    'errorHandlingConfig': errorHandlingConfig,
    'bootstrap': bootstrap,
    'copy': copy,
    'extend': extend,
    'merge': merge,
    'equals': equals,
    'element': jqLite,
    'forEach': forEach,
    /* ... */
  });

  angularModule = setupModuleLoader(window); // 创建模块加载器，主要作用是通过 angular.module 创建和获取模块

  angularModule('ng', ['ngLocale'], ['$provide',
    function ngModule($provide) {
      // $$sanitizeUriProvider needs to be before $compileProvider as it is used by it.
      $provide.provider({
        $$sanitizeUri: $$SanitizeUriProvider
      });
      $provide.provider('$compile', $CompileProvider).
        directive({ // //创建 ng 内置的 directive
          a: htmlAnchorDirective,
          input: inputDirective,
          ngBind: ngBindDirective,
          ngClass: ngClassDirective,
          ngController: ngControllerDirective,
          ngRepeat: ngRepeatDirective,
          ngShow: ngShowDirective,
          /* ... */
        }).
        directive({
          ngInclude: ngIncludeFillContentDirective
        }).
        directive(ngAttributeAliasDirectives).
        directive(ngEventDirectives);
      $provide.provider({ // 创建 ng 内置的 provider
        $filter: $FilterProvider,
        $http: $HttpProvider,
        $parse: $ParseProvider,
        $rootScope: $RootScopeProvider,
        $q: $QProvider,
        $sce: $SceProvider,
        $timeout: $TimeoutProvider,
        /* ... */
      });
    }
  ])
  .info({ angularVersion: '1.6.4' });
}
</code></pre>

<h3 id="setupmoduleloader">setupModuleLoader()</h3>

<p><strong>setupModuleLoader()</strong> 的实现如下:</p>

<ol>
  <li>主要为 angular 定义 module 属性;</li>
  <li>在 module 上挂载 controller、directive、service 等方法，注意此处只是定义服务，真正的创建是通过注入器来完成的。</li>
</ol>

<pre><code class="language-JS">function setupModuleLoader(window) {
  function ensure(obj, name, factory) { // 通过 ensure 方法得到的对象能够保证全局唯一性
    return obj[name] || (obj[name] = factory());
  }
  var angular = ensure(window, 'angular', Object); // 确保 window 对象拥有 angular 属性
  return ensure(angular, 'module', function() { // 返回 angular.module
    var modules = {};

    return function module(name, requires, configFn) { // name 用来定义模块的名称，requires 是一个数组对象，用来定义该模块以外的模块名称
      /* ... */
      return ensure(modules, name, function() { // 执行 angular.module() 后，在返回的 moduleInstance 实例上挂载以下方法，再次返回该实例。因此可以链式调用
        var moduleInstance = {
          // Private state
          _invokeQueue: invokeQueue, // // invokeQueue 会被初始化为一个空数组 []
          _configBlocks: configBlocks,
          _runBlocks: runBlocks,
          provider: invokeLaterAndSetModuleName('$provide', 'provider'),
          service: invokeLaterAndSetModuleName('$provide', 'service'),
          filter: invokeLaterAndSetModuleName('$filterProvider', 'register'),
          controller: invokeLaterAndSetModuleName('$controllerProvider', 'register'),
          directive: invokeLaterAndSetModuleName('$compileProvider', 'directive'),
          /* ... */
          run: function(block) {
            runBlocks.push(block);
            return this;
          }
        }
        return moduleInstance;

        /* ... */
        function invokeLaterAndSetModuleName(provider, method, queue) { // 默认将参数 push 到 _invokeQueue 中稍后执行
          if (!queue) queue = invokeQueue;
          return function(recipeName, factoryFunction) {
            if (factoryFunction &amp;&amp; isFunction(factoryFunction)) factoryFunction.$$moduleName = name;
            queue.push([provider, method, arguments]);
            return moduleInstance;
          };
        }
      });
    };
   });
};
</code></pre>

<p>因此，在声明 angular.module 后，可以在返回的对象上挂载控制器或服务等，且支持链式调用，如 <code>.controller().directive()</code>:</p>

<pre><code class="language-JS">// 创建模块
var app = angular.module('myAPP', []);

// 获取模块
angular
  .module('myApp')
  .controller('myController', myController);

myController.$inject = ['$scope']; // 标注式依赖注入

function myController($scope) {
  $scope.name = 'tate';
}
</code></pre>

<h2 id="angularinit">angularInit()</h2>

<p><strong>angularInit</strong> 方法定义了 angular 的初始化方法，查找 <code>ng-app='myApp'</code> 指令，得到名为 “myApp” 的模块，并在末尾直接调用了 <strong>bootstrap</strong> 方法启动:</p>

<pre><code class="language-JS">var ngAttrPrefixes = ['ng-', 'data-ng-', 'ng:', 'x-ng-'];

function angularInit(element, bootstrap) {
  var appElement,
      module,
      config = {};

  // The element `element` has priority over any other element.
  // 寻找 ng-app 指令，包含 ng:app、x-ng-app 等
  forEach(ngAttrPrefixes, function(prefix) {
    var name = prefix + 'app';

    if (!appElement &amp;&amp; element.hasAttribute &amp;&amp; element.hasAttribute(name)) {
      appElement = element;
      module = element.getAttribute(name);
    }
  });
  forEach(ngAttrPrefixes, function(prefix) {
    /* ... */
  });
  if (appElement) {
    /* ... */
    bootstrap(appElement, module ? [module] : [], config);
  }
}
</code></pre>

<p>若页面存在多个 ng-app 指令，AngularJS 只会自动引导启动它找到的第一个 ng-app 应用，此时可以通过 <code>angular.bootstrap</code> 方法手动引导:</p>

<pre><code class="language-JS">angular.bootstrap(element, [modules], [config]);
</code></pre>

<h3 id="bootstrap">bootstrap()</h3>

<p><strong>bootstrap</strong> 方法的主要实现如下:</p>

<pre><code class="language-JS">function bootstrap(element, modules, config) {
  /* ... */
  var doBootstrap = function() {
    element = jqLite(element);

    if (element.injector()) {
      var tag = (element[0] === window.document) ? 'document' : startingTag(element);

    modules = modules || []; // 目前 modules = ['myApp']
    modules.unshift(['$provide', function($provide) {
      $provide.value('$rootElement', element);
    }]);
    modules.unshift('ng'); // 需要注入的模块数组

    // 创建根注入器，返回一个 instanceInjector 实例，继承 invoke、get 等方法
    // 此时 modules = ['ng',['$provider',function(){/.../}], 'myApp']
    var injector = createInjector(modules, config.strictDi);
    injector.invoke(['$rootScope', '$rootElement', '$compile', '$injector',
       function bootstrapApply(scope, element, compile, injector) {
        scope.$apply(function() { // 调用 $apply 方法将将作用域转入 angular 作用域，即通过脏检查实现数据双向绑定
          element.data('$injector', injector);
          compile(element)(scope); // compile 编译，编译的核心是生成指令对应的 link 函数
        });
      }]
    );
    return injector;
  };
  /* ... */
}
</code></pre>

<h3 id="createinjector">createInjector()</h3>

<p><strong>createInjector</strong> 方法用来创建根注入器，注入器是访问 AngularJS 所有功能的入口，而 AngularJS 的功能实现，是通过模块的方式组织的。所以在创建注入器的时候，需要告诉 AngularJS 载入哪些模块，即上述的 modules:</p>

<pre><code class="language-JS">function createInjector(modulesToLoad, strictDi) {
  strictDi = (strictDi === true);
  var INSTANTIATING = {},
    providerSuffix = 'Provider',
    path = [],
    loadedModules = new NgMap(), // 操作存储模块的一个数据结构，如 get、set 等
    providerCache = {
      $provide: {
        provider: supportObject(provider),
        factory: supportObject(factory),
        service: supportObject(service),
        value: supportObject(value),
        constant: supportObject(constant),
        decorator: decorator
      }
    },
    providerInjector = (providerCache.$injector = // provider 注入器
      createInternalInjector(providerCache, function(serviceName, caller) {
        if (angular.isString(caller)) {
          path.push(caller);
        }
        throw $injectorMinErr('unpr', 'Unknown provider: {0}', path.join(' &lt;- '));
      })),
    instanceCache = {}, // // 所有被注入器管理的对象缓存
    protoInstanceInjector =
      createInternalInjector(instanceCache, function(serviceName, caller) {
        var provider = providerInjector.get(serviceName + providerSuffix, caller);
        return instanceInjector.invoke(
          provider.$get, provider, undefined, serviceName);
      }),
    instanceInjector = protoInstanceInjector;

  // 此处将实例注入器通过 $injectorProvider 这个键值给注册到了 providerCache 中去
  // 当你需要 $injector 时，实例注入器会委托给 provider 注入器，该注入器去寻找一个名为 $injectorProvider 的 provider 对象，并调用其 $get 方法返回真正的实例。
  providerCache['$injector' + providerSuffix] = { $get: valueFn(protoInstanceInjector) };
  instanceInjector.modules = providerInjector.modules = createMap();

  var runBlocks = loadModules(modulesToLoad); // 加载模块
  instanceInjector = protoInstanceInjector.get('$injector');
  instanceInjector.strictDi = strictDi;

  // 遍历并执行创建工作
  forEach(runBlocks, function(fn) { if (fn) instanceInjector.invoke(fn); });

  return instanceInjector; // 返回一个注入器实例

  ////////////////////////////////////
  // $provider
  ////////////////////////////////////
  function supportObject(delegate) {
    return function(key, value) {
      if (isObject(key)) {
        forEach(key, reverseParams(delegate));
      } else {
        return delegate(key, value);
      }
    };
  }

  function provider(name, provider_) {
    assertNotHasOwnProperty(name, 'service');
    if (isFunction(provider_) || isArray(provider_)) { // 如果提供的是 provider 是函数或者数组，直接使用 injector 实例化
      provider_ = providerInjector.instantiate(provider_);
    }
    if (!provider_.$get) {
      throw $injectorMinErr('pget', 'Provider \'{0}\' must define $get factory method.', name);
    }
    return (providerCache[name + providerSuffix] = provider_);
  }

  function factory(name, factoryFn, enforce) { // factory 服务本质上调用的是 provider
    return provider(name, {
      $get: enforce !== false ? enforceReturnValue(name, factoryFn) : factoryFn
    });
  }

  function service(name, constructor) { // service 服务本质上调用的是 factory，只是书写形式不同而已
    return factory(name, ['$injector', function($injector) {
      return $injector.instantiate(constructor);
    }]);
  }
}
</code></pre>

<p>可以看到在 <strong>$provide</strong> 的实现里有以下几个方法: provider、service、factory 等。内部其实调用的都是 provider 方法，provider 方法必须包含一个 $get 属性，但通过 service、factory 等方法创建的话，不必显式的调用 $get 属性，因为 factory 方法中已经帮你实现了。具体写法请<a href="#provider--factory--service">参考以下部分</a>。</p>

<p>这里涉及几个重要的变量，一个是 <strong>providerCache</strong>，这个会保存一个 $provide 属性对象，此属性对象主要用来对外提供创建服务提供者(provider)的方法，同时，providerCache 会保存所有已经注入进来的 provider。providerCache 还有一个 $injector 属性对象，此属性对象就是一个注入器实例。它跟另一个变量 <strong>providerInjector</strong> 指向的是同一个注入器实例对象。</p>

<p><strong>instanceCache</strong> 变量会保存所有已经实例化的 provider 对象，同时，这个变量的 $injector 属性值是一个注入器实例。它跟另外一个变量 <strong>instanceInjector</strong> 指向的是同一个注入器实例对象，这个注入器实例对象是用来真正实例化一个 provider 的。</p>

<pre><code class="language-JS">providerCache = {
  $provide: {
    provider: supportObject(provider),
    factory: supportObject(factory),
    service: supportObject(service),
    value: supportObject(value),
    constant: supportObject(constant),
    decorator: decorator
  },
  $injector:{
    invoke:invoke,
    instantiate:instantiate,
    get:getService,
    annotate:annotate,
    has:has
  }
}

instanceInjector = {
  invoke: invoke,
  instantiate: instantiate,
  get: getService,
  annotate: annotate,
  has: has
}
</code></pre>

<h3 id="createinternalinjector">createInternalInjector()</h3>

<pre><code class="language-JS">function createInternalInjector(cache, factory) {
  // 获取服务的函数，函数体中的 cache 就是之前提到的 instanceCache
  function getService(serviceName, caller) {}

  function invoke(fn, self, locals, servicename) {}

  // module 上定义 service，provider 的时候，实际上内部就是调用的 instantiate 函数来完成对象的创建
  function instantiate(Type, locals, serviceName) {}

  return { // $injector 服务，返回五个方法
    invoke: invoke,
    instantiate: instantiate,
    get: getService,
    annotate: createInjector.$$annotate,
    has: function(name) {
      return providerCache.hasOwnProperty(name + providerSuffix) || cache.hasOwnProperty(name);
    }
  };
}
</code></pre>

<p><strong>invoke</strong> 方法可以直接调用一个用户自定义的函数体，并通过函数参数注入所依赖的服务对象，并进行实例化:</p>

<pre><code class="language-JS">angular.injector(['ng'])
  .invoke(function($http){
    //do sth. with $http
  });
</code></pre>

<p><strong>annotate</strong> 注释是实现依赖注入的关键元素之一，查看后文示例–<a href="#依赖注入的三种写法">依赖注入的三种写法</a>，AngularJS 如何知道需要注入 $scope 以及 $rootScope 呢？详情可以<a href="https://blog.csdn.net/dm_vincent/article/details/52081180">查看这篇博客</a>。</p>

<h3 id="loadmodules">loadModules()</h3>

<p>在加载模块的时候，之前定义在任务队列(_invokeQueue)中的任务就会被执行:</p>

<pre><code class="language-JS">function loadModules(modulesToLoad) {
  /* ... */
  forEach(modulesToLoad, function(module) { // 加载传入的每个模块
    function runInvokeQueue(queue) { // 运行传入的 _invokeQueue
      var i, ii;
      // 通过注入器得到对应的服务提供者 provider，然后调用服务提供者的实例化方法，创建这个服务的实例对象
      for (i = 0, ii = queue.length; i &lt; ii; i++) {
        var invokeArgs = queue[i],
          provider = providerInjector.get(invokeArgs[0]); // 得到 $provide 对象

        provider[invokeArgs[1]].apply(provider, invokeArgs[2]); // 实际上的调用的是 $provide 对象上的 provider 方法
      }
    }

    try {
      if (isString(module)) { // 实例化
        moduleFn = angularModule(module); // 根据 module 拿到对应的实例，angularModule = setupModuleLoader(window)
        instanceInjector.modules[module] = moduleFn;
        // 递归进行 module 的加载工作，因为被依赖的 module 同样还可以依赖于别的 module
        runBlocks = runBlocks.concat(loadModules(moduleFn.requires)).concat(moduleFn._runBlocks);
        // 开始执行 _invokeQueue 中的任务
        runInvokeQueue(moduleFn._invokeQueue);
        // 开始执行配置队列
        runInvokeQueue(moduleFn._configBlocks);
      } else if (isFunction(module)) {
        runBlocks.push(providerInjector.invoke(module));
      } else if (isArray(module)) {
        runBlocks.push(providerInjector.invoke(module));
      } else {
        assertArgFn(module, 'module');
      }
    } catch (e) {
      if (isArray(module)) {
        module = module[module.length - 1];
      }
      /* ... */
    }
  });
  return runBlocks; // 用于容纳注入器需要执行的任务的数组
}
</code></pre>

<h2 id="依赖注入相关的三种队列">依赖注入相关的三种队列</h2>

<p>本部分摘自<a href="https://blog.csdn.net/dm_vincent/article/details/52199714">配置队列以及运行队列</a>。</p>

<p>1、<strong>任务队列(Invoke Queue)</strong></p>

<p>调用 module 上的高层 API 就会向任务队列中增加一个相应任务，比如 module.constant 的调用就导致了一个常量任务的创建，具体而言就是定义在依赖注入模块(injector.js)中的 constant 函数的执行：</p>

<pre><code class="language-JS">function constant(name, value) {
  assertNotHasOwnProperty(name, 'constant');
  providerCache[name] = value;
  instanceCache[name] = value;
}
</code></pre>

<p>除此之外，还有对应于 config 中 factory、service 等方法的定义在注入器中的 factory 函数和 service 函数等。对于 factory、service 等任务而言，它们的执行并不会导致真正的对象被创建，而是注册一个具体的 provider，这个 provider 知道该如何创建真正的对象，待需要的时候创建之，从而实现”懒加载”。执行时机上，任务队列的执行发生在模块被加载的时候。</p>

<p>2、<strong>配置队列(Config Queue)</strong></p>

<p>配置队列是为了提供一个配置各种 providers 的地方，通过 provider 注入器完成调用。任务队列和执行队列中定义的任务都是通过实例注入器进行调用的，因此它们无法直接地注入定义在 provider 注入器中的各种 providers。配置队列的执行时机和任务队列相似，都是在加载某个模块的时候就会被执行，但是在顺序上它的执行发生在同模块的任务队列执行之后。</p>

<p>3、<strong>运行队列(Run Queue)</strong></p>

<p>它用于定义一些模块的初始化工作。和任务队列一样，定义在运行队列中的任务都是通过实例注入器完成实际的调用工作的。但是和它以及配置队列不一样的是，它的执行时机是在所有模块全部加载完毕之后，此时所有的服务都已经完成注册工作(各路 providers 都已经准备好，知道如何初始化托管对象)。所以当运行队列中的任务被执行时，它是可以将需要的各种依赖都声明在其参数列表中的，哪怕这些依赖被定义在不同的模块中。</p>

<h2 id="依赖注入的三种写法">依赖注入的三种写法</h2>

<p>1、<strong>标注式注入($inject)</strong></p>

<pre><code class="language-JS">angular.module('myApp', []);
  .controller('myController', myFn);

myFn.$inject = ['Alice', 'Bob'];
function myFn(a, b) {
  // a 代表的就是 Alice 服务
  // b 代表的就是 Bob 服务
}
</code></pre>

<p>2、<strong>内联式注入</strong></p>

<pre><code class="language-JS">angular.module('myApp', []);
  .controller('myController', ['Alice', 'Bob', myFn]);

function myFn(a, b) {
  // a 代表的就是 Alice 服务
  // b 代表的就是 Bob 服务
}
</code></pre>

<p>3、<strong>推断式注入</strong></p>

<pre><code class="language-JS">angular.module('myApp', []);
  .controller('myController', myFn);

function myFn(Alice, Bob) {}
</code></pre>

<h2 id="provider--factory--service">provider / factory / service</h2>

<p>三种写法如下，本质上一样:</p>

<pre><code class="language-JS">// service
angular.module('myApp')
  .service('user', function($http) { // 隐式注入服务
    var self = this;  // service() 是通过构造函数创建的
    this.name = 'tate';
    this.setName = function(newName) {
      self.name = newName;
    }
  }
});
</code></pre>

<pre><code class="language-JS">// service
angular.module('myApp')
  .factory('user', function($http) { // 隐式注入服务
    var user = {
      'name': 'tate',
      'setName': function(newName) {
        user.name = newName;
      }
    }
    return user; // 返回 user 对象
  }
});
</code></pre>

<pre><code class="language-JS">// provider
angular.module('myApp')
  .provider('user', function() {
    this.$get = function($http) { // 隐式注入服务
      var user = {
        'name': 'tate',
        'setName': function(newName) {
        user.name = newName;
        }
      }
      return user; // 返回 user 对象
    }
  }
});
</code></pre>

<h2 id="参考链接">参考链接</h2>

<ol>
  <li><a href="https://www.cnblogs.com/sealzrt/p/5465203.html">AngularJS 的启动引导过程</a> By sealzrt</li>
  <li><a href="https://www.cnblogs.com/wuya16/p/3769032.html">angularjs 源码分析之：angularjs 执行流程</a> By 城池</li>
  <li><a href="https://www.cnblogs.com/chaojidan/p/4267846.html">AngularJS 源码解析2：注入器的详解</a> By chaojidan</li>
  <li><a href="https://blog.csdn.net/dm_vincent/article/details/51884464">[AngularJS面面观] 14. 依赖注入 — module 的定义与实现</a> By dm_vincent</li>
  <li><a href="https://segmentfault.com/a/1190000003096933">AngularJS 中的 Provider 们：Service 和 Factory 等的区别</a> By savokiss</li>
</ol>
 
<div id="gitalk-container"></div>
<script>
    var gitalk = new Gitalk({
      enable: true,
      clientID: '020f142489f80c92b097',
      clientSecret: '1fa083372b44031cf1b8249251515c4e3d54c69d',
      repo: 'tate-young.github.io',
      owner: 'Tate-Young',
      admin: ['Tate-Young'],
      id: location.pathname,      // Ensure uniqueness and length less than 50
      distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script>
<!-- disqus -->
<!-- <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function () {
        this.page.url = 'https://tate-young.github.io/2018/04/24/ng-bootstrap.html';
        this.page.identifier = '/2018/04/24/ng-bootstrap';
        this.page.title = 'AngularJS 启动过程';
    };

    (function () { // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document,
            s = d.createElement('script');

        s.src = '//tate.disqus.com/embed.js'; // IMPORTANT: Replace EXAMPLE with your forum shortname!

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript> -->


            <!-- <p class="post-info">
			本文由 <a href="/">liberxue</a> 创作，采用 <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external nofollow">知识共享署名4.0</a> 国际许可协议进行许可<br>本站文章除注明转载/出处外，均为本站原创或翻译，转载前请务必署名<br>最后编辑时间为:2018-04-24 16:35:00</p> -->
        </div>
    </article>

    <!-- <div class="related-post-lists">
	<div class="post-lists">
		<div class="post-lists-body">
					<div class="post-list-item">
				<div class="post-list-item-container">
					<div class="item-label">
						<div class="item-title"><a href="induction.html">归纳的随想</a></div>
						<div class="item-meta clearfix">
														<div class="item-meta-ico bg-ico-image" style="background: url('../usr/themes/pinghsu/images/bg-ico.png') no-repeat;background-size: 40px auto;"></div>
	                        							<div class="item-meta-cat"><a href="../category/thoughts/index.html">Thoughts</a></div>
						</div>
					</div>
				</div>
			</div>
				</div>
	</div>
</div> -->

    <!-- <footer class="footer bg-white">
	<div class="footer-social">
		<div class="footer-container clearfix">
			<div class="social-list">
	 <a class="social segmentfault" target="blank" href="https://segmentfault.com/u/liberxue" title="访问 LiberXue_Twitter" data-hover="Segmentfault">Segmentfault</a>
    <a class="social github" target="blank" href="https://github.com/liberxue" title="访问 LiberXue_Twitter" data-hover="GitHub">GitHub</a>
    <a class="social twitter" target="blank" href="http://twitter.com/liberxue" title="访问 LiberXue_Twitter" data-hover="Twitter">Twitter</a>
     <a class="social stackoverflow" target="blank" href="https://stackoverflow.com/users/6902190/liberxue" title="访问 LiberXue_stackoverflow" data-hover="StackOverflow">StackOverflow</a>
          <a class="social oschina" target="blank" href="https://my.oschina.net/bolanzw" title="访问 LiberXue_Oschina" data-hover="Oschina">Oschina</a>
     <a class="social rss" target="blank" href="/feed.xml"title="访问 LiberXue_RSS" data-hover="RSS">RSS</a>
	</div>
		</div>
	</div>
	<div class="footer-meta">
        <div class="footer-container">
            <div class="meta-item meta-copyright">
                <div class="meta-copyright-info">
                    <a href="/" class="info-logo">
                         <img src="http://localhost:4000/style/images/logo-liberxue.png"   title="访问 LiberXue_blog" data-hover="LiberXue_blog" alt="LiberXue_blog" /> </a>
                    <div class="info-text">
                        <p>Theme is <a href="http://www.liberxue.com/2017/08/03/Jekyllthemes.html" title="访问 Jekyll liberxue主题"  data-hover="Jekyll liberxue"target="_blank">Jekyll liberxue</a> by <a href="http://www.liberxue.com/about" target="_blank">liberxue</a></p>
                        <p>Powered by <a href="http://localhost:4000/tags/#Jekyll" title="Jekyll" data-hover="Jekyll" target="_blank" rel="nofollow">Jekyll</a></p>
                        <p>&copy; 2017 <a href="/feed.xml"  title="访问 liberxue blog RSS" data-hover="liberxue blog RSS">liberxue blog RSS</a></p>
                        <p>总计文章：篇</p>
                      <p>本blog已开源点击Fork</p><iframe src="http://ghbtns.com/github-btn.html?user=liberxue&repo=liberxue.github.io&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="95" height="20"></iframe>
                    </div>
                </div>
            </div>
            <div class="meta-item meta-posts">
                <h3 class="meta-title">置顶文章</h3>
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
            </div>
            <div class="meta-item meta-comments">
                <h3 class="meta-title">最新文章</h3>
  
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
</div>
		</div>
    </div>
</footer> -->
<script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.js"></script>
<script async src="/search/js/520.js"></script>
<script async src="/search/js/gtag.js"></script>
<!-- <script src="/search/js/canvas.js"></script> -->

<script>
    $(function () {
        setTimeout(function () {
            $('code').removeClass('hljs');
            $('code').removeClass('language');
        }, 90);
    });
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    <!--liberxueconnnet-menu-->
    <div id="directory-content" class="directory-content">
        <div id="directory"></div>
    </div>
    <!--liberxueconnnet-menu-->
    <script>
      const directoryContainer = document.getElementById('directory')
      const postTitle = document.getElementsByClassName('post-title')[0]
      var postDirectoryBuild = function () {
        var postChildren = function children(childNodes, reg) {
          var result = [],
              isReg = typeof reg === 'object',
              isStr = typeof reg === 'string',
              node, i, len;
          for (i = 0, len = childNodes.length; i < len; i++) {
            node = childNodes[i];
            if ((node.nodeType === 1 || node.nodeType === 9) &&
              (!reg ||
                  isReg && reg.test(node.tagName.toLowerCase()) ||
                  isStr && node.tagName.toLowerCase() === reg)) {
                result.push(node);
              }
            }
            return result;
          },
          createPostDirectory = function (article, directory, isDirNum) {
            var contentArr = [],
                titleId = [],
                levelArr, root, level,
                currentList, list, li, link, i, len;
            levelArr = (function (article, contentArr, titleId) {
                  var titleElem = postChildren(article.childNodes, /^h\d$/),
                      levelArr = [],
                      lastNum = 1,
                      lastRevNum = 1,
                      count = 0,
                      guid = 1,
                      id = 'directory' + (Math.random() + '').replace(/\D/, ''),
                      lastRevNum, num, elem;
                  while (titleElem.length) {
                      elem = titleElem.shift();
                      contentArr.push(elem.innerHTML);
                      num = +elem.tagName.match(/\d/)[0];
                      if (num > lastNum) {
                          levelArr.push(1);
                          lastRevNum += 1;
                      } else if (num === lastRevNum ||
                          num > lastRevNum && num <= lastNum) {
                          levelArr.push(0);
                          lastRevNum = lastRevNum;
                      } else if (num < lastRevNum) {
                          levelArr.push(num - lastRevNum);
                          lastRevNum = num;
                      }
                      count += levelArr[levelArr.length - 1];
                      lastNum = num;
                      elem.id = elem.id || (id + guid++);
                      titleId.push(elem.id);
                  }
                  if (count !== 0 && levelArr[0] === 1) levelArr[0] = 0;

                  return levelArr;
              })(article, contentArr, titleId);
              currentList = root = document.createElement('ul');
              dirNum = [0];
              for (i = 0, len = levelArr.length; i < len; i++) {
                  level = levelArr[i];
                  if (level === 1) {
                      list = document.createElement('ul');
                      if (!currentList.lastElementChild) {
                          currentList.appendChild(document.createElement('li'));
                      }
                      currentList.lastElementChild.appendChild(list);
                      currentList = list;
                      dirNum.push(0);
                  } else if (level < 0) {
                      level *= 2;
                      while (level++) {
                          if (level % 2) dirNum.pop();
                          currentList = currentList.parentNode;
                      }
                  }
                  dirNum[dirNum.length - 1]++;
                  li = document.createElement('li');
                  link = document.createElement('a');
                  link.name = '#' + titleId[i];
                  link.href = 'Javascript:;'
                  link.title = '访问' + titleId[i];
                  link.innerHTML = !isDirNum ? contentArr[i] :
                      dirNum.join('.') + ' ' + contentArr[i];
                  li.appendChild(link);
                  currentList.appendChild(li);
              }
            directory.appendChild(root);
          };
        createPostDirectory(document.getElementById('post-content'), directoryContainer, true);
      };
      postDirectoryBuild();
    </script>
    <script>
      // gtag('config', GA_TRACKING_ID, {
      //   'page_title' : 'Blog',
      //   'page_path': window.location.pathname,
      //   'post_title': 'watttsdfasdf',
      // });

    </script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script>
        lang = hljs.initHighlightingOnLoad();
    </script>
</body>

</html>
