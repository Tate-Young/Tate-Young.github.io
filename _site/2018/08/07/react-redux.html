
<!DOCTYPE>
<html lang="zh-cn" data-scribe-reduced-action-queue="true">
<head>
    <meta content='Redux & Redux-Saga - Tate & Snow' name='title' />
    <meta content='Redux & Redux-Saga - Tate & Snow' name='og:title' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <title>Redux & Redux-Saga - Tate & Snow</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Redux & Redux-Saga - Tate & Snow</title>
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redux & Redux-Saga - Tate & Snow">
<meta name="twitter:keywords" content="Redux & Redux-Saga - Tate & Snow" property='og:description' />
<meta property="og:type" content="article">
<meta property="og:title" content="Redux & Redux-Saga - Tate & Snow">
<meta name="og:keywords" content="Redux & Redux-Saga - Tate & Snow|Redux &amp; Redux-SagaRedux &amp; FluxRedux æ˜¯ JavaScript çŠ¶æ€å®¹å™¨ï¼Œæä¾›å¯é¢„æµ‹åŒ–çš„çŠ¶æ€ç®¡ç†ã€‚å’Œ Flux ä¸€æ ·ï¼ŒRedux è§„å®šï¼Œå°†æ¨¡å‹çš„æ›´æ–°é€»è¾‘å…¨éƒ¨é›†ä¸­äºä¸€ä¸ªç‰¹å®šçš„å±‚(Flux..."
  property='og:description' />
<link rel="icon" type="image/png" href="http://localhost:2333/style/favicons/favicon.ico" />
<link href="http://localhost:2333/style/favicons/favicon.ico" rel="shortcut icon" type="image/png">
<link rel="canonical" href="http://localhost:2333/">
<link rel="alternate" type="application/rss+xml" title="Liberxue" href="http://localhost:2333/feed.xml">
<meta charset="UTF-8">
<link rel="manifest" href="/manifest.json">
<link rel="shortcut icon" href="http://localhost:2333/style/favicons/favicon.ico" type="image/x-icon">
<meta name="keywords" content="Redux &amp; Redux-SagaRedux &amp; FluxRedux æ˜¯ JavaScript çŠ¶æ€å®¹å™¨ï¼Œæä¾›å¯é¢„æµ‹åŒ–çš„çŠ¶æ€ç®¡ç†ã€‚å’Œ Flux ä¸€æ ·ï¼ŒRedux è§„å®šï¼Œå°†æ¨¡å‹çš„æ›´æ–°é€»è¾‘å…¨éƒ¨é›†ä¸­äºä¸€ä¸ªç‰¹å®šçš„å±‚(Flux..." property='og:description'
/>
<meta name="description" content="Tate & Snow's Github blog" />
<link href="https://cdn.bootcss.com/highlight.js/9.10.0/styles/xcode.min.css" rel="stylesheet">
<link href="http://localhost:2333/style/theme.css" rel="stylesheet"> 
<meta content='http://localhost:2333/2018/08/07/react-redux.html' property='og:url' />
<meta content="http://localhost:2333/2018/08/07/react-redux.html|Redux &amp; Redux-SagaRedux &amp; FluxRedux æ˜¯ JavaScript çŠ¶æ€å®¹å™¨ï¼Œæä¾›å¯é¢„æµ‹åŒ–çš„çŠ¶æ€ç®¡ç†ã€‚å’Œ Flux ä¸€æ ·ï¼ŒRedux è§„å®šï¼Œå°†æ¨¡å‹çš„æ›´æ–°é€»è¾‘å…¨éƒ¨é›†ä¸­äºä¸€ä¸ªç‰¹å®šçš„å±‚(Flux..." property='og:description'
/>
<meta content="article" property="og:type" /> 

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-136311746-1"></script>
<!-- <script async src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>
<script>
  window.dataLayer = window.dataLayer || [];
  window.GA_TRACKING_ID = 'UA-136311746-1'
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('set', {
    'country': 'US',
    'currency': 'USD',
    'description': 'fuck',
  });
  gtag('config', GA_TRACKING_ID, {
    'custom_map': {
      'dimension1': 'post_title',
    },
    'post_title': 'test',
  });
</script>
<meta content="" property="fb:app_id" />
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Redux &amp; Redux-Saga | Tate &amp; Snow</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Redux &amp; Redux-Saga" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Redux &amp; Redux-Saga" />
<meta property="og:description" content="Redux &amp; Redux-Saga" />
<link rel="canonical" href="http://localhost:2333/2018/08/07/react-redux.html" />
<meta property="og:url" content="http://localhost:2333/2018/08/07/react-redux.html" />
<meta property="og:site_name" content="Tate &amp; Snow" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-07T18:15:00+08:00" />
<script type="application/ld+json">
{"description":"Redux &amp; Redux-Saga","@type":"BlogPosting","url":"http://localhost:2333/2018/08/07/react-redux.html","headline":"Redux &amp; Redux-Saga","dateModified":"2018-08-07T18:15:00+08:00","datePublished":"2018-08-07T18:15:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:2333/2018/08/07/react-redux.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<script>
  (function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s);
    js.id = id;
    js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

</head>

<body class="dark-theme" gtools_scp_screen_capture_injected="true">
    <header id="header" class="header bg-white">
        <div class="navbar-container">
            <a href="Javascript:;" onclick="onClickLogo()" title="è®¿é—® Tate & Snow" class="navbar-logo menu-logo">
                <img src="http://localhost:2333/style/images/tate.png" alt="Tate & Snow"> </a>
            <!-- <a href="/?tate" title="è®¿é—® Tate & Snow" class="navbar-logo">Tate & Snow</a>   -->
            <div class="navbar-menu">
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('é¦–é¡µ', '/')" title="è®¿é—® é¦–é¡µ" data-hover="é¦–é¡µ">é¦–é¡µ</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('å‰ç«¯', '/front')" title="è®¿é—® å‰ç«¯" data-hover="å‰ç«¯">å‰ç«¯</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('å†å²', '/history')" title="è®¿é—® å†å²" data-hover="å†å²">å†å²</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('å…¶ä»–', '/other')" title="è®¿é—® å…¶ä»–" data-hover="å…¶ä»–">å…¶ä»–</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('æ ‡ç­¾', '/tags')" title="è®¿é—® æ ‡ç­¾" data-hover="æ ‡ç­¾">æ ‡ç­¾</a>
                
                  <a class=" menu-item-about " href="Javascript:;" onclick="onClickMenu('å…³äº', '/README')" title="è®¿é—® å…³äº" data-hover="å…³äº">å…³äº</a>
                
            </div>
            <!-- <div class="navbar-menu">
                
                <a href="http://localhost:2333/">é¦–é¡µ</a>
                
                <a href="http://localhost:2333/front">å‰ç«¯</a>
                
                <a href="http://localhost:2333/history">å†å²</a>
                
                <a href="http://localhost:2333/other">å…¶ä»–</a>
                
                <a href="http://localhost:2333/tags">æ ‡ç­¾</a>
                
                <a href="http://localhost:2333/README">å…³äº</a>
                
            </div> -->
            <div class="navbar-search menu-item-search" onclick="onClickSearch()">
                <span class="icon-search"></span>
                <form id="cb-search-btn" role="search">
                    <span class="search-box">
                        <input type="text" class="input" id="cb-search-content" required="true" placeholder="æ ‡é¢˜ æ ‡ç­¾..." maxlength="30" autocomplete="off">
                    </span>
                </form>
            </div>
            <div class="navbar-mobile-menu" onclick="">
                <span class="icon-menu cross">
                    <span class="middle"></span>
                </span>
                <ul>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('é¦–é¡µ', 'http://localhost:2333/')">é¦–é¡µ</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å‰ç«¯', 'http://localhost:2333/front')">å‰ç«¯</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å†å²', 'http://localhost:2333/history')">å†å²</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å…¶ä»–', 'http://localhost:2333/other')">å…¶ä»–</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('æ ‡ç­¾', 'http://localhost:2333/tags')">æ ‡ç­¾</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å…³äº', 'http://localhost:2333/README')">å…³äº</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </header>
    <a href="#header" class="back-to-top" onclick="onClickTop('Redux & Redux-Saga')">â¤´Topâ¤´</a>
    <div class="post-header-thumb bg-white}">
        <div class="post-header-thumb-op"></div>
        <div class="post-header-thumb">
            <div class="post-header-thumb-container">
                <h1 class="post-title" itemprop="name headline">
                    Redux & Redux-Saga</h1>
                <div class="post-data">
                    <time datetime="2018-08-07 18:15:00" itemprop="datePublished">
                      å‘å¸ƒæ—¶é—´ï¼š2018-08-07 18:15:00
                      &nbsp;&nbsp;&nbsp;
                      
                        ä¿®æ”¹æ—¶é—´ï¼š2020-05-18 19:07:00
                      
                    </time>
                    <a onclick="onClickCategory('å‰ç«¯')" href="Javascript:;" title="è®¿é—® å‰ç«¯" data-hover="åšå®¢åˆ†ç±»: å‰ç«¯">åšå®¢åˆ†ç±»: å‰ç«¯</a>
                    <!-- <a href="#read"> é˜…è¯»æ¬¡æ•°: comments</a>  -->
                </div>
                <div class="post-tags">
                       
                    <a class="menu-item-tags" href="Javascript:;" onclick="onClickTag('React')" title="è®¿é—®React" data-hover="React">
                        React
                        <span>(11)</span>
                        
                    </a>
                       
                </div>
            </div>
        </div>
    </div>
    <article class="main-content post-page" itemscope itemtype="http://schema.org/Article">
        <div class="post-header">
            <h1 class="post-title" itemprop="name headline">
                Redux & Redux-Saga</h1>
            <div class="post-data">
                <time datetime="2018-08-07 18:15:00" itemprop="datePublished">2018-08-07 18:15:00</time>
            </div>
        </div>
        <div id="post-content" class="post-content" itemprop="articleBody">
            <p class="post-tags">
                   
                <a href="Javascript:;" onclick="onClickTag('React')" title="è®¿é—®React" data-hover="React">
                    React
                    <span>(11)</span>
                    </a>
                   
            </p>
            <h1 id="redux--redux-saga">Redux &amp; Redux-Saga</h1>

<h2 id="redux--flux">Redux &amp; Flux</h2>

<p>Redux æ˜¯ JavaScript çŠ¶æ€å®¹å™¨ï¼Œæä¾›å¯é¢„æµ‹åŒ–çš„çŠ¶æ€ç®¡ç†ã€‚å’Œ Flux ä¸€æ ·ï¼ŒRedux è§„å®šï¼Œå°†æ¨¡å‹çš„æ›´æ–°é€»è¾‘å…¨éƒ¨é›†ä¸­äºä¸€ä¸ªç‰¹å®šçš„å±‚(Flux é‡Œçš„ <strong>store</strong>ï¼ŒRedux é‡Œçš„ <strong>reducer</strong>)ã€‚ä¸¤è€…éƒ½ä¸å…è®¸ç¨‹åºç›´æ¥ä¿®æ”¹æ•°æ®ï¼Œè€Œæ˜¯ç”¨ä¸€ä¸ªå«ä½œ â€œ<strong>action</strong>â€ çš„æ™®é€šå¯¹è±¡æ¥å¯¹æ›´æ”¹è¿›è¡Œæè¿°ã€‚è€Œä¸åŒäº Flux ï¼ŒRedux å¹¶æ²¡æœ‰ <strong>dispatcher</strong> çš„æ¦‚å¿µã€‚åŸå› æ˜¯å®ƒä¾èµ–çº¯å‡½æ•°æ¥æ›¿ä»£äº‹ä»¶å¤„ç†å™¨ã€‚çº¯å‡½æ•°æ„å»ºç®€å•ï¼Œä¹Ÿä¸éœ€é¢å¤–çš„å®ä½“æ¥ç®¡ç†å®ƒä»¬ã€‚Flux å¸¸å¸¸è¢«è¡¨è¿°ä¸º <code class="highlighter-rouge">(state, action) =&gt; state</code>ã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šè¯´ï¼ŒRedux æ— ç–‘æ˜¯ Flux æ¶æ„çš„å®ç°ï¼Œä¸”å¾—ç›Šäºçº¯å‡½æ•°è€Œæ›´ä¸ºç®€å•ã€‚</p>

<blockquote>
  <p>Redux å’Œ React ä¹‹é—´æ²¡æœ‰å…³ç³»ã€‚Redux æ”¯æŒ Reactã€Angularã€Emberã€jQuery ç”šè‡³çº¯ JavaScriptã€‚å°½ç®¡å¦‚æ­¤ï¼ŒRedux è¿˜æ˜¯å’Œ React å’Œ Deku è¿™ç±»åº“æ­é…èµ·æ¥ç”¨æœ€å¥½ï¼Œå› ä¸ºè¿™ç±»åº“å…è®¸ä½ ä»¥ state å‡½æ•°çš„å½¢å¼æ¥æè¿°ç•Œé¢ï¼ŒRedux é€šè¿‡ action çš„å½¢å¼æ¥å‘èµ· state å˜åŒ–ã€‚</p>
</blockquote>

<h2 id="æ¦‚å¿µ">æ¦‚å¿µ</h2>

<p><img src="http://localhost:2333/style/images/smms/redux-pattern-diagram.png" alt="redux-pattern-diagram.png" /></p>

<h3 id="action">Action</h3>

<p><strong>Action</strong> æ˜¯æŠŠæ•°æ®ä»åº”ç”¨ä¼ åˆ° store çš„æœ‰æ•ˆè½½è·ã€‚å®ƒæ˜¯ store æ•°æ®çš„å”¯ä¸€æ¥æºã€‚ä¸€èˆ¬é€šè¿‡ <code class="highlighter-rouge">store.dispatch()</code> å°† action ä¼ åˆ° storeã€‚ä¸€èˆ¬çº¦å®š action æ˜¯ä¸€ä¸ªæ‹¥æœ‰ <strong>type</strong> å±æ€§çš„å¯¹è±¡ã€‚ç„¶åæŒ‰ type å†³å®šå¦‚ä½•å¤„ç† actionã€‚å½“ç„¶ï¼Œaction ä¾æ—§å¯ä»¥æ‹¥æœ‰å…¶ä»–å±æ€§ï¼Œä½ å¯ä»¥ä»»æ„å­˜æ”¾æƒ³è¦çš„æ•°æ®:</p>

<pre><code class="language-JS">// action ç¤ºä¾‹
{ type: 'ADD_TODO', text: 'Go to swimming pool' }
{ type: 'TOGGLE_TODO', index: 1 }
{ type: 'SET_VISIBILITY_FILTER', filter: 'SHOW_ALL' }
</code></pre>

<p>action å¯ä»¥é€šè¿‡ <strong>action creator</strong> åˆ›å»º:</p>

<pre><code class="language-JS">// action creator å°±æ˜¯å‡½æ•°è€Œå·²...
function addTodo (text) {
  return {
    type: 'ADD_TODO',
    text
  }
}
</code></pre>

<h3 id="reducer">Reducer</h3>

<p><strong>Reducers</strong> å‡½æ•°æ˜¯ action çš„è®¢é˜…è€…ï¼ŒæŒ‡å®šäº†åº”ç”¨çŠ¶æ€çš„å˜åŒ–å¦‚ä½•å“åº” actions å¹¶å‘é€åˆ° store çš„ï¼Œè®°ä½ actions åªæ˜¯æè¿°äº†æœ‰äº‹æƒ…å‘ç”Ÿäº†è¿™ä¸€äº‹å®ï¼Œå¹¶æ²¡æœ‰æè¿°åº”ç”¨å¦‚ä½•æ›´æ–° <strong>state</strong>ã€‚åœ¨ Redux åº”ç”¨ä¸­ï¼Œæ‰€æœ‰çš„ state éƒ½è¢«ä¿å­˜åœ¨ä¸€ä¸ªå•ä¸€å¯¹è±¡ä¸­ï¼Œä¸€ä¸ª state å¯¹åº”ä¸€ä¸ª viewï¼Œå¦‚ä¸‹:</p>

<pre><code class="language-JS">// state
{
  visibilityFilter: 'SHOW_ALL',
  todos: [
    {
      text: 'Consider using Redux',
      completed: true,
    },
    {
      text: 'Keep all state in a single tree',
      completed: false
    }
  ]
}
</code></pre>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»ç¡®å®šäº† state å¯¹è±¡çš„ç»“æ„ï¼Œå°±å¯ä»¥å¼€å§‹å¼€å‘ reducerã€‚reducer å°±æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œæ¥æ”¶æ—§çš„ state å’Œ actionï¼Œè¿”å›æ–°çš„ state : <code class="highlighter-rouge">(previousState, action) =&gt; newState</code>ã€‚éœ€è¦è°¨è®° reducer æ˜¯<a href="https://zh.wikipedia.org/wiki/%E7%BA%AF%E5%87%BD%E6%95%B0">çº¯å‡½æ•°</a>ï¼Œä¸è¦æ‰§è¡Œæœ‰å‰¯ä½œç”¨çš„æ“ä½œï¼Œå¦‚ API è¯·æ±‚å’Œè·¯ç”±è·³è½¬ã€‚</p>

<pre><code class="language-JS">export default (state = 0, action) =&gt; { // é¦–æ¬¡æ‰§è¡Œæ—¶ï¼Œstate ä¸º undefinedï¼Œéœ€è¦å®šä¹‰åˆå§‹å€¼
  switch (action.type) {
    case 'INCREMENT':
      return state + 1
    case 'DECREMENT':
      return state - 1
    default:
      return state // é»˜è®¤è¿”å›ä¼ å…¥çš„æ—§ state
  }
}
</code></pre>

<p><strong>åˆ‡è®°ä¸èƒ½ä¿®æ”¹ state</strong>ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚æ­¤æ—¶åº”å½“é‡‡ç”¨æ‹·è´æˆ–è€…ç›´æ¥ä½¿ç”¨ immutable åº“:</p>

<pre><code class="language-JSX">// ä¸èƒ½ä¿®æ”¹ state
function reducer (state, action) {
  return Object.assign({}, state, { thingToChange });
  // æˆ–è€…
  return { ...state, ...newState };
  // æˆ–è€… immutable
  return state.set('thingToChange', action.counter)
}
</code></pre>

<p>ä¸€ä¸ª reducer å¯ä»¥å¤„ç†å¾ˆå¤šçš„ actionï¼Œä½†ç»´æŠ¤å°†å˜å¾—è‰°éš¾ã€‚å¤šä¸ª reducer çš„åˆå¹¶å¯ä»¥ä½¿ç”¨ <strong>combineReducers()</strong>:</p>

<pre><code class="language-JS">// åœ¨è¿™ç§å¤šä¸ª reducer çš„æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è®©æ¯ä¸ª reducer åªå¤„ç†æ•´ä¸ªåº”ç”¨çš„éƒ¨åˆ† state ã€‚
var userReducer = function (state = {}, action) {
  console.log('userReducer was called with state', state, 'and action', action)

  switch (action.type) {
    case 'SET_NAME':
      return {
        ...state,
        name: action.name
      }
    // etc.
    default:
      return state;
  }
}
var itemsReducer = function (state = [], action) {
  console.log('itemsReducer was called with state', state, 'and action', action)

  switch (action.type) {
    case 'ADD_ITEM':
      return [
        ...state,
        action.item
      ]
    // etc.
    default:
      return state;
  }
}
</code></pre>

<pre><code class="language-JS">import { createStore, combineReducers } from 'redux'

var reducer = combineReducers({
    user: userReducer,
    items: itemsReducer
})
var store_0 = createStore(reducer)

// åˆ›å»ºå¹¶å‘é€ä¸€ä¸ª action
var setNameActionCreator = function (name) {
  return {
    type: 'SET_NAME',
    name: name
  }
}

store_0.dispatch(setNameActionCreator('bob'))
// è¾“å‡ºï¼š
// userReducer was called with state {} and action { type: 'SET_NAME', name: 'bob' }
// itemsReducer was called with state [] and action { type: 'SET_NAME', name: 'bob' }
console.log('store_0 state after action SET_NAME:', store_0.getState())
// è¾“å‡ºï¼š
// store_0 state after action SET_NAME: { user: { name: 'bob' }, items: [] }
</code></pre>

<h3 id="store">Store</h3>

<p>store ç”± <code class="highlighter-rouge">createStore(reducerï¼Œ defaultState)</code> è¿™ä¸ªæ–¹æ³•ç”Ÿæˆï¼Œåœ¨æ•´ä¸ªåº”ç”¨ä¸­æ˜¯å”¯ä¸€çš„ï¼ŒåŠŸèƒ½å¦‚ä¸‹:</p>

<ul>
  <li>ç»´æŒåº”ç”¨çš„ stateï¼›</li>
  <li>æä¾› getState() æ–¹æ³•è·å– stateï¼›</li>
  <li>æä¾› dispatch(action) æ–¹æ³•æ›´æ–° stateï¼›</li>
  <li>é€šè¿‡ subscribe(listener) æ³¨å†Œç›‘å¬å™¨ï¼Œä¸€æ—¦ state å‘ç”Ÿå˜åŒ–ï¼Œå°±è‡ªåŠ¨æ‰§è¡Œè¿™ä¸ªå‡½æ•°;</li>
  <li>é€šè¿‡ subscribe(listener) è¿”å›çš„å‡½æ•°æ³¨é”€ç›‘å¬å™¨</li>
</ul>

<p><img src="http://localhost:2333/style/images/smms/react-redux-store.png" alt="react-redux-store.png" /></p>

<pre><code class="language-JS">// æ•´ä¸ªæµç¨‹å¯æ€»ç»“ä¸º: ç”¨æˆ·å‘å‡º Actionï¼ŒReducer å‡½æ•°ç®—å‡ºæ–°çš„ Stateï¼ŒView é‡æ–°æ¸²æŸ“
import React from 'react'
import ReactDOM from 'react-dom'
import { createStore } from 'redux'
import Counter from './components/Counter'
import counter from './reducers'

const store = createStore(counter) // counter å±äº reducer
const rootEl = document.getElementById('root')

const render = () =&gt; ReactDOM.render(
  &lt;Counter
    value={store.getState()}
    onIncrement={() =&gt; store.dispatch({ type: 'INCREMENT' })}
    onDecrement={() =&gt; store.dispatch({ type: 'DECREMENT' })}
  /&gt;,
  rootEl
)

render()
store.subscribe(render) // ç›‘å¬å¹¶ä¿®æ”¹è§†å›¾
</code></pre>

<p>å½“éœ€è¦æŠŠå¤šä¸ª store å¢å¼ºå™¨ä¾æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ <a href="https://www.kancloud.cn/allanyu/redux-in-chinese/82435"><strong>compose</strong></a> æ–¹æ³•ï¼Œä»å³åˆ°å·¦æŠŠæ¥æ”¶åˆ°çš„å‡½æ•°åˆæˆåçš„æœ€ç»ˆå‡½æ•°ã€‚compose åšçš„åªæ˜¯è®©ä½ ä¸ä½¿ç”¨æ·±åº¦å³æ‹¬å·çš„æƒ…å†µä¸‹æ¥å†™æ·±åº¦åµŒå¥—çš„å‡½æ•°:</p>

<pre><code class="language-JS">const store = compose()(createStore)(counter)
</code></pre>

<p>å¯¹ä¸Šè¿° actionã€reducer å’Œ store ä¸‰è€…å…³ç³»çš„ä¸€ä¸ªæ•´ç†:</p>

<p><img src="http://localhost:2333/style/images/smms/react-redux-action.png" alt="react-redux-action.png" /></p>

<h3 id="å¼‚æ­¥-action--ä¸­é—´ä»¶">å¼‚æ­¥ Action &amp; ä¸­é—´ä»¶</h3>

<h4 id="applymiddlewares">applyMiddlewares()</h4>

<p><strong>applyMiddlewares</strong> æ–¹æ³•å°†æ‰€æœ‰ä¸­é—´ä»¶ç»„æˆä¸€ä¸ªæ•°ç»„ï¼Œä¾æ¬¡æ‰§è¡Œã€‚æ¯”å¦‚æ‰§è¡Œæ—¥å¿—ä¸­é—´ä»¶:</p>

<pre><code class="language-JS">import { applyMiddleware, createStore } from 'redux';
import createLogger from 'redux-logger';
const logger = createLogger();

const store = createStore(
  reducer,
  applyMiddleware(logger)
);
</code></pre>

<h4 id="å¼‚æ­¥-redux-thunk">å¼‚æ­¥ Redux-Thunk</h4>

<p>åŒæ­¥æ“ä½œåªè¦å‘å‡ºä¸€ç§ Action å³å¯ï¼Œå¼‚æ­¥æ“ä½œçš„å·®åˆ«æ˜¯å®ƒè¦å‘å‡ºä¸‰ç§ Actionã€‚</p>

<ul>
  <li>ä¸€ç§é€šçŸ¥ reducer è¯·æ±‚å¼€å§‹çš„ Action</li>
  <li>ä¸€ç§é€šçŸ¥ reducer è¯·æ±‚æˆåŠŸçš„ Action</li>
  <li>ä¸€ç§é€šçŸ¥ reducer è¯·æ±‚å¤±è´¥çš„ Action</li>
</ul>

<p>Action çš„è®¾ç½®æ— éä¸¤ç§æƒ…å†µ:</p>

<pre><code class="language-JS">// åŒä¸€ç§ typeï¼Œä½†ä¸åŒ status
{ type: 'FETCH_POSTS' }
{ type: 'FETCH_POSTS', status: 'error', error: 'Oops' }
{ type: 'FETCH_POSTS', status: 'success', response: { ... } }

// æˆ–è€…ä¸åŒ type
{ type: 'FETCH_POSTS_REQUEST' }
{ type: 'FETCH_POSTS_FAILURE', error: 'Oops' }
{ type: 'FETCH_POSTS_SUCCESS', response: { ... } }
</code></pre>

<p>å¼‚æ­¥æ“ä½œçš„ state ä¹Ÿè¦è¿›è¡Œæ”¹é€ ï¼Œåæ˜ ä¸åŒçš„æ“ä½œçŠ¶æ€:</p>

<pre><code class="language-JS">let state = {
  // ...
  isFetching: true, // è¡¨ç¤ºæ˜¯å¦åœ¨æŠ“å–æ•°æ®
  didInvalidate: true, // è¡¨ç¤ºæ•°æ®æ˜¯å¦è¿‡æ—¶
  lastUpdated: 'xxxxxxx' // è¡¨ç¤ºä¸Šä¸€æ¬¡æ›´æ–°æ—¶é—´
};
</code></pre>

<p>æ•´ä¸ªæµç¨‹æ€è·¯å³:</p>

<p>1ã€æ“ä½œå¼€å§‹æ—¶ï¼Œé€å‡ºä¸€ä¸ª actionï¼Œè§¦å‘ state æ›´æ–°ä¸ºâ€æ­£åœ¨æ“ä½œâ€çŠ¶æ€ï¼Œview é‡æ–°æ¸²æŸ“
2ã€æ“ä½œç»“æŸåï¼Œå†é€å‡ºä¸€ä¸ª actionï¼Œè§¦å‘ state æ›´æ–°ä¸ºâ€æ“ä½œç»“æŸâ€çŠ¶æ€ï¼Œview å†ä¸€æ¬¡é‡æ–°æ¸²æŸ“</p>

<p>æ¥ä¸‹æ¥é€šè¿‡ä¸­é—´ä»¶ <strong>redux-thunk</strong> è¿›è¡Œå¼‚æ­¥ action çš„åˆ›å»ºï¼Œå…·ä½“å¯æŸ¥çœ‹ä¸‹èŠ‚å¼‚æ­¥ç¤ºä¾‹:</p>

<pre><code class="language-JS">// è™½ç„¶å†…éƒ¨æ“ä½œä¸åŒï¼Œä½ å¯ä»¥åƒå…¶å®ƒ action åˆ›å»ºå‡½æ•° ä¸€æ ·ä½¿ç”¨å®ƒï¼šstore.dispatch(fetchPosts('reactjs'))
// store.dispatch æ–¹æ³•æ­£å¸¸æƒ…å†µä¸‹ï¼Œå‚æ•°åªèƒ½æ˜¯å¯¹è±¡ï¼Œä¸èƒ½æ˜¯å‡½æ•°ï¼Œå°±è¦ä½¿ç”¨ä¸­é—´ä»¶ redux-thunk
export function fetchPosts(subreddit) {

  // Thunk middleware çŸ¥é“å¦‚ä½•å¤„ç†å‡½æ•°ã€‚
  // è¿™é‡ŒæŠŠ dispatch æ–¹æ³•é€šè¿‡å‚æ•°çš„å½¢å¼ä¼ ç»™å‡½æ•°ï¼Œä»¥æ­¤æ¥è®©å®ƒè‡ªå·±ä¹Ÿèƒ½ dispatch actionã€‚

  return function (dispatch) {

    // é¦–æ¬¡ dispatchï¼šæ›´æ–°åº”ç”¨çš„ state æ¥é€šçŸ¥ API è¯·æ±‚å‘èµ·äº†ã€‚

    dispatch(requestPosts(subreddit))

    // thunk middleware è°ƒç”¨çš„å‡½æ•°å¯ä»¥æœ‰è¿”å›å€¼ï¼Œå®ƒä¼šè¢«å½“ä½œ dispatch æ–¹æ³•çš„è¿”å›å€¼ä¼ é€’ã€‚
    // è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬è¿”å›ä¸€ä¸ªç­‰å¾…å¤„ç†çš„ promiseã€‚è¿™å¹¶ä¸æ˜¯ redux middleware æ‰€å¿…é¡»çš„ï¼Œä½†è¿™å¯¹äºæˆ‘ä»¬è€Œè¨€å¾ˆæ–¹ä¾¿ã€‚

    return fetch(`http://www.subreddit.com/r/${subreddit}.json`)
      .then(
        response =&gt; response.json(),
        // ä¸è¦ä½¿ç”¨ catchï¼Œå› ä¸ºä¼šæ•è·åœ¨ dispatch å’Œæ¸²æŸ“ä¸­å‡ºç°çš„ä»»ä½•é”™è¯¯ï¼Œå¯¼è‡´ 'Unexpected batch number' é”™è¯¯ã€‚
         error =&gt; console.log('An error occurred.', error)
      )
      .then(json =&gt;
        // å¯ä»¥å¤šæ¬¡ dispatchï¼è¿™é‡Œï¼Œä½¿ç”¨ API è¯·æ±‚ç»“æœæ¥æ›´æ–°åº”ç”¨çš„ stateã€‚

        dispatch(receivePosts(subreddit, json))
      )
  }
}
</code></pre>

<blockquote>
  <p>å¼‚æ­¥å»ºè®®ä½¿ç”¨ <strong>redux-saga</strong> æ¥å¤„ç†æ•°æ®çš„è¯»å–ã€‚ä¸åŒäº redux-thunkï¼Œä½ ä¸ä¼šå†é‡åˆ°å›è°ƒåœ°ç‹±äº†ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°æµ‹è¯•å¼‚æ­¥æµç¨‹å¹¶ä¿æŒä½ çš„ action æ˜¯å¹²å‡€çš„ã€‚å½“ç„¶æˆ‘ä»¬ç°åœ¨æœ‰æ›´å¤šé€‰æ‹©ï¼Œæ¯”å¦‚ <a href="https://redux-observable.js.org/docs/basics/Epics.html"><strong>redux-observable</strong></a></p>
</blockquote>

<h2 id="react-redux">React-Redux</h2>

<p>æˆ‘ä»¬å½“ç„¶å¯ä»¥ç›´æ¥åœ¨ React ä¸­ä½¿ç”¨ Reduxï¼šåœ¨æœ€å¤–å±‚å®¹å™¨ç»„ä»¶ä¸­åˆå§‹åŒ– storeï¼Œç„¶åå°† state ä¸Šçš„å±æ€§ä½œä¸º props å±‚å±‚ä¼ é€’ä¸‹å»ï¼Œæœ€ä½³çš„æ–¹å¼æ˜¯ä½¿ç”¨ <strong>React-Redux</strong> æä¾›çš„ <strong>Provider</strong> å’Œ <strong>connect</strong> æ–¹æ³•ã€‚React-Redux å°†æ‰€æœ‰ç»„ä»¶åˆ†æˆä¸¤å¤§ç±»ï¼šUI ç»„ä»¶ï¼ˆpresentational componentï¼‰å’Œå®¹å™¨ç»„ä»¶ï¼ˆcontainer componentï¼‰ã€‚UI ç»„ä»¶è´Ÿè´£ UI çš„å‘ˆç°ï¼Œå®¹å™¨ç»„ä»¶è´Ÿè´£ç®¡ç†æ•°æ®å’Œé€»è¾‘ã€‚</p>

<p><img src="http://localhost:2333/style/images/smms/react-redux.png" alt="react-redux.png" /></p>

<h3 id="provider">Provider</h3>

<p>connect æ–¹æ³•ç”Ÿæˆå®¹å™¨ç»„ä»¶ä»¥åï¼Œéœ€è¦è®©å®¹å™¨ç»„ä»¶æ‹¿åˆ° state å¯¹è±¡ï¼Œæ‰èƒ½ç”Ÿæˆ UI ç»„ä»¶çš„å‚æ•°ã€‚æœ€å…³é”®çš„ä½œç”¨å°±æ˜¯åœ¨ context ä¸­æ”¾å…¥ Redux çš„ storeï¼Œæ–¹ä¾¿å­ç»„ä»¶è·å–:</p>

<pre><code class="language-JSX">import { render } from 'react-dom'
import { Provider } from 'react-redux'
import { createStore } from 'redux'
import todoApp from './reducers'
import App from './components/App'

let store = createStore(todoApp);

render(
  // ä½¿ç”¨çš„æ—¶å€™å®¹å™¨ç»„ä»¶ä¼šè¢«åŒ…è£¹åœ¨ Provider ç»„ä»¶ä¸‹é¢ï¼Œè¿™æ ·è¿™äº›ç»„ä»¶å°±å¯ä»¥è·å¾— Provider æŒ‚åœ¨ context ä¸Šçš„ state äº†
  // Provider å†…çš„ä»»ä½•ä¸€ä¸ªç»„ä»¶ï¼ˆæ¯”å¦‚è¿™é‡Œçš„ Appï¼‰ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ state ä¸­çš„æ•°æ®ï¼Œå°±å¿…é¡»æ˜¯ã€Œè¢« connect è¿‡çš„ã€ç»„ä»¶â€”â€”ä½¿ç”¨ connect æ–¹æ³•å¯¹ã€Œä½ ç¼–å†™çš„ç»„ä»¶ï¼ˆMyAppï¼‰ã€è¿›è¡ŒåŒ…è£…åçš„äº§ç‰©
  &lt;Provider store={store}&gt;
    &lt;App /&gt;
  &lt;/Provider&gt;,
  document.getElementById('root')
)
</code></pre>

<p><strong>context</strong> å±äº React çš„ä¸€ä¸ªé‡è¦å±æ€§ã€‚è¢«éšå¼åœ°ä¼ é€’ç»™åä»£ç»„ä»¶(ç±»ä¼¼äºå…¨å±€å˜é‡çš„ä½œç”¨ï¼Œæ‰€æœ‰ç»„ä»¶éƒ½å¯ä»¥è®¿é—®):</p>

<ul>
  <li>React.withContext ï¼šä¼šæ‰§è¡Œä¸€ä¸ªæŒ‡å®šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯çš„å›è°ƒå‡½æ•°ï¼Œä»»ä½•åœ¨è¿™ä¸ªå›è°ƒå‡½æ•°é‡Œé¢æ¸²æŸ“çš„ç»„ä»¶éƒ½æœ‰è¿™ä¸ª context çš„è®¿é—®æƒé™ã€‚</li>
  <li>getChildContext ï¼šå’Œ React.withContext ä¸€æ ·çš„ä½œç”¨ï¼ŒæŒ‡å®šçš„ä¼ é€’ç»™å­ç»„ä»¶çš„å±æ€§ã€‚ä¸è¿‡ä¸ React.withContext å†™æ³•ä¸åŒï¼Œä¸”è¦å…ˆé€šè¿‡ childContextTypes æ¥æŒ‡å®šç±»å‹ï¼Œä¸ç„¶ä¼šäº§ç”Ÿé”™è¯¯ã€‚</li>
  <li>childContextTypes ï¼šå£°æ˜ä¼ é€’ç»™å­ç»„ä»¶çš„å±æ€§çš„æ•°æ®ç±»å‹ã€‚</li>
  <li>contextTypes ï¼šä»»ä½•æƒ³è®¿é—® context é‡Œé¢çš„å±æ€§çš„ç»„ä»¶éƒ½å¿…é¡»æ˜¾å¼åœ°æŒ‡å®šä¸€ä¸ª contextTypes çš„å±æ€§ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šè¯¥å±æ€§ï¼Œé‚£ä¹ˆç»„ä»¶é€šè¿‡ this.context è®¿é—®å±æ€§å°†ä¼šå‡ºé”™ã€‚</li>
</ul>

<p>Provider å°±æ˜¯ä½¿ç”¨äº† getChildContext å°† store ç»‘åˆ° context ä¸Šä½¿å­å…ƒç´ éƒ½å¯ä»¥è®¿é—®åˆ°ã€‚é€šè¿‡ context ä¼ é€’å±æ€§çš„æ–¹å¼è¦ä¼˜äºé€šè¿‡ props é€å±‚ä¼ é€’å±æ€§çš„æ–¹å¼ã€‚è¿™æ ·å¯ä»¥å‡å°‘ç»„ä»¶ä¹‹é—´çš„ç›´æ¥ä¾èµ–å…³ç³»ã€‚</p>

<h3 id="connect">connect</h3>

<p><strong>connect</strong> è´Ÿè´£ä¸ React çš„å±•ç¤ºç»„ä»¶è¿›è¡Œäº¤äº’ï¼Œæ›´æ–°ã€‚å®¹å™¨ç»„ä»¶åœ¨ä½¿ç”¨çš„æ—¶å€™ä¼šè¢«åŒ…è£¹åœ¨ Provider ç»„ä»¶ä¸‹é¢ï¼Œè¿™æ ·è¿™äº›ç»„ä»¶å°±å¯ä»¥è·å¾— Provider æŒ‚åœ¨ context ä¸Šçš„ stateã€‚connect ä½œä¸ºé«˜é˜¶å‡½æ•°åŒ…è£¹è¿™äº›å®¹å™¨ç»„ä»¶å°±å¯ä»¥æ¥æ”¶åˆ° stateï¼Œå¹¶ä¸”å¯ä»¥:</p>

<p>1ã€å°†æŒ‡å®š state å’Œ action ä½œä¸º props ç»‘å®šåˆ°ç»„ä»¶ä¸Šæ–¹ä¾¿è°ƒç”¨</p>

<p>2ã€å¸®åŠ©ç»„ä»¶è®¢é˜…ç›‘å¬ state çš„å˜åŒ–</p>

<pre><code class="language-JSX">import { connect } from 'react-redux'

class MyComp extends Component {
  // ...
}
const Comp = connect(...args)(MyComp);
</code></pre>

<pre><code class="language-JSX">// å¯ä»¥æ¥æ”¶å››ä¸ªå‚æ•°ï¼Œåä¸¤ä¸ªå‚æ•°ä¸€èˆ¬çœç•¥ï¼Œä¸åšåˆ†æ
connect([mapStateToProps], [mapDispatchToProps], [mergeProps],[options])
</code></pre>

<p>è¦åš TS è¿ç§»çš„è¯ï¼Œç±»å‹æ£€æŸ¥å¯ä»¥ä½¿ç”¨ <code class="highlighter-rouge">ConnectedProps&lt;T&gt;</code>ï¼Œå¯ä»¥ç›´æ¥<a href="https://react-redux.js.org/using-react-redux/static-typing">å‚è€ƒå®˜æ–¹æ–‡æ¡£</a>:</p>

<pre><code class="language-JS">// alternately, declare `type Props = Props From Redux &amp; {backgroundColor: string}`
interface Props extends PropsFromRedux {
  backgroundColor: string;
}

const MyComponent = (props: Props) =&gt; /* same as above */

const connector = connect(/* same as above*/)

type PropsFromRedux = ConnectedProps&lt;typeof connector&gt;

export default connector(MyComponent)
</code></pre>

<h4 id="mapstatetoprops">mapStateToProps()</h4>

<p><strong>mapStateToProps</strong> å°† store ä¸­çš„æ•°æ®ä½œä¸º props ç»‘å®šåˆ°ç»„ä»¶ä¸Šã€‚æ¥æ”¶çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬éœ€è¦ä» Redux ä¸­æå–çš„çŠ¶æ€ï¼Œç¬¬äºŒä¸ªå¯é€‰å‚æ•°æ˜¯ç»„ä»¶æœ¬èº«çš„ propsã€‚ä¸å¿…å°† Redux ä¸­æ‰€æœ‰çš„ state æ•°æ®éƒ½ä¼ è¿›ç»„ä»¶ï¼Œå¯ä»¥ç»“åˆ ownProps è¿›è¡Œç­›é€‰ï¼Œä¼ å…¥éœ€è¦çš„æœ€å°‘å±æ€§ã€‚</p>

<pre><code class="language-JSX">const mapStateToProps = (state, ownProps) =&gt; {
  // state æ˜¯ {userList: [{id: 0, name: 'ç‹äºŒ'}]}
  return {
    user: _.find(state.userList, {id: ownProps.userId})
  }
}

class MyComp extends Component {
  static PropTypes = {
    userId: PropTypes.string.isRequired,
    user: PropTypes.object
  };
  
  render(){
    return &lt;div&gt;ç”¨æˆ·åï¼š{this.props.user.name}&lt;/div&gt;
  }
}

const Comp = connect(mapStateToProps)(MyComp);
</code></pre>

<p>å½“ state å˜åŒ–ï¼Œæˆ–è€… ownProps å˜åŒ–çš„æ—¶å€™ï¼ŒmapStateToProps éƒ½ä¼šè¢«è°ƒç”¨ï¼Œè®¡ç®—å‡ºä¸€ä¸ªæ–°çš„ statePropsã€‚</p>

<h4 id="mapdispatchtoprops">mapDispatchToProps()</h4>

<p><strong>mapDispatchToProps</strong> å°† action ä½œä¸º props ç»‘å®šåˆ°ç»„ä»¶ä¸Š:</p>

<pre><code class="language-JSX">//å°† state.counter ç»‘å®šåˆ° props çš„ count
const mapStateToProps = state =&gt; ({
  count: state.counter
});

const mapDispatchToProps = (dispatch, ownProps) =&gt; ({
  // ç”±äº mapDispatchToProps æ–¹æ³•è¿”å›äº†å…·æœ‰ increase å±æ€§å’Œ decrease å±æ€§çš„å¯¹è±¡ï¼Œè¿™ä¸¤ä¸ªå±æ€§ä¹Ÿä¼šæˆä¸º MyComp çš„ props
  increase: (...args) =&gt; dispatch(actions.increase(...args)),
  decrease: (...args) =&gt; dispatch(actions.decrease(...args))
})

class MyComp extends Component {
  render(){
    // ä»ç»„ä»¶çš„ props å±æ€§ä¸­å¯¼å…¥ä¸¤ä¸ªæ–¹æ³•å’Œä¸€ä¸ªå˜é‡ count
    const {count, increase, decrease} = this.props;

    return (&lt;div&gt;
      &lt;div&gt;è®¡æ•°ï¼š{count}æ¬¡&lt;/div&gt;
      &lt;button onClick={increase}&gt;å¢åŠ &lt;/button&gt;
      &lt;button onClick={decrease}&gt;å‡å°‘&lt;/button&gt;
    &lt;/div&gt;)
  }
}

const Comp = connect(mapStateToPropsï¼Œ mapDispatchToProps)(MyComp);
</code></pre>

<p>ä¸Šé¢çš„ state å¯¹è±¡çš„ key ä¸º counterï¼Œå–å†³äºè¿™é‡Œçš„è®¾ç½®:</p>

<pre><code class="language-JSX">import counter from './crement'
import { combineReducers } from 'redux';
export default combineReducers({
  counter, // é€šè¿‡ state.counter è®¿é—®
})
</code></pre>

<h3 id="hooks">hooks</h3>

<h4 id="useselector">useSelector</h4>

<p>å¥½æ¶ˆæ¯å¥½æ¶ˆæ¯ï¼Œåœ¨ React hooks ç«éå¤§æ±Ÿå—åŒ—ä¹‹åï¼ŒReact Redux ä¹Ÿç»ˆäºæŠ›å¼ƒäº† HOC connectï¼Œæä¾›äº†å‡ ä¸ªå®ç”¨çš„é’©å­ï¼Œä¸‹é¢å°±æ¥ç®€å•ä»‹ç»ä¸‹ï¼Œè¯¦ç»†å¯ä»¥<a href="https://react-redux.js.org/api/hooks#useselector-examples">å‚è€ƒä¸‹æ–‡æ¡£</a> ğŸ‘ˆ</p>

<p>è¿™ä¸ª selector æ–¹æ³•ç±»ä¼¼äºä¸Šè¿°çš„ connect çš„ mapStateToProps å‚æ•°çš„æ¦‚å¿µï¼Œå¹¶ä¸” useSelector ä¼šè®¢é˜… store, å½“ action è¢« dispatched çš„æ—¶å€™ï¼Œä¼šè¿è¡Œ selectorã€‚ä¸¤è€…æœ‰ä»¥ä¸‹çš„ä¸€äº›å·®å¼‚:</p>

<ul>
  <li>selector ä¼šè¿”å›ä»»ä½•å€¼ä½œä¸ºç»“æœï¼Œå¹¶ä¸ä»…é™äºå¯¹è±¡</li>
  <li>å½“ action è¢« dispatched çš„æ—¶å€™ï¼ŒuseSelector å°†å¯¹å‰ä¸€ä¸ª selector ç»“æœå€¼å’Œå½“å‰ç»“æœå€¼è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœä¸åŒï¼Œåˆ™é‡æ–°æ¸²æŸ“ã€‚useSelector é»˜è®¤ä½¿ç”¨ === (ä¸¥æ ¼ç›¸ç­‰)è¿›è¡Œç›¸ç­‰æ€§æ£€æŸ¥ï¼Œè€Œä¸æ˜¯ ==ã€‚connect ä½¿ç”¨çš„æ˜¯æµ…æ¯”è¾ƒ</li>
  <li>selector ä¸ä¼šæ¥æ”¶ ownProps å‚æ•°ï¼Œä½†æ˜¯ï¼Œå¯ä»¥é€šè¿‡é—­åŒ…æˆ–ä½¿ç”¨æŸ¯é‡ŒåŒ– selector æ¥ä½¿ç”¨ props</li>
</ul>

<p>å¦‚æœæˆ‘ä»¬è¦ç”¨å¤šä¸ª selector å€¼ï¼Œæ²¡å…³ç³»ï¼Œå¤šæ¬¡è°ƒç”¨ useSelector éƒ½ä¼šåˆ›å»º redux store çš„å•ä¸ªè®¢é˜…ã€‚ç”±äº react-redux v7 ç‰ˆæœ¬ä½¿ç”¨çš„ react çš„æ‰¹é‡(batching)æ›´æ–°è¡Œä¸ºï¼ŒåŒä¸ªç»„ä»¶ä¸­ï¼Œå¤šæ¬¡ useSelector è¿”å›çš„å€¼åªä¼šé‡æ–°æ¸²æŸ“ä¸€æ¬¡ã€‚æˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥å€ŸåŠ©ä¹‹å‰è®²åˆ°çš„ reselect åº“ï¼Œå¯ä»¥å°†æ•°æ®ä¸€å¹¶å¤„ç†å¹¶ç»Ÿä¸€è¿”å›å•ä¸ª selectorã€‚ä½¿ç”¨ memoize selector æ—¶å¿…é¡»è€ƒè™‘å¤šä¸ªç»„ä»¶å®ä¾‹ä¸”éœ€è¦è·å–ç»„ä»¶ props çš„æƒ…å†µï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <a href="( http://localhost:2333/2020/04/28/react-redux-toolkit.html#createselector--reselect )">reselect å°èŠ‚</a>ã€‚è¿™é‡Œä¹Ÿä¸¾ä¸ªä¾‹å­:</p>

<pre><code class="language-JS">import React from 'react'
import { useSelector } from 'react-redux'
import { createSelector } from 'reselect'

const selectNumOfTodosWithIsDoneValue = createSelector(
  state =&gt; state.todos,
  (_, isDone) =&gt; isDone, // ä¾èµ–äºç»„ä»¶ props
  (todos, isDone) =&gt; todos.filter(todo =&gt; todo.isDone === isDone).length
)

export const TodoCounterForIsDoneValue = ({ isDone }) =&gt; {
  const NumOfTodosWithIsDoneValue = useSelector(state =&gt;
    selectNumOfTodosWithIsDoneValue(state, isDone)
  )

  return &lt;div&gt;{NumOfTodosWithIsDoneValue}&lt;/div&gt;
}

export const App = () =&gt; {
  return (
    &lt;&gt;
      &lt;span&gt;Number of done todos:&lt;/span&gt;
      &lt;TodoCounterForIsDoneValue isDone={true} /&gt;
    &lt;/&gt;
  )
}
</code></pre>

<p>å½“è¿™ä¸ª selector åœ¨å¤šä¸ªç»„ä»¶å®ä¾‹å†…è¿è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»è¦ä¿è¯åœ¨æ¯ä¸ªç»„ä»¶å®ä¾‹ä¸­è·å–è‡ªå·±çš„ selector å®ä¾‹ï¼Œæ”¹é€ å¦‚ä¸‹:</p>

<pre><code class="language-JS">import React, { useMemo } from 'react'
import { useSelector } from 'react-redux'
import { createSelector } from 'reselect'

const makeNumOfTodosWithIsDoneSelector = () =&gt;
  createSelector(
    state =&gt; state.todos,
    (_, isDone) =&gt; isDone,
    (todos, isDone) =&gt; todos.filter(todo =&gt; todo.isDone === isDone).length
  )

export const TodoCounterForIsDoneValue = ({ isDone }) =&gt; {
  const selectNumOfTodosWithIsDone = useMemo(makeNumOfTodosWithIsDoneSelector, [])

  const numOfTodosWithIsDoneValue = useSelector(state =&gt;
    selectNumOfTodosWithIsDone(state, isDone)
  )

  return &lt;div&gt;{numOfTodosWithIsDoneValue}&lt;/div&gt;
}

export const App = () =&gt; {
  return (
    &lt;&gt;
      &lt;span&gt;Number of done todos:&lt;/span&gt;
      &lt;TodoCounterForIsDoneValue isDone={true} /&gt;
      &lt;span&gt;Number of unfinished todos:&lt;/span&gt;
      &lt;TodoCounterForIsDoneValue isDone={false} /&gt;
    &lt;/&gt;
  )
}
</code></pre>

<h4 id="usedispatch">useDispatch</h4>

<p>æˆ‘ä»¬åŒæ ·å¯ä»¥åˆ©ç”¨ useDispatch æ¥åˆ†å‘ actionï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™æ³¨æ„åˆ©ç”¨ <code class="highlighter-rouge">useCallback</code> æ¥é¿å…ä¸å¿…è¦çš„æ¸²æŸ“:</p>

<pre><code class="language-JS">import React, { useCallback } from 'react'
import { useDispatch } from 'react-redux'

export const CounterComponent = ({ value }) =&gt; {
  const dispatch = useDispatch()
  const incrementCounter = useCallback(
    () =&gt; dispatch({ type: 'increment-counter' }),
    [dispatch]
  )

  return (
    &lt;div&gt;
      &lt;span&gt;{value}&lt;/span&gt;
      &lt;MyIncrementButton onIncrement={incrementCounter} /&gt;
    &lt;/div&gt;
  )
}

export const MyIncrementButton = React.memo(({ onIncrement }) =&gt; (
  &lt;button onClick={onIncrement}&gt;Increment counter&lt;/button&gt;
))
</code></pre>

<h2 id="redux-saga">Redux-Saga</h2>

<p><strong>redux-saga</strong> æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†åº”ç”¨ç¨‹åº <strong>Side Effect</strong>(å‰¯ä½œç”¨ï¼Œä¾‹å¦‚å¼‚æ­¥è·å–æ•°æ®ï¼Œè®¿é—®æµè§ˆå™¨ç¼“å­˜ç­‰)çš„åº“ï¼Œå®ƒçš„ç›®æ ‡æ˜¯è®©å‰¯ä½œç”¨ç®¡ç†æ›´å®¹æ˜“ï¼Œæ‰§è¡Œæ›´é«˜æ•ˆï¼Œæµ‹è¯•æ›´ç®€å•ï¼Œåœ¨å¤„ç†æ•…éšœæ—¶æ›´å®¹æ˜“ã€‚redux-saga ä½¿ç”¨äº† ES6 çš„ <strong>Generator</strong> åŠŸèƒ½ï¼Œè®©å¼‚æ­¥çš„æµç¨‹æ›´æ˜“äºè¯»å–ï¼Œå†™å…¥å’Œæµ‹è¯•ã€‚å¯ä»¥æƒ³åƒä¸ºï¼Œä¸€ä¸ª saga å°±åƒæ˜¯åº”ç”¨ç¨‹åºä¸­ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œå®ƒç‹¬è‡ªè´Ÿè´£å¤„ç†å‰¯ä½œç”¨ã€‚ redux-saga æ˜¯ä¸€ä¸ª redux ä¸­é—´ä»¶ï¼Œæ„å‘³ç€è¿™ä¸ªçº¿ç¨‹å¯ä»¥é€šè¿‡æ­£å¸¸çš„ redux action ä»ä¸»åº”ç”¨ç¨‹åºå¯åŠ¨ï¼Œæš‚åœå’Œå–æ¶ˆï¼Œå®ƒèƒ½è®¿é—®å®Œæ•´çš„ redux stateï¼Œä¹Ÿå¯ä»¥ dispatch redux actionã€‚</p>

<h3 id="createsagamiddleware">createSagaMiddleware()</h3>

<pre><code class="language-JS">// åˆ›å»ºä¸€ä¸ª saga ä¸­é—´ä»¶å¹¶è¿æ¥è‡³ Redux Store
import { createStore, applyMiddleware } from 'redux'
import createSagaMiddleware from 'redux-saga'
import { helloSaga } from './sagas'

const sagaMiddleware = createSagaMiddleware()
const store = createStore(
  reducer,
  applyMiddleware(sagaMiddleware)
)

// å¯åŠ¨ Generatorsï¼Œå‚æ•°å¿…é¡»æ˜¯ Generator function
sagaMiddleware.run(helloSaga)
</code></pre>

<h3 id="saga-è¾…åŠ©å‡½æ•°">Saga è¾…åŠ©å‡½æ•°</h3>

<p>redux-saga æä¾›äº†ä¸€äº›è¾…åŠ©å‡½æ•°ï¼ŒåŒ…è£…äº†ä¸€äº›å†…éƒ¨æ–¹æ³•ï¼Œç”¨æ¥åœ¨ä¸€äº›ç‰¹å®šçš„ action è¢«å‘èµ·åˆ° Store æ—¶æ´¾ç”Ÿä»»åŠ¡ï¼Œå¸¸ç”¨çš„ä¸¤ä¸ªè¾…åŠ©å‡½æ•°ä¸º:</p>

<ul>
  <li><strong>takeEvery</strong> - æ˜¯ä¸€ä¸ªä½¿ç”¨ take å’Œ fork æ„å»ºçš„é«˜çº§ APIã€‚æ¯æ¬¡æŒ‡å®š action è¢«å‘èµ·æ—¶ï¼Œæ¥å¯åŠ¨ä¸€ä¸ªæ–°çš„ saga ä»»åŠ¡</li>
  <li><strong>takeLatest</strong> - åŒä¸Šï¼Œä½†ä¼šè‡ªåŠ¨å–æ¶ˆä¹‹å‰æ‰€æœ‰å·²ç»å¯åŠ¨ä½†ä»åœ¨æ‰§è¡Œä¸­çš„ saga ä»»åŠ¡ã€‚</li>
</ul>

<pre><code class="language-JS">import { call, put, takeEvery, takeLatest } from 'redux-saga/effects'
import Api from '...'

// åˆ›å»ºå¼‚æ­¥ä»»åŠ¡ï¼Œå°†åœ¨ USER_FETCH_REQUESTED action è¢« dispatch æ—¶è°ƒç”¨
function* fetchUser(action) {
  try {
    const user = yield call(Api.fetchUser, action.payload.userId); // call å±äºå£°æ˜å¼è°ƒç”¨ï¼Œåˆ›å»ºä¸€ä¸ªçº¯æ–‡æœ¬å¯¹è±¡æè¿°å‡½æ•°è°ƒç”¨
    yield put({type: "USER_FETCH_SUCCEEDED", user: user}); // put ç”¨äºåˆ›å»º dispatch Effect
  } catch (e) {
    yield put({type: "USER_FETCH_FAILED", message: e.message});
  }
}

function* watchFetchData() {
  yield* takeEvery("FETCH_REQUESTED", fetchData)
}

// ä¸Šé¢ generator å‡½æ•°ç­‰ä»·äº
function* watchFetchData() {
  while (true) {
    yield take('FETCH_REQUESTED');
    yield fork(fetchData);
  }
}

function* mySaga() {
  yield takeLatest("USER_FETCH_REQUESTED", fetchUser);
}
</code></pre>

<h3 id="effect-åˆ›å»ºå™¨">Effect åˆ›å»ºå™¨</h3>

<p>redux-saga åº“æä¾›äº†å¾ˆå¤šåˆ›å»º effect çš„å‡½æ•°ï¼Œå¸¸ç”¨çš„æœ‰ä»¥ä¸‹è¿™äº›ï¼Œæ›´å¤š<a href="https://redux-saga-in-chinese.js.org/docs/api/">å‚è€ƒè¿™é‡Œ</a>:</p>

<ul>
  <li><strong>put</strong>(action)</li>
  <li><strong>call</strong>(fn, â€¦args)</li>
  <li><strong>fork</strong>(fn, â€¦args)</li>
  <li><strong>cancel</strong>(â€¦tasks)</li>
  <li><strong>take</strong>(pattern) - ç›‘å¬æœªæ¥çš„ action</li>
  <li><strong>select</strong>(selector, â€¦args)</li>
</ul>

<p>1ã€<strong>put</strong></p>

<p>åˆ›å»ºä¸€ä¸ª Effect æè¿°ä¿¡æ¯ï¼Œç”¨æ¥å‘½ä»¤ middleware å‘ Store å‘èµ·ä¸€ä¸ª actionã€‚ è¿™ä¸ª effect æ˜¯éé˜»å¡å‹çš„ï¼Œå¹¶ä¸”æ‰€æœ‰å‘ä¸‹æ¸¸æŠ›å‡ºçš„é”™è¯¯ï¼ˆä¾‹å¦‚åœ¨ reducer ä¸­ï¼‰ï¼Œéƒ½ä¸ä¼šå†’æ³¡å›åˆ° saga å½“ä¸­:</p>

<pre><code class="language-JS">yield put({type: "USER_FETCH_SUCCEEDED", user: user});
</code></pre>

<p>2ã€<strong>call</strong></p>

<p>åˆ›å»ºä¸€ä¸ª Effect æè¿°ä¿¡æ¯ï¼Œç”¨æ¥å‘½ä»¤ middleware ä»¥å‚æ•° args è°ƒç”¨å‡½æ•° fnï¼Œfn å³å¯ä»¥æ˜¯ä¸€ä¸ª æ™®é€š å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª Generator å‡½æ•°ã€‚call å‡½æ•°ä¹Ÿæ˜¯<strong>é˜»å¡</strong> effect:</p>

<pre><code class="language-JS">const user = yield call(Api.fetchUser, action.payload.userId);
</code></pre>

<p>ç±»ä¼¼äº <code class="highlighter-rouge">Promise.all</code> åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡:</p>

<pre><code class="language-JS">import { call } from 'redux-saga/effects'

// effects å°†ä¼šåŒæ­¥æ‰§è¡Œã€‚generator ä¼šè¢«é˜»å¡ç›´åˆ°æ‰€æœ‰çš„ effects éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œæˆ–è€…å½“ä¸€ä¸ª effect è¢«æ‹’ç»
const [users, repos] = yield [
  call(fetch, '/users'),
  call(fetch, '/repos')
]
</code></pre>

<p>3ã€<strong>fork</strong></p>

<p>fork ç±»ä¼¼äº callï¼Œå¯ä»¥ç”¨æ¥è°ƒç”¨æ™®é€šå‡½æ•°å’Œ Generator å‡½æ•°ã€‚ä¸è¿‡ï¼Œfork çš„è°ƒç”¨æ˜¯<strong>éé˜»å¡</strong>çš„ï¼ŒGenerator ä¸ä¼šåœ¨ç­‰å¾… fn è¿”å›ç»“æœçš„æ—¶å€™è¢« middleware æš‚åœï¼›ç›¸åï¼Œå®ƒåœ¨ fn è¢«è°ƒç”¨æ—¶ä¾¿ä¼šç«‹å³æ¢å¤æ‰§è¡Œ:</p>

<pre><code class="language-JS">export default function* rootSaga() {
  // ä¸‹é¢çš„å››ä¸ª Generator å‡½æ•°ä¼šä¸€æ¬¡æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡æ‰§è¡Œ
  yield fork(addItemFlow)
  yield fork(removeItemFlow)
  yield fork(toggleItemFlow)
  yield fork(modifyItemFLOW)
}
</code></pre>

<p>4ã€<strong>cancel</strong></p>

<p>åˆ›å»ºä¸€ä¸ª Effect æè¿°ä¿¡æ¯ï¼Œä¸€æ—¦ä»»åŠ¡è¢« forkï¼Œå¯ä»¥ç”¨æ¥ä¸­æ­¢ä»»åŠ¡æ‰§è¡Œ:</p>

<pre><code class="language-JS">function* main() {
  while ( yield take(START_BACKGROUND_SYNC) ) {
    // å¯åŠ¨åå°ä»»åŠ¡
    const bgSyncTask = yield fork(bgSync)

    // ç­‰å¾…ç”¨æˆ·çš„åœæ­¢æ“ä½œ
    yield take(STOP_BACKGROUND_SYNC)
    // ç”¨æˆ·ç‚¹å‡»äº†åœæ­¢ï¼Œå–æ¶ˆåå°ä»»åŠ¡ï¼Œè¿™ä¼šå¯¼è‡´è¢« fork çš„ bgSync ä»»åŠ¡è·³è¿›å®ƒçš„ finally åŒºå—
    yield cancel(bgSyncTask)
  }
}
</code></pre>

<p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå–æ¶ˆ bgSyncTask å°†ä¼šå¯¼è‡´ Generator è·³è¿› finally åŒºå—ã€‚å¯ä½¿ç”¨ <code class="highlighter-rouge">yield cancelled()</code> æ¥æ£€æŸ¥ Generator æ˜¯å¦å·²ç»è¢«å–æ¶ˆ:</p>

<pre><code class="language-JS">function* saga() {
  try {
    // ...
  } finally {
    if (yield cancelled()) {
      // åªåº”åœ¨å–æ¶ˆæ—¶æ‰§è¡Œçš„é€»è¾‘
    }
    // åº”åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æ‰§è¡Œçš„é€»è¾‘ï¼ˆä¾‹å¦‚å…³é—­ä¸€ä¸ª channelï¼‰
  }
}
</code></pre>

<p>5ã€<strong>take</strong></p>

<p>å®ƒåˆ›å»ºäº†ä¸€ä¸ªå‘½ä»¤å¯¹è±¡ï¼Œå‘Šè¯‰ middleware ç­‰å¾…ä¸€ä¸ªç‰¹å®šçš„ actionï¼Œ Generator ä¼šæš‚åœï¼Œç›´åˆ°ä¸€ä¸ªä¸ pattern åŒ¹é…çš„ action è¢«å‘èµ·ï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œtake æ˜¯ä¸€ä¸ªé˜»å¡çš„ effectã€‚</p>

<pre><code class="language-JS">function* loginFlow() {
  while (true) {
    yield take('LOGIN')
    // ... perform the login logic
    yield take('LOGOUT')
    // ... perform the logout logic
  }
}
</code></pre>

<p>6ã€<strong>select</strong></p>

<p>åˆ›å»ºä¸€ä¸ª Effectï¼Œç”¨æ¥å‘½ä»¤ middleware åœ¨å½“å‰ Store çš„ state ä¸Šè°ƒç”¨æŒ‡å®šçš„é€‰æ‹©å™¨ï¼Œå¦‚æœè°ƒç”¨ select çš„å‚æ•°ä¸ºç©º(å³ yield select())ï¼Œé‚£ä¹ˆ effect ä¼šå–å¾—å®Œæ•´çš„ state(ä¸è°ƒç”¨ <code class="highlighter-rouge">store.getState()</code> çš„ç»“æœç›¸åŒ):</p>

<pre><code class="language-JS">export function* toggleItemFlow() {
  // é€šè¿‡ select effect æ¥è·å– å…¨å±€ stateä¸Šçš„ `getTodoList` ä¸­çš„ list
  let tempList = yield select(state =&gt; state.getTodoList.list)
}
</code></pre>

<h3 id="effect-ç»„åˆå™¨">Effect ç»„åˆå™¨</h3>

<p>Effect ç»„åˆå™¨åŒ…å«ä¸¤ç§æ–¹æ³•:</p>

<ul>
  <li><strong>race</strong> - ä¼ å…¥çš„æ˜¯ effect çš„æ•°ç»„ï¼Œè¿›è¡Œâ€ç«èµ›â€</li>
  <li><strong>all</strong> - å¹¶è¡Œåœ°è¿è¡Œå¤šä¸ª Effectï¼Œå¹¶ç­‰å¾…å®ƒä»¬å…¨éƒ¨å®Œæˆ</li>
</ul>

<p>1ã€<strong>race</strong></p>

<pre><code class="language-JS">import { take, call, race } from `redux-saga/effects`
import fetchUsers from './path/to/fetchUsers'

// å¦‚æœ call(fetchUsers) å…ˆ resolveï¼ˆæˆ– rejectï¼‰ï¼Œé‚£ä¹ˆ response å°†æ˜¯ fetchUsers çš„ç»“æœï¼Œå¹¶ä¸” cancel å°†æ˜¯ undefinedï¼Œåä¹‹åŒç†
function* fetchUsersSaga {
  const [response, cancel] = yield race([
    call(fetchUsers),
    take(CANCEL_FETCH)
  ])
}
</code></pre>

<p>2ã€<strong>all</strong></p>

<p>ä¸¾ä¸ªå¤šä¸ª Generator çš„æ —å­ï¼Œæ­¤æ—¶å¯ä»¥é‡‡ç”¨ all ç»„åˆå™¨æ–¹æ³•ä¸€èµ·å¯åŠ¨:</p>

<pre><code class="language-JS">import { delay } from 'redux-saga'
import { put, takeEvery, all } from 'redux-saga/effects'

function* incrementAsync() {
  yield delay(1000) // å»¶è¿Ÿ 1s
  yield put({ type: 'INCREMENT' }) // è§¦å‘ action
}

function* watchIncrementAsync() { // åœ¨æ¯ä¸ª INCREMENT_ASYNC action spawn ä¸€ä¸ªæ–°çš„ incrementAsync ä»»åŠ¡
  yield takeEvery('INCREMENT_ASYNC', incrementAsync)
}

// notice how we now only export the rootSaga single entry point to start all Sagas at once
export default function* rootSaga() {
  yield all([
    helloSaga(),
    watchIncrementAsync()
  ])
}
</code></pre>

<h2 id="reduxsauce">reduxsauce</h2>

<p><a href="https://github.com/infinitered/reduxsauce"><strong>reduxsauce</strong></a> å°±æ˜¯ä¸€ä¸ª â€œè°ƒå‘³å‰‚â€ï¼Œè™½ç„¶ä¸æ˜¯å¿…éœ€å“ã€‚ä½†æœ‰å®ƒå¯ä»¥è®©ä»£ç æ›´ â€œç¾å‘³â€ã€‚å¤§å®¶å·²ç»çœ‹åˆ°ä¸Šé¢çš„ reducer å¸¸è§„å†™æ³•å°±æ˜¯åŒ…å«ç¯‡å¹…å·¨å¤§çš„ switch è¯­æ³•ï¼Œçœ‹èµ·æ¥æ¯”è¾ƒæ··ä¹±ã€‚å…ˆçœ‹çœ‹å®ƒæä¾›çš„å‡ ä¸ª API:</p>

<ul>
  <li><strong>createReducer</strong> - è®© reducers æ›´æ˜“äºé˜…è¯»å’Œæµ‹è¯•</li>
  <li><strong>createTypes</strong> - ä»å­—ç¬¦ä¸²ä¸­å®šä¹‰ä½ çš„ç±»å‹å¯¹è±¡</li>
  <li><strong>createActions</strong> - åŒæ—¶åˆ›å»º Action Types å’Œ Action Creators</li>
  <li><strong>resettableReducer</strong> - å…è®¸é‡ç½® reducers</li>
</ul>

<p>1ã€åˆå§‹åŒ–:</p>

<pre><code class="language-JSX">const INITIAL_STATE = { name: null, age: null }

// å¦‚æœä½¿ç”¨ immutable
import { fromJS } from 'immutable'
const INITIAL_STATE = fromJS({ name: null, age: null })
</code></pre>

<p>2ã€è¿è¡Œ</p>

<pre><code class="language-JSX">const sayHello = (state = INITIAL_STATE, action) =&gt; {
  const { age, name } = action
  return { ...state, age, name }
}
</code></pre>

<p>3ã€è§¦å‘</p>

<p>åœ¨ redux ä¸­ï¼Œreducers ä¼šè¢« action è§¦å‘ï¼Œé€šè¿‡ <code class="highlighter-rouge">action.type</code> ä¸Šçš„ switch æ‰€é©±åŠ¨ã€‚ç°åœ¨åªéœ€è¦ä¸€ä¸ªç®€å•çš„å¯¹è±¡ï¼Œå°†æ‰€æœ‰ actions æ˜ å°„åˆ° reducer å‡½æ•°ä¸Š:</p>

<pre><code class="language-JSX">import Types from './actionTypes'
import { Types as ReduxSauceTypes } from 'reduxsauce'

const HANDLERS = {
  [Types.SAY_HELLO]: sayHello,
  [Types.SAY_GOODBYE]: sayGoodbye,
  [ReduxSauceTypes.DEFAULT]: defaultHandler, // default handler
}
</code></pre>

<p>4ã€æ³¨å…¥</p>

<pre><code class="language-JSX">// Injecting Into The Global State Tree
export default createReducer(INITIAL_STATE, HANDLERS)
</code></pre>

<p>å®Œæ•´çš„ç¤ºä¾‹å¦‚ä¸‹:</p>

<pre><code class="language-JSX">// sampleReducer.js
import { createReducer, Types as ReduxSauceTypes } from 'reduxsauce'
import Types from './actionTypes'

// the initial state of this reducer
export const INITIAL_STATE = { error: false, goodies: null }

// the eagle has landed
export const success = (state = INITIAL_STATE, action) =&gt; {
  return { ...state, error: false, goodies: action.goodies }
}

// uh oh
export const failure = (state = INITIAL_STATE, action) =&gt; {
  return { ...state, error: true, goodies: null }
}

// map our action types to our reducer functions
export const HANDLERS = {
  [Types.GOODS_SUCCESS]: success,
  [Types.GOODS_FAILURE]: failure,
  [ReduxSauceTypes.DEFAULT]: (state = INITIAL_STATE) =&gt; state,
}

export default createReducer(INITIAL_STATE, HANDLERS)
</code></pre>

<h2 id="redux-logger">redux-logger</h2>

<p><a href="https://github.com/evgenyrodionov/redux-logger"><strong>redux-logger</strong></a> å¯ä»¥ç”¨æ¥æ‰“å°æ—¥å¿—ï¼Œå¯é…ç½®çš„å±æ€§æœ‰:</p>

<pre><code class="language-JS">{
  predicate, // if specified this function will be called before each action is processed with this middleware.
  collapsed, // takes a Boolean or optionally a Function that receives `getState` function for accessing current store state and `action` object as parameters. Returns `true` if the log group should be collapsed, `false` otherwise.
  duration = false: Boolean, // print the duration of each action?
  timestamp = true: Boolean, // print the timestamp with each action?

  level = 'log': 'log' | 'console' | 'warn' | 'error' | 'info', // console's level
  colors: ColorsObject, // colors for title, prev state, action and next state: https://github.com/evgenyrodionov/redux-logger/blob/master/src/defaults.js#L12-L18
  titleFormatter, // Format the title used when logging actions.

  stateTransformer, // Transform state before print. Eg. convert Immutable object to plain JSON.
  actionTransformer, // Transform action before print. Eg. convert Immutable object to plain JSON.
  errorTransformer, // Transform error before print. Eg. convert Immutable object to plain JSON.

  logger = console: LoggerObject, // implementation of the `console` API.
  logErrors = true: Boolean, // should the logger catch, log, and re-throw errors?

  diff = false: Boolean, // (alpha) show diff between states?
  diffPredicate // (alpha) filter function for showing states diff, similar to `predicate`
}
</code></pre>

<pre><code class="language-JSX">// store.js
import { compose, createStore, applyMiddleware } from 'redux'
import rootReducer from './reducers'

const middlewares = []

if (process.env.NODE_ENV === 'development') {
  const { createLogger } = require('redux-logger')
  middlewares.push(createLogger({
    stateTransformer: (state) =&gt; {
      if (state.toJS) return state.toJS()
      const entries = Object.entries(state)
      return entries.reduce((obj, entry) =&gt; {
        entry[1].toJS ? (obj[entry[0]] = entry[1].toJS()) : (obj[entry[0]] = entry[1]) // eslint-disable-line
        return obj
      }, {})
    },
  }))
}

const store = compose(
  applyMiddleware(...middlewares),
)(createStore)(rootReducer)

export default store
</code></pre>

<p><img src="https://camo.githubusercontent.com/73b5dc54ec615f18746e8472e02d130f79a3cf9f/687474703a2f2f692e696d6775722e636f6d2f43674175486c452e706e67" alt="redux-logger" /></p>

<h2 id="redux-devtools-extension">Redux DevTools Extension</h2>

<p><a href="https://github.com/zalmoxisus/redux-devtools-extension"><strong>Redux DevTools Extension</strong></a> æ˜¯ç”¨æ¥è°ƒè¯• redux åº”ç”¨çš„æ’ä»¶ï¼Œå¯ä»¥ç›‘æµ‹åˆ° state çš„å˜åŒ–å¹¶æä¾›å¯è§†åŒ–çš„åŠŸèƒ½ï¼Œä»¥è°·æ­Œä¸ºä¾‹<a href="https://chrome.google.com/webstore/detail/redux-devtools/lmhkpmbekcpmknklioeibfkpmmfibljd">å®‰è£…æ’ä»¶</a>:</p>

<p><img src="https://user-images.githubusercontent.com/7957859/48663602-3aac4900-ea9b-11e8-921f-97059cbb599c.png" alt="Redux DevTools Extension" /></p>

<p>åœ¨é¡¹ç›®ä¸­é’ˆå¯¹æœ€åŸºæœ¬çš„ store:</p>

<pre><code class="language-JSX">/* eslint-disable no-underscore-dangle */
const store = createStore(
  reducer, /* preloadedState, */
  window.__REDUX_DEVTOOLS_EXTENSION__ &amp;&amp; window.__REDUX_DEVTOOLS_EXTENSION__()
)
/* eslint-enable */
</code></pre>

<p>å¦‚æœæœ‰ç”¨åˆ°ä¸­é—´ä»¶çš„è¯ï¼Œä¿®æ”¹å¦‚ä¸‹:</p>

<pre><code class="language-JSX"> import { createStore, applyMiddleware, compose } from 'redux'

+ const composeEnhancers = window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || compose
+ const store = createStore(reducer, /* preloadedState, */ composeEnhancers(
- const store = createStore(reducer, /* preloadedState, */ compose(
    applyMiddleware(...middleware)
  ))
</code></pre>

<p>ä¸Šè¿°æ–¹æ³•åœ¨é¡¹ç›®ä¸­æ— éœ€å®‰è£…ç¬¬ä¸‰æ–¹åº“ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡å®‰è£… <code class="highlighter-rouge">redux-devtools-extension</code> æ¥å®ç°:</p>

<pre><code class="language-JSX">// yarn add -D redux-devtools-extension

import { createStore, applyMiddleware } from 'redux';
import { composeWithDevTools } from 'redux-devtools-extension'

const store = createStore(reducer, composeWithDevTools(
  applyMiddleware(...middleware),
  // other store enhancers if any
))
</code></pre>

<h2 id="ç¤ºä¾‹">ç¤ºä¾‹</h2>

<p>Redux è¿è¡Œ Counter ç¤ºä¾‹ï¼Œåœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œæ¨èä½¿ç”¨ React å’Œæ›´é«˜æ•ˆçš„ React-Redux ç»‘å®šï¼Œ<a href="https://github.com/lipeishang/react-redux-connect-demo">å‚è€ƒ demo</a>:</p>

<iframe src="https://codesandbox.io/embed/github/reactjs/redux/tree/master/examples/counter" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe>

<p>React-Redux è¿è¡Œ TodoList ç¤ºä¾‹:</p>

<iframe src="https://codesandbox.io/embed/github/reactjs/redux/tree/master/examples/todos-with-undo" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe>

<p>Redux-thunk è¿è¡Œ å¼‚æ­¥è¯·æ±‚ ç¤ºä¾‹:</p>

<iframe src="https://codesandbox.io/embed/github/reactjs/redux/tree/master/examples/async" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe>

<p>æ›´å¤šç¤ºä¾‹<a href="http://cn.redux.js.org/docs/introduction/Examples.html">è¯·å‚è€ƒè¿™é‡Œ</a>ã€‚</p>

<h2 id="ducks-æ–‡ä»¶ç»“æ„">Ducks æ–‡ä»¶ç»“æ„</h2>

<p>ä¾ç…§<a href="https://redux.js.org/faq/codestructure">å®˜æ–¹ç»„ç»‡ä»£ç çš„æ–‡ç« </a>ï¼Œå¤§è‡´å¯åˆ†ä¸ºä¸‰ç§æ–‡ä»¶ç»“æ„:</p>

<ul>
  <li><strong>Rails é£æ ¼</strong></li>
  <li><strong>åº”ç”¨é¢†åŸŸé£æ ¼(Domain)</strong></li>
  <li><strong>é¸­å­(Ducks)</strong></li>
</ul>

<p>1ã€ <strong>Railsé£æ ¼</strong></p>

<p>åˆå¯ä»¥ç§°ä¸ºâ€ä¾ç…§ç±»å‹(by type)â€çš„é›†ä¸­ç»„ç»‡æ–¹å¼ã€‚ç”¨ actionsã€constantsã€reducersã€containersã€components ç­‰ç›®å½•åŒºåˆ†ï¼Œæ–‡æ¡£åå¯ä»¥ä¾åŠŸèƒ½æˆ–åº”ç”¨å‘½ååŒºåˆ†ï¼Œè¿™å¤§æ¦‚æ˜¯æœ€å¸¸è§çš„ä¸€ç§:</p>

<pre><code class="language-TEXT">actions/
    CommandActions.js
    UserActions.js
components/
    Header.js
    Sidebar.js
    Command.js
    User.js
    UserProfile.js
    UserAvatar.js
containers/
    App.js
    Command.js
    User.js
reducers/
    index.js
    command.js
    user.js
routes.js
index.js
rootReducer.js
</code></pre>

<p>2ã€<strong>åº”ç”¨é¢†åŸŸé£æ ¼(Domain)</strong></p>

<p>åˆå¯ä»¥ç§°ä¸ºâ€ä¾ç…§åŠŸèƒ½(by feature)â€çš„é›†ä¸­ç»„ç»‡æ–¹å¼ã€‚å…ˆä»¥åŠŸèƒ½æˆ–åº”ç”¨é¢†åŸŸä¸åŒçš„ç›®å½•åŒºåˆ†ï¼Œç›®å½•é‡Œæœ‰å„è‡ªçš„ reducerã€action ç­‰ç­‰æ–‡æ¡£ï¼Œå¯ä»¥ç”¨æ–‡æ¡£å‘½åå†ä½œç±»å‹åŒºåˆ†:</p>

<pre><code class="language-TEXT">app/
    Header.js
    Sidebar.js
    App.js
    rootReducer.js
    routes.js
product/
    Product.js
    ProductContainer.js
    ProductActions.js
    ProductList.js
    ProductItem.js
    ProductImage.js
    productReducer.js
user/
    User.js
    UserContainer.js
    UserActions.js
    UserProfile.js
    UserAvatar.js
    userReducer.js
</code></pre>

<p>3ã€<strong>é¸­å­(Ducks)</strong></p>

<p>é¸­å­æ˜¯ä¸€ç§æ¨¡ç»„åŒ– Redux çš„ä»£ç ç»„è¯†æ–¹æ³•ï¼Œå®ƒæ˜¯æŠŠ reducersã€constantsã€action types ä¸ actions æ‰“åŒ…æˆæ¨¡ç»„æ¥ç”¨ã€‚é¸­å­å¯ä»¥å‡å°‘å¾ˆå¤šç›®å½•ä¸æ–‡æ¡£ç»“æ„:</p>

<pre><code class="language-TEXT">|_ containers
|_ constants
|_ reducers
|_ actions
</code></pre>

<p>æ”¹ç”¨é¸­å­åå°±ä¼šå˜æˆåªæœ‰ä¸¤ä¸ªç›®å½•ï¼Œä¹Ÿå°±æ˜¯è¯´æŠŠ constants, reducers, actions éƒ½åˆå¹¶ä¸ºæ¨¡ç»„å°±æ˜¯:</p>

<pre><code class="language-TEXT">|_ containers
|_ modules
</code></pre>

<p>é¸­å­æœ‰ä¸€äº›ä¼˜ç‚¹ï¼Œä¹Ÿæœ‰ä¸€äº›æ˜æ˜¾çš„ç¼ºç‚¹ã€‚å®ƒåœ¨å°å‹åº”ç”¨ä¸­æ˜¯å¾ˆç†æƒ³çš„ä½œæ³•ï¼Œä½ ä¸ç”¨ä¸ºäº†è¦åŠ ä¸€ä¸ªåŠŸèƒ½ï¼Œè‡³å°‘éœ€è¦å¼€ä¸‰ã€å››ä¸ªä»£ç æ–‡æ¡£ã€‚å®ƒä»ç„¶æœ‰è‡ªè®¢çš„ç©ºé—´ï¼Œ<a href="https://hackernoon.com/my-journey-toward-a-maintainable-project-structure-for-react-redux-b05dfd999b5">è¯¦ç»†è¯·å‚è€ƒè¿™ç¯‡æ–‡ç« </a>ã€‚</p>

<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h2>

<ol>
  <li><a href="http://cn.redux.js.org/">Redux ä¸­æ–‡æ–‡æ¡£</a></li>
  <li><a href="https://github.com/react-guide/redux-tutorial-cn#redux-tutorial">react-guide/redux-tutorial-cn</a></li>
  <li><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html">Redux å…¥é—¨æ•™ç¨‹</a> By é˜®ä¸€å³°</li>
  <li><a href="https://cisy.me/react-redux/">react-redux è¯¦è§£</a> By Cisy</li>
  <li><a href="http://taobaofed.org/blog/2016/08/18/react-redux-connect/">React å®è·µå¿ƒå¾—ï¼šreact-redux ä¹‹ connect æ–¹æ³•è¯¦è§£</a> By å¶æ–‹</li>
  <li><a href="http://www.alloyteam.com/2016/03/10532/">æ¢ç´¢ react-redux çš„å°ç§˜å¯†</a></li>
  <li><a href="https://redux-saga-in-chinese.js.org/">Redux-Saga ä¸­æ–‡æ–‡æ¡£</a></li>
  <li><a href="https://www.jianshu.com/p/7cac18e8d870">redux-saga æ¡†æ¶ä½¿ç”¨è¯¦è§£åŠ Demo æ•™ç¨‹</a> By å…‰å¼º_ä¸Šæµ·</li>
  <li><a href="https://github.com/infinitered/reduxsauce">Github - reduxsauce</a></li>
  <li><a href="https://segmentfault.com/q/1010000008187210">å…³äº redux é¡¹ç›®ç»“æ„é—®é¢˜</a> By eyesofkids</li>
  <li><a href="https://hackernoon.com/my-journey-toward-a-maintainable-project-structure-for-react-redux-b05dfd999b5">My journey toward a maintainable project structure for React/Redux</a> By Matteo Mazzarolo</li>
  <li><a href="https://segmentfault.com/a/1190000011473973">Redux å…³ç³»å›¾è§£</a> By Yawenina</li>
  <li><a href="https://juejin.im/post/5b2e3b9451882574934c3c8d">å¯¹ Reactã€Reduxã€React-Redux è¯¦ç»†å‰–æ</a> By æ®µäº¦å¿ƒ</li>
</ol>
 
<div id="gitalk-container"></div>
<script>
    var gitalk = new Gitalk({
      enable: true,
      clientID: '020f142489f80c92b097',
      clientSecret: '1fa083372b44031cf1b8249251515c4e3d54c69d',
      repo: 'tate-young.github.io',
      owner: 'Tate-Young',
      admin: ['Tate-Young'],
      id: location.pathname,      // Ensure uniqueness and length less than 50
      distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script>
<!-- disqus -->
<!-- <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function () {
        this.page.url = 'https://tate-young.github.io/2018/08/07/react-redux.html';
        this.page.identifier = '/2018/08/07/react-redux';
        this.page.title = 'Redux & Redux-Saga';
    };

    (function () { // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document,
            s = d.createElement('script');

        s.src = '//tate.disqus.com/embed.js'; // IMPORTANT: Replace EXAMPLE with your forum shortname!

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript> -->


            <!-- <p class="post-info">
			æœ¬æ–‡ç”± <a href="/">liberxue</a> åˆ›ä½œï¼Œé‡‡ç”¨ <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external nofollow">çŸ¥è¯†å…±äº«ç½²å4.0</a> å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯<br>æœ¬ç«™æ–‡ç« é™¤æ³¨æ˜è½¬è½½/å‡ºå¤„å¤–ï¼Œå‡ä¸ºæœ¬ç«™åŸåˆ›æˆ–ç¿»è¯‘ï¼Œè½¬è½½å‰è¯·åŠ¡å¿…ç½²å<br>æœ€åç¼–è¾‘æ—¶é—´ä¸º:2018-08-07 18:15:00</p> -->
        </div>
    </article>

    <!-- <div class="related-post-lists">
	<div class="post-lists">
		<div class="post-lists-body">
					<div class="post-list-item">
				<div class="post-list-item-container">
					<div class="item-label">
						<div class="item-title"><a href="induction.html">å½’çº³çš„éšæƒ³</a></div>
						<div class="item-meta clearfix">
														<div class="item-meta-ico bg-ico-image" style="background: url('../usr/themes/pinghsu/images/bg-ico.png') no-repeat;background-size: 40px auto;"></div>
	                        							<div class="item-meta-cat"><a href="../category/thoughts/index.html">Thoughts</a></div>
						</div>
					</div>
				</div>
			</div>
				</div>
	</div>
</div> -->

    <!-- <footer class="footer bg-white">
	<div class="footer-social">
		<div class="footer-container clearfix">
			<div class="social-list">
	 <a class="social segmentfault" target="blank" href="https://segmentfault.com/u/liberxue" title="è®¿é—® LiberXue_Twitter" data-hover="Segmentfault">Segmentfault</a>
    <a class="social github" target="blank" href="https://github.com/liberxue" title="è®¿é—® LiberXue_Twitter" data-hover="GitHub">GitHub</a>
    <a class="social twitter" target="blank" href="http://twitter.com/liberxue" title="è®¿é—® LiberXue_Twitter" data-hover="Twitter">Twitter</a>
     <a class="social stackoverflow" target="blank" href="https://stackoverflow.com/users/6902190/liberxue" title="è®¿é—® LiberXue_stackoverflow" data-hover="StackOverflow">StackOverflow</a>
          <a class="social oschina" target="blank" href="https://my.oschina.net/bolanzw" title="è®¿é—® LiberXue_Oschina" data-hover="Oschina">Oschina</a>
     <a class="social rss" target="blank" href="/feed.xml"title="è®¿é—® LiberXue_RSS" data-hover="RSS">RSS</a>
	</div>
		</div>
	</div>
	<div class="footer-meta">
        <div class="footer-container">
            <div class="meta-item meta-copyright">
                <div class="meta-copyright-info">
                    <a href="/" class="info-logo">
                         <img src="http://localhost:2333/style/images/logo-liberxue.png"   title="è®¿é—® LiberXue_blog" data-hover="LiberXue_blog" alt="LiberXue_blog" /> </a>
                    <div class="info-text">
                        <p>Theme is <a href="http://www.liberxue.com/2017/08/03/Jekyllthemes.html" title="è®¿é—® Jekyll liberxueä¸»é¢˜"  data-hover="Jekyll liberxue"target="_blank">Jekyll liberxue</a> by <a href="http://www.liberxue.com/about" target="_blank">liberxue</a></p>
                        <p>Powered by <a href="http://localhost:2333/tags/#Jekyll" title="Jekyll" data-hover="Jekyll" target="_blank" rel="nofollow">Jekyll</a></p>
                        <p>&copy; 2017 <a href="/feed.xml"  title="è®¿é—® liberxue blog RSS" data-hover="liberxue blog RSS">liberxue blog RSS</a></p>
                        <p>æ€»è®¡æ–‡ç« ï¼šç¯‡</p>
                      <p>æœ¬blogå·²å¼€æºç‚¹å‡»Fork</p><iframe src="http://ghbtns.com/github-btn.html?user=liberxue&repo=liberxue.github.io&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="95" height="20"></iframe>
                    </div>
                </div>
            </div>
            <div class="meta-item meta-posts">
                <h3 class="meta-title">ç½®é¡¶æ–‡ç« </h3>
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
            </div>
            <div class="meta-item meta-comments">
                <h3 class="meta-title">æœ€æ–°æ–‡ç« </h3>
  
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
</div>
		</div>
    </div>
</footer> -->
<script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.js"></script>
<script async src="/search/js/520.js"></script>
<script async src="/search/js/gtag.js"></script>
<script async src="/search/live2d/autoload.js"></script>
<!-- <script src="/search/js/canvas.js"></script> -->

<script>
    $(function () {
        setTimeout(function () {
            $('code').removeClass('hljs');
            $('code').removeClass('language');
        }, 90);
    });
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    <!--liberxueconnnet-menu-->
    <div id="directory-content" class="directory-content">
        <div id="directory"></div>
    </div>
    <!--liberxueconnnet-menu-->
    <script>
      const directoryContainer = document.getElementById('directory')
      const postTitle = document.getElementsByClassName('post-title')[0]
      var postDirectoryBuild = function () {
        var postChildren = function children(childNodes, reg) {
          var result = [],
              isReg = typeof reg === 'object',
              isStr = typeof reg === 'string',
              node, i, len;
          for (i = 0, len = childNodes.length; i < len; i++) {
            node = childNodes[i];
            if ((node.nodeType === 1 || node.nodeType === 9) &&
              (!reg ||
                  isReg && reg.test(node.tagName.toLowerCase()) ||
                  isStr && node.tagName.toLowerCase() === reg)) {
                result.push(node);
              }
            }
            return result;
          },
          createPostDirectory = function (article, directory, isDirNum) {
            var contentArr = [],
                titleId = [],
                levelArr, root, level,
                currentList, list, li, link, i, len;
            levelArr = (function (article, contentArr, titleId) {
                  var titleElem = postChildren(article.childNodes, /^h\d$/),
                      levelArr = [],
                      lastNum = 1,
                      lastRevNum = 1,
                      count = 0,
                      guid = 1,
                      id = 'directory' + (Math.random() + '').replace(/\D/, ''),
                      lastRevNum, num, elem;
                  while (titleElem.length) {
                      elem = titleElem.shift();
                      contentArr.push(elem.innerHTML);
                      num = +elem.tagName.match(/\d/)[0];
                      if (num > lastNum) {
                          levelArr.push(1);
                          lastRevNum += 1;
                      } else if (num === lastRevNum ||
                          num > lastRevNum && num <= lastNum) {
                          levelArr.push(0);
                          lastRevNum = lastRevNum;
                      } else if (num < lastRevNum) {
                          levelArr.push(num - lastRevNum);
                          lastRevNum = num;
                      }
                      count += levelArr[levelArr.length - 1];
                      lastNum = num;
                      elem.id = elem.id || (id + guid++);
                      titleId.push(elem.id);
                  }
                  if (count !== 0 && levelArr[0] === 1) levelArr[0] = 0;

                  return levelArr;
              })(article, contentArr, titleId);
              currentList = root = document.createElement('ul');
              dirNum = [0];
              for (i = 0, len = levelArr.length; i < len; i++) {
                  level = levelArr[i];
                  if (level === 1) {
                      list = document.createElement('ul');
                      if (!currentList.lastElementChild) {
                          currentList.appendChild(document.createElement('li'));
                      }
                      currentList.lastElementChild.appendChild(list);
                      currentList = list;
                      dirNum.push(0);
                  } else if (level < 0) {
                      level *= 2;
                      while (level++) {
                          if (level % 2) dirNum.pop();
                          currentList = currentList.parentNode;
                      }
                  }
                  dirNum[dirNum.length - 1]++;
                  li = document.createElement('li');
                  link = document.createElement('a');
                  link.name = '#' + titleId[i];
                  link.href = 'Javascript:;'
                  link.className = "post-aside-anchor"
                  link.title = 'è®¿é—®' + titleId[i];
                  link.innerHTML = !isDirNum ? contentArr[i] :
                      dirNum.join('.') + ' ' + contentArr[i];
                  li.appendChild(link);
                  currentList.appendChild(li);
              }
            directory.appendChild(root);
          };
        createPostDirectory(document.getElementById('post-content'), directoryContainer, true);
      };
      postDirectoryBuild();
    </script>
    <script>
      // gtag('config', GA_TRACKING_ID, {
      //   'page_title' : 'Blog',
      //   'page_path': window.location.pathname,
      //   'post_title': 'watttsdfasdf',
      // });

    </script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script>
        lang = hljs.initHighlightingOnLoad();
    </script>
</body>

</html>
