
<!DOCTYPE>
<html lang="zh-cn" data-scribe-reduced-action-queue="true">
<head>
    <meta content='PWA ç®€ä»‹ - Tate & Snow' name='title' />
    <meta content='PWA ç®€ä»‹ - Tate & Snow' name='og:title' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <title>PWA ç®€ä»‹ - Tate & Snow</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>PWA ç®€ä»‹ - Tate & Snow</title>
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PWA ç®€ä»‹ - Tate & Snow">
<meta name="twitter:keywords" content="PWA ç®€ä»‹ - Tate & Snow" property='og:description' />
<meta property="og:type" content="article">
<meta property="og:title" content="PWA ç®€ä»‹ - Tate & Snow">
<meta name="og:keywords" content="PWA ç®€ä»‹ - Tate & Snow|PWA ç®€ä»‹ä»€ä¹ˆæ˜¯ PWAPWA(Progressive Web App) å³æ¸è¿›å¼ç½‘ç»œåº”ç”¨ï¼ŒPWA å¯ä»¥å°† Web å’Œ App å„è‡ªçš„ä¼˜åŠ¿èåˆåœ¨ä¸€èµ·ï¼Œæ˜¯æå‡ Web App çš„ä½“éªŒçš„ä¸€ç§æ–°æ–¹æ³•ï¼Œèƒ½ç»™ç”¨æˆ·åŸç”Ÿåº”ç”¨çš„ä½“éªŒã€‚å…¶æ ¸å¿ƒæŠ€æœ¯åŒ…æ‹¬..."
  property='og:description' />
<link rel="icon" type="image/png" href="http://localhost:2333/style/favicons/favicon.ico" />
<link href="http://localhost:2333/style/favicons/favicon.ico" rel="shortcut icon" type="image/png">
<link rel="canonical" href="http://localhost:2333/">
<link rel="alternate" type="application/rss+xml" title="Liberxue" href="http://localhost:2333/feed.xml">
<meta charset="UTF-8">
<link rel="manifest" href="/manifest.json">
<link rel="shortcut icon" href="http://localhost:2333/style/favicons/favicon.ico" type="image/x-icon">
<meta name="keywords" content="PWA ç®€ä»‹ä»€ä¹ˆæ˜¯ PWAPWA(Progressive Web App) å³æ¸è¿›å¼ç½‘ç»œåº”ç”¨ï¼ŒPWA å¯ä»¥å°† Web å’Œ App å„è‡ªçš„ä¼˜åŠ¿èåˆåœ¨ä¸€èµ·ï¼Œæ˜¯æå‡ Web App çš„ä½“éªŒçš„ä¸€ç§æ–°æ–¹æ³•ï¼Œèƒ½ç»™ç”¨æˆ·åŸç”Ÿåº”ç”¨çš„ä½“éªŒã€‚å…¶æ ¸å¿ƒæŠ€æœ¯åŒ…æ‹¬..." property='og:description'
/>
<meta name="description" content="Tate & Snow's Github blog" />
<link href="https://cdn.bootcss.com/highlight.js/9.10.0/styles/xcode.min.css" rel="stylesheet">
<link href="http://localhost:2333/style/theme.css" rel="stylesheet"> 
<meta content='http://localhost:2333/2019/04/07/progressive-web-app.html' property='og:url' />
<meta content="http://localhost:2333/2019/04/07/progressive-web-app.html|PWA ç®€ä»‹ä»€ä¹ˆæ˜¯ PWAPWA(Progressive Web App) å³æ¸è¿›å¼ç½‘ç»œåº”ç”¨ï¼ŒPWA å¯ä»¥å°† Web å’Œ App å„è‡ªçš„ä¼˜åŠ¿èåˆåœ¨ä¸€èµ·ï¼Œæ˜¯æå‡ Web App çš„ä½“éªŒçš„ä¸€ç§æ–°æ–¹æ³•ï¼Œèƒ½ç»™ç”¨æˆ·åŸç”Ÿåº”ç”¨çš„ä½“éªŒã€‚å…¶æ ¸å¿ƒæŠ€æœ¯åŒ…æ‹¬..." property='og:description'
/>
<meta content="article" property="og:type" /> 

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-136311746-1"></script>
<!-- <script async src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>
<script>
  window.dataLayer = window.dataLayer || [];
  window.GA_TRACKING_ID = 'UA-136311746-1'
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('set', {
    'country': 'US',
    'currency': 'USD',
    'description': 'fuck',
  });
  gtag('config', GA_TRACKING_ID, {
    'custom_map': {
      'dimension1': 'post_title',
    },
    'post_title': 'test',
  });
</script>
<meta content="" property="fb:app_id" />
<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>PWA ç®€ä»‹ | Tate &amp; Snow</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="PWA ç®€ä»‹" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="PWA ç®€ä»‹" />
<meta property="og:description" content="PWA ç®€ä»‹" />
<link rel="canonical" href="http://localhost:2333/2019/04/07/progressive-web-app.html" />
<meta property="og:url" content="http://localhost:2333/2019/04/07/progressive-web-app.html" />
<meta property="og:site_name" content="Tate &amp; Snow" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-07T23:40:00+08:00" />
<script type="application/ld+json">
{"description":"PWA ç®€ä»‹","@type":"BlogPosting","url":"http://localhost:2333/2019/04/07/progressive-web-app.html","headline":"PWA ç®€ä»‹","dateModified":"2019-04-07T23:40:00+08:00","datePublished":"2019-04-07T23:40:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:2333/2019/04/07/progressive-web-app.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<script>
  (function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s);
    js.id = id;
    js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

</head>

<body class="dark-theme" gtools_scp_screen_capture_injected="true">
    <header id="header" class="header bg-white">
        <div class="navbar-container">
            <a href="Javascript:;" onclick="onClickLogo()" title="è®¿é—® Tate & Snow" class="navbar-logo menu-logo">
                <img src="https://i.loli.net/2018/03/13/5aa74f5b4c2c7.png" alt="Tate & Snow"> </a>
            <!-- <a href="/?tate" title="è®¿é—® Tate & Snow" class="navbar-logo">Tate & Snow</a>   -->
            <div class="navbar-menu">
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('é¦–é¡µ', '/')" title="è®¿é—® é¦–é¡µ" data-hover="é¦–é¡µ">é¦–é¡µ</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('å‰ç«¯', '/front')" title="è®¿é—® å‰ç«¯" data-hover="å‰ç«¯">å‰ç«¯</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('å†å²', '/history')" title="è®¿é—® å†å²" data-hover="å†å²">å†å²</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('å…¶ä»–', '/other')" title="è®¿é—® å…¶ä»–" data-hover="å…¶ä»–">å…¶ä»–</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('æ ‡ç­¾', '/tags')" title="è®¿é—® æ ‡ç­¾" data-hover="æ ‡ç­¾">æ ‡ç­¾</a>
                
                  <a class=" menu-item-about " href="Javascript:;" onclick="onClickMenu('å…³äº', '/README')" title="è®¿é—® å…³äº" data-hover="å…³äº">å…³äº</a>
                
            </div>
            <!-- <div class="navbar-menu">
                
                <a href="http://localhost:2333/">é¦–é¡µ</a>
                
                <a href="http://localhost:2333/front">å‰ç«¯</a>
                
                <a href="http://localhost:2333/history">å†å²</a>
                
                <a href="http://localhost:2333/other">å…¶ä»–</a>
                
                <a href="http://localhost:2333/tags">æ ‡ç­¾</a>
                
                <a href="http://localhost:2333/README">å…³äº</a>
                
            </div> -->
            <div class="navbar-search menu-item-search" onclick="onClickSearch()">
                <span class="icon-search"></span>
                <form id="cb-search-btn" role="search">
                    <span class="search-box">
                        <input type="text" class="input" id="cb-search-content" required="true" placeholder="æ ‡é¢˜ æ ‡ç­¾..." maxlength="30" autocomplete="off">
                    </span>
                </form>
            </div>
            <div class="navbar-mobile-menu" onclick="">
                <span class="icon-menu cross">
                    <span class="middle"></span>
                </span>
                <ul>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('é¦–é¡µ', 'http://localhost:2333/')">é¦–é¡µ</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å‰ç«¯', 'http://localhost:2333/front')">å‰ç«¯</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å†å²', 'http://localhost:2333/history')">å†å²</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å…¶ä»–', 'http://localhost:2333/other')">å…¶ä»–</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('æ ‡ç­¾', 'http://localhost:2333/tags')">æ ‡ç­¾</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å…³äº', 'http://localhost:2333/README')">å…³äº</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </header>
    <a href="#header" class="back-to-top" onclick="onClickTop('PWA ç®€ä»‹')">â¤´Topâ¤´</a>
    <div class="post-header-thumb bg-white}">
        <div class="post-header-thumb-op"></div>
        <div class="post-header-thumb">
            <div class="post-header-thumb-container">
                <h1 class="post-title" itemprop="name headline">
                    PWA ç®€ä»‹</h1>
                <div class="post-data">
                    <time datetime="2019-04-07 23:40:00" itemprop="datePublished">
                      å‘å¸ƒæ—¶é—´ï¼š2019-04-07 23:40:00
                      &nbsp;&nbsp;&nbsp;
                      
                        ä¿®æ”¹æ—¶é—´ï¼š2019-04-10 11:30:00
                      
                    </time>
                    <a onclick="onClickCategory('å‰ç«¯')" href="Javascript:;" title="è®¿é—® å‰ç«¯" data-hover="åšå®¢åˆ†ç±»: å‰ç«¯">åšå®¢åˆ†ç±»: å‰ç«¯</a>
                    <!-- <a href="#read"> é˜…è¯»æ¬¡æ•°: comments</a>  -->
                </div>
                <div class="post-tags">
                       
                    <a class="menu-item-tags" href="Javascript:;" onclick="onClickTag('pwa')" title="è®¿é—®pwa" data-hover="pwa">
                        pwa
                        <span>(1)</span>
                        
                    </a>
                       
                </div>
            </div>
        </div>
    </div>
    <article class="main-content post-page" itemscope itemtype="http://schema.org/Article">
        <div class="post-header">
            <h1 class="post-title" itemprop="name headline">
                PWA ç®€ä»‹</h1>
            <div class="post-data">
                <time datetime="2019-04-07 23:40:00" itemprop="datePublished">2019-04-07 23:40:00</time>
            </div>
        </div>
        <div id="post-content" class="post-content" itemprop="articleBody">
            <p class="post-tags">
                   
                <a href="Javascript:;" onclick="onClickTag('pwa')" title="è®¿é—®pwa" data-hover="pwa">
                    pwa
                    <span>(1)</span>
                    </a>
                   
            </p>
            <h1 id="pwa-ç®€ä»‹">PWA ç®€ä»‹</h1>

<h2 id="ä»€ä¹ˆæ˜¯-pwa">ä»€ä¹ˆæ˜¯ PWA</h2>

<p><strong>PWA(Progressive Web App)</strong> å³æ¸è¿›å¼ç½‘ç»œåº”ç”¨ï¼ŒPWA å¯ä»¥å°† Web å’Œ App å„è‡ªçš„ä¼˜åŠ¿èåˆåœ¨ä¸€èµ·ï¼Œæ˜¯æå‡ Web App çš„ä½“éªŒçš„ä¸€ç§æ–°æ–¹æ³•ï¼Œèƒ½ç»™ç”¨æˆ·åŸç”Ÿåº”ç”¨çš„ä½“éªŒã€‚å…¶æ ¸å¿ƒæŠ€æœ¯åŒ…æ‹¬:</p>

<ul>
  <li><strong>App Manifest</strong> - Web åº”ç”¨ç¨‹åºæ¸…å•ï¼Œå®ç°å¯å®‰è£…</li>
  <li><strong>Service Worker</strong> - åå°è¿è¡Œçš„ç‹¬ç«‹çº¿ç¨‹ï¼Œå®ç°ç¦»çº¿ä½¿ç”¨</li>
  <li><strong>Web Push &amp; Notification</strong> - æ¶ˆæ¯æ¨é€å’Œæé†’</li>
</ul>

<blockquote>
  <p>æ­¤åšå®¢åŸºæœ¬è½¬è‡ª alienzhou çš„<a href="https://alienzhou.gitbook.io/learning-pwa/2018-kai-shi-ni-de-pwa-xue-xi-zhi-lv">2018ï¼Œå¼€å§‹ä½ çš„ PWA å­¦ä¹ ä¹‹æ—…</a></p>
</blockquote>

<h2 id="manifest">Manifest</h2>

<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/Manifest"><strong>Manifest</strong></a> æ˜¯ä¸€ä¸ª JSON æ ¼å¼çš„æ–‡ä»¶ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªæŒ‡å®šäº† Web App æ¡Œé¢å›¾æ ‡ã€åç§°ã€å¼€å±å›¾æ ‡ã€è¿è¡Œæ¨¡å¼ç­‰ä¸€ç³»åˆ—èµ„æºçš„ä¸€ä¸ªæ¸…å•ã€‚åˆ›å»ºå¥½åç›´æ¥é€šè¿‡ meta æ ‡ç­¾æ¥ä½¿ç”¨:</p>

<pre><code class="language-HTML">&lt;!-- åœ¨ index.html ä¸­æ·»åŠ ä»¥ä¸‹ meta æ ‡ç­¾ --&gt;
&lt;link rel="manifest" href="/manifest.json"&gt;
</code></pre>

<pre><code class="language-JSON">{
  "name": "HackerWeb",
  "short_name": "HackerWeb", # å½“æ²¡æœ‰è¶³å¤Ÿç©ºé—´å±•ç¤ºåº”ç”¨çš„ name æ—¶ï¼Œç³»ç»Ÿå°±ä¼šä½¿ç”¨ short_name
  "start_url": "./?utm_source=web_app_manifest", # æŒ‡å®šç”¨æˆ·ä»è®¾å¤‡å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶åŠ è½½çš„ URLã€‚ å¦‚æœä»¥ç›¸å¯¹ URL çš„å½¢å¼ç»™å‡ºï¼Œåˆ™åŸºæœ¬ URL å°†æ˜¯ manifest çš„ URL
  "display": "standalone", # å®šä¹‰å¼€å‘äººå‘˜å¯¹ Web åº”ç”¨ç¨‹åºçš„é¦–é€‰æ˜¾ç¤ºæ¨¡å¼
  "background_color": "#fff", # ä¸º web åº”ç”¨ç¨‹åºé¢„å®šä¹‰çš„èƒŒæ™¯é¢œè‰²
  "orientation": "portrait", # å®šä¹‰æ‰€æœ‰ Web åº”ç”¨ç¨‹åºé¡¶çº§çš„é»˜è®¤æ–¹å‘ browsing contexts
  "description": "A simply readable Hacker News app.",
  "icons": [{
    "src": "images/touch/homescreen48.png",
    "sizes": "48x48",
    "type": "image/png"
  }, {
    "src": "images/touch/homescreen72.png",
    "sizes": "72x72",
    "type": "image/png"
  }, {
    "src": "images/touch/homescreen192.png",
    "sizes": "192x192",
    "type": "image/png"
  }],
  "related_applications": [{ # æŒ‡å®šä¸€ä¸ªâ€œåº”ç”¨ç¨‹åºå¯¹è±¡â€æ•°ç»„ï¼Œä»£è¡¨å¯ç”±åº•å±‚å¹³å°å®‰è£…æˆ–å¯è®¿é—®çš„æœ¬æœºåº”ç”¨ç¨‹åº
    "platform": "web"
  }, {
    "platform": "play",
    "url": "https://play.google.com/store/apps/details?id=cheeaun.hackerweb"
  }]
}
</code></pre>

<p>å…¶ä¸­ <code class="highlighter-rouge">display</code> æ˜¯ç”¨æ¥å®šä¹‰å¼€å‘äººå‘˜å¯¹ Web åº”ç”¨ç¨‹åºçš„é¦–é€‰æ˜¾ç¤ºæ¨¡å¼:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">æ˜¾ç¤ºæ¨¡å¼</th>
      <th style="text-align: left">æè¿°</th>
      <th>åå¤‡æ˜¾ç¤ºæ¨¡å¼</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">fullscreen</td>
      <td style="text-align: left">å…¨å±æ˜¾ç¤º, æ‰€æœ‰å¯ç”¨çš„æ˜¾ç¤ºåŒºåŸŸéƒ½è¢«ä½¿ç”¨, å¹¶ä¸”ä¸æ˜¾ç¤ºçŠ¶æ€æ </td>
      <td>standalone</td>
    </tr>
    <tr>
      <td style="text-align: left">standalone</td>
      <td style="text-align: left">ç‹¬ç«‹åº”ç”¨æ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼ä¸‹æ‰“å¼€çš„åº”ç”¨æœ‰è‡ªå·±çš„å¯åŠ¨å›¾æ ‡ï¼Œå¹¶ä¸”ä¸ä¼šæœ‰æµè§ˆå™¨çš„åœ°å€æ ã€‚å› æ­¤çœ‹èµ·æ¥æ›´åƒä¸€ä¸ª Native App</td>
      <td>minimal-ui</td>
    </tr>
    <tr>
      <td style="text-align: left">minimal-ui</td>
      <td style="text-align: left">ä¸ standalone ç›¸æ¯”ï¼Œä¼šæœ‰æµè§ˆå™¨åœ°å€æ ï¼Œæ ·å¼å› æµè§ˆå™¨è€Œå¼‚</td>
      <td>browser</td>
    </tr>
    <tr>
      <td style="text-align: left">browser</td>
      <td style="text-align: left">è¯¥åº”ç”¨ç¨‹åºåœ¨ä¼ ç»Ÿçš„æµè§ˆå™¨æ ‡ç­¾æˆ–æ–°çª—å£ä¸­æ‰“å¼€ï¼Œå…·ä½“å®ç°å–å†³äºæµè§ˆå™¨å’Œå¹³å°ã€‚ è¿™æ˜¯é»˜è®¤çš„è®¾ç½®</td>
      <td>None</td>
    </tr>
  </tbody>
</table>

<h2 id="service-worker">Service Worker</h2>

<p><strong>Service Worker</strong> å¯ä»¥ç®€å•ç†è§£ä¸ºä¸€ä¸ªç‹¬ç«‹äºå‰ç«¯é¡µé¢ï¼Œåœ¨åå°è¿è¡Œçš„è¿›ç¨‹ã€‚å®ƒæœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ï¼šä½ å¯ä»¥åœ¨ Service Worker ä¸­ç›‘å¬æ‰€æœ‰å®¢æˆ·ç«¯(Web)å‘å‡ºçš„è¯·æ±‚ï¼Œç„¶åé€šè¿‡å®ƒæ¥ä»£ç†ï¼Œå‘åç«¯æœåŠ¡å‘èµ·è¯·æ±‚ã€‚é€šè¿‡ç›‘å¬ç”¨æˆ·è¯·æ±‚ä¿¡æ¯ï¼ŒService Worker å¯ä»¥å†³å®šæ˜¯å¦ä½¿ç”¨ç¼“å­˜æ¥ä½œä¸º Web è¯·æ±‚çš„è¿”å›ã€‚å› æ­¤å®ƒæ˜¯å®ç°ç¦»çº¿è®¿é—®çš„æ ¸å¿ƒï¼Œä¸‹å›¾å±•ç¤ºæ™®é€š Web App ä¸æ·»åŠ äº† Service Worker çš„ Web App åœ¨ç½‘ç»œè¯·æ±‚ä¸Šçš„å·®å¼‚:</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/4/8/162a560d0bdb6ed1?w=567&amp;h=271&amp;f=png&amp;s=14952" alt="service worker" /></p>

<blockquote>
  <p>Service Worker å®é™…è¿è¡Œäºæœ¬æœºä¸Šï¼Œç›¸å½“äºä¸€ä¸ªå®¢æˆ·ç«¯ä»£ç†ã€‚</p>
</blockquote>

<h3 id="æ³¨å†Œ">æ³¨å†Œ</h3>

<pre><code class="language-JS">// index.js
// æ³¨å†Œ service workerï¼Œå…¶è„šæœ¬æ–‡ä»¶ä¸º sw.js
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(function () {
    console.log('Service Worker æ³¨å†ŒæˆåŠŸ');
  });
}
</code></pre>

<h3 id="ç”Ÿå‘½å‘¨æœŸ">ç”Ÿå‘½å‘¨æœŸ</h3>

<p>å½“æˆ‘ä»¬æ³¨å†Œäº† Service Worker åï¼Œå®ƒä¼šç»å†ç”Ÿå‘½å‘¨æœŸçš„å„ä¸ªé˜¶æ®µï¼ŒåŒæ—¶ä¼šè§¦å‘ç›¸åº”çš„äº‹ä»¶ã€‚æ•´ä¸ªç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬äº†: <code class="highlighter-rouge">installing --&gt; installed --&gt; activating --&gt; activated --&gt; redundant</code>:</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/4/8/162a560d0bdaf33b?w=579&amp;h=867&amp;f=png&amp;s=39680" alt="lifecycle" /></p>

<p>æ¯”å¦‚å¯ä»¥ç›‘å¬ install äº‹ä»¶:</p>

<pre><code class="language-JS">// ç›‘å¬ install äº‹ä»¶
self.addEventListener('install', function (e) {
  console.log('Service Worker çŠ¶æ€ï¼š install');
});
</code></pre>

<blockquote>
  <p><strong>self</strong> æ˜¯ Service Worker ä¸­ä¸€ä¸ªç‰¹æ®Šçš„å…¨å±€å˜é‡ï¼Œç±»ä¼¼äº window å¯¹è±¡ã€‚self å¼•ç”¨äº†å½“å‰è¿™ä¸ª Service Workerã€‚</p>
</blockquote>

<h3 id="cachestorage">CacheStorage</h3>

<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/CacheStorage"><strong>CacheStorage</strong></a> æ¥å£è¡¨ç¤º Cache å¯¹è±¡çš„å­˜å‚¨ï¼Œæš´éœ²ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•:</p>

<ul>
  <li><strong>CacheStorage.match()</strong> - æ£€æŸ¥ç»™å®šçš„ Request æ˜¯å¦æ˜¯ CacheStorage å¯¹è±¡è·Ÿè¸ªçš„ä»»ä½• Cache å¯¹è±¡çš„é”®ï¼Œå¹¶è¿”å›ä¸€ä¸ª resolve ä¸ºè¯¥åŒ¹é…çš„ Promise</li>
  <li><strong>CacheStorage.has()</strong> - å¦‚æœå­˜åœ¨ä¸ cacheName åŒ¹é…çš„ Cache å¯¹è±¡ï¼Œåˆ™è¿”å›ä¸€ä¸ª resolve ä¸º true çš„ Promise</li>
  <li><strong>CacheStorage.open()</strong> - è¿”å›ä¸€ä¸ª Promise ï¼Œresolve ä¸ºåŒ¹é…  cacheName çš„ Cache å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ cache</li>
  <li><strong>CacheStorage.delete()</strong> - æŸ¥æ‰¾åŒ¹é… cacheName çš„ Cache å¯¹è±¡ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œåˆ™åˆ é™¤ Cache å¯¹è±¡å¹¶è¿”å›ä¸€ä¸ª resolve ä¸º true çš„ Promise ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ° Cache å¯¹è±¡ï¼Œåˆ™è¿”å› false</li>
  <li><strong>CacheStorage.keys()</strong> - è¿”å›ä¸€ä¸ª Promise ï¼Œå®ƒå°†ä½¿ç”¨ä¸€ä¸ªåŒ…å«ä¸ CacheStorage è¿½è¸ªçš„æ‰€æœ‰å‘½å Cache å¯¹è±¡å¯¹åº”å­—ç¬¦ä¸²çš„æ•°ç»„æ¥ resolve. ä½¿ç”¨è¯¥æ–¹æ³•è¿­ä»£æ‰€æœ‰ Cache å¯¹è±¡çš„åˆ—è¡¨</li>
</ul>

<p>è¦ä½¿æˆ‘ä»¬çš„ Web App ç¦»çº¿å¯ç”¨ï¼Œå°±éœ€è¦å°†æ‰€éœ€èµ„æºç¼“å­˜ä¸‹æ¥ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¿™æ ·çš„èµ„æºåˆ—è¡¨ï¼Œå½“ Service Worker è¢«æ¿€æ´»æ—¶ï¼Œä¼šå°†è¯¥åˆ—è¡¨å†…çš„èµ„æºç¼“å­˜è¿› cache:</p>

<pre><code class="language-JS">// sw.js
var cacheName = 'bs-0-2-0';
var cacheFiles = [ // åˆ—å‡ºæ‰€æœ‰çš„é™æ€èµ„æºä¾èµ–
  '/',
  './index.html',
  './index.js',
  './style.css',
  './img/book.png',
  './img/loading.svg'
];

// ç›‘å¬ install äº‹ä»¶ï¼Œå®‰è£…å®Œæˆåï¼Œè¿›è¡Œæ–‡ä»¶ç¼“å­˜
self.addEventListener('install', function (e) {
  // caches æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥æ“ä½œ Cache ç›¸å…³æ¥å£
  var cacheOpenPromise = caches.open(cacheName).then(function (cache) {
    return cache.addAll(cacheFiles);
  });
  e.waitUntil(cacheOpenPromise);
});
</code></pre>

<p>ç¼“å­˜æœ‰äº†ï¼Œä½†æ˜¯å¦‚ä½•å‘ŠçŸ¥æµè§ˆå™¨ä½¿ç”¨å‘¢ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹å‡ ä¸ªç­–ç•¥:</p>

<ul>
  <li>æœ‰ç¼“å­˜</li>
</ul>

<p><img src="https://user-gold-cdn.xitu.io/2018/4/8/162a560d2d6b1798?w=567&amp;h=284&amp;f=png&amp;s=19408" alt="cached" /></p>

<ul>
  <li>æ— ç¼“å­˜</li>
</ul>

<p><img src="https://user-gold-cdn.xitu.io/2018/4/8/162a560d30b47136?w=567&amp;h=284&amp;f=png&amp;s=13705" alt="noCache" /></p>

<ol>
  <li>æµè§ˆå™¨å‘èµ·è¯·æ±‚ï¼Œè¯·æ±‚å„ç±»é™æ€èµ„æº</li>
  <li>Service Worker æ‹¦æˆªæµè§ˆå™¨è¯·æ±‚ï¼Œå¹¶æŸ¥è¯¢å½“å‰ cache</li>
  <li>è‹¥å­˜åœ¨ cache åˆ™ç›´æ¥è¿”å›ï¼Œç»“æŸ</li>
  <li>è‹¥ä¸å­˜åœ¨ cacheï¼Œåˆ™é€šè¿‡ fetch æ–¹æ³•å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚ï¼Œå¹¶è¿”å›è¯·æ±‚ç»“æœç»™æµè§ˆå™¨</li>
</ol>

<pre><code class="language-JS">// sw.js
self.addEventListener('fetch', function (e) {
  // respondWith - é€šè¿‡å®ƒè®© Service Worker å‘æµè§ˆå™¨è¿”å›æ•°æ®
  e.respondWith(
  // å¦‚æœæœ‰ cache åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™é€šè¿‡ fetch è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚ç»“æœè¿”å›ç»™æµè§ˆå™¨
    caches.match(e.request).then(function (cache) {
      return cache || fetch(e.request);
    }).catch(function (err) {
      return fetch(e.request);
    })
  );
});
</code></pre>

<p>å½“æˆ‘ä»¬å°†èµ„æºç¼“å­˜åï¼Œé™¤éæ³¨é”€(unregister) sw.jsã€æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜ï¼Œå¦åˆ™æ–°çš„é™æ€èµ„æºå°†æ— æ³•ç¼“å­˜ã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ä¸ªç®€å•æ–¹æ³•å°±æ˜¯ä¿®æ”¹ <code class="highlighter-rouge">cacheName</code>ã€‚ç”±äºæµè§ˆå™¨åˆ¤æ–­ sw.js æ˜¯å¦æ›´æ–°æ˜¯é€šè¿‡å­—èŠ‚æ–¹å¼ï¼Œå› æ­¤ä¿®æ”¹ cacheName ä¼šé‡æ–°è§¦å‘ install å¹¶ç¼“å­˜èµ„æºã€‚æ­¤å¤–ï¼Œåœ¨ activate äº‹ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥ cacheName æ˜¯å¦å˜åŒ–ï¼Œå¦‚æœå˜åŒ–åˆ™è¡¨ç¤ºæœ‰äº†æ–°çš„ç¼“å­˜èµ„æºï¼ŒåŸæœ‰ç¼“å­˜éœ€è¦åˆ é™¤:</p>

<pre><code class="language-JS">// sw.js
// ç›‘å¬ activate äº‹ä»¶ï¼Œæ¿€æ´»åé€šè¿‡ cache çš„ key æ¥åˆ¤æ–­æ˜¯å¦æ›´æ–° cache ä¸­çš„é™æ€èµ„æº
self.addEventListener('activate', function (e) {
  var cachePromise = caches.keys().then(function (keys) {
    return Promise.all(keys.map(function (key) {
      if (key !== cacheName) {
        return caches.delete(key);
      }
    }));
  })
  e.waitUntil(cachePromise);
  return self.clients.claim();
});
</code></pre>

<p>å¦ä¸€æ–¹é¢ Web App ä¹Ÿä¼šæŠŠ XHR è¯·æ±‚çš„æ•°æ®ç¼“å­˜ä¸€ä»½ã€‚è€Œå†æ¬¡è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ä¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œç„¶åå‘æœåŠ¡ç«¯è¯·æ±‚æ•°æ®ï¼ŒæœåŠ¡ç«¯è¿”å›æ•°æ®åï¼ŒåŸºäºè¯¥æ•°æ®æ›¿æ¢å±•ç¤º:</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/4/8/162a560d35c15a67?w=567&amp;h=266&amp;f=png&amp;s=16946" alt="fetch" /></p>

<p>åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ”¹é€ ä¸‹ <code class="highlighter-rouge">fetch</code>:</p>

<pre><code class="language-JS">// sw.js
var apiCacheName = 'api-0-1-1';
self.addEventListener('fetch', function (e) {
  // éœ€è¦ç¼“å­˜çš„è¯·æ±‚
  var cacheRequestUrls = [
    '/book?'
  ];

  // åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦éœ€è¦ç¼“å­˜
  var needCache = cacheRequestUrls.some(function (url) {
    return e.request.url.indexOf(url) &gt; -1;
  });

  /**** è¿™é‡Œæ˜¯å¯¹ XHR æ•°æ®ç¼“å­˜çš„ç›¸å…³æ“ä½œ ****/
  if (needCache) {
      // éœ€è¦ç¼“å­˜
    // ä½¿ç”¨ fetch è¯·æ±‚æ•°æ®ï¼Œå¹¶å°†è¯·æ±‚ç»“æœ clone ä¸€ä»½ç¼“å­˜åˆ° cache
    // æ­¤éƒ¨åˆ†ç¼“å­˜ååœ¨ browser ä¸­ä½¿ç”¨å…¨å±€å˜é‡ caches è·å–
    caches.open(apiCacheName).then(function (cache) {
      return fetch(e.request).then(function (response) {
        // clone æ–¹æ³•æ‹·è´ä¸€ä»½å“åº”æ•°æ®ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¯¹å“åº”ç¼“å­˜è¿›è¡Œå„ç±»æ“ä½œè€Œä¸ç”¨æ‹…å¿ƒåŸå“åº”ä¿¡æ¯è¢«ä¿®æ”¹äº†
        cache.put(e.request.url, response.clone());
        return response;
      });
    });
  }
  /* ******************************* */

  else {
    // é api è¯·æ±‚ï¼Œç›´æ¥æŸ¥è¯¢ cache
    e.respondWith(
      caches.match(e.request).then(function (cache) {
        return cache || fetch(e.request);
      }).catch(function (err) {
        return fetch(e.request);
      })
    );
  }
});
</code></pre>

<p>SW é…ç½®å¥½åï¼Œæœ€ååªå‰©ä¸‹å¦‚ä½•åœ¨ XHR è¯·æ±‚æ—¶æœ‰ç­–ç•¥çš„ä½¿ç”¨ç¼“å­˜äº†ï¼Œè¿™ä¸€éƒ¨åˆ†çš„æ”¹é€ å…¨éƒ¨é›†ä¸­äº <code class="highlighter-rouge">index.js</code>:</p>

<pre><code class="language-JS">function getApiDataFromCache(url) {
  // ä»ç„¶å¯ä»¥é€šè¿‡ caches æ¥è®¿é—®ç¼“å­˜ã€‚ä¸ºäº†ä¿è¯æ¸è¿›å¯ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè¿›è¡Œåˆ¤æ–­ 'caches' in window
  if ('caches' in window) {
    return caches.match(url).then(function (cache) {
      // åˆ¤æ–­æ˜¯å¦å‘½ä¸­ç¼“å­˜
      if (!cache) return;

      return cache.json();
    });
  }

  return Promise.resolve();
}
</code></pre>

<p>è¿™æ ·å¤„ç†ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ„Ÿå—åˆ°ä¸¤ä¸ªæ¯”è¾ƒå¤§çš„æå‡:</p>

<ul>
  <li>ç¦»çº¿å¯ç”¨ - å¦‚æœæˆ‘ä»¬ä¹‹å‰è®¿é—®è¿‡æŸäº› URLï¼Œé‚£ä¹ˆå³ä½¿åœ¨ç¦»çº¿çš„æƒ…å†µä¸‹ï¼Œä¾ç„¶å¯ä»¥æ­£å¸¸è®¿é—®</li>
  <li>ä¼˜åŒ–ä½“éªŒ - æé«˜è®¿é—®é€Ÿåº¦ã€‚è¯»å–æœ¬åœ° cache è€—æ—¶ç›¸æ¯”äºç½‘ç»œè¯·æ±‚è¾ƒä½ï¼Œåœ¨å¼±ç½‘æƒ…å†µä¸‹æ›´æ˜æ˜¾</li>
</ul>

<h3 id="workbox">Workbox</h3>

<p><a href="https://developers.google.com/web/tools/workbox/modules/workbox-sw"><strong>Workbox</strong></a> å¯ä»¥ç†è§£ä¸º Google å®˜æ–¹ PWA æ¡†æ¶ï¼Œå®ƒè§£å†³çš„å°±æ˜¯ç”¨åº•å±‚ API å†™ PWA å¤ªè¿‡å¤æ‚çš„é—®é¢˜ã€‚è¿™é‡Œè¯´çš„åº•å±‚ APIï¼ŒæŒ‡çš„å°±æ˜¯å»ç›‘å¬ SW çš„ <code class="highlighter-rouge">installã€activeã€fetch</code> äº‹ä»¶åšç›¸åº”é€»è¾‘å¤„ç†ç­‰:</p>

<pre><code class="language-JS">// é¦–å…ˆå¼•å…¥ workbox æ¡†æ¶
importScripts('https://storage.googleapis.com/workbox-cdn/releases/4.1.1/workbox-sw.js');
workbox.precaching([
 // æ³¨å†ŒæˆåŠŸåè¦ç«‹å³ç¼“å­˜çš„èµ„æºåˆ—è¡¨
])

// æ¥ä¸‹æ¥å®šä¹‰ html çš„ç¼“å­˜ç­–ç•¥
workbox.routing.registerRoute(
 new RegExp('.*\.(?:js|css)'),
 workbox.strategies.cacheFirst()
);
</code></pre>

<p>å¯¹åº”çš„å‡ ç§ç­–ç•¥å¦‚ä¸‹:</p>

<ul>
  <li><strong>Stale-While-Revalidate</strong></li>
</ul>

<p>The stale-while-revalidate pattern allows you to respond the request as quickly as possible with a cached response if available, falling back to the network request if itâ€™s not cached. The network request is then used to update the cache.</p>

<pre><code class="language-JS">workbox.routing.registerRoute(
  new RegExp('https://your\.cdn\.com/'),
  workbox.strategies.staleWhileRevalidate()
);
</code></pre>

<p><img src="https://developers.google.com/web/tools/workbox/images/modules/workbox-strategies/stale-while-revalidate.png" alt="Stale-While-Revalidate" /></p>

<ul>
  <li><strong>Cache First</strong> (Cache Falling Back to Network)</li>
</ul>

<p>If there is a Response in the cache, the Request will be fulfilled using the cached response, the network will not be used at all. If there isnâ€™t a cached response, the Request will be fulfilled by a a network request and the response will be cached so that the next request is served directly from the cache.</p>

<pre><code class="language-JS">workbox.routing.registerRoute(
  new RegExp('https://your\.img\.cdn\.com/'),
  workbox.strategies.cacheFirst({
    cacheName: 'example:img'
  })
);
</code></pre>

<p><img src="https://developers.google.com/web/tools/workbox/images/modules/workbox-strategies/cache-first.png" alt="Cache First" /></p>

<ul>
  <li><strong>Network First</strong> (Network Falling Back to Cache)</li>
</ul>

<p>For requests that are updating frequently, the network first strategy is the ideal solution. By default it will try and fetch the latest request from the network. If the request is successful, itâ€™ll put the response in the cache. If the network fails to return a response, the caches response will be used.</p>

<pre><code class="language-JS">workbox.routing.registerRoute(
  new RegExp('/social-timeline/'),
  new workbox.strategies.NetworkFirst()
);
</code></pre>

<p><img src="https://developers.google.com/web/tools/workbox/images/modules/workbox-strategies/network-first.png" alt="Network First" /></p>

<ul>
  <li><strong>Network Only</strong></li>
</ul>

<pre><code class="language-JS">workbox.routing.registerRoute(
  new RegExp('/admin/'),
  new workbox.strategies.NetworkOnly()
);
</code></pre>

<p><img src="https://developers.google.com/web/tools/workbox/images/modules/workbox-strategies/network-only.png" alt="Network Only" /></p>

<ul>
  <li><strong>Cache Only</strong></li>
</ul>

<pre><code class="language-JS">workbox.routing.registerRoute(
  new RegExp('/app/v2/'),
  new workbox.strategies.CacheOnly()
);
</code></pre>

<p><img src="https://developers.google.com/web/tools/workbox/images/modules/workbox-strategies/cache-only.png" alt="Cach Only" /></p>

<h2 id="web-push-æ¶ˆæ¯æ¨é€">Web Push æ¶ˆæ¯æ¨é€</h2>

<p>ä¸‹å›¾æ¥è‡ª <a href="https://tools.ietf.org/html/draft-ietf-webpush-protocol-12">Web Push åè®®è‰æ¡ˆ</a>ï¼Œæ˜¯ Web Push çš„æ•´ä¸ªæµç¨‹ï¼Œè¯¥æ—¶åºå›¾è¡¨æ˜äº† Web Push çš„å„ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†ä¸º<strong>è®¢é˜…(subscribe)</strong>ä¸<strong>æ¨é€(push)</strong>ä¸¤éƒ¨åˆ†æ¥çœ‹:</p>

<pre><code class="language-TEXT">    +-------+           +--------------+       +-------------+
    |  UA   |           | Push Service |       | Application |
    +-------+           +--------------+       |   Server    |
        |                      |               +-------------+
        |      Subscribe       |                      |
        |---------------------&gt;|                      |
        |       Monitor        |                      |
        |&lt;====================&gt;|                      |
        |                      |                      |
        |          Distribute Push Resource           |
        |--------------------------------------------&gt;|
        |                      |                      |
        :                      :                      :
        |                      |     Push Message     |
        |    Push Message      |&lt;---------------------|
        |&lt;---------------------|                      |
        |                      |                      |
</code></pre>

<p>é¦–å…ˆæ˜¯è®¢é˜…:</p>

<ul>
  <li><strong>Ask Permission</strong> - è¿™ä¸€æ­¥ä¸å†ä¸Šå›¾çš„æµç¨‹ä¸­ï¼Œè¿™å…¶å®æ˜¯æµè§ˆå™¨ä¸­çš„ç­–ç•¥ã€‚æµè§ˆå™¨ä¼šè¯¢é—®ç”¨æˆ·æ˜¯å¦å…è®¸é€šçŸ¥ï¼Œåªæœ‰åœ¨ç”¨æˆ·å…è®¸åï¼Œæ‰èƒ½è¿›è¡Œåé¢çš„æ“ä½œ</li>
  <li><strong>Subscribe</strong> - æµè§ˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰éœ€è¦å‘ Push Service å‘èµ·è®¢é˜…ï¼ˆsubscribeï¼‰ï¼Œè®¢é˜…åä¼šå¾—åˆ°ä¸€ä¸ª <strong>PushSubscription</strong> å¯¹è±¡</li>
  <li><strong>Monitor</strong> - è®¢é˜…æ“ä½œä¼šå’Œ Push Service è¿›è¡Œé€šä¿¡ï¼Œç”Ÿæˆç›¸åº”çš„è®¢é˜…ä¿¡æ¯ï¼ŒPush Service ä¼šç»´æŠ¤ç›¸åº”ä¿¡æ¯ï¼Œå¹¶åŸºäºæ­¤ä¿æŒä¸å®¢æˆ·ç«¯çš„è”ç³»</li>
  <li><strong>Distribute Push Resource</strong> - æµè§ˆå™¨è®¢é˜…å®Œæˆåï¼Œä¼šè·å–è®¢é˜…çš„ç›¸å…³ä¿¡æ¯ï¼ˆå­˜åœ¨äº PushSubscription å¯¹è±¡ä¸­ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™äº›ä¿¡æ¯å‘é€åˆ°è‡ªå·±çš„æœåŠ¡ç«¯ï¼Œåœ¨æœåŠ¡ç«¯è¿›è¡Œä¿å­˜</li>
</ul>

<p>ç„¶åæ˜¯æ¨é€:</p>

<ul>
  <li><strong>Push Message é˜¶æ®µä¸€</strong> - æˆ‘ä»¬çš„æœåŠ¡ç«¯éœ€è¦æ¨é€æ¶ˆæ¯æ—¶ï¼Œä¸ç›´æ¥å’Œå®¢æˆ·ç«¯äº¤äº’ï¼Œè€Œæ˜¯é€šè¿‡ Web Push åè®®ï¼Œå°†ç›¸å…³ä¿¡æ¯é€šçŸ¥ Push Serviceï¼›</li>
  <li><strong>Push Message é˜¶æ®µäºŒ</strong> - Push Service æ”¶åˆ°æ¶ˆæ¯ï¼Œé€šè¿‡æ ¡éªŒåï¼ŒåŸºäºå…¶ç»´æŠ¤çš„å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œå°†æ¶ˆæ¯æ¨é€ç»™è®¢é˜…äº†çš„å®¢æˆ·ç«¯ã€‚æœ€åï¼Œå®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯ï¼Œå®Œæˆæ•´ä¸ªæ¨é€è¿‡ç¨‹</li>
</ul>

<blockquote>
  <p><strong>Push Service</strong> å¯ä»¥æ¥æ”¶ç½‘ç»œè¯·æ±‚ï¼Œæ ¡éªŒè¯¥è¯·æ±‚å¹¶å°†å…¶æ¨é€ç»™åˆé€‚çš„æµè§ˆå™¨å®¢æˆ·ç«¯ã€‚Push Service è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„åŠŸèƒ½ï¼šå½“ç”¨æˆ·ç¦»çº¿æ—¶ï¼Œå¯ä»¥å¸®æˆ‘ä»¬ä¿å­˜æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç›´åˆ°ç”¨æˆ·è”ç½‘åå†å‘é€ç»™ä»–ä»¬ã€‚ä¸åŒçš„æµè§ˆå™¨å‚å•†å®ç°äº†ä¸åŒçš„ Push Serviceï¼Œä½†éƒ½éµå¾ª <strong>Web Push Protocol</strong>ã€‚</p>
</blockquote>

<h3 id="è®¢é˜…-subscribe">è®¢é˜… subscribe</h3>

<p>ä¸Šé¢å¯ä»¥çœ‹åˆ°æ•´ä¸ªå¤§æ¦‚æµç¨‹ï¼Œé‚£ä¹ˆæ€ä¹ˆå…·ä½“å»å®æ–½å‘¢ï¼Œé¦–å…ˆè¦åœ¨å®¢æˆ·ç«¯ç”Ÿæˆ subscription ä¿¡æ¯ï¼Œå³éœ€è¦ä½¿ç”¨ <strong>PushManager</strong> çš„ <strong>subscribe</strong> æ–¹æ³•æ¥åœ¨æµè§ˆå™¨ä¸­è¿›è¡Œè®¢é˜…:</p>

<pre><code class="language-JS">// index.js
function registerServiceWorker(file) {
  return navigator.serviceWorker.register(file);
}

// å‘ SW å‘èµ·è®¢é˜…
function subscribeUserToPush(registration, publicKey) {
  var subscribeOptions = {
    userVisibleOnly: true, // è¡¨æ˜è¯¥æ¨é€æ˜¯å¦éœ€è¦æ˜¾æ€§åœ°å±•ç¤ºç»™ç”¨æˆ·ï¼Œå³æ¨é€æ—¶æ˜¯å¦ä¼šæœ‰æ¶ˆæ¯æé†’
    applicationServerKey: window.urlBase64ToUint8Array(publicKey) // ä¸€ä¸ªå®¢æˆ·ç«¯çš„å…¬é’¥ï¼ŒVAPID å®šä¹‰äº†å…¶è§„èŒƒ
  };
  // å½“æˆ‘ä»¬æ³¨å†Œå®Œ Service Worker åä¼šå¾—åˆ°ä¸€ä¸ª Registration å¯¹è±¡
  return registration.pushManager.subscribe(subscribeOptions).then(function (pushSubscription) {
    console.log('Received PushSubscription: ', JSON.stringify(pushSubscription));
    return pushSubscription;
  });
}

if ('serviceWorker' in navigator &amp;&amp; 'PushManager' in window) {
  var publicKey = 'BOEQSjdhorIf8M0XFNlwohK3sTzO9iJwvbYU-fuXRF0tvRpPPMGO6d_gJC_pUQwBT7wD8rKutpNTFHOHN3VqJ0A';
  // æ³¨å†Œservice worker
  registerServiceWorker('./sw.js').then(function (registration) {
    console.log('Service Worker æ³¨å†ŒæˆåŠŸ');
    // å¼€å¯è¯¥å®¢æˆ·ç«¯çš„æ¶ˆæ¯æ¨é€è®¢é˜…åŠŸèƒ½
    return subscribeUserToPush(registration, publicKey);
  }).then(function (subscription) {
    var body = {subscription: subscription};
    // ä¸ºäº†æ–¹ä¾¿ä¹‹åçš„æ¨é€ï¼Œä¸ºæ¯ä¸ªå®¢æˆ·ç«¯ç®€å•ç”Ÿæˆä¸€ä¸ªæ ‡è¯†
    body.uniqueid = new Date().getTime();
    console.log('uniqueid', body.uniqueid);
    // å°†ç”Ÿæˆçš„å®¢æˆ·ç«¯è®¢é˜…ä¿¡æ¯å­˜å‚¨åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Š
    return sendSubscriptionToServer(JSON.stringify(body));
  }).then(function (res) {
    console.log(res);
  }).catch(function (err) {
    console.log(err);
  });
}
</code></pre>

<p>ä¸€ä¸ª PushSubscription å¯èƒ½åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼Œå…¶ä¸­çš„ <code class="highlighter-rouge">endpoint</code>ï¼ŒPush Service ä¼šä¸ºæ¯ä¸ªå®¢æˆ·ç«¯éšæœºç”Ÿæˆä¸€ä¸ªä¸åŒçš„å€¼:</p>

<pre><code class="language-JSON">{
  "endpoint":"https://fcm.googleapis.com/fcm/send/dFBJcJfA0ZQ:APA91bGP1bm8aLVRVEei1IxdhqLFZXPV28z1pQK6t-5nsCEpc7_JRsr3wQYAAE-d6hPbgo0qch5aLMc2sDbZBreFmkA6thkz28c3ajfXoiU4zf5ANJWM8QLZjmWJ4MF_WbbtlaP7o21u",
  "expirationTime":null,
  "keys":{
      "p256dh":"BGTNJ4e5-xxxPDbVpFdvM9KYHFiMTTEwCKXFbO1TOCuV7E",
      "auth":"WBS6llMxxxDmRhiqQ"
  }
}
</code></pre>

<blockquote>
  <p>applicationServerKey çš„ç”Ÿæˆè§„åˆ™æ˜¯å°† base64 çš„å…¬é’¥å­—ç¬¦ä¸²è½¬ä¸º Unit8Arrayï¼Œå¯ä»¥<a href="https://github.com/web-push-libs/web-push#using-vapid-key-for-applicationserverkey">å‚è€ƒè¿™é‡Œ</a> ğŸ‘ˆ</p>
</blockquote>

<h3 id="distribute-push-resource">Distribute Push Resource</h3>

<p>æ¥ä¸‹æ¥éœ€è¦æœåŠ¡ç«¯å­˜å‚¨å®¢æˆ·ç«¯ subscription ä¿¡æ¯ï¼Œä¸ºäº†å­˜å‚¨æµè§ˆå™¨ post æ¥çš„è®¢é˜…ä¿¡æ¯ï¼ŒæœåŠ¡ç«¯éœ€è¦å¢åŠ ä¸€ä¸ªæ¥å£ <code class="highlighter-rouge">/subscription</code>ï¼ŒåŒæ—¶æ·»åŠ ä¸­é—´ä»¶ <code class="highlighter-rouge">koa-body</code> ç”¨äºå¤„ç† body:</p>

<pre><code class="language-JS">// index.js
function sendSubscriptionToServer(body, url) {
  url = url || '/subscription';
  return new Promise(function (resolve, reject) {
    var xhr = new XMLHttpRequest();
    ...
    xhr.open('POST', url, true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.send(body);
  });
}
</code></pre>

<pre><code class="language-JS">// app.js
const koaBody = require('koa-body');
const util = require('./util');
/**
 * æäº¤ subscription ä¿¡æ¯ï¼Œå¹¶ä¿å­˜
 * è¿™é‡Œä½¿ç”¨äº† nedb æ¥è¿›è¡Œç®€å•çš„å­˜å‚¨ã€‚nedb ä¸éœ€è¦éƒ¨ç½²å®‰è£…ï¼Œå¯ä»¥å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä¹Ÿå¯ä»¥æŒä¹…åŒ–ï¼Œnedb çš„ api å’Œ mongodb ä¹Ÿæ¯”è¾ƒç±»ä¼¼
 */
router.post('/subscription', koaBody(), async ctx =&gt; {
  let body = ctx.request.body;
  await util.saveRecord(body);
  ctx.response.body = {
    status: 0
  };
});
</code></pre>

<pre><code class="language-JS">// utils.js
const Datastore = require('nedb');
const db = new Datastore();
module.exports.saveRecord = function (obj) {
  return new Promise((r, j) =&gt; {
    db.findOne(obj, (err, res) =&gt; {
      if (err) {
        j(err);
        return;
      }
      if (res) {
        console.log('å·²å­˜åœ¨');
        r(obj);
        return;
      }
      db.insert(obj, (err, item) =&gt; {
        if (err) {
          j(err);
          return;
        }
        console.log('å­˜å‚¨å®Œæ¯•');
        r(obj);
      });
    });
  });
};
</code></pre>

<h3 id="push-message">Push Message</h3>

<p>æ¥ä¸‹æ¥ä½¿ç”¨ subscription ä¿¡æ¯æ¨é€ä¿¡æ¯ï¼Œä»¥ä¸‹æ¨¡æ‹Ÿäº†ä¸€ä¸ªæ¥å£æ¥æ¨é€:</p>

<pre><code class="language-JS">// app.js
const webpush = require('web-push');
/**
 * æ¶ˆæ¯æ¨é€ APIï¼Œå¯ä»¥åœ¨ç®¡ç†åå°è¿›è¡Œè°ƒç”¨
 * æœ¬ä¾‹å­ä¸­ï¼Œå¯ä»¥ç›´æ¥ post ä¸€ä¸ªè¯·æ±‚æ¥æŸ¥çœ‹æ•ˆæœ
 */
router.post('/push', koaBody(), async ctx =&gt; {
  let { uniqueid, payload } = ctx.request.body;
  // æˆ‘ä»¬å¯ä»¥é€šè¿‡ uniqueid æ¥æŸ¥è¯¢æŸæ¡è®¢é˜…ä¿¡æ¯æˆ–è€…å…¨éƒ¨ä¿¡æ¯
  let list = uniqueid ? await util.find({uniqueid}) : await util.findAll();
  let status = list.length &gt; 0 ? 0 : -1;

  for (let i = 0; i &lt; list.length; i++) {
    let subscription = list[i].subscription;
    // é€šè¿‡å°è£…çš„ pushMessage æ–¹æ³•å‘ Push Service å‘é€è¯·æ±‚
    pushMessage(subscription, JSON.stringify(payload));
  }

  ctx.response.body = {
    status
  };
});

// å‘ Push Service æ¨é€ä¿¡æ¯
function pushMessage(subscription, data = {}) {
  // webpush.sendNotification æ–¹æ³•ä¸ºæˆ‘ä»¬å°è£…äº†è¯·æ±‚çš„å¤„ç†ç»†èŠ‚
  webpush.sendNotification(subscription, data, options).then(data =&gt; {
    console.log('push service çš„ç›¸åº”æ•°æ®:', JSON.stringify(data));
    return;
  }).catch(err =&gt; {
    // åˆ¤æ–­çŠ¶æ€ç ï¼Œ440 å’Œ 410 è¡¨ç¤ºå¤±æ•ˆ
    if (err.statusCode === 410 || err.statusCode === 404) {
      return util.remove(subscription);
    }
    else {
      console.log(subscription);
      console.log(err);
    }
  })
}
</code></pre>

<blockquote>
  <p>Web Push åè®®çš„è¯·æ±‚å°è£…ã€åŠ å¯†å¤„ç†ç›¸å…³æ“ä½œéå¸¸ç¹çã€‚å› æ­¤ï¼ŒWeb Push ä¸ºå„ç§è¯­è¨€çš„å¼€å‘è€…æä¾›äº†ä¸€ç³»åˆ—å¯¹åº”çš„åº“ï¼š<a href="https://github.com/web-push-libs/web-push#using-vapid-key-for-applicationserverkey">Web Push Libaray</a> ğŸ‘ˆ</p>
</blockquote>

<p>é€šè¿‡ web-push æˆ‘ä»¬å¯ä»¥ç”Ÿæˆä¸€å¯¹å…¬é’¥å’Œç§é’¥:</p>

<pre><code class="language-SHELL"># å®‰è£…
npm install web-push --save

# ç”Ÿæˆ vapid keys
web-push generate-vapid-keys

================
Public key:
BOEQSjdhorIf8M0XFNlwohK3sTzO9iJwvbYU-fuXRF0tvRpPPMGO6d_gJC_pUQwBT7wD8rKutpNTFHOHN3VqJ0A
Private key:
TVe_nJlciDOn130gFyFYP8UiGxxWd3QdH6C5axXpSgM
</code></pre>

<p>ç„¶åè®¾ç½® vapid keyï¼Œè®¾ç½®å®Œæˆåå³å¯ä½¿ç”¨ <code class="highlighter-rouge">webpush.sendNotification()</code> æ–¹æ³•å‘ Push Service å‘èµ·è¯·æ±‚:</p>

<pre><code class="language-JS">// app.js
const webpush = require('web-push');
/**
 * VAPID å€¼
 */
const vapidKeys = {
  publicKey: 'BOEQSjdhorIf8M0XFNlwohK3sTzO9iJwvbYU-fuXRF0tvRpPPMGO6d_gJC_pUQwBT7wD8rKutpNTFHOHN3VqJ0A',
  privateKey: 'TVe_nJlciDOn130gFyFYP8UiGxxWd3QdH6C5axXpSgM'
};

// è®¾ç½® web-push çš„ VAPID å€¼
webpush.setVapidDetails(
  'mailto:smd.tate@gmail.com',
  vapidKeys.publicKey,
  vapidKeys.privateKey
);
</code></pre>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å·²ç»æŠŠæ¶ˆæ¯å‘é€è‡³ Push Service äº†ï¼Œè€Œ Push Service ä¼šå°†æˆ‘ä»¬çš„æ¶ˆæ¯æ¨é€è‡³æµè§ˆå™¨ã€‚è¦æƒ³åœ¨æµè§ˆå™¨ä¸­è·å–æ¨é€ä¿¡æ¯ï¼Œåªéœ€åœ¨ Service Worker ä¸­ç›‘å¬ push çš„äº‹ä»¶å³å¯:</p>

<pre><code class="language-JS">// sw.js
self.addEventListener('push', function (e) {
  var data = e.data;
  if (e.data) {
    data = data.json();
    console.log('pushçš„æ•°æ®ä¸ºï¼š', data);
    self.registration.showNotification(data.text);
  }
  else {
    console.log('pushæ²¡æœ‰ä»»ä½•æ•°æ®');
  }
});
</code></pre>

<p><img src="https://user-gold-cdn.xitu.io/2018/4/13/162bc954b09d78cf?w=1277&amp;h=774&amp;f=gif&amp;s=2877596" alt="web-push" /></p>

<p>æˆ‘ä»¬è¿˜å¯ä»¥åœ¨æ§åˆ¶å°å¯¹ SW è¿›è¡Œè°ƒè¯•ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ° cache ä¸­æ‰€å­˜å‚¨çš„ä¸€äº›è„šæœ¬å’Œè¯·æ±‚ä¿¡æ¯:</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/4/29/16310a142d0c794d?w=1197&amp;h=503&amp;f=png&amp;s=116464" alt="console" /></p>

<h2 id="notification-æé†’">Notification æé†’</h2>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/1/1631a562ba773ddd?w=1275&amp;h=762&amp;f=gif&amp;s=384884" alt="Notification" /></p>

<p>å³ä½¿å½“ä½ åˆ‡æ¢åˆ°å…¶ä»–é¡µç­¾ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æé†’äº¤äº’æ¥å¿«é€Ÿè®©ç”¨æˆ·å›åˆ°ä½ çš„ç½‘ç«™ï¼Œç”šè‡³å½“ç”¨æˆ·ç¦»å¼€å½“å‰ç½‘ç«™ï¼Œä»ç„¶å¯ä»¥æ”¶åˆ°ç³»ç»Ÿçš„æé†’æ¶ˆæ¯ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æ¶ˆæ¯æé†’å¿«é€Ÿæ‰“å¼€ä½ çš„ç½‘ç«™:</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/1/1631b52052cccb59?w=1270&amp;h=676&amp;f=gif&amp;s=2317289" alt="Notification-back" /></p>

<h3 id="requestpermission-è·å–æˆæƒ">requestPermission è·å–æˆæƒ</h3>

<p>è¦å®Œæˆæé†’ï¼Œé¦–å…ˆè°ƒç”¨ <strong>Notification</strong> å¯¹è±¡ä¸Šçš„é™æ€æ–¹æ³• <code class="highlighter-rouge">Notification.requestPermission()</code> æ¥è·å–æˆæƒ:</p>

<pre><code class="language-JS">// index.js
function askPermission() {
  return new Promise(function (resolve, reject) {
    var permissionResult = Notification.requestPermission(function (result) {
      resolve(result);
    });

    if (permissionResult) {
      permissionResult.then(resolve, reject);
    }
  }).then(function (permissionResult) {
    /*
    * permissionResult å¯èƒ½å€¼æœ‰ä»¥ä¸‹å‡ ä¸ª
    * deniedï¼šç”¨æˆ·æ‹’ç»äº†é€šçŸ¥çš„æ˜¾ç¤º
    * grantedï¼šç”¨æˆ·å…è®¸äº†é€šçŸ¥çš„æ˜¾ç¤º
    * defaultï¼šå› ä¸ºä¸çŸ¥é“ç”¨æˆ·çš„é€‰æ‹©ï¼Œæ‰€ä»¥æµè§ˆå™¨çš„è¡Œä¸ºä¸ denied æ—¶ç›¸åŒ
    */
    if (permissionResult !== 'granted') {
      throw new Error('We weren\'t granted permission.');
    }
  });
}


registerServiceWorker('./sw.js').then(function (registration) {
  return Promise.all([
    registration,
    askPermission()
  ])
 })
</code></pre>

<h3 id="shownotification-æé†’å†…å®¹">showNotification æé†’å†…å®¹</h3>

<p>è·å–ç”¨æˆ·æˆæƒåï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code class="highlighter-rouge">registration.showNotification()</code> æ–¹æ³•è¿›è¡Œæ¶ˆæ¯æé†’äº†:</p>

<pre><code class="language-JS">// index.js
registerServiceWorker('./sw.js').then(function (registration) {
  return Promise.all([
    registration,
    askPermission()
  ])
}).then(function (result) {
  var registration = result[0];
  /* ===== æ·»åŠ æé†’åŠŸèƒ½ ====== */
  document.querySelector('#js-notification-btn').addEventListener('click', function () {
    var title = 'PWAå³å­¦å³ç”¨'; // æ ‡é¢˜
    var options = {
      body: 'é‚€è¯·ä½ ä¸€èµ·å­¦ä¹ ',
      icon: '/img/icons/book-128.png',
      actions: [{
        action: 'show-book',
        title: 'å»çœ‹çœ‹'
      }, {
        action: 'contact-me',
        title: 'è”ç³»æˆ‘'
      }],
      tag: 'pwa-starter',
      renotify: true
    };
    registration.showNotification(title, options);
  });
  /* ======================= */
})
</code></pre>

<p>options æ”¯æŒä»¥ä¸‹å­—æ®µ:</p>

<ul>
  <li>body - æé†’çš„å†…å®¹</li>
  <li>icon - æé†’çš„å›¾æ ‡</li>
  <li>actions - æé†’å¯ä»¥åŒ…å«ä¸€äº›è‡ªå®šä¹‰æ“ä½œ</li>
  <li>tag - ç›¸å½“äºæ˜¯ IDï¼Œé€šè¿‡è¯¥ ID æ ‡è¯†å¯ä»¥æ“ä½œç‰¹å®šçš„ notification</li>
  <li>renotify - æ˜¯å¦å…è®¸é‡å¤æé†’ï¼Œé»˜è®¤ä¸º falseã€‚å½“ä¸å…è®¸é‡å¤æé†’æ—¶ï¼ŒåŒä¸€ä¸ª tag çš„ notification åªä¼šæ˜¾ç¤ºä¸€æ¬¡</li>
</ul>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/1/1631a6c6007ffec9?w=800&amp;h=300&amp;f=jpeg&amp;s=114296" alt="options" /></p>

<h3 id="notificationclick-äº‹ä»¶ç›‘å¬">notificationclick äº‹ä»¶ç›‘å¬</h3>

<p>ä¸ºäº†èƒ½å¤Ÿå“åº”ç”¨æˆ·å¯¹äºæé†’æ¡†çš„ç‚¹å‡»äº‹ä»¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Service Worker ä¸­ç›‘å¬ <strong>notificationclick</strong> äº‹ä»¶ã€‚åœ¨è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥è·å–ç‚¹å‡»çš„ç›¸å…³ä¿¡æ¯:</p>

<pre><code class="language-JS">// sw.js
self.addEventListener('notificationclick', function (e) {
  var action = e.action;
  console.log(`action tag: ${e.notification.tag}`, `action: ${action}`);

  switch (action) {
    case 'show-book':
      console.log('show-book');
      break;
    case 'contact-me':
      console.log('contact-me');
      break;
    default:
      console.log(`æœªå¤„ç†çš„action: ${e.action}`);
      action = 'default';
      break;
  }
  e.notification.close();
});
</code></pre>

<p>å¦‚æœéœ€è¦ Service Worker ä¸ client é€šä¿¡ï¼Œåˆ™è¿˜éœ€è¦ä¿®æ”¹ä»¥ä¸‹ä¸¤ä¸ªéƒ¨åˆ†:</p>

<pre><code class="language-JS">// sw.js
// åœ¨ Service Worker ä¸­ä½¿ç”¨ Worker çš„ postMessage() æ–¹æ³•æ¥é€šçŸ¥ client
self.addEventListener('notificationclick', function (e) {
  ...
 e.waitUntil(
    // è·å–æ‰€æœ‰clients
    self.clients.matchAll().then(function (clients) {
      if (!clients || clients.length === 0) {
        // å½“ä¸å­˜åœ¨ client æ—¶(æ¯”å¦‚ç½‘é¡µå·²ç»å…³é—­)ï¼Œæ‰“å¼€è¯¥ç½‘ç«™
        self.clients.openWindow &amp;&amp; self.clients.openWindow('http://127.0.0.1:8085');
        return;
      }
      // åˆ‡æ¢åˆ°è¯¥ç«™ç‚¹çš„ tab
      clients[0].focus &amp;&amp; clients[0].focus();
      clients.forEach(function (client) {
        // ä½¿ç”¨postMessageè¿›è¡Œé€šä¿¡
        client.postMessage(action);
      });
    })
  );
});
</code></pre>

<pre><code class="language-JS">// index.js
// åœ¨ client ä¸­ç›‘å¬ message äº‹ä»¶ï¼Œåˆ¤æ–­ dataï¼Œè¿›è¡Œä¸åŒçš„æ“ä½œ
navigator.serviceWorker.addEventListener('message', function (e) {
  var action = e.data;
  console.log(`receive post-message from sw, action is '${e.data}'`);
  switch (action) {
    case 'show-book':
      location.href = 'https://book.douban.com/subject/20515024/';
      break;
    case 'contact-me':
      location.href = 'mailto:someone@sample.com';
      break;
    default:
      document.querySelector('.panel').classList.add('show');
      break;
  }
});
</code></pre>

<p>å¦å¤–ï¼ŒWeb Push å’Œ Notification ä¹Ÿå¯ä»¥ç»„åˆä½¿ç”¨:</p>

<pre><code class="language-JS">// sw.js
// è¿™æ ·ï¼Œå³ä½¿æ˜¯åœ¨ç”¨æˆ·å…³é—­è¯¥ Web App æ—¶ï¼Œä¾ç„¶å¯ä»¥æ”¶åˆ°æé†’ï¼Œç±»ä¼¼äº Native ä¸­çš„æ¶ˆæ¯æ¨é€ä¸æé†’
self.addEventListener('push', function (e) {
  var data = e.data;
  if (e.data) {
    data = data.json();
    console.log('pushçš„æ•°æ®ä¸ºï¼š', data);
    var title = 'PWAå³å­¦å³ç”¨';
    var options = {
      body: data,
      icon: '/img/icons/book-128.png',
      image: '/img/icons/book-521.png',
      actions: [{
        action: 'show-book',
        title: 'å»çœ‹çœ‹'
      }, {
        action: 'contact-me',
        title: 'è”ç³»æˆ‘'
      }],
      tag: 'pwa-starter',
      renotify: true
    };
    self.registration.showNotification(title, options);
  }
  else {
    console.log('push æ²¡æœ‰ä»»ä½•æ•°æ®');
  }
});
</code></pre>

<h2 id="background-sync-åå°åŒæ­¥">Background Sync åå°åŒæ­¥</h2>

<p>åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°ä¸¤ä¸ªå¸¸è§çš„é—®é¢˜:</p>

<ul>
  <li>æ™®é€šçš„é¡µé¢å‘èµ·çš„è¯·æ±‚ä¼šéšç€æµè§ˆå™¨è¿›ç¨‹çš„ç»“æŸæˆ–è€… Tab é¡µé¢çš„å…³é—­è€Œç»ˆæ­¢</li>
  <li>æ— ç½‘ç¯å¢ƒä¸‹ï¼Œæ²¡æœ‰ä¸€ç§æœºåˆ¶èƒ½â€œç»´æŒâ€ä½è¯¥è¯·æ±‚ï¼Œä»¥å¾…æœ‰ç½‘æƒ…å†µä¸‹å†è¿›è¡Œè¯·æ±‚</li>
</ul>

<p>è€Œ <strong>Background Sync</strong> åå°åŒæ­¥åŠŸèƒ½å¯ä»¥æœ‰æ•ˆè§£å†³æ­¤é—®é¢˜ï¼Œå…¶å·¥ä½œåŸç†å¤§è‡´å¦‚ä¸‹:</p>

<ol>
  <li>åœ¨ Service Worker ä¸­ç›‘å¬ sync äº‹ä»¶</li>
  <li>åœ¨æµè§ˆå™¨ä¸­å‘èµ·åå°åŒæ­¥ syncï¼ˆå›¾ä¸­ç¬¬ä¸€æ­¥ï¼‰</li>
  <li>ä¼šè§¦å‘ Service Worker çš„ sync äº‹ä»¶ï¼Œåœ¨è¯¥ç›‘å¬çš„å›è°ƒä¸­è¿›è¡Œæ“ä½œï¼Œä¾‹å¦‚å‘åç«¯å‘èµ·è¯·æ±‚ï¼ˆå›¾ä¸­ç¬¬äºŒæ­¥ï¼‰</li>
  <li>å¯ä»¥åœ¨ Service Worker ä¸­å¯¹æœåŠ¡ç«¯è¿”å›çš„æ•°æ®è¿›è¡Œå¤„ç†</li>
</ol>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/13/1635905056b125a7?w=573&amp;h=129&amp;f=png&amp;s=8623" alt="Background Sync æµç¨‹" /></p>

<p>æ¥ä¸‹æ¥çœ‹çœ‹å¦‚ä½•åœ¨å®é™…ä¸­æ“ä½œï¼Œé¦–å…ˆåœ¨ client è§¦å‘ sync äº‹ä»¶:</p>

<pre><code class="language-JS">// index.js
// ç”±äºåå°åŒæ­¥åŠŸèƒ½éœ€è¦åœ¨ Service Worker æ³¨å†Œå®Œæˆåè§¦å‘ï¼Œå› æ­¤è¾ƒå¥½çš„ä¸€ä¸ªæ–¹å¼æ˜¯åœ¨ navigator.serviceWorker.ready ä¹‹åç»‘å®šç›¸å…³æ“ä½œ
navigator.serviceWorker.ready.then(function (registration) {
  var tag = "sample_sync";
  document.getElementById('js-sync-btn').addEventListener('click', function () {
    registration.sync.register(tag).then(function () {
      console.log('åå°åŒæ­¥å·²è§¦å‘', tag);
    }).catch(function (err) {
      console.log('åå°åŒæ­¥è§¦å‘å¤±è´¥', err);
    });
  });
});
</code></pre>

<p>å…¶ä¸­ <code class="highlighter-rouge">registration.sync</code> è¿”å›ä¸€ä¸ª <code class="highlighter-rouge">SyncManager</code> å¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•:</p>

<ul>
  <li>register() - Create a new sync registration and return a Promise.</li>
  <li>getTags() - Return a list of developer-defined identifiers for SyncManager registration</li>
</ul>

<p>ç„¶ååœ¨ SW ä¸­ç›‘å¬ sync äº‹ä»¶:</p>

<pre><code class="language-JS">// sw.js
// éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œfetch è¯·æ±‚ä¸€å®šè¦æ”¾åœ¨ e.waitUntil() å†…ã€‚å› ä¸ºæˆ‘ä»¬è¦ä¿è¯â€œåå°åŒæ­¥â€
// å°† Promise å¯¹è±¡æ”¾åœ¨ e.waitUntil() å†…å¯ä»¥ç¡®ä¿åœ¨ç”¨æˆ·ç¦»å¼€æˆ‘ä»¬çš„ç½‘ç«™åï¼ŒService Worker ä¼šæŒç»­åœ¨åå°è¿è¡Œï¼Œç­‰å¾…è¯¥è¯·æ±‚å®Œæˆ
self.addEventListener('sync', function (e) {
  console.log(`service workeréœ€è¦è¿›è¡Œåå°åŒæ­¥ï¼Œtag: ${e.tag}`);
  var init = {
    method: 'GET'
  };
  // æ ¹æ®ä¸åŒçš„ä¼ å…¥çš„ tagï¼Œå¯ä»¥ä¸åŒå¤„ç†
  if (e.tag === 'sample_sync') {
    var request = new Request(`sync?name=AlienZHOU`, init);
    e.waitUntil(
      fetch(request).then(function (response) {
        response.json().then(console.log.bind(console));
        return response;
      })
    );
  }
});
</code></pre>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/13/163598ca174364ed?w=800&amp;h=499&amp;f=gif&amp;s=2269837" alt="Background Sync" /></p>

<h2 id="firebase">Firebase</h2>

<p>ä»¥ä¸Šé¡¹ç›®å¯éƒ¨ç½²è‡³ <a href="https://firebase.google.com"><strong>Firebase</strong></a>ï¼Œéœ€è¦å…ˆåˆ›å»ºå¸æˆ·å¹¶å®‰è£…ä¸€äº›å·¥å…·ï¼š</p>

<ol>
  <li>åœ¨ <code class="highlighter-rouge">https://firebase.google.com/console/</code> ä¸Šåˆ›å»ºä¸€ä¸ª Firebase å¸æˆ·</li>
  <li>é€šè¿‡ npm å®‰è£… Firebaseï¼š<code class="highlighter-rouge">npm install -g firebase-tools</code></li>
</ol>

<p>åˆ›å»ºå¸æˆ·å¹¶ç™»å½•åï¼Œä¾¿å¯éšæ—¶è¿›è¡Œéƒ¨ç½²ï¼</p>

<ol>
  <li>åœ¨ <code class="highlighter-rouge">https://firebase.google.com/console/</code> ä¸Šåˆ›å»ºä¸€ä¸ªæ–°åº”ç”¨</li>
  <li>å¦‚æœæ‚¨è¿‘æœŸæœªç™»å½• Firebase å·¥å…·ï¼Œè¯·æ›´æ–°æ‚¨çš„å‡­æ®ï¼š<code class="highlighter-rouge">firebase login</code></li>
  <li>åˆå§‹åŒ–æ‚¨çš„åº”ç”¨ï¼Œå¹¶æä¾›æ‚¨å®Œæˆçš„åº”ç”¨æ‰€åœ¨çš„ç›®å½•ï¼š <code class="highlighter-rouge">firebase init</code></li>
  <li>æœ€åï¼Œå°†åº”ç”¨éƒ¨ç½²åˆ° Firebaseï¼š <code class="highlighter-rouge">firebase deploy</code></li>
  <li>å¤§åŠŸå‘Šæˆã€‚ æ“ä½œå®Œæˆï¼æ‚¨çš„åº”ç”¨å°†éƒ¨ç½²åˆ°ä»¥ä¸‹ç½‘åŸŸï¼š<code class="highlighter-rouge">https://YOUR-FIREBASE-APP.firebaseapp.com</code></li>
</ol>

<blockquote>
  <p>æ·±å…¥é˜…è¯»ï¼š<a href="https://www.firebase.com/docs/hosting/guide/">Firebase æ‰˜ç®¡æŒ‡å—</a> ğŸ‘ˆ</p>
</blockquote>

<h2 id="lighthouse">LightHouse</h2>

<p><strong>Lighthouse</strong> æ˜¯ä¸€ä¸ªå¼€æºçš„è‡ªåŠ¨åŒ–å·¥å…·ï¼Œç”¨äºæ”¹è¿›ç½‘ç»œåº”ç”¨çš„è´¨é‡ã€‚ æ‚¨å¯ä»¥å°†å…¶ä½œä¸ºä¸€ä¸ª <a href="https://chrome.google.com/webstore/detail/lighthouse/blipmdconlkpinefehnmjammfjpmpbjk">Chrome æ‰©å±•ç¨‹åº</a>è¿è¡Œï¼Œæˆ–ä»å‘½ä»¤è¡Œè¿è¡Œã€‚ æ‚¨ä¸º Lighthouse æä¾›ä¸€ä¸ªæ‚¨è¦å®¡æŸ¥çš„ç½‘å€ï¼Œå®ƒå°†é’ˆå¯¹æ­¤é¡µé¢è¿è¡Œä¸€è¿ä¸²çš„æµ‹è¯•ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªæœ‰å…³é¡µé¢æ€§èƒ½çš„æŠ¥å‘Šã€‚</p>

<pre><code class="language-SHELL"># å®‰è£…
npm install -g lighthouse

# å®¡æŸ¥
lighthouse https://airhorner.com/
</code></pre>

<p><img src="https://developers.google.com/web/tools/lighthouse/images/report.png" alt="lighthouse" /></p>

<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h2>

<ol>
  <li><a href="https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/?hl=zh-cn">Your First Progressive Web App</a></li>
  <li><a href="https://developers.google.com/web/tools/workbox/modules/workbox-sw">Workbox</a></li>
  <li><a href="https://alienzhou.gitbook.io/learning-pwa/2018-kai-shi-ni-de-pwa-xue-xi-zhi-lv">2018ï¼Œå¼€å§‹ä½ çš„ PWA å­¦ä¹ ä¹‹æ—…</a> By alienzhou</li>
</ol>
 
<div id="gitalk-container"></div>
<script>
    var gitalk = new Gitalk({
      enable: true,
      clientID: '020f142489f80c92b097',
      clientSecret: '1fa083372b44031cf1b8249251515c4e3d54c69d',
      repo: 'tate-young.github.io',
      owner: 'Tate-Young',
      admin: ['Tate-Young'],
      id: location.pathname,      // Ensure uniqueness and length less than 50
      distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script>
<!-- disqus -->
<!-- <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function () {
        this.page.url = 'https://tate-young.github.io/2019/04/07/progressive-web-app.html';
        this.page.identifier = '/2019/04/07/progressive-web-app';
        this.page.title = 'PWA ç®€ä»‹';
    };

    (function () { // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document,
            s = d.createElement('script');

        s.src = '//tate.disqus.com/embed.js'; // IMPORTANT: Replace EXAMPLE with your forum shortname!

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript> -->


            <!-- <p class="post-info">
			æœ¬æ–‡ç”± <a href="/">liberxue</a> åˆ›ä½œï¼Œé‡‡ç”¨ <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external nofollow">çŸ¥è¯†å…±äº«ç½²å4.0</a> å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯<br>æœ¬ç«™æ–‡ç« é™¤æ³¨æ˜è½¬è½½/å‡ºå¤„å¤–ï¼Œå‡ä¸ºæœ¬ç«™åŸåˆ›æˆ–ç¿»è¯‘ï¼Œè½¬è½½å‰è¯·åŠ¡å¿…ç½²å<br>æœ€åç¼–è¾‘æ—¶é—´ä¸º:2019-04-07 23:40:00</p> -->
        </div>
    </article>

    <!-- <div class="related-post-lists">
	<div class="post-lists">
		<div class="post-lists-body">
					<div class="post-list-item">
				<div class="post-list-item-container">
					<div class="item-label">
						<div class="item-title"><a href="induction.html">å½’çº³çš„éšæƒ³</a></div>
						<div class="item-meta clearfix">
														<div class="item-meta-ico bg-ico-image" style="background: url('../usr/themes/pinghsu/images/bg-ico.png') no-repeat;background-size: 40px auto;"></div>
	                        							<div class="item-meta-cat"><a href="../category/thoughts/index.html">Thoughts</a></div>
						</div>
					</div>
				</div>
			</div>
				</div>
	</div>
</div> -->

    <!-- <footer class="footer bg-white">
	<div class="footer-social">
		<div class="footer-container clearfix">
			<div class="social-list">
	 <a class="social segmentfault" target="blank" href="https://segmentfault.com/u/liberxue" title="è®¿é—® LiberXue_Twitter" data-hover="Segmentfault">Segmentfault</a>
    <a class="social github" target="blank" href="https://github.com/liberxue" title="è®¿é—® LiberXue_Twitter" data-hover="GitHub">GitHub</a>
    <a class="social twitter" target="blank" href="http://twitter.com/liberxue" title="è®¿é—® LiberXue_Twitter" data-hover="Twitter">Twitter</a>
     <a class="social stackoverflow" target="blank" href="https://stackoverflow.com/users/6902190/liberxue" title="è®¿é—® LiberXue_stackoverflow" data-hover="StackOverflow">StackOverflow</a>
          <a class="social oschina" target="blank" href="https://my.oschina.net/bolanzw" title="è®¿é—® LiberXue_Oschina" data-hover="Oschina">Oschina</a>
     <a class="social rss" target="blank" href="/feed.xml"title="è®¿é—® LiberXue_RSS" data-hover="RSS">RSS</a>
	</div>
		</div>
	</div>
	<div class="footer-meta">
        <div class="footer-container">
            <div class="meta-item meta-copyright">
                <div class="meta-copyright-info">
                    <a href="/" class="info-logo">
                         <img src="http://localhost:2333/style/images/logo-liberxue.png"   title="è®¿é—® LiberXue_blog" data-hover="LiberXue_blog" alt="LiberXue_blog" /> </a>
                    <div class="info-text">
                        <p>Theme is <a href="http://www.liberxue.com/2017/08/03/Jekyllthemes.html" title="è®¿é—® Jekyll liberxueä¸»é¢˜"  data-hover="Jekyll liberxue"target="_blank">Jekyll liberxue</a> by <a href="http://www.liberxue.com/about" target="_blank">liberxue</a></p>
                        <p>Powered by <a href="http://localhost:2333/tags/#Jekyll" title="Jekyll" data-hover="Jekyll" target="_blank" rel="nofollow">Jekyll</a></p>
                        <p>&copy; 2017 <a href="/feed.xml"  title="è®¿é—® liberxue blog RSS" data-hover="liberxue blog RSS">liberxue blog RSS</a></p>
                        <p>æ€»è®¡æ–‡ç« ï¼šç¯‡</p>
                      <p>æœ¬blogå·²å¼€æºç‚¹å‡»Fork</p><iframe src="http://ghbtns.com/github-btn.html?user=liberxue&repo=liberxue.github.io&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="95" height="20"></iframe>
                    </div>
                </div>
            </div>
            <div class="meta-item meta-posts">
                <h3 class="meta-title">ç½®é¡¶æ–‡ç« </h3>
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
            </div>
            <div class="meta-item meta-comments">
                <h3 class="meta-title">æœ€æ–°æ–‡ç« </h3>
  
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
</div>
		</div>
    </div>
</footer> -->
<script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.js"></script>
<script async src="/search/js/520.js"></script>
<script async src="/search/js/gtag.js"></script>
<script async src="/search/live2d/autoload.js"></script>
<!-- <script src="/search/js/canvas.js"></script> -->

<script>
    $(function () {
        setTimeout(function () {
            $('code').removeClass('hljs');
            $('code').removeClass('language');
        }, 90);
    });
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    <!--liberxueconnnet-menu-->
    <div id="directory-content" class="directory-content">
        <div id="directory"></div>
    </div>
    <!--liberxueconnnet-menu-->
    <script>
      const directoryContainer = document.getElementById('directory')
      const postTitle = document.getElementsByClassName('post-title')[0]
      var postDirectoryBuild = function () {
        var postChildren = function children(childNodes, reg) {
          var result = [],
              isReg = typeof reg === 'object',
              isStr = typeof reg === 'string',
              node, i, len;
          for (i = 0, len = childNodes.length; i < len; i++) {
            node = childNodes[i];
            if ((node.nodeType === 1 || node.nodeType === 9) &&
              (!reg ||
                  isReg && reg.test(node.tagName.toLowerCase()) ||
                  isStr && node.tagName.toLowerCase() === reg)) {
                result.push(node);
              }
            }
            return result;
          },
          createPostDirectory = function (article, directory, isDirNum) {
            var contentArr = [],
                titleId = [],
                levelArr, root, level,
                currentList, list, li, link, i, len;
            levelArr = (function (article, contentArr, titleId) {
                  var titleElem = postChildren(article.childNodes, /^h\d$/),
                      levelArr = [],
                      lastNum = 1,
                      lastRevNum = 1,
                      count = 0,
                      guid = 1,
                      id = 'directory' + (Math.random() + '').replace(/\D/, ''),
                      lastRevNum, num, elem;
                  while (titleElem.length) {
                      elem = titleElem.shift();
                      contentArr.push(elem.innerHTML);
                      num = +elem.tagName.match(/\d/)[0];
                      if (num > lastNum) {
                          levelArr.push(1);
                          lastRevNum += 1;
                      } else if (num === lastRevNum ||
                          num > lastRevNum && num <= lastNum) {
                          levelArr.push(0);
                          lastRevNum = lastRevNum;
                      } else if (num < lastRevNum) {
                          levelArr.push(num - lastRevNum);
                          lastRevNum = num;
                      }
                      count += levelArr[levelArr.length - 1];
                      lastNum = num;
                      elem.id = elem.id || (id + guid++);
                      titleId.push(elem.id);
                  }
                  if (count !== 0 && levelArr[0] === 1) levelArr[0] = 0;

                  return levelArr;
              })(article, contentArr, titleId);
              currentList = root = document.createElement('ul');
              dirNum = [0];
              for (i = 0, len = levelArr.length; i < len; i++) {
                  level = levelArr[i];
                  if (level === 1) {
                      list = document.createElement('ul');
                      if (!currentList.lastElementChild) {
                          currentList.appendChild(document.createElement('li'));
                      }
                      currentList.lastElementChild.appendChild(list);
                      currentList = list;
                      dirNum.push(0);
                  } else if (level < 0) {
                      level *= 2;
                      while (level++) {
                          if (level % 2) dirNum.pop();
                          currentList = currentList.parentNode;
                      }
                  }
                  dirNum[dirNum.length - 1]++;
                  li = document.createElement('li');
                  link = document.createElement('a');
                  link.name = '#' + titleId[i];
                  link.href = 'Javascript:;'
                  link.className = "post-aside-anchor"
                  link.title = 'è®¿é—®' + titleId[i];
                  link.innerHTML = !isDirNum ? contentArr[i] :
                      dirNum.join('.') + ' ' + contentArr[i];
                  li.appendChild(link);
                  currentList.appendChild(li);
              }
            directory.appendChild(root);
          };
        createPostDirectory(document.getElementById('post-content'), directoryContainer, true);
      };
      postDirectoryBuild();
    </script>
    <script>
      // gtag('config', GA_TRACKING_ID, {
      //   'page_title' : 'Blog',
      //   'page_path': window.location.pathname,
      //   'post_title': 'watttsdfasdf',
      // });

    </script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script>
        lang = hljs.initHighlightingOnLoad();
    </script>
</body>

</html>
