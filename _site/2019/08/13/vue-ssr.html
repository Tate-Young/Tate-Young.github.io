
<!DOCTYPE>
<html lang="zh-cn" data-scribe-reduced-action-queue="true">
<head>
    <meta content='Vue SSR - Tate & Snow' name='title' />
    <meta content='Vue SSR - Tate & Snow' name='og:title' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <title>Vue SSR - Tate & Snow</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Vue SSR - Tate & Snow</title>
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Vue SSR - Tate & Snow">
<meta name="twitter:keywords" content="Vue SSR - Tate & Snow" property='og:description' />
<meta property="og:type" content="article">
<meta property="og:title" content="Vue SSR - Tate & Snow">
<meta name="og:keywords" content="Vue SSR - Tate & Snow|Vue SSRæœåŠ¡ç«¯æ¸²æŸ“å’Œå®¢æˆ·ç«¯æ¸²æŸ“ä¸ä¼ ç»Ÿ SPA (å•é¡µåº”ç”¨ç¨‹åº (Single-Page Application)) ç›¸æ¯”ï¼ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR) çš„ä¼˜åŠ¿ä¸»è¦åœ¨äº:  æ›´å¥½çš„ SEO - æœç´¢å¼•æ“çˆ¬è™«æŠ“å–å·¥å…·å¯ä»¥ç›´æ¥æŸ¥çœ‹å®Œå…¨æ¸²æŸ“..."
  property='og:description' />
<link rel="icon" type="image/png" href="http://localhost:2333/style/favicons/favicon.ico" />
<link href="http://localhost:2333/style/favicons/favicon.ico" rel="shortcut icon" type="image/png">
<link rel="canonical" href="http://localhost:2333/">
<link rel="alternate" type="application/rss+xml" title="Liberxue" href="http://localhost:2333/feed.xml">
<meta charset="UTF-8">
<link rel="manifest" href="/manifest.json">
<link rel="shortcut icon" href="http://localhost:2333/style/favicons/favicon.ico" type="image/x-icon">
<meta name="keywords" content="Vue SSRæœåŠ¡ç«¯æ¸²æŸ“å’Œå®¢æˆ·ç«¯æ¸²æŸ“ä¸ä¼ ç»Ÿ SPA (å•é¡µåº”ç”¨ç¨‹åº (Single-Page Application)) ç›¸æ¯”ï¼ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR) çš„ä¼˜åŠ¿ä¸»è¦åœ¨äº:  æ›´å¥½çš„ SEO - æœç´¢å¼•æ“çˆ¬è™«æŠ“å–å·¥å…·å¯ä»¥ç›´æ¥æŸ¥çœ‹å®Œå…¨æ¸²æŸ“..." property='og:description'
/>
<meta name="description" content="Tate & Snow's Github blog" />
<link href="https://cdn.bootcss.com/highlight.js/9.10.0/styles/xcode.min.css" rel="stylesheet">
<link href="http://localhost:2333/style/theme.css" rel="stylesheet"> 
<meta content='http://localhost:2333/2019/08/13/vue-ssr.html' property='og:url' />
<meta content="http://localhost:2333/2019/08/13/vue-ssr.html|Vue SSRæœåŠ¡ç«¯æ¸²æŸ“å’Œå®¢æˆ·ç«¯æ¸²æŸ“ä¸ä¼ ç»Ÿ SPA (å•é¡µåº”ç”¨ç¨‹åº (Single-Page Application)) ç›¸æ¯”ï¼ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR) çš„ä¼˜åŠ¿ä¸»è¦åœ¨äº:  æ›´å¥½çš„ SEO - æœç´¢å¼•æ“çˆ¬è™«æŠ“å–å·¥å…·å¯ä»¥ç›´æ¥æŸ¥çœ‹å®Œå…¨æ¸²æŸ“..." property='og:description'
/>
<meta content="article" property="og:type" /> 

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-136311746-1"></script>
<!-- <script async src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>
<script>
  window.dataLayer = window.dataLayer || [];
  window.GA_TRACKING_ID = 'UA-136311746-1'
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('set', {
    'country': 'US',
    'currency': 'USD',
    'description': 'fuck',
  });
  gtag('config', GA_TRACKING_ID, {
    'custom_map': {
      'dimension1': 'post_title',
    },
    'post_title': 'test',
  });
</script>
<meta content="" property="fb:app_id" />
<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Vue SSR | Tate &amp; Snow</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Vue SSR" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Vue SSR" />
<meta property="og:description" content="Vue SSR" />
<link rel="canonical" href="http://localhost:2333/2019/08/13/vue-ssr.html" />
<meta property="og:url" content="http://localhost:2333/2019/08/13/vue-ssr.html" />
<meta property="og:site_name" content="Tate &amp; Snow" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-08-13T17:11:00+08:00" />
<script type="application/ld+json">
{"description":"Vue SSR","@type":"BlogPosting","url":"http://localhost:2333/2019/08/13/vue-ssr.html","headline":"Vue SSR","dateModified":"2019-08-13T17:11:00+08:00","datePublished":"2019-08-13T17:11:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:2333/2019/08/13/vue-ssr.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<script>
  (function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s);
    js.id = id;
    js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

</head>

<body class="dark-theme" gtools_scp_screen_capture_injected="true">
    <header id="header" class="header bg-white">
        <div class="navbar-container">
            <a href="Javascript:;" onclick="onClickLogo()" title="è®¿é—® Tate & Snow" class="navbar-logo menu-logo">
                <img src="https://i.loli.net/2018/03/13/5aa74f5b4c2c7.png" alt="Tate & Snow"> </a>
            <!-- <a href="/?tate" title="è®¿é—® Tate & Snow" class="navbar-logo">Tate & Snow</a>   -->
            <div class="navbar-menu">
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('é¦–é¡µ', '/')" title="è®¿é—® é¦–é¡µ" data-hover="é¦–é¡µ">é¦–é¡µ</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('å‰ç«¯', '/front')" title="è®¿é—® å‰ç«¯" data-hover="å‰ç«¯">å‰ç«¯</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('å†å²', '/history')" title="è®¿é—® å†å²" data-hover="å†å²">å†å²</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('å…¶ä»–', '/other')" title="è®¿é—® å…¶ä»–" data-hover="å…¶ä»–">å…¶ä»–</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('æ ‡ç­¾', '/tags')" title="è®¿é—® æ ‡ç­¾" data-hover="æ ‡ç­¾">æ ‡ç­¾</a>
                
                  <a class=" menu-item-about " href="Javascript:;" onclick="onClickMenu('å…³äº', '/README')" title="è®¿é—® å…³äº" data-hover="å…³äº">å…³äº</a>
                
            </div>
            <!-- <div class="navbar-menu">
                
                <a href="http://localhost:2333/">é¦–é¡µ</a>
                
                <a href="http://localhost:2333/front">å‰ç«¯</a>
                
                <a href="http://localhost:2333/history">å†å²</a>
                
                <a href="http://localhost:2333/other">å…¶ä»–</a>
                
                <a href="http://localhost:2333/tags">æ ‡ç­¾</a>
                
                <a href="http://localhost:2333/README">å…³äº</a>
                
            </div> -->
            <div class="navbar-search menu-item-search" onclick="onClickSearch()">
                <span class="icon-search"></span>
                <form id="cb-search-btn" role="search">
                    <span class="search-box">
                        <input type="text" class="input" id="cb-search-content" required="true" placeholder="æ ‡é¢˜ æ ‡ç­¾..." maxlength="30" autocomplete="off">
                    </span>
                </form>
            </div>
            <div class="navbar-mobile-menu" onclick="">
                <span class="icon-menu cross">
                    <span class="middle"></span>
                </span>
                <ul>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('é¦–é¡µ', 'http://localhost:2333/')">é¦–é¡µ</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å‰ç«¯', 'http://localhost:2333/front')">å‰ç«¯</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å†å²', 'http://localhost:2333/history')">å†å²</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å…¶ä»–', 'http://localhost:2333/other')">å…¶ä»–</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('æ ‡ç­¾', 'http://localhost:2333/tags')">æ ‡ç­¾</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å…³äº', 'http://localhost:2333/README')">å…³äº</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </header>
    <a href="#header" class="back-to-top" onclick="onClickTop('Vue SSR')">â¤´Topâ¤´</a>
    <div class="post-header-thumb bg-white}">
        <div class="post-header-thumb-op"></div>
        <div class="post-header-thumb">
            <div class="post-header-thumb-container">
                <h1 class="post-title" itemprop="name headline">
                    Vue SSR</h1>
                <div class="post-data">
                    <time datetime="2019-08-13 17:11:00" itemprop="datePublished">
                      å‘å¸ƒæ—¶é—´ï¼š2019-08-13 17:11:00
                      &nbsp;&nbsp;&nbsp;
                      
                    </time>
                    <a onclick="onClickCategory('å‰ç«¯')" href="Javascript:;" title="è®¿é—® å‰ç«¯" data-hover="åšå®¢åˆ†ç±»: å‰ç«¯">åšå®¢åˆ†ç±»: å‰ç«¯</a>
                    <!-- <a href="#read"> é˜…è¯»æ¬¡æ•°: comments</a>  -->
                </div>
                <div class="post-tags">
                       
                    <a class="menu-item-tags" href="Javascript:;" onclick="onClickTag('Vue')" title="è®¿é—®Vue" data-hover="Vue">
                        Vue
                        <span>(5)</span>
                        
                    </a>
                       
                </div>
            </div>
        </div>
    </div>
    <article class="main-content post-page" itemscope itemtype="http://schema.org/Article">
        <div class="post-header">
            <h1 class="post-title" itemprop="name headline">
                Vue SSR</h1>
            <div class="post-data">
                <time datetime="2019-08-13 17:11:00" itemprop="datePublished">2019-08-13 17:11:00</time>
            </div>
        </div>
        <div id="post-content" class="post-content" itemprop="articleBody">
            <p class="post-tags">
                   
                <a href="Javascript:;" onclick="onClickTag('Vue')" title="è®¿é—®Vue" data-hover="Vue">
                    Vue
                    <span>(5)</span>
                    </a>
                   
            </p>
            <h1 id="vue-ssr">Vue SSR</h1>

<h2 id="æœåŠ¡ç«¯æ¸²æŸ“å’Œå®¢æˆ·ç«¯æ¸²æŸ“">æœåŠ¡ç«¯æ¸²æŸ“å’Œå®¢æˆ·ç«¯æ¸²æŸ“</h2>

<p>ä¸ä¼ ç»Ÿ <strong>SPA (å•é¡µåº”ç”¨ç¨‹åº (Single-Page Application))</strong> ç›¸æ¯”ï¼Œ<strong>æœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR)</strong> çš„ä¼˜åŠ¿ä¸»è¦åœ¨äº:</p>

<ol>
  <li>æ›´å¥½çš„ <strong>SEO</strong> - æœç´¢å¼•æ“çˆ¬è™«æŠ“å–å·¥å…·å¯ä»¥ç›´æ¥æŸ¥çœ‹å®Œå…¨æ¸²æŸ“çš„é¡µé¢</li>
  <li>æ›´å¿«çš„<strong>å†…å®¹åˆ°è¾¾æ—¶é—´ (time-to-content)</strong> - ç‰¹åˆ«æ˜¯å¯¹äºç¼“æ…¢çš„ç½‘ç»œæƒ…å†µæˆ–è¿è¡Œç¼“æ…¢çš„è®¾å¤‡ã€‚æ— éœ€ç­‰å¾…æ‰€æœ‰çš„ JavaScript éƒ½å®Œæˆä¸‹è½½å¹¶æ‰§è¡Œï¼Œæ‰æ˜¾ç¤ºæœåŠ¡å™¨æ¸²æŸ“çš„æ ‡è®°ï¼Œæ‰€ä»¥ä½ çš„ç”¨æˆ·å°†ä¼šæ›´å¿«é€Ÿåœ°çœ‹åˆ°å®Œæ•´æ¸²æŸ“çš„é¡µé¢ã€‚</li>
</ol>

<p>è€ŒåŠ£åŠ¿åœ¨äº:</p>

<ol>
  <li>å¼€å‘æ¡ä»¶æ‰€é™ã€‚æµè§ˆå™¨ç‰¹å®šçš„ä»£ç ï¼Œåªèƒ½åœ¨æŸäº›ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•° (lifecycle hook) ä¸­ä½¿ç”¨ï¼›ä¸€äº›å¤–éƒ¨æ‰©å±•åº“ (external library) å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œæ‰èƒ½åœ¨æœåŠ¡å™¨æ¸²æŸ“åº”ç”¨ç¨‹åºä¸­è¿è¡Œ</li>
  <li>æ¶‰åŠæ„å»ºè®¾ç½®å’Œéƒ¨ç½²çš„æ›´å¤šè¦æ±‚ã€‚ä¸å¯ä»¥éƒ¨ç½²åœ¨ä»»ä½•é™æ€æ–‡ä»¶æœåŠ¡å™¨ä¸Šçš„å®Œå…¨é™æ€å•é¡µé¢åº”ç”¨ç¨‹åº (SPA) ä¸åŒï¼ŒæœåŠ¡å™¨æ¸²æŸ“åº”ç”¨ç¨‹åºï¼Œéœ€è¦å¤„äº Node.js server è¿è¡Œç¯å¢ƒ</li>
  <li>æ›´å¤šçš„æœåŠ¡å™¨ç«¯è´Ÿè½½ã€‚åœ¨ Node.js ä¸­æ¸²æŸ“å®Œæ•´çš„åº”ç”¨ç¨‹åºï¼Œæ˜¾ç„¶ä¼šæ¯”ä»…ä»…æä¾›é™æ€æ–‡ä»¶çš„ server æ›´åŠ å¤§é‡å ç”¨ CPU èµ„æº</li>
</ol>

<h2 id="vue-ssr-1">Vue SSR</h2>

<p>Vue æ˜¯æ„å»ºå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºçš„æ¡†æ¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¾“å‡º Vue ç»„ä»¶ï¼Œè¿›è¡Œç”Ÿæˆ DOM å’Œæ“ä½œ DOMã€‚ç„¶è€Œï¼Œä¹Ÿå¯ä»¥å°†åŒä¸€ä¸ªç»„ä»¶æ¸²æŸ“ä¸ºæœåŠ¡å™¨ç«¯çš„ HTML å­—ç¬¦ä¸²ï¼Œå°†å®ƒä»¬ç›´æ¥å‘é€åˆ°æµè§ˆå™¨ï¼Œæœ€åå°†è¿™äº›é™æ€æ ‡è®°â€æ¿€æ´»â€ä¸ºå®¢æˆ·ç«¯ä¸Šå®Œå…¨å¯äº¤äº’çš„åº”ç”¨ç¨‹åºï¼Œå³æœåŠ¡ç«¯æ¸²æŸ“ã€‚æˆ‘ä»¬éœ€è¦æ³¨æ„çš„å‡ ä¸ªé—®é¢˜æ˜¯:</p>

<ol>
  <li>æœåŠ¡å™¨ä¸Šçš„æ•°æ®å“åº” - åœ¨çº¯å®¢æˆ·ç«¯åº”ç”¨ç¨‹åº (client-only app) ä¸­ï¼Œæ¯ä¸ªç”¨æˆ·ä¼šåœ¨ä»–ä»¬å„è‡ªçš„æµè§ˆå™¨ä¸­ä½¿ç”¨æ–°çš„åº”ç”¨ç¨‹åºå®ä¾‹ã€‚å¯¹äºæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›å¦‚æ­¤ï¼šæ¯ä¸ªè¯·æ±‚åº”è¯¥éƒ½æ˜¯å…¨æ–°çš„ã€ç‹¬ç«‹çš„åº”ç”¨ç¨‹åºå®ä¾‹ï¼Œä»¥ä¾¿ä¸ä¼šæœ‰<strong>äº¤å‰è¯·æ±‚é€ æˆçš„çŠ¶æ€æ±¡æŸ“ (cross-request state pollution)</strong></li>
  <li>ç»„ä»¶ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•° - ç”±äºæ²¡æœ‰åŠ¨æ€æ›´æ–°ï¼Œæ‰€æœ‰çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ä¸­ï¼Œåªæœ‰ <strong>beforeCreate</strong> å’Œ <strong>created</strong> ä¼šåœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR) è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œä½†ä¸èƒ½åœ¨è¯¥ç”Ÿå‘½å‘¨æœŸä¸­ä½¿ç”¨å…¨å±€å‰¯ä½œç”¨çš„ä»£ç ï¼Œä¾‹å¦‚ setIntervalï¼ŒSSR æœŸé—´å¹¶ä¸ä¼šè°ƒç”¨é”€æ¯é’©å­å‡½æ•°</li>
  <li>è®¿é—®ç‰¹å®šå¹³å°(Platform-Specific) API - é€šç”¨ä»£ç ä¸å¯æ¥å—ç‰¹å®šå¹³å°çš„ APIï¼Œå› æ­¤å¦‚æœä½ çš„ä»£ç ä¸­ï¼Œç›´æ¥ä½¿ç”¨äº†åƒ <code class="highlighter-rouge">window</code> æˆ– <code class="highlighter-rouge">document</code>ï¼Œè¿™ç§ä»…æµè§ˆå™¨å¯ç”¨çš„å…¨å±€å˜é‡ï¼Œåˆ™ä¼šåœ¨ Node.js ä¸­æ‰§è¡Œæ—¶æŠ›å‡ºé”™è¯¯</li>
</ol>

<p><img src="https://cloud.githubusercontent.com/assets/499550/17607895/786a415a-5fee-11e6-9c11-45a2cfdf085c.png" alt="webpack" /></p>

<p>webpack æ„å»ºæ­¥éª¤å¦‚ä¸Šï¼Œå¯¹äºå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå’ŒæœåŠ¡å™¨åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éƒ½è¦ä½¿ç”¨ webpack æ‰“åŒ… - æœåŠ¡å™¨éœ€è¦ã€ŒæœåŠ¡å™¨ bundleã€ç„¶åç”¨äºæœåŠ¡å™¨ç«¯æ¸²æŸ“(SSR)ï¼Œè€Œã€Œå®¢æˆ·ç«¯ bundleã€ä¼šå‘é€ç»™æµè§ˆå™¨ï¼Œç”¨äºæ··åˆé™æ€æ ‡è®°ã€‚ä¸€ä¸ªåŸºæœ¬çš„é¡¹ç›®ç»“æ„å¯å‚è€ƒå¦‚ä¸‹:</p>

<pre><code class="language-TEXT">config
â”œâ”€â”€ setup-dev-server.js # è®¾ç½®å¼€å‘æ¨¡å¼ä¸­é—´ä»¶ï¼Œæ¯”å¦‚çƒ­é‡è½½ï¼Œé€šè¿‡è¯»å–æ›´æ–°åçš„ bundleï¼Œç„¶åé‡æ–°åˆ›å»º renderer å®ä¾‹ï¼ˆéœ€è¦ webpack.client.config.js / webpack.server.config.jsï¼‰
â”œâ”€â”€ webpack.base.config.js # webpack åŸºç¡€å…¬å…±é…ç½®
â”œâ”€â”€ webpack.client.config.js # å®¢æˆ·ç«¯é…ç½®ï¼Œç”Ÿæˆ clientManifestï¼ˆéœ€è¦ entry-client.jsï¼‰
â”œâ”€â”€ webpack.server.config.js # æœåŠ¡ç«¯é…ç½®ï¼Œç”¨äºç”Ÿæˆä¼ é€’ç»™ createBundleRenderer çš„ server bundleï¼ˆéœ€è¦ entry-server.jsï¼‰
src
â”œâ”€â”€ components
â”‚   â”œâ”€â”€ Foo.vue
â”‚   â””â”€â”€ Bar.vue
â”œâ”€â”€ App.vue
â”œâ”€â”€ app.js # é€šç”¨ entryï¼Œæš´éœ²ä¸€ä¸ªå¯ä»¥é‡å¤æ‰§è¡Œçš„å·¥å‚å‡½æ•°åˆ›å»º vue å®ä¾‹
â”œâ”€â”€ entry-client.js # ä»…è¿è¡Œäºæµè§ˆå™¨ï¼Œä¸»è¦å¤„ç†å®¢æˆ·ç«¯æ•°æ®é¢„å–å’ŒæŒ‚è½½ DOMï¼ˆéœ€è¦ app.jsï¼‰
â””â”€â”€ entry-server.js # ä»…è¿è¡ŒäºæœåŠ¡å™¨ã€‚ä¸»è¦å¤„ç†æœåŠ¡ç«¯è·¯ç”±åŒ¹é…å’Œæ•°æ®é¢„å–ï¼ˆéœ€è¦ app.jsï¼‰
server.js # åˆ©ç”¨ Bundle Renderer è¿›è¡ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆéœ€è¦ server bundle / clientManifest / setup-dev-server.jsï¼‰
</code></pre>

<h3 id="appjs">app.js</h3>

<p>ä¸Šé¢æˆ‘ä»¬å·²ç»è®¨è®ºè¿‡ï¼Œæˆ‘ä»¬è¦ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„æ ¹ Vue å®ä¾‹ï¼Œå› æ­¤æš´éœ²ä¸€ä¸ªå¯ä»¥é‡å¤æ‰§è¡Œçš„å·¥å‚å‡½æ•° <code class="highlighter-rouge">createApp</code>:</p>

<pre><code class="language-JS">import { sync } from 'vuex-router-sync'

// Expose a factory function that creates a fresh set of store, router,
// app instances on each call (which is called for each SSR request)
export function createApp () {
  // create store and router instances
  const store = createStore()
  const router = createRouter()

  // sync the router with the vuex store.
  // this registers `store.state.route`
  sync(store, router)

  // create the app instance.
  // here we inject the router, store and ssr context to all child components,
  // making them available everywhere as `this.$router` and `this.$store`.
  const app = new Vue({
    router,
    store,
    render: h =&gt; h(App)
  })

  // expose the app, the router and the store.
  // note we are not mounting the app here, since bootstrapping will be
  // different depending on whether we are in a browser or on the server.
  return { app, router, store }
}
</code></pre>

<p>åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“(SSR)æœŸé—´ï¼Œæˆ‘ä»¬æœ¬è´¨ä¸Šæ˜¯åœ¨æ¸²æŸ“æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„â€å¿«ç…§â€ï¼Œæ‰€ä»¥å¦‚æœåº”ç”¨ç¨‹åºä¾èµ–äºä¸€äº›å¼‚æ­¥æ•°æ®ï¼Œé‚£ä¹ˆåœ¨å¼€å§‹æ¸²æŸ“è¿‡ç¨‹ä¹‹å‰ï¼Œéœ€è¦å…ˆé¢„å–å’Œè§£æå¥½è¿™äº›æ•°æ®ã€‚å¦ä¸€ä¸ªéœ€è¦å…³æ³¨çš„é—®é¢˜æ˜¯åœ¨å®¢æˆ·ç«¯ï¼Œåœ¨æŒ‚è½½ (mount) åˆ°å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¹‹å‰ï¼Œéœ€è¦è·å–åˆ°ä¸æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºå®Œå…¨ç›¸åŒçš„æ•°æ® - å¦åˆ™ï¼Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¼šå› ä¸ºä½¿ç”¨ä¸æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºä¸åŒçš„çŠ¶æ€ï¼Œç„¶åå¯¼è‡´æ··åˆå¤±è´¥ã€‚å› æ­¤é‡‡ç”¨å®˜æ–¹çš„ <a href="http://localhost:2333/2019/08/06/vuex-profile.html">Vuex çŠ¶æ€ç®¡ç†åº“</a>ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨å“ªé‡Œæ”¾ç½®ã€Œdispatch æ•°æ®é¢„å– actionã€çš„ä»£ç å‘¢ï¼Ÿ</p>

<p>æˆ‘ä»¬åœ¨è·¯ç”±ç»„ä»¶ä¸Šæš´éœ²å‡ºä¸€ä¸ªè‡ªå®šä¹‰é™æ€å‡½æ•° <code class="highlighter-rouge">asyncData</code>ã€‚æ³¨æ„ï¼Œç”±äºæ­¤å‡½æ•°ä¼šåœ¨ç»„ä»¶å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ï¼Œæ‰€ä»¥å®ƒæ— æ³•è®¿é—® thisã€‚éœ€è¦å°† store å’Œè·¯ç”±ä¿¡æ¯ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»:</p>

<pre><code class="language-JS">// Item.vue
export default {
  asyncData ({ store, route }) {
    // è§¦å‘ action åï¼Œä¼šè¿”å› Promise
    return store.dispatch('fetchItem', route.params.id)
  },
  computed: {
    // ä» store çš„ state å¯¹è±¡ä¸­çš„è·å– itemã€‚
    item () {
      return this.$store.state.items[this.$route.params.id]
    }
  }
}
</code></pre>

<h3 id="entry-serverjs">entry-server.js</h3>

<p>æœåŠ¡å™¨ entry ä½¿ç”¨ <code class="highlighter-rouge">default export</code> å¯¼å‡ºå‡½æ•°ï¼Œå¹¶åœ¨æ¯æ¬¡æ¸²æŸ“ä¸­é‡å¤è°ƒç”¨æ­¤å‡½æ•°ã€‚ä¸»è¦æ‰§è¡Œ<strong>æœåŠ¡å™¨ç«¯è·¯ç”±åŒ¹é… (server-side route matching)</strong> å’Œ<strong>æ•°æ®é¢„å–é€»è¾‘ (data pre-fetching logic)</strong>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è·¯ç”±è·å¾—ä¸ <code class="highlighter-rouge">router.getMatchedComponents()</code> ç›¸åŒ¹é…çš„ç»„ä»¶ï¼Œå¦‚æœç»„ä»¶æš´éœ²å‡º <code class="highlighter-rouge">asyncData</code>ï¼Œæˆ‘ä»¬å°±è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚ç„¶åæˆ‘ä»¬éœ€è¦å°†è§£æå®Œæˆçš„çŠ¶æ€ï¼Œé™„åŠ åˆ°æ¸²æŸ“ä¸Šä¸‹æ–‡(render context)ä¸­:</p>

<pre><code class="language-JS">import { createApp } from './app'

// This exported function will be called by `bundleRenderer`.
// This is where we perform data-prefetching to determine the
// state of our application before actually rendering it.
// Since data fetching is async, this function is expected to
// return a Promise that resolves to the app instance.
export default context =&gt; {
  return new Promise((resolve, reject) =&gt; {
    const { app, router, store } = createApp()

    // è®¾ç½®æœåŠ¡å™¨ç«¯ router çš„ä½ç½®
    router.push(context.url)

    // ç­‰åˆ° router å°†å¯èƒ½çš„å¼‚æ­¥ç»„ä»¶å’Œé’©å­å‡½æ•°è§£æå®Œ
    router.onReady(() =&gt; {
      const matchedComponents = router.getMatchedComponents()
      // åŒ¹é…ä¸åˆ°çš„è·¯ç”±ï¼Œæ‰§è¡Œ reject å‡½æ•°ï¼Œå¹¶è¿”å› 404
      if (!matchedComponents.length) {
        return reject({ code: 404 })
      }

      // å¯¹æ‰€æœ‰åŒ¹é…çš„è·¯ç”±ç»„ä»¶è°ƒç”¨ `asyncData()`
      Promise.all(matchedComponents.map(Component =&gt; {
        if (Component.asyncData) {
          return Component.asyncData({
            store,
            route: router.currentRoute
          })
        }
      })).then(() =&gt; {
        // åœ¨æ‰€æœ‰é¢„å–é’©å­(preFetch hook) resolve åï¼Œ
        // æˆ‘ä»¬çš„ store ç°åœ¨å·²ç»å¡«å……å…¥æ¸²æŸ“åº”ç”¨ç¨‹åºæ‰€éœ€çš„çŠ¶æ€ã€‚
        // å½“æˆ‘ä»¬å°†çŠ¶æ€é™„åŠ åˆ°ä¸Šä¸‹æ–‡ï¼Œ
        // å¹¶ä¸” `template` é€‰é¡¹ç”¨äº renderer æ—¶ï¼Œ
        // çŠ¶æ€å°†è‡ªåŠ¨åºåˆ—åŒ–ä¸º `window.__INITIAL_STATE__`ï¼Œå¹¶æ³¨å…¥ HTMLã€‚
        context.state = store.state

        // Promise åº”è¯¥ resolve åº”ç”¨ç¨‹åºå®ä¾‹ï¼Œä»¥ä¾¿å®ƒå¯ä»¥æ¸²æŸ“
        resolve(app)
      }).catch(reject)
    }, reject)
  })
}
</code></pre>

<h3 id="entry-clientjs">entry-client.js</h3>

<p>å®¢æˆ·ç«¯ entry åªéœ€åˆ›å»ºåº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”å°†å…¶æŒ‚è½½åˆ° DOM ä¸­:</p>

<pre><code class="language-JS">import { createApp } from './app'

const { app, router } = createApp()

// éœ€è¦åœ¨æŒ‚è½½ app ä¹‹å‰è°ƒç”¨ router.onReadyï¼Œå› ä¸ºè·¯ç”±å™¨å¿…é¡»è¦æå‰è§£æè·¯ç”±é…ç½®ä¸­çš„å¼‚æ­¥ç»„ä»¶ï¼Œæ‰èƒ½æ­£ç¡®åœ°è°ƒç”¨ç»„ä»¶ä¸­å¯èƒ½å­˜åœ¨çš„è·¯ç”±é’©å­
router.onReady(() =&gt; {
  app.$mount('#app')
})
</code></pre>

<p>å®¢æˆ·ç«¯æ•°æ®é¢„å– (Client Data Fetching) ä¸€èˆ¬æœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼:</p>

<ul>
  <li><strong>åœ¨è·¯ç”±å¯¼èˆªä¹‹å‰è§£ææ•°æ®</strong> - ä½¿ç”¨æ­¤ç­–ç•¥ï¼Œåº”ç”¨ç¨‹åºä¼šç­‰å¾…è§†å›¾æ‰€éœ€æ•°æ®å…¨éƒ¨è§£æä¹‹åï¼Œå†ä¼ å…¥æ•°æ®å¹¶å¤„ç†å½“å‰è§†å›¾ã€‚å¥½å¤„åœ¨äºï¼Œå¯ä»¥ç›´æ¥åœ¨æ•°æ®å‡†å¤‡å°±ç»ªæ—¶ï¼Œä¼ å…¥è§†å›¾æ¸²æŸ“å®Œæ•´å†…å®¹ï¼Œä½†æ˜¯å¦‚æœæ•°æ®é¢„å–éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œç”¨æˆ·åœ¨å½“å‰è§†å›¾ä¼šæ„Ÿå—åˆ°â€æ˜æ˜¾å¡é¡¿â€</li>
  <li><strong>åŒ¹é…è¦æ¸²æŸ“çš„è§†å›¾åï¼Œå†è·å–æ•°æ®</strong> - æ­¤ç­–ç•¥å°†å®¢æˆ·ç«¯æ•°æ®é¢„å–é€»è¾‘ï¼Œæ”¾åœ¨è§†å›¾ç»„ä»¶çš„ <code class="highlighter-rouge">beforeMount</code> å‡½æ•°ä¸­ã€‚å½“è·¯ç”±å¯¼èˆªè¢«è§¦å‘æ—¶ï¼Œå¯ä»¥ç«‹å³åˆ‡æ¢è§†å›¾ï¼Œå› æ­¤åº”ç”¨ç¨‹åºå…·æœ‰æ›´å¿«çš„å“åº”é€Ÿåº¦ã€‚ç„¶è€Œï¼Œä¼ å…¥è§†å›¾åœ¨æ¸²æŸ“æ—¶ä¸ä¼šæœ‰å®Œæ•´çš„å¯ç”¨æ•°æ®ã€‚å› æ­¤ï¼Œå¯¹äºä½¿ç”¨æ­¤ç­–ç•¥çš„æ¯ä¸ªè§†å›¾ç»„ä»¶ï¼Œéƒ½éœ€è¦å…·æœ‰æ¡ä»¶åŠ è½½çŠ¶æ€</li>
</ul>

<p>1ã€åœ¨è·¯ç”±å¯¼èˆªä¹‹å‰è§£ææ•°æ®</p>

<pre><code class="language-JS">router.onReady(() =&gt; {
  // æ·»åŠ è·¯ç”±é’©å­å‡½æ•°ï¼Œç”¨äºå¤„ç† asyncData.
  // åœ¨åˆå§‹è·¯ç”± resolve åæ‰§è¡Œï¼Œ
  // ä»¥ä¾¿æˆ‘ä»¬ä¸ä¼šäºŒæ¬¡é¢„å–(double-fetch)å·²æœ‰çš„æ•°æ®ã€‚
  // ä½¿ç”¨ `router.beforeResolve()`ï¼Œä»¥ä¾¿ç¡®ä¿æ‰€æœ‰å¼‚æ­¥ç»„ä»¶éƒ½ resolveã€‚
  router.beforeResolve((to, from, next) =&gt; {
    const matched = router.getMatchedComponents(to)
    const prevMatched = router.getMatchedComponents(from)

    // æˆ‘ä»¬åªå…³å¿ƒéé¢„æ¸²æŸ“çš„ç»„ä»¶
    // æ‰€ä»¥æˆ‘ä»¬å¯¹æ¯”å®ƒä»¬ï¼Œæ‰¾å‡ºä¸¤ä¸ªåŒ¹é…åˆ—è¡¨çš„å·®å¼‚ç»„ä»¶
    let diffed = false
    const activated = matched.filter((c, i) =&gt; {
      return diffed || (diffed = (prevMatched[i] !== c))
    })

    if (!activated.length) {
      return next()
    }

    // è¿™é‡Œå¦‚æœæœ‰åŠ è½½æŒ‡ç¤ºå™¨ (loading indicator)ï¼Œå°±è§¦å‘

    Promise.all(activated.map(c =&gt; {
      if (c.asyncData) {
        return c.asyncData({ store, route: to })
      }
    })).then(() =&gt; {

      // åœæ­¢åŠ è½½æŒ‡ç¤ºå™¨(loading indicator)

      next()
    }).catch(next)
  })

  app.$mount('#app')
})
</code></pre>

<p>2ã€åŒ¹é…è¦æ¸²æŸ“çš„è§†å›¾åï¼Œå†è·å–æ•°æ®</p>

<pre><code class="language-JS">// å…¨å±€ mixin
Vue.mixin({
  beforeMount () {
    const { asyncData } = this.$options
    if (asyncData) {
      // å°†è·å–æ•°æ®æ“ä½œåˆ†é…ç»™ promise
      // ä»¥ä¾¿åœ¨ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ•°æ®å‡†å¤‡å°±ç»ªå
      // é€šè¿‡è¿è¡Œ `this.dataPromise.then(...)` æ¥æ‰§è¡Œå…¶ä»–ä»»åŠ¡
      this.dataPromise = asyncData({
        store: this.$store,
        route: this.$route
      })
    }
  }
})
</code></pre>

<p>è¿™ä¸¤ç§ç­–ç•¥æ˜¯æ ¹æœ¬ä¸Šä¸åŒçš„ç”¨æˆ·ä½“éªŒå†³ç­–ï¼Œåº”è¯¥æ ¹æ®ä½ åˆ›å»ºçš„åº”ç”¨ç¨‹åºçš„å®é™…ä½¿ç”¨åœºæ™¯è¿›è¡ŒæŒ‘é€‰ã€‚ä½†æ˜¯æ— è®ºä½ é€‰æ‹©å“ªç§ç­–ç•¥ï¼Œå½“è·¯ç”±ç»„ä»¶é‡ç”¨ï¼ˆåŒä¸€è·¯ç”±ï¼Œä½†æ˜¯ params æˆ– query å·²æ›´æ”¹ï¼Œä¾‹å¦‚ï¼Œä» user/1 åˆ° user/2ï¼‰æ—¶ï¼Œä¹Ÿåº”è¯¥è°ƒç”¨ <code class="highlighter-rouge">asyncData</code> å‡½æ•°ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡çº¯å®¢æˆ·ç«¯ (client-only) çš„å…¨å±€ mixin æ¥å¤„ç†è¿™ä¸ªé—®é¢˜:</p>

<pre><code class="language-JS">Vue.mixin({
  beforeRouteUpdate (to, from, next) {
    const { asyncData } = this.$options
    if (asyncData) {
      asyncData({
        store: this.$store,
        route: to
      }).then(next).catch(next)
    } else {
      next()
    }
  }
})
</code></pre>

<h3 id="serverjs">server.js</h3>

<p><strong>vue-server-renderer</strong> æä¾›ä¸€ä¸ªåä¸º <code class="highlighter-rouge">createBundleRenderer</code> çš„ APIï¼Œé€šè¿‡ä½¿ç”¨ webpack çš„è‡ªå®šä¹‰æ’ä»¶ï¼Œ<code class="highlighter-rouge">server bundle</code> å°†ç”Ÿæˆä¸ºå¯ä¼ é€’åˆ° <code class="highlighter-rouge">bundle renderer</code> çš„ç‰¹æ®Š JSON æ–‡ä»¶ã€‚æ‰€åˆ›å»ºçš„ <code class="highlighter-rouge">bundle renderer</code>ï¼Œç”¨æ³•å’Œæ™®é€š renderer ç›¸åŒï¼Œä½†æ˜¯ <code class="highlighter-rouge">bundle renderer</code> æä¾›ä»¥ä¸‹ä¼˜ç‚¹:</p>

<ol>
  <li>å†…ç½®çš„ <code class="highlighter-rouge">source map</code> æ”¯æŒï¼ˆåœ¨ webpack é…ç½®ä¸­ä½¿ç”¨ <code class="highlighter-rouge">devtool: 'source-map'</code>ï¼‰</li>
  <li>åœ¨å¼€å‘ç¯å¢ƒç”šè‡³éƒ¨ç½²è¿‡ç¨‹ä¸­çƒ­é‡è½½ï¼ˆé€šè¿‡è¯»å–æ›´æ–°åçš„ bundleï¼Œç„¶åé‡æ–°åˆ›å»º renderer å®ä¾‹ï¼‰</li>
  <li>å…³é”® <code class="highlighter-rouge">CSS(critical CSS)</code> æ³¨å…¥ï¼ˆåœ¨ä½¿ç”¨ *.vue æ–‡ä»¶æ—¶ï¼‰ï¼šè‡ªåŠ¨å†…è”åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ç”¨åˆ°çš„ç»„ä»¶æ‰€éœ€çš„CSS</li>
  <li>ä½¿ç”¨ <code class="highlighter-rouge">clientManifest</code> è¿›è¡Œèµ„æºæ³¨å…¥ï¼šè‡ªåŠ¨æ¨æ–­å‡ºæœ€ä½³çš„é¢„åŠ è½½(preload)å’Œé¢„å–(prefetch)æŒ‡ä»¤ï¼Œä»¥åŠåˆå§‹æ¸²æŸ“æ‰€éœ€çš„ä»£ç åˆ†å‰² chunk</li>
</ol>

<p><code class="highlighter-rouge">bundle renderer</code> åœ¨è°ƒç”¨ <code class="highlighter-rouge">renderToString</code> æ—¶ï¼Œå®ƒå°†è‡ªåŠ¨æ‰§è¡Œã€Œç”± bundle åˆ›å»ºçš„åº”ç”¨ç¨‹åºå®ä¾‹ã€æ‰€å¯¼å‡ºçš„å‡½æ•°ï¼ˆä¼ å…¥ä¸Šä¸‹æ–‡ä½œä¸ºå‚æ•°ï¼‰ï¼Œç„¶åæ¸²æŸ“å®ƒ:</p>

<pre><code class="language-JS">const { createBundleRenderer } = require('vue-server-renderer')

function createRenderer (bundle, options) {
  // https://github.com/vuejs/vue/blob/dev/packages/vue-server-renderer/README.md#why-use-bundlerenderer
  return createBundleRenderer(bundle, Object.assign(options, {
    // for component caching
    cache: LRU({
      max: 1000,
      maxAge: 1000 * 60 * 15
    }),
    // this is only needed when vue-server-renderer is npm-linked
    basedir: resolve('./dist'),
    // recommended for performance, default value is true
    runInNewContext: false
  }))
}

let renderer
let readyPromise
const templatePath = resolve('./src/index.template.html')
if (isProd) {
  // In production: create server renderer using template and built server bundle.
  // The server bundle is generated by vue-ssr-webpack-plugin.
  const template = fs.readFileSync(templatePath, 'utf-8')
  const bundle = require('./dist/vue-ssr-server-bundle.json')
  // The client manifests are optional, but it allows the renderer
  // to automatically infer preload/prefetch links and directly add &lt;script&gt;
  // tags for any async chunks used during render, avoiding waterfall requests.
  const clientManifest = require('./dist/vue-ssr-client-manifest.json')
  renderer = createRenderer(bundle, {
    template, // ï¼ˆå¯é€‰ï¼‰é¡µé¢æ¨¡æ¿
    clientManifest // ï¼ˆå¯é€‰ï¼‰å®¢æˆ·ç«¯æ„å»º manifest
  })
} else {
  // In development: setup the dev server with watch and hot-reload,
  // and create a new renderer on bundle / index template update.
  readyPromise = require('./build/setup-dev-server')(
    app,
    templatePath,
    (bundle, options) =&gt; {
      renderer = createRenderer(bundle, options)
    }
  )
}

function render (req, res) {
  const s = Date.now()

  res.setHeader("Content-Type", "text/html")
  res.setHeader("Server", serverInfo)

  const handleError = err =&gt; {
    if (err.url) {
      res.redirect(err.url)
    } else if(err.code === 404) {
      res.status(404).send('404 | Page Not Found')
    } else {
      // Render Error Page or Redirect
      res.status(500).send('500 | Internal Server Error')
      console.error(`error during render : ${req.url}`)
      console.error(err.stack)
    }
  }

  const context = {
    title: 'Vue HN 2.0', // default title
    url: req.url
  }
  renderer.renderToString(context, (err, html) =&gt; {
    if (err) {
      return handleError(err)
    }
    res.send(html)
    if (!isProd) {
      console.log(`whole request: ${Date.now() - s}ms`)
    }
  })
}

app.get('*', isProd ? render : (req, res) =&gt; {
  readyPromise.then(() =&gt; render(req, res))
})
</code></pre>

<blockquote>
  <p>ä¸€èˆ¬æƒ…å†µä¸‹éœ€è¦åœ¨ <code class="highlighter-rouge">createApp</code> ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œå¹¶ä»æ ¹ Vue å®ä¾‹æ³¨å…¥ã€‚åœ¨ä½¿ç”¨å¸¦æœ‰ <code class="highlighter-rouge">{ runInNewContext: true }</code> çš„ <code class="highlighter-rouge">bundle renderer</code> æ—¶ï¼Œå¯ä»¥æ¶ˆé™¤æ­¤çº¦æŸï¼Œä½†æ˜¯ç”±äºéœ€è¦ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡å¹¶é‡æ–°æ‰§è¡Œæ•´ä¸ª bundleï¼Œå› æ­¤ä¼´éšæœ‰ä¸€äº›æ˜¾è‘—æ€§èƒ½å¼€é”€ã€‚å› æ­¤å»ºè®®æ˜¾ç¤ºè®¾ç½®ä¸º <code class="highlighter-rouge">{ runInNewContext: false }</code></p>
</blockquote>

<blockquote>
  <p><a href="https://ssr.vuejs.org/zh/api/#template"><strong>template</strong></a> ä¸ºæ•´ä¸ªé¡µé¢çš„ HTML æä¾›ä¸€ä¸ªæ¨¡æ¿ã€‚æ­¤æ¨¡æ¿åº”åŒ…å«æ³¨é‡Š <code class="highlighter-rouge">&lt;!--vue-ssr-outlet--&gt;</code>ï¼Œä½œä¸ºæ¸²æŸ“åº”ç”¨ç¨‹åºå†…å®¹çš„å ä½ç¬¦ã€‚æ›´å¤š Renderer é…ç½®é¡¹<a href="https://ssr.vuejs.org/zh/api/#cache">å¯å‚è€ƒè¿™é‡Œ</a> ğŸ‘ˆ</p>
</blockquote>

<h3 id="store-æ‹†åˆ†">store æ‹†åˆ†</h3>

<p>å¯¹äºå„æ¨¡å—ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œstate å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä»¥ä¾¿åˆ›å»ºå¤šä¸ªå®ä¾‹åŒ–è¯¥æ¨¡å—:</p>

<pre><code class="language-JS">// store/modules/foo.js
export default {
  namespaced: true,
  // é‡è¦ä¿¡æ¯ï¼šstate å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå› æ­¤å¯ä»¥åˆ›å»ºå¤šä¸ªå®ä¾‹åŒ–è¯¥æ¨¡å—
  state: () =&gt; ({
    count: 0
  }),
  actions: {
    inc: ({ commit }) =&gt; commit('inc')
  },
  mutations: {
    inc: state =&gt; state.count++
  }
}
</code></pre>

<p>æˆ‘ä»¬å¯ä»¥åœ¨è·¯ç”±ç»„ä»¶çš„ <code class="highlighter-rouge">asyncData</code> é’©å­å‡½æ•°ä¸­ï¼Œä½¿ç”¨ <code class="highlighter-rouge">store.registerModule</code> æƒ°æ€§æ³¨å†Œ(lazy-register)è¿™ä¸ªæ¨¡å—:</p>

<pre><code class="language-JS">import fooStoreModule from '../store/modules/foo' // å¯¼å…¥æ¨¡å—

export default {
  asyncData ({ store }) {
    store.registerModule('foo', fooStoreModule)
    return store.dispatch('foo/inc')
  },

  // é‡è¦ä¿¡æ¯ï¼šå½“å¤šæ¬¡è®¿é—®è·¯ç”±æ—¶ï¼Œé¿å…åœ¨å®¢æˆ·ç«¯é‡å¤æ³¨å†Œæ¨¡å—ã€‚
  destroyed () {
    this.$store.unregisterModule('foo')
  },

  computed: {
    fooCount () {
      return this.$store.state.foo.count
    }
  }
}
</code></pre>

<h3 id="å®¢æˆ·ç«¯æ¿€æ´»client-side-hydration">å®¢æˆ·ç«¯æ¿€æ´»(client-side hydration)</h3>

<p>æ‰€è°“<strong>å®¢æˆ·ç«¯æ¿€æ´»</strong>ï¼ŒæŒ‡çš„æ˜¯ Vue åœ¨æµè§ˆå™¨ç«¯æ¥ç®¡ç”±æœåŠ¡ç«¯å‘é€çš„é™æ€ HTMLï¼Œä½¿å…¶å˜ä¸ºç”± Vue ç®¡ç†çš„åŠ¨æ€ DOM çš„è¿‡ç¨‹ã€‚åœ¨ <code class="highlighter-rouge">entry-client.js</code> ä¸­ï¼Œæˆ‘ä»¬ç”¨ä¸‹é¢è¿™è¡ŒæŒ‚è½½(mount)åº”ç”¨ç¨‹åº:</p>

<pre><code class="language-JS">// è¿™é‡Œå‡å®š App.vue template æ ¹å…ƒç´ çš„ `id="app"`
app.$mount('#app')
</code></pre>

<p>åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼ŒVue å°†æ¨æ–­å®¢æˆ·ç«¯ç”Ÿæˆçš„è™šæ‹Ÿ DOM æ ‘ (virtual DOM tree)ï¼Œæ˜¯å¦ä¸ä»æœåŠ¡å™¨æ¸²æŸ“çš„ DOM ç»“æ„ (DOM structure) åŒ¹é…ã€‚å¦‚æœæ— æ³•åŒ¹é…ï¼Œå®ƒå°†é€€å‡ºæ··åˆæ¨¡å¼ï¼Œä¸¢å¼ƒç°æœ‰çš„ DOM å¹¶ä»å¤´å¼€å§‹æ¸²æŸ“ã€‚åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œæ­¤æ£€æµ‹ä¼šè¢«è·³è¿‡ï¼Œä»¥é¿å…æ€§èƒ½æŸè€—ã€‚</p>

<p>ä½¿ç”¨ã€ŒSSR + å®¢æˆ·ç«¯æ··åˆã€æ—¶ï¼Œéœ€è¦äº†è§£çš„ä¸€ä»¶äº‹æ˜¯ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šæ›´æ”¹çš„ä¸€äº›ç‰¹æ®Šçš„ HTML ç»“æ„ã€‚ä¾‹å¦‚ï¼Œå½“ä½ åœ¨ Vue æ¨¡æ¿ä¸­å†™å…¥:</p>

<pre><code class="language-HTML">&lt;table&gt;
  &lt;tr&gt;&lt;td&gt;hi&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;
</code></pre>

<p>æµè§ˆå™¨ä¼šåœ¨ &lt;table&gt; å†…éƒ¨è‡ªåŠ¨æ³¨å…¥ &lt;tbody&gt;ï¼Œç„¶è€Œï¼Œç”±äº Vue ç”Ÿæˆçš„è™šæ‹Ÿ DOM (virtual DOM) ä¸åŒ…å« &lt;tbody&gt;ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´æ— æ³•åŒ¹é…ã€‚ä¸ºèƒ½å¤Ÿæ­£ç¡®åŒ¹é…ï¼Œè¯·ç¡®ä¿åœ¨æ¨¡æ¿ä¸­å†™å…¥æœ‰æ•ˆçš„ HTMLã€‚
å¦‚æœæƒ³é¿å…åœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œå¯åˆ©ç”¨ <code class="highlighter-rouge">vue-no-ssr</code> ç­‰ä¸€äº›åº“æ¥å®ç°:</p>

<pre><code class="language-HTML">&lt;template&gt;
  &lt;div id="app"&gt;
    &lt;h1&gt;My Website&lt;/h1&gt;
    &lt;no-ssr&gt;
      &lt;!-- this component will only be rendered on client-side --&gt;
      &lt;comments /&gt;
    &lt;/no-ssr&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>

<pre><code class="language-JS">  import NoSSR from 'vue-no-ssr'

  export default {
    components: {
      'no-ssr': NoSSR
    }
  }
</code></pre>

<h3 id="æ„å»ºé…ç½®">æ„å»ºé…ç½®</h3>

<p>å»ºè®®å°†é…ç½®åˆ†ä¸ºä¸‰ä¸ªæ–‡ä»¶ï¼š<code class="highlighter-rouge">base</code>, <code class="highlighter-rouge">client</code> å’Œ <code class="highlighter-rouge">server</code>ã€‚åŸºæœ¬é…ç½® (base config) åŒ…å«åœ¨ä¸¤ä¸ªç¯å¢ƒå…±äº«çš„é…ç½®ï¼Œä¾‹å¦‚ï¼Œè¾“å‡ºè·¯å¾„ (output path)ï¼Œåˆ«å (alias) å’Œ loaderã€‚æœåŠ¡å™¨é…ç½® (server config) å’Œå®¢æˆ·ç«¯é…ç½® (client config)ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ <code class="highlighter-rouge">webpack-merge</code> æ¥ç®€å•åœ°æ‰©å±•åŸºæœ¬é…ç½®ã€‚</p>

<h4 id="æœåŠ¡å™¨é…ç½®-server-config">æœåŠ¡å™¨é…ç½® (Server Config)</h4>

<p>æœåŠ¡å™¨é…ç½®ï¼Œæ˜¯ç”¨äºç”Ÿæˆä¼ é€’ç»™ <code class="highlighter-rouge">createBundleRenderer</code> çš„ <code class="highlighter-rouge">server bundle</code>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">merge</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">webpack-merge</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">nodeExternals</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">webpack-node-externals</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">baseConfig</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./webpack.base.config.js</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">VueSSRServerPlugin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">vue-server-renderer/server-plugin</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">baseConfig</span><span class="p">,</span> <span class="p">{</span>
  <span class="c1">// å°† entry æŒ‡å‘åº”ç”¨ç¨‹åºçš„ server entry æ–‡ä»¶</span>
  <span class="na">entry</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/path/to/entry-server.js</span><span class="dl">'</span><span class="p">,</span>

  <span class="c1">// è¿™å…è®¸ webpack ä»¥ Node é€‚ç”¨æ–¹å¼(Node-appropriate fashion)å¤„ç†åŠ¨æ€å¯¼å…¥(dynamic import)ï¼Œ</span>
  <span class="c1">// å¹¶ä¸”è¿˜ä¼šåœ¨ç¼–è¯‘ Vue ç»„ä»¶æ—¶ï¼Œ</span>
  <span class="c1">// å‘ŠçŸ¥ `vue-loader` è¾“é€é¢å‘æœåŠ¡å™¨ä»£ç (server-oriented code)ã€‚</span>
  <span class="na">target</span><span class="p">:</span> <span class="dl">'</span><span class="s1">node</span><span class="dl">'</span><span class="p">,</span>

  <span class="c1">// å¯¹ bundle renderer æä¾› source map æ”¯æŒ</span>
  <span class="na">devtool</span><span class="p">:</span> <span class="dl">'</span><span class="s1">source-map</span><span class="dl">'</span><span class="p">,</span>

  <span class="c1">// æ­¤å¤„å‘ŠçŸ¥ server bundle ä½¿ç”¨ Node é£æ ¼å¯¼å‡ºæ¨¡å—(Node-style exports)</span>
  <span class="na">output</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">path</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">public</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">dist</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">filename</span><span class="p">:</span> <span class="dl">'</span><span class="s1">server-bundle.js</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">libraryTarget</span><span class="p">:</span> <span class="dl">'</span><span class="s1">commonjs2</span><span class="dl">'</span>
  <span class="p">},</span>

  <span class="c1">// https://webpack.js.org/configuration/externals/#function</span>
  <span class="c1">// https://github.com/liady/webpack-node-externals</span>
  <span class="c1">// å¤–ç½®åŒ–åº”ç”¨ç¨‹åºä¾èµ–æ¨¡å—ã€‚å¯ä»¥ä½¿æœåŠ¡å™¨æ„å»ºé€Ÿåº¦æ›´å¿«ï¼Œå¹¶ç”Ÿæˆè¾ƒå°çš„ bundle æ–‡ä»¶ã€‚</span>
  <span class="na">externals</span><span class="p">:</span> <span class="nx">nodeExternals</span><span class="p">({</span>
    <span class="c1">// do not externalize CSS files in case we need to import it from a dep</span>
    <span class="na">whitelist</span><span class="p">:</span> <span class="sr">/</span><span class="se">\.</span><span class="sr">css$/</span>
  <span class="p">}),</span>

  <span class="c1">// è¿™æ˜¯å°†æœåŠ¡å™¨çš„æ•´ä¸ªè¾“å‡º</span>
  <span class="c1">// æ„å»ºä¸ºå•ä¸ª JSON æ–‡ä»¶çš„æ’ä»¶ã€‚</span>
  <span class="c1">// é»˜è®¤æ–‡ä»¶åä¸º `vue-ssr-server-bundle.json`</span>
  <span class="na">plugins</span><span class="p">:</span> <span class="p">[</span>
    <span class="k">new</span> <span class="nx">webpack</span><span class="p">.</span><span class="nx">DefinePlugin</span><span class="p">({</span>
      <span class="dl">'</span><span class="s1">process.env.NODE_ENV</span><span class="dl">'</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">development</span><span class="dl">'</span><span class="p">),</span>
      <span class="dl">'</span><span class="s1">process.env.VUE_ENV</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">"server"</span><span class="dl">'</span>
    <span class="p">}),</span>
    <span class="k">new</span> <span class="nx">VueSSRServerPlugin</span><span class="p">()</span>
  <span class="p">]</span>
<span class="p">})</span>
</code></pre></div></div>

<p>åœ¨ç”Ÿæˆ <code class="highlighter-rouge">vue-ssr-server-bundle.json</code> ä¹‹åï¼Œåªéœ€å°†æ–‡ä»¶è·¯å¾„ä¼ é€’ç»™ <code class="highlighter-rouge">createBundleRenderer</code>:</p>

<pre><code class="language-JS">onst { createBundleRenderer } = require('vue-server-renderer')
const renderer = createBundleRenderer('/path/to/vue-ssr-server-bundle.json', {
  // â€¦â€¦renderer çš„å…¶ä»–é€‰é¡¹
})
</code></pre>

<h4 id="å®¢æˆ·ç«¯é…ç½®-client-config">å®¢æˆ·ç«¯é…ç½® (Client Config)</h4>

<p>æˆ‘ä»¬è¿˜å¯ä»¥ç”Ÿæˆ<strong>å®¢æˆ·ç«¯æ„å»ºæ¸…å• (client build manifest)</strong>ã€‚ä½¿ç”¨å®¢æˆ·ç«¯æ¸…å• (client manifest) å’ŒæœåŠ¡å™¨ bundle(server bundle)ï¼Œrenderer ç°åœ¨å…·æœ‰äº†æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„æ„å»ºä¿¡æ¯ï¼Œå› æ­¤å®ƒå¯ä»¥è‡ªåŠ¨æ¨æ–­å’Œæ³¨å…¥èµ„æºé¢„åŠ è½½ / æ•°æ®é¢„å–æŒ‡ä»¤(preload / prefetch directive)ï¼Œä»¥åŠ css é“¾æ¥ / script æ ‡ç­¾åˆ°æ‰€æ¸²æŸ“çš„ HTML:</p>

<pre><code class="language-JS">const webpack = require('webpack')
const merge = require('webpack-merge')
const base = require('./webpack.base.config')
const SWPrecachePlugin = require('sw-precache-webpack-plugin')
// ç”Ÿæˆä¸€ä¸ªå®¢æˆ·ç«¯æ„å»º manifest å¯¹è±¡ï¼ŒåŒ…å«äº† webpack æ•´ä¸ªæ„å»ºè¿‡ç¨‹çš„ä¿¡æ¯ï¼Œä»è€Œå¯ä»¥è®© bundle renderer è‡ªåŠ¨æ¨å¯¼éœ€è¦åœ¨ HTML æ¨¡æ¿ä¸­æ³¨å…¥çš„å†…å®¹
const VueSSRClientPlugin = require('vue-server-renderer/client-plugin')

const config = merge(base, {
  entry: {
    app: '/path/to/entry-client.js'
  },
  resolve: {
    alias: {
      'create-api': './create-api-client.js'
    }
  },
  plugins: [
    // strip dev-only code in Vue source
    new webpack.DefinePlugin({
      'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV || 'development'),
      'process.env.VUE_ENV': '"client"'
    }),
    // extract vendor chunks for better caching
    new webpack.optimize.CommonsChunkPlugin({
      name: 'vendor',
      minChunks: function (module) {
        // a module is extracted into the vendor chunk if...
        return (
          // it's inside node_modules
          /node_modules/.test(module.context) &amp;&amp;
          // and not a CSS file (due to extract-text-webpack-plugin limitation)
          !/\.css$/.test(module.request)
        )
      }
    }),
    // extract webpack runtime &amp; manifest to avoid vendor chunk hash changing
    // on every build.
    new webpack.optimize.CommonsChunkPlugin({
      name: 'manifest'
    }),
    new VueSSRClientPlugin()
  ]
})

if (process.env.NODE_ENV === 'production') {
  config.plugins.push(
    // auto generate service worker
    new SWPrecachePlugin({
      cacheId: 'vue-hn',
      filename: 'service-worker.js',
      minify: true,
      dontCacheBustUrlsMatching: /./,
      staticFileGlobsIgnorePatterns: [/\.map$/, /\.json$/],
      runtimeCaching: [
        {
          urlPattern: '/',
          handler: 'networkFirst'
        },
        {
          urlPattern: /\/(top|new|show|ask|jobs)/,
          handler: 'networkFirst'
        },
        {
          urlPattern: '/item/:id',
          handler: 'networkFirst'
        },
        {
          urlPattern: '/user/:id',
          handler: 'networkFirst'
        }
      ]
    })
  )
}

module.exports = config
</code></pre>

<h4 id="å¼€å‘ç¯å¢ƒé…ç½®">å¼€å‘ç¯å¢ƒé…ç½®</h4>

<p>ä¸»è¦æ˜¯è®¾ç½®å¼€å‘æ¨¡å¼ä¸­é—´ä»¶ï¼Œæ¯”å¦‚çƒ­é‡è½½ï¼Œé€šè¿‡è¯»å–æ›´æ–°åçš„ bundleï¼Œç„¶åé‡æ–°åˆ›å»º renderer å®ä¾‹ã€‚ç”Ÿäº§æ¨¡å¼ç”±äºæ€§èƒ½é—®é¢˜ä¸å»ºè®®å¼€å¯:</p>

<pre><code class="language-JS">// setup-dev-server.js
const fs = require('fs')
const path = require('path')
const MFS = require('memory-fs')
const webpack = require('webpack')
const chokidar = require('chokidar')
const clientConfig = require('./webpack.client.config')
const serverConfig = require('./webpack.server.config')

const readFile = (fs, file) =&gt; {
  try {
    return fs.readFileSync(path.join(clientConfig.output.path, file), 'utf-8')
  } catch (e) {}
}

module.exports = function setupDevServer (app, templatePath, cb) {
  let bundle
  let template
  let clientManifest

  let ready
  const readyPromise = new Promise(r =&gt; { ready = r })
  const update = () =&gt; {
    if (bundle &amp;&amp; clientManifest) {
      ready()
      cb(bundle, {
        template,
        clientManifest
      })
    }
  }

  // read template from disk and watch
  template = fs.readFileSync(templatePath, 'utf-8')
  chokidar.watch(templatePath).on('change', () =&gt; {
    template = fs.readFileSync(templatePath, 'utf-8')
    console.log('index.html template updated.')
    update()
  })

  // modify client config to work with hot middleware
  clientConfig.entry.app = ['webpack-hot-middleware/client', clientConfig.entry.app]
  clientConfig.output.filename = '[name].js'
  clientConfig.plugins.push(
    new webpack.HotModuleReplacementPlugin(),
    new webpack.NoEmitOnErrorsPlugin()
  )

  // dev middleware
  const clientCompiler = webpack(clientConfig)
  const devMiddleware = require('webpack-dev-middleware')(clientCompiler, {
    publicPath: clientConfig.output.publicPath,
    noInfo: true
  })
  app.use(devMiddleware)
  clientCompiler.plugin('done', stats =&gt; {
    stats = stats.toJson()
    stats.errors.forEach(err =&gt; console.error(err))
    stats.warnings.forEach(err =&gt; console.warn(err))
    if (stats.errors.length) return
    clientManifest = JSON.parse(readFile(
      devMiddleware.fileSystem,
      'vue-ssr-client-manifest.json'
    ))
    update()
  })

  // hot middleware
  app.use(require('webpack-hot-middleware')(clientCompiler, { heartbeat: 5000 }))

  // watch and update server renderer
  const serverCompiler = webpack(serverConfig)
  const mfs = new MFS()
  serverCompiler.outputFileSystem = mfs
  serverCompiler.watch({}, (err, stats) =&gt; {
    if (err) throw err
    stats = stats.toJson()
    if (stats.errors.length) return

    // read bundle generated by vue-ssr-webpack-plugin
    bundle = JSON.parse(readFile(mfs, 'vue-ssr-server-bundle.json'))
    update()
  })

  return readyPromise
}
</code></pre>

<h3 id="ç¼“å­˜">ç¼“å­˜</h3>

<h4 id="é¡µé¢çº§åˆ«ç¼“å­˜">é¡µé¢çº§åˆ«ç¼“å­˜</h4>

<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨åä¸º <a href="https://www.nginx.com/blog/benefits-of-microcaching-nginx/"><strong>micro-caching</strong></a> çš„ç¼“å­˜ç­–ç•¥ï¼Œæ¥å¤§å¹…åº¦æé«˜åº”ç”¨ç¨‹åºå¤„ç†é«˜æµé‡çš„èƒ½åŠ›:</p>

<pre><code class="language-JS">// https://github.com/isaacs/node-lru-cache
const LRU = require('lru-cache')
const microCache = LRU({
  max: 100,
  maxAge: 1000 // é‡è¦æç¤ºï¼šæ¡ç›®åœ¨ 1 ç§’åè¿‡æœŸã€‚
})

const isCacheable = req =&gt; {
  // å®ç°é€»è¾‘ä¸ºï¼Œæ£€æŸ¥è¯·æ±‚æ˜¯å¦æ˜¯ç”¨æˆ·ç‰¹å®š(user-specific)ã€‚
  // åªæœ‰éç”¨æˆ·ç‰¹å®š (non-user-specific) é¡µé¢æ‰ä¼šç¼“å­˜
}

server.get('*', (req, res) =&gt; {
  const cacheable = isCacheable(req)
  if (cacheable) {
    const hit = microCache.get(req.url)
    if (hit) {
      return res.end(hit)
    }
  }

  renderer.renderToString((err, html) =&gt; {
    res.end(html)
    if (cacheable) {
      microCache.set(req.url, html)
    }
  })
})
</code></pre>

<h4 id="ç»„ä»¶çº§åˆ«ç¼“å­˜">ç»„ä»¶çº§åˆ«ç¼“å­˜</h4>

<pre><code class="language-JS">// server.js
function createRenderer (bundle, options) {
  // https://github.com/vuejs/vue/blob/dev/packages/vue-server-renderer/README.md#why-use-bundlerenderer
  return createBundleRenderer(bundle, Object.assign(options, {
    // for component caching
    cache: LRU({
      max: 1000,
      maxAge: 1000 * 60 * 15
    }),
    // this is only needed when vue-server-renderer is npm-linked
    basedir: resolve('./dist'),
    // recommended for performance
    runInNewContext: false
  }))
}
</code></pre>

<p>ç„¶åï¼Œä½ å¯ä»¥é€šè¿‡å®ç° <code class="highlighter-rouge">serverCacheKey</code> å‡½æ•°æ¥ç¼“å­˜ç»„ä»¶:</p>

<pre><code class="language-JS">export default {
  name: 'item', // å¿…å¡«é€‰é¡¹
  props: ['item'],
  serverCacheKey: props =&gt; props.item.id,
  render (h) {
    return h('div', this.item.id)
  }
}
</code></pre>

<p>é€‚ç”¨äºç¼“å­˜çš„æœ€å¸¸è§ç±»å‹çš„ç»„ä»¶ï¼Œæ˜¯åœ¨å¤§çš„ v-for åˆ—è¡¨ä¸­é‡å¤å‡ºç°çš„ç»„ä»¶ã€‚ç”±äºè¿™äº›ç»„ä»¶é€šå¸¸ç”±æ•°æ®åº“é›†åˆ(database collection)ä¸­çš„å¯¹è±¡é©±åŠ¨ï¼Œå®ƒä»¬å¯ä»¥ä½¿ç”¨ç®€å•çš„ç¼“å­˜ç­–ç•¥ï¼šä½¿ç”¨å…¶å”¯ä¸€ idï¼Œå†åŠ ä¸Šæœ€åæ›´æ–°çš„æ—¶é—´æˆ³ï¼Œæ¥ç”Ÿæˆå…¶ç¼“å­˜é”®(cache key):</p>

<pre><code class="language-JS">serverCacheKey: props =&gt; props.item.id + '::' + props.item.last_updated
</code></pre>

<h2 id="nuxt">Nuxt</h2>

<p><a href="https://zh.nuxtjs.org/guide/installation"><strong>Nuxt</strong></a> æ˜¯ä¸€ä¸ªåŸºäº Vue.js çš„é€šç”¨åº”ç”¨æ¡†æ¶ï¼Œé¢„è®¾äº†åˆ©ç”¨ Vue.js å¼€å‘æœåŠ¡ç«¯æ¸²æŸ“çš„åº”ç”¨æ‰€éœ€è¦çš„å„ç§é…ç½®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æä¾›äº†ä¸€ç§å‘½ä»¤å«ï¼š<code class="highlighter-rouge">nuxt generate</code> ï¼Œä¸ºåŸºäº Vue.js çš„åº”ç”¨æä¾›ç”Ÿæˆå¯¹åº”çš„é™æ€ç«™ç‚¹çš„åŠŸèƒ½ã€‚æˆ‘ä»¬ç›¸ä¿¡è¿™ä¸ªå‘½ä»¤æ‰€æä¾›çš„åŠŸèƒ½ï¼Œæ˜¯å‘å¼€å‘é›†æˆå„ç§å¾®æœåŠ¡ï¼ˆMicroservicesï¼‰çš„ Web åº”ç”¨è¿ˆå¼€çš„æ–°ä¸€æ­¥:</p>

<p><img src="https://zh.nuxtjs.org/nuxt-schema.svg" alt="Nuxt.js" /></p>

<blockquote>
  <p>è‡³äºæœåŠ¡ç«¯æ¸²æŸ“ï¼Œç›®å‰å®è·µçš„å…¶å®ä¸å¤šï¼ŒTo be continued</p>
</blockquote>
 
<div id="gitalk-container"></div>
<script>
    var gitalk = new Gitalk({
      enable: true,
      clientID: '020f142489f80c92b097',
      clientSecret: '1fa083372b44031cf1b8249251515c4e3d54c69d',
      repo: 'tate-young.github.io',
      owner: 'Tate-Young',
      admin: ['Tate-Young'],
      id: location.pathname,      // Ensure uniqueness and length less than 50
      distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script>
<!-- disqus -->
<!-- <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function () {
        this.page.url = 'https://tate-young.github.io/2019/08/13/vue-ssr.html';
        this.page.identifier = '/2019/08/13/vue-ssr';
        this.page.title = 'Vue SSR';
    };

    (function () { // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document,
            s = d.createElement('script');

        s.src = '//tate.disqus.com/embed.js'; // IMPORTANT: Replace EXAMPLE with your forum shortname!

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript> -->


            <!-- <p class="post-info">
			æœ¬æ–‡ç”± <a href="/">liberxue</a> åˆ›ä½œï¼Œé‡‡ç”¨ <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external nofollow">çŸ¥è¯†å…±äº«ç½²å4.0</a> å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯<br>æœ¬ç«™æ–‡ç« é™¤æ³¨æ˜è½¬è½½/å‡ºå¤„å¤–ï¼Œå‡ä¸ºæœ¬ç«™åŸåˆ›æˆ–ç¿»è¯‘ï¼Œè½¬è½½å‰è¯·åŠ¡å¿…ç½²å<br>æœ€åç¼–è¾‘æ—¶é—´ä¸º:2019-08-13 17:11:00</p> -->
        </div>
    </article>

    <!-- <div class="related-post-lists">
	<div class="post-lists">
		<div class="post-lists-body">
					<div class="post-list-item">
				<div class="post-list-item-container">
					<div class="item-label">
						<div class="item-title"><a href="induction.html">å½’çº³çš„éšæƒ³</a></div>
						<div class="item-meta clearfix">
														<div class="item-meta-ico bg-ico-image" style="background: url('../usr/themes/pinghsu/images/bg-ico.png') no-repeat;background-size: 40px auto;"></div>
	                        							<div class="item-meta-cat"><a href="../category/thoughts/index.html">Thoughts</a></div>
						</div>
					</div>
				</div>
			</div>
				</div>
	</div>
</div> -->

    <!-- <footer class="footer bg-white">
	<div class="footer-social">
		<div class="footer-container clearfix">
			<div class="social-list">
	 <a class="social segmentfault" target="blank" href="https://segmentfault.com/u/liberxue" title="è®¿é—® LiberXue_Twitter" data-hover="Segmentfault">Segmentfault</a>
    <a class="social github" target="blank" href="https://github.com/liberxue" title="è®¿é—® LiberXue_Twitter" data-hover="GitHub">GitHub</a>
    <a class="social twitter" target="blank" href="http://twitter.com/liberxue" title="è®¿é—® LiberXue_Twitter" data-hover="Twitter">Twitter</a>
     <a class="social stackoverflow" target="blank" href="https://stackoverflow.com/users/6902190/liberxue" title="è®¿é—® LiberXue_stackoverflow" data-hover="StackOverflow">StackOverflow</a>
          <a class="social oschina" target="blank" href="https://my.oschina.net/bolanzw" title="è®¿é—® LiberXue_Oschina" data-hover="Oschina">Oschina</a>
     <a class="social rss" target="blank" href="/feed.xml"title="è®¿é—® LiberXue_RSS" data-hover="RSS">RSS</a>
	</div>
		</div>
	</div>
	<div class="footer-meta">
        <div class="footer-container">
            <div class="meta-item meta-copyright">
                <div class="meta-copyright-info">
                    <a href="/" class="info-logo">
                         <img src="http://localhost:2333/style/images/logo-liberxue.png"   title="è®¿é—® LiberXue_blog" data-hover="LiberXue_blog" alt="LiberXue_blog" /> </a>
                    <div class="info-text">
                        <p>Theme is <a href="http://www.liberxue.com/2017/08/03/Jekyllthemes.html" title="è®¿é—® Jekyll liberxueä¸»é¢˜"  data-hover="Jekyll liberxue"target="_blank">Jekyll liberxue</a> by <a href="http://www.liberxue.com/about" target="_blank">liberxue</a></p>
                        <p>Powered by <a href="http://localhost:2333/tags/#Jekyll" title="Jekyll" data-hover="Jekyll" target="_blank" rel="nofollow">Jekyll</a></p>
                        <p>&copy; 2017 <a href="/feed.xml"  title="è®¿é—® liberxue blog RSS" data-hover="liberxue blog RSS">liberxue blog RSS</a></p>
                        <p>æ€»è®¡æ–‡ç« ï¼šç¯‡</p>
                      <p>æœ¬blogå·²å¼€æºç‚¹å‡»Fork</p><iframe src="http://ghbtns.com/github-btn.html?user=liberxue&repo=liberxue.github.io&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="95" height="20"></iframe>
                    </div>
                </div>
            </div>
            <div class="meta-item meta-posts">
                <h3 class="meta-title">ç½®é¡¶æ–‡ç« </h3>
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
            </div>
            <div class="meta-item meta-comments">
                <h3 class="meta-title">æœ€æ–°æ–‡ç« </h3>
  
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
</div>
		</div>
    </div>
</footer> -->
<script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.js"></script>
<script async src="/search/js/520.js"></script>
<script async src="/search/js/gtag.js"></script>
<script async src="/search/live2d/autoload.js"></script>
<!-- <script src="/search/js/canvas.js"></script> -->

<script>
    $(function () {
        setTimeout(function () {
            $('code').removeClass('hljs');
            $('code').removeClass('language');
        }, 90);
    });
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    <!--liberxueconnnet-menu-->
    <div id="directory-content" class="directory-content">
        <div id="directory"></div>
    </div>
    <!--liberxueconnnet-menu-->
    <script>
      const directoryContainer = document.getElementById('directory')
      const postTitle = document.getElementsByClassName('post-title')[0]
      var postDirectoryBuild = function () {
        var postChildren = function children(childNodes, reg) {
          var result = [],
              isReg = typeof reg === 'object',
              isStr = typeof reg === 'string',
              node, i, len;
          for (i = 0, len = childNodes.length; i < len; i++) {
            node = childNodes[i];
            if ((node.nodeType === 1 || node.nodeType === 9) &&
              (!reg ||
                  isReg && reg.test(node.tagName.toLowerCase()) ||
                  isStr && node.tagName.toLowerCase() === reg)) {
                result.push(node);
              }
            }
            return result;
          },
          createPostDirectory = function (article, directory, isDirNum) {
            var contentArr = [],
                titleId = [],
                levelArr, root, level,
                currentList, list, li, link, i, len;
            levelArr = (function (article, contentArr, titleId) {
                  var titleElem = postChildren(article.childNodes, /^h\d$/),
                      levelArr = [],
                      lastNum = 1,
                      lastRevNum = 1,
                      count = 0,
                      guid = 1,
                      id = 'directory' + (Math.random() + '').replace(/\D/, ''),
                      lastRevNum, num, elem;
                  while (titleElem.length) {
                      elem = titleElem.shift();
                      contentArr.push(elem.innerHTML);
                      num = +elem.tagName.match(/\d/)[0];
                      if (num > lastNum) {
                          levelArr.push(1);
                          lastRevNum += 1;
                      } else if (num === lastRevNum ||
                          num > lastRevNum && num <= lastNum) {
                          levelArr.push(0);
                          lastRevNum = lastRevNum;
                      } else if (num < lastRevNum) {
                          levelArr.push(num - lastRevNum);
                          lastRevNum = num;
                      }
                      count += levelArr[levelArr.length - 1];
                      lastNum = num;
                      elem.id = elem.id || (id + guid++);
                      titleId.push(elem.id);
                  }
                  if (count !== 0 && levelArr[0] === 1) levelArr[0] = 0;

                  return levelArr;
              })(article, contentArr, titleId);
              currentList = root = document.createElement('ul');
              dirNum = [0];
              for (i = 0, len = levelArr.length; i < len; i++) {
                  level = levelArr[i];
                  if (level === 1) {
                      list = document.createElement('ul');
                      if (!currentList.lastElementChild) {
                          currentList.appendChild(document.createElement('li'));
                      }
                      currentList.lastElementChild.appendChild(list);
                      currentList = list;
                      dirNum.push(0);
                  } else if (level < 0) {
                      level *= 2;
                      while (level++) {
                          if (level % 2) dirNum.pop();
                          currentList = currentList.parentNode;
                      }
                  }
                  dirNum[dirNum.length - 1]++;
                  li = document.createElement('li');
                  link = document.createElement('a');
                  link.name = '#' + titleId[i];
                  link.href = 'Javascript:;'
                  link.className = "post-aside-anchor"
                  link.title = 'è®¿é—®' + titleId[i];
                  link.innerHTML = !isDirNum ? contentArr[i] :
                      dirNum.join('.') + ' ' + contentArr[i];
                  li.appendChild(link);
                  currentList.appendChild(li);
              }
            directory.appendChild(root);
          };
        createPostDirectory(document.getElementById('post-content'), directoryContainer, true);
      };
      postDirectoryBuild();
    </script>
    <script>
      // gtag('config', GA_TRACKING_ID, {
      //   'page_title' : 'Blog',
      //   'page_path': window.location.pathname,
      //   'post_title': 'watttsdfasdf',
      // });

    </script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script>
        lang = hljs.initHighlightingOnLoad();
    </script>
</body>

</html>
