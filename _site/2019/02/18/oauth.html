
<!DOCTYPE>
<html lang="zh-cn" data-scribe-reduced-action-queue="true">
<head>
    <meta content='OAuth 2.0 及 SSO 单点登录 - Tate & Snow' name='title' />
    <meta content='OAuth 2.0 及 SSO 单点登录 - Tate & Snow' name='og:title' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <title>OAuth 2.0 及 SSO 单点登录 - Tate & Snow</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>OAuth 2.0 及 SSO 单点登录 - Tate & Snow</title>
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OAuth 2.0 及 SSO 单点登录 - Tate & Snow">
<meta name="twitter:keywords" content="OAuth 2.0 及 SSO 单点登录 - Tate & Snow" property='og:description' />
<meta property="og:type" content="article">
<meta property="og:title" content="OAuth 2.0 及 SSO 单点登录 - Tate & Snow">
<meta name="og:keywords" content="OAuth 2.0 及 SSO 单点登录 - Tate & Snow|OAuth 2.0 及 SSO 单点登录什么是 OAuthOAuth 即开放授权，是一个开放标准，允许用户让第三方应用访问该用户在某一网站上存储的私密的资源，而无需将用户名和密码提供给第三方应用。比如访问某小程序又不想注册时则可以使用..."
  property='og:description' />
<link rel="icon" type="image/png" href="http://localhost:2333/style/favicons/favicon.ico" />
<link href="http://localhost:2333/style/favicons/favicon.ico" rel="shortcut icon" type="image/png">
<link rel="canonical" href="http://localhost:2333/">
<link rel="alternate" type="application/rss+xml" title="Liberxue" href="http://localhost:2333/feed.xml">
<meta charset="UTF-8">
<link rel="manifest" href="/manifest.json">
<link rel="shortcut icon" href="http://localhost:2333/style/favicons/favicon.ico" type="image/x-icon">
<meta name="keywords" content="OAuth 2.0 及 SSO 单点登录什么是 OAuthOAuth 即开放授权，是一个开放标准，允许用户让第三方应用访问该用户在某一网站上存储的私密的资源，而无需将用户名和密码提供给第三方应用。比如访问某小程序又不想注册时则可以使用..." property='og:description'
/>
<meta name="description" content="Tate & Snow's Github blog" />
<link href="https://cdn.bootcss.com/highlight.js/9.10.0/styles/xcode.min.css" rel="stylesheet">
<link href="http://localhost:2333/style/theme.css" rel="stylesheet"> 
<meta content='http://localhost:2333/2019/02/18/oauth.html' property='og:url' />
<meta content="http://localhost:2333/2019/02/18/oauth.html|OAuth 2.0 及 SSO 单点登录什么是 OAuthOAuth 即开放授权，是一个开放标准，允许用户让第三方应用访问该用户在某一网站上存储的私密的资源，而无需将用户名和密码提供给第三方应用。比如访问某小程序又不想注册时则可以使用..." property='og:description'
/>
<meta content="article" property="og:type" /> 

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-136311746-1"></script>
<!-- <script async src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>
<script>
  window.dataLayer = window.dataLayer || [];
  window.GA_TRACKING_ID = 'UA-136311746-1'
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('set', {
    'country': 'US',
    'currency': 'USD',
    'description': 'fuck',
  });
  gtag('config', GA_TRACKING_ID, {
    'custom_map': {
      'dimension1': 'post_title',
    },
    'post_title': 'test',
  });
</script>
<meta content="" property="fb:app_id" />
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>OAuth 2.0 及 SSO 单点登录 | Tate &amp; Snow</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="OAuth 2.0 及 SSO 单点登录" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="add SSO cas" />
<meta property="og:description" content="add SSO cas" />
<link rel="canonical" href="http://localhost:2333/2019/02/18/oauth.html" />
<meta property="og:url" content="http://localhost:2333/2019/02/18/oauth.html" />
<meta property="og:site_name" content="Tate &amp; Snow" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-02-18T17:47:00+08:00" />
<script type="application/ld+json">
{"description":"add SSO cas","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:2333/2019/02/18/oauth.html"},"@type":"BlogPosting","url":"http://localhost:2333/2019/02/18/oauth.html","headline":"OAuth 2.0 及 SSO 单点登录","dateModified":"2019-02-18T17:47:00+08:00","datePublished":"2019-02-18T17:47:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<script>
  (function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s);
    js.id = id;
    js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

</head>

<body class="dark-theme" gtools_scp_screen_capture_injected="true">
    <header id="header" class="header bg-white">
        <div class="navbar-container">
            <a href="Javascript:;" onclick="onClickLogo()" title="访问 Tate & Snow" class="navbar-logo menu-logo">
                <img src="http://localhost:2333/style/images/tate.webp" alt="Tate & Snow"> </a>
            <!-- <a href="/?tate" title="访问 Tate & Snow" class="navbar-logo">Tate & Snow</a>   -->
            <div class="navbar-menu">
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('首页', '/')" title="访问 首页" data-hover="首页">首页</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('前端', '/front')" title="访问 前端" data-hover="前端">前端</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('历史', '/history')" title="访问 历史" data-hover="历史">历史</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('其他', '/other')" title="访问 其他" data-hover="其他">其他</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('标签', '/tags')" title="访问 标签" data-hover="标签">标签</a>
                
                  <a class=" menu-item-about " href="Javascript:;" onclick="onClickMenu('关于', '/README')" title="访问 关于" data-hover="关于">关于</a>
                
            </div>
            <!-- <div class="navbar-menu">
                
                <a href="http://localhost:2333/">首页</a>
                
                <a href="http://localhost:2333/front">前端</a>
                
                <a href="http://localhost:2333/history">历史</a>
                
                <a href="http://localhost:2333/other">其他</a>
                
                <a href="http://localhost:2333/tags">标签</a>
                
                <a href="http://localhost:2333/README">关于</a>
                
            </div> -->
            <div class="navbar-search menu-item-search" onclick="onClickSearch()">
                <span class="icon-search"></span>
                <form id="cb-search-btn" role="search">
                    <span class="search-box">
                        <input type="text" class="input" id="cb-search-content" required="true" placeholder="标题 标签..." maxlength="30" autocomplete="off">
                    </span>
                </form>
            </div>
            <div class="navbar-mobile-menu" onclick="">
                <span class="icon-menu cross">
                    <span class="middle"></span>
                </span>
                <ul>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('首页', 'http://localhost:2333/')">首页</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('前端', 'http://localhost:2333/front')">前端</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('历史', 'http://localhost:2333/history')">历史</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('其他', 'http://localhost:2333/other')">其他</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('标签', 'http://localhost:2333/tags')">标签</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('关于', 'http://localhost:2333/README')">关于</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </header>
    <a href="#header" class="back-to-top" onclick="onClickTop('OAuth 2.0 及 SSO 单点登录')">⤴Top⤴</a>
    <div class="post-header-thumb bg-white}">
        <div class="post-header-thumb-op"></div>
        <div class="post-header-thumb">
            <div class="post-header-thumb-container">
                <h1 class="post-title" itemprop="name headline">
                    OAuth 2.0 及 SSO 单点登录</h1>
                <div class="post-data">
                    <time datetime="2019-02-18 17:47:00" itemprop="datePublished">
                      发布时间：2019-02-18 17:47:00
                      &nbsp;&nbsp;&nbsp;
                      
                        修改时间：2022-09-19 15:37:00
                      
                    </time>
                    <a onclick="onClickCategory('后端')" href="Javascript:;" title="访问 后端" data-hover="博客分类: 后端">博客分类: 后端</a>
                    <!-- <a href="#read"> 阅读次数: comments</a>  -->
                </div>
                
                  <div role='update-description' class="post-data">
                    修改内容：add SSO cas
                  </div>
                
                <div class="post-tags">
                       
                    <a class="menu-item-tags" href="Javascript:;" onclick="onClickTag('Server')" title="访问Server" data-hover="Server">
                        Server
                        <span>(4)</span>
                        
                    </a>
                       
                </div>
            </div>
        </div>
    </div>
    <article class="main-content post-page" itemscope itemtype="http://schema.org/Article">
        <div class="post-header">
            <h1 class="post-title" itemprop="name headline">
                OAuth 2.0 及 SSO 单点登录</h1>
            <div class="post-data">
                <time datetime="2019-02-18 17:47:00" itemprop="datePublished">2019-02-18 17:47:00</time>
            </div>
        </div>
        <div id="post-content" class="post-content" itemprop="articleBody">
            <p class="post-tags">
                   
                <a href="Javascript:;" onclick="onClickTag('Server')" title="访问Server" data-hover="Server">
                    Server
                    <span>(4)</span>
                    </a>
                   
            </p>
            <h1 id="oauth-20-及-sso-单点登录">OAuth 2.0 及 SSO 单点登录</h1>

<h2 id="什么是-oauth">什么是 OAuth</h2>

<p><strong>OAuth</strong> 即开放授权，是一个开放标准，允许用户让第三方应用访问该用户在某一网站上存储的私密的资源，而无需将用户名和密码提供给第三方应用。比如访问某小程序又不想注册时则可以使用微信授权。以下主要介绍 <strong>OAuth 2.0</strong> ，它是 OAuth 协议的下一版本，但不向下兼容 OAuth 1.0。</p>

<h3 id="运行流程">运行流程</h3>

<pre><code class="language-TEXT">     +--------+                               +---------------+
     |        |--(A)- Authorization Request -&gt;|   Resource    |                   A. 用户要访问客户端时，客户端需要用户给予授权。
     |        |                               |     Owner     |
     |        |&lt;-(B)-- Authorization Grant ---|               |                   B. 用户同意给予客户端授权。
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(C)-- Authorization Grant --&gt;| Authorization |                   C. 客户端向认证服务器申请令牌。
     | Client |                               |     Server    |
     |        |&lt;-(D)----- Access Token -------|               |                   D. 认证服务器对客户端进行认证后发放令牌。
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(E)----- Access Token ------&gt;|    Resource   |                   E. 客户端使用令牌，向资源服务器申请获取资源。
     |        |                               |     Server    |
     |        |&lt;-(F)--- Protected Resource ---|               |                   F. 资源服务器确认令牌无误，同意向客户端开放资源。
     +--------+                               +---------------+
</code></pre>

<h4 id="授权模式">授权模式</h4>

<p>客户端必须得到用户的<strong>授权(authorization grant)</strong>，才能获得<strong>令牌(access token)</strong>。OAuth 2.0 定义了四种授权方式:</p>

<ul>
  <li>授权码模式(authorization code)</li>
  <li>简化模式(implicit)</li>
  <li>密码模式(resource owner password credentials)</li>
  <li>客户端模式(client credentials)</li>
</ul>

<h4 id="授权码模式">授权码模式</h4>

<p><strong>授权码模式(authorization code)</strong>是功能最完整、流程最严密的授权模式。它的特点就是通过客户端的后台服务器，与”服务提供商”的认证服务器进行互动:</p>

<pre><code class="language-TEXT">     +----------+
     | Resource |
     |   Owner  |
     |          |
     +----------+
          ^
          |
         (B)
     +----|-----+          Client Identifier      +---------------+
     |         -+----(A)-- &amp; Redirection URI ----&gt;|               |                   A. 用户访问客户端，后者将前者导向认证服务器。
     |  User-   |                                 | Authorization |
     |  Agent  -+----(B)-- User authenticates ---&gt;|     Server    |                   B. 用户选择是否给予客户端授权。
     |          |                                 |               |
     |         -+----(C)-- Authorization Code ---&lt;|               |                   C. 认证服务器将用户导向客户端事先指定的重定向地址，同时附上一个授权码 code。
     +-|----|---+                                 +---------------+
       |    |                                         ^      v
      (A)  (C)                                        |      |
       |    |                                         |      |
       ^    v                                         |      |
     +---------+                                      |      |
     |         |&gt;---(D)-- Authorization Code ---------'      |                        D. 客户端收到授权码，向认证服务器申请令牌。
     |  Client |          &amp; Redirection URI                  |
     |         |                                             |
     |         |&lt;---(E)----- Access Token -------------------'                        E. 认证服务器核对了授权码和重定向 URI，确认无误后，向客户端发送访问令牌和更新令牌。
     +---------+       (w/ Optional Refresh Token)
</code></pre>

<p>A 步骤中，客户端申请认证的 URI，包含以下参数:</p>

<ul>
  <li><strong>response_type</strong> - 必选。表示授权类型，固定值为 “code”</li>
  <li><strong>client_id</strong> - 必选。表示客户端的 ID</li>
  <li><strong>redirect_uri</strong> - 可选。表示重定向 URI</li>
  <li>scope - 可选。表示申请的权限范围</li>
  <li>state - 表示客户端的当前状态，可以指定任意值，认证服务器会原封不动地返回这个值</li>
</ul>

<pre><code class="language-TEXT">/authorize?response_type=code&amp;client_id=s6BhdRkqt3&amp;state=xyz&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb

&lt;!-- 简书登录跳微信认证的页面 --&gt;
https://open.weixin.qq.com/connect/qrconnect?appid=wxe9199d568fe57fdd&amp;client_id=wxe9199d568fe57fdd&amp;redirect_uri=http%3A%2F%2Fwww.jianshu.com%2Fusers%2Fauth%2Fwechat%2Fcallback&amp;response_type=code&amp;scope=snsapi_login&amp;state=%257B%257D#wechat_redirect
</code></pre>

<p>C 步骤中，服务器回应客户端的 URI，包含以下参数:</p>

<ul>
  <li><strong>code</strong> - 必选。表示授权码，具有较短的有效期且客户端只能使用一次，否则会被授权服务器拒绝。该码与客户端 ID 和重定向 URI，是一一对应关系</li>
  <li>state - 如果客户端的请求中包含这个参数，则原封不动返回</li>
</ul>

<pre><code class="language-TEXT">https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA&amp;state=xyz
</code></pre>

<p>D 步骤中，客户端向认证服务器申请令牌的 HTTP 请求，包含以下参数:</p>

<ul>
  <li><strong>grant_type</strong> - 必选。表示使用的授权模式，值固定为 “authorization_code”</li>
  <li>code - 必选。表示上一步获得的授权码</li>
  <li>redirect_uri - 必选、表示重定向 URI，且必须与 A 步骤中的该参数值保持一致</li>
  <li>client_id - 必选。表示客户端 ID</li>
</ul>

<pre><code class="language-TEXT">grant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb
</code></pre>

<p>E 步骤中，认证服务器发送的 HTTP 回复，包含以下参数:</p>

<ul>
  <li><strong>access_token</strong> - 必选。表示访问令牌</li>
  <li>token_type - 必选。表示令牌类型，该值大小写不敏感，可以是 bearer 类型或 mac 类型</li>
  <li>expires_in - 表示过期时间，单位为秒。如果省略该参数，必须其他方式设置过期时间</li>
  <li>refresh_token - 可选。表示更新令牌，用来获取下一次的访问令牌</li>
  <li>scope - 表示权限范围，如果与客户端申请的范围一致，此项可省略</li>
</ul>

<pre><code class="language-JSON">{
  "access_token": "2YotnFZFEjr1zCsicMWpAA",
  "token_type": "example",
  "expires_in": 3600,
  "refresh_token": "tGzv3JOkF0XG5Qx2TlKWIA",
  "example_parameter": "example_value"
}
</code></pre>

<h4 id="简化模式">简化模式</h4>

<p>简化模式(implicit grant type)不通过第三方应用程序的服务器，直接在浏览器中向认证服务器申请令牌，跳过了”授权码”这个步骤。所有步骤在浏览器中完成，令牌对访问者是可见的，且客户端不需要认证:</p>

<pre><code class="language-TEXT">     +----------+
     | Resource |
     |  Owner   |
     |          |
     +----------+
          ^
          |
         (B)
     +----|-----+          Client Identifier     +---------------+
     |         -+----(A)-- &amp; Redirection URI ---&gt;|               |                    A. 客户端将用户导向认证服务器。
     |  User-   |                                | Authorization |
     |  Agent  -|----(B)-- User authenticates --&gt;|     Server    |                    B. 用户选择是否给于客户端授权。
     |          |                                |               |
     |          |&lt;---(C)--- Redirection URI ----&lt;|               |                    C. 认证服务器将用户导向客户端事先指定的重定向地址，并在 URI 的 Hash 部分包含了访问令牌。
     |          |          with Access Token     +---------------+
     |          |            in Fragment
     |          |                                +---------------+
     |          |----(D)--- Redirection URI ----&gt;|   Web-Hosted  |                    D. 浏览器向资源服务器发出请求，其中不包括上一步收到的 Hash 值。
     |          |          without Fragment      |     Client    |
     |          |                                |    Resource   |
     |     (F)  |&lt;---(E)------- Script ---------&lt;|               |                    E. 资源服务器返回一个网页，其中包含的代码可以获取 Hash 值中的令牌。
     |          |                                +---------------+                    F. 浏览器执行上一步获得的脚本，提取出令牌。
     +-|--------+
       |    |
      (A)  (G) Access Token                                                           G. 浏览器将令牌发给客户端。
       |    |
       ^    v
     +---------+
     |         |
     |  Client |
     |         |
     +---------+
</code></pre>

<h4 id="密码模式">密码模式</h4>

<p><strong>密码模式(Resource Owner Password Credentials Grant)</strong>中，用户向客户端提供自己的用户名和密码。客户端使用这些信息，向”服务商提供商”索要授权。在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而认证服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式:</p>

<pre><code class="language-TEXT">     +----------+
     | Resource |
     |  Owner   |
     |          |
     +----------+
          v
          |    Resource Owner
         (A) Password Credentials                                                     A. 用户向客户端提供用户名和密码。
          |
          v
     +---------+                                  +---------------+
     |         |&gt;--(B)---- Resource Owner -------&gt;|               |                   B. 客户端将用户名和密码发给认证服务器，向后者请求令牌。
     |         |         Password Credentials     | Authorization |
     | Client  |                                  |     Server    |
     |         |&lt;--(C)---- Access Token ---------&lt;|               |                   C. 认证服务器确认无误后，向客户端提供访问令牌。
     |         |    (w/ Optional Refresh Token)   |               |
     +---------+                                  +---------------+
</code></pre>

<h4 id="客户端模式">客户端模式</h4>

<p><strong>客户端模式(Client Credentials Grant)</strong>指客户端以自己的名义，而不是以用户的名义，向”服务提供商”进行认证。严格地说，客户端模式并不属于 OAuth 框架所要解决的问题。在这种模式中，用户直接向客户端注册，客户端以自己的名义要求”服务提供商”提供服务，其实不存在授权问题:</p>

<pre><code class="language-TEXT">     +---------+                                  +---------------+
     |         |                                  |               |
     |         |&gt;--(A)- Client Authentication ---&gt;| Authorization |                   A. 客户端向认证服务器进行身份认证，并要求一个访问令牌。
     | Client  |                                  |     Server    |
     |         |&lt;--(B)---- Access Token ---------&lt;|               |                   B. 认证服务器确认无误后，向客户端提供访问令牌。
     |         |                                  |               |
     +---------+                                  +---------------+
</code></pre>

<h3 id="更新令牌">更新令牌</h3>

<p>如果用户访问的时候，客户端的”访问令牌”已经过期，则需要使用”更新令牌”申请一个新的访问令牌:</p>

<pre><code class="language-TEXT">  +--------+                                           +---------------+
  |        |--(A)------- Authorization Grant ---------&gt;|               |
  |        |                                           |               |
  |        |&lt;-(B)----------- Access Token -------------|               |
  |        |               &amp; Refresh Token             |               |
  |        |                                           |               |
  |        |                            +----------+   |               |
  |        |--(C)---- Access Token ----&gt;|          |   |               |
  |        |                            |          |   |               |
  |        |&lt;-(D)- Protected Resource --| Resource |   | Authorization |
  | Client |                            |  Server  |   |     Server    |
  |        |--(E)---- Access Token ----&gt;|          |   |               |
  |        |                            |          |   |               |
  |        |&lt;-(F)- Invalid Token Error -|          |   |               |
  |        |                            +----------+   |               |
  |        |                                           |               |
  |        |--(G)----------- Refresh Token -----------&gt;|               |
  |        |                                           |               |
  |        |&lt;-(H)----------- Access Token -------------|               |
  +--------+           &amp; Optional Refresh Token        +---------------+
</code></pre>

<h3 id="部署">部署</h3>

<p>推荐<a href="https://waylau.com/principle-and-practice-of-oauth2/">阅读这篇文章</a> 👈</p>

<h2 id="什么是单点登录">什么是单点登录</h2>

<p><strong>单点登录(Single Sign On，即 SSO)</strong>是多域名企业站点流行的登录方式，指用户只需输入一次账密，在一处完成登录，之后可以直接进入所有业务系统。想要完成单点登录的效果，必须有一个唯一身份源，其他业务系统必须配合完成改造和对接。目前主流的 SSO 技术有 CAS、OAuth2、SAML、xxl-sso 等。</p>

<h3 id="同域下的单点登录实现">同域下的单点登录实现</h3>

<p>普通的登陆认证机制可以基于 cookie 和 session 去实现，具体可<a href="http://localhost:2333/2018/03/02/http-cookie-session.html#session">参考这篇</a>。</p>

<p>一个企业一般情况下只有一个域名，通过二级域名区分不同的系统。比如我们有个域名叫做：a.com，同时有两个业务系统分别为：app1.a.com 和 app2.a.com。我们要做单点登录，需要一个登录系统，叫做：sso.a.com。</p>

<p>我们只要在 sso.a.com 登录，app1.a.com 和 app2.a.com 就也登录了。通过上面的登陆认证机制，我们可以知道，在 sso.a.com 中登录了，其实是在 sso.a.com 的服务端的 session 中记录了登录状态，同时在浏览器端的 sso.a.com 下写入了 Cookie。那么我们怎么才能让 app1.a.com 和 app2.a.com 登录呢？这里有两个问题：</p>

<ol>
  <li>Cookie 是不能跨域携带的，我们 Cookie 的 domain 属性是 sso.a.com，在给 app1.a.com 和 app2.a.com 发送请求是带不上的。</li>
  <li>sso、app1 和 app2 是不同的应用，它们的 session 存在自己的应用内，是不共享的。</li>
</ol>

<p>解决方案：</p>

<ol>
  <li>可以将 Cookie 的域设置为顶域，即.a.com，这样所有子域的系统都可以访问到顶域的 Cookie</li>
  <li>共享 Session 的解决方案有很多，例如：Spring-Session</li>
</ol>

<p><img src="http://localhost:2333/style/images/smms/sso-cookie-session.webp" alt="sso-cookie-session" /></p>

<h3 id="跨域下的单点登录-cas-实现">跨域下的单点登录 CAS 实现</h3>

<p>同域下的单点登录是巧用了 Cookie 顶域的特性。跨域的话可以使用 CAS 流程，这个流程是单点登录的标准流程。<a href="https://apereo.github.io/cas/6.6.x/index.html"><strong>CAS(Central Authentication Service)</strong></a> 即中心授权服务，是耶鲁大学发起的一个开源项目，旨在为 Web 应用系统提供一种可靠的单点登录方法：</p>

<ol>
  <li>用户访问 app.example.com 网页，但用户未登录。</li>
  <li>跳转到 CAS server，即 SSO 登录系统。SSO server 找不到用户信息，弹出用户登录页。</li>
  <li>用户填写用户名、密码，SSO server 进行认证后，将登录状态写入 SSO 的 session(key 为 TGT，即 Ticket Granting Ticket)，浏览器中写入 SSO 域下的 Cookie(名称为 CASTGC)。</li>
  <li>SSO server 登录完成后会生成一个 ST（Service Ticket），然后跳转到网页，同时将 ST 作为参数传递给网页。</li>
  <li>网页拿到 ST 后，向 SSO 发送请求，验证 ST 是否有效。</li>
  <li>验证通过后，网页将更新 session 并设置客户端的 Cookie(默认名为 jSESSIONID)。</li>
  <li>用户再次访问该网页时，带上 cookie 即可认证。如果访问的是网页 2，由于 SSO 能够检测到用户，所以也不需要重新登录了，分配新的 ST 即可</li>
</ol>

<p><img src="http://localhost:2333/style/images/smms/sso-cas.webp" alt="sso-cas" /></p>

<p>至于为啥中间要多一步 ST 认证环节？用户在给 SSO 服务器提供了用户名密码后，作为业务系统并不知道这件事。SSO 随便给业务系统一个 ST，那么业务系统是不能确定这个 ST 是用户伪造的，还是真的有效，所以要拿着这个 ST 去 SSO 服务器再问一下，这个用户给我的 ST 是否有效，是有效的我才能让这个用户访问。</p>

<p>总体而言。从开发集成难易程度方面考虑，依次为 CAS、OAuth2 稍复杂，SAML 最复杂。OAuth2 是目前互联网最流行的单点登录技术，比如微信平台、QQ 平台、钉钉平台等，但在企业应用方面，OAuth2 使用远没有 CAS 多，尤其是企业存在大量的存量系统，有的是前后端分离架构，基于 token 认证鉴权，有的是传统 SOA 架构，基于中间件 session 会话认证鉴权，所以在企业内部改造 OAuth2 的成本比较高。SAML 是协议最复杂的一种 SSO，安全性最好，仅仅适用于 web，开发集成难度高，一般企业内部的应用系统不推荐使用。</p>

<h2 id="参考链接">参考链接</h2>

<ol>
  <li><a href="http://www.rfcreader.com/#rfc6749">The OAuth 2.0 Authorization Framework - RFC 6749</a></li>
  <li><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html">理解 OAuth 2.0</a> By 阮一峰</li>
  <li><a href="https://waylau.com/principle-and-practice-of-oauth2/">OAuth 2.0 认证的原理与实践</a> By Way Lau</li>
  <li><a href="https://www.cnblogs.com/XiongMaoMengNan/p/6785155.html">OAuth 2.0: Bearer Token Usage</a> By 熊猫猛男</li>
  <li><a href="https://developer.aliyun.com/article/636281">单点登录（SSO）看这一篇就够了</a></li>
</ol>
 
<div id="gitalk-container"></div>
<script>
    var gitalk = new Gitalk({
      enable: true,
      clientID: '020f142489f80c92b097',
      clientSecret: '1fa083372b44031cf1b8249251515c4e3d54c69d',
      repo: 'tate-young.github.io',
      owner: 'Tate-Young',
      admin: ['Tate-Young'],
      id: location.pathname,      // Ensure uniqueness and length less than 50
      distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script>
<!-- disqus -->
<!-- <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function () {
        this.page.url = 'https://tate-young.github.io/2019/02/18/oauth.html';
        this.page.identifier = '/2019/02/18/oauth';
        this.page.title = 'OAuth 2.0 及 SSO 单点登录';
    };

    (function () { // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document,
            s = d.createElement('script');

        s.src = '//tate.disqus.com/embed.js'; // IMPORTANT: Replace EXAMPLE with your forum shortname!

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript> -->


            <!-- <p class="post-info">
			本文由 <a href="/">liberxue</a> 创作，采用 <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external nofollow">知识共享署名4.0</a> 国际许可协议进行许可<br>本站文章除注明转载/出处外，均为本站原创或翻译，转载前请务必署名<br>最后编辑时间为:2019-02-18 17:47:00</p> -->
        </div>
    </article>

    <!-- <div class="related-post-lists">
	<div class="post-lists">
		<div class="post-lists-body">
					<div class="post-list-item">
				<div class="post-list-item-container">
					<div class="item-label">
						<div class="item-title"><a href="induction.html">归纳的随想</a></div>
						<div class="item-meta clearfix">
														<div class="item-meta-ico bg-ico-image" style="background: url('../usr/themes/pinghsu/images/bg-ico.png') no-repeat;background-size: 40px auto;"></div>
	                        							<div class="item-meta-cat"><a href="../category/thoughts/index.html">Thoughts</a></div>
						</div>
					</div>
				</div>
			</div>
				</div>
	</div>
</div> -->

    <!-- <footer class="footer bg-white">
	<div class="footer-social">
		<div class="footer-container clearfix">
			<div class="social-list">
	 <a class="social segmentfault" target="blank" href="https://segmentfault.com/u/liberxue" title="访问 LiberXue_Twitter" data-hover="Segmentfault">Segmentfault</a>
    <a class="social github" target="blank" href="https://github.com/liberxue" title="访问 LiberXue_Twitter" data-hover="GitHub">GitHub</a>
    <a class="social twitter" target="blank" href="http://twitter.com/liberxue" title="访问 LiberXue_Twitter" data-hover="Twitter">Twitter</a>
     <a class="social stackoverflow" target="blank" href="https://stackoverflow.com/users/6902190/liberxue" title="访问 LiberXue_stackoverflow" data-hover="StackOverflow">StackOverflow</a>
          <a class="social oschina" target="blank" href="https://my.oschina.net/bolanzw" title="访问 LiberXue_Oschina" data-hover="Oschina">Oschina</a>
     <a class="social rss" target="blank" href="/feed.xml"title="访问 LiberXue_RSS" data-hover="RSS">RSS</a>
	</div>
		</div>
	</div>
	<div class="footer-meta">
        <div class="footer-container">
            <div class="meta-item meta-copyright">
                <div class="meta-copyright-info">
                    <a href="/" class="info-logo">
                         <img src="http://localhost:2333/style/images/logo-liberxue.png"   title="访问 LiberXue_blog" data-hover="LiberXue_blog" alt="LiberXue_blog" /> </a>
                    <div class="info-text">
                        <p>Theme is <a href="http://www.liberxue.com/2017/08/03/Jekyllthemes.html" title="访问 Jekyll liberxue主题"  data-hover="Jekyll liberxue"target="_blank">Jekyll liberxue</a> by <a href="http://www.liberxue.com/about" target="_blank">liberxue</a></p>
                        <p>Powered by <a href="http://localhost:2333/tags/#Jekyll" title="Jekyll" data-hover="Jekyll" target="_blank" rel="nofollow">Jekyll</a></p>
                        <p>&copy; 2017 <a href="/feed.xml"  title="访问 liberxue blog RSS" data-hover="liberxue blog RSS">liberxue blog RSS</a></p>
                        <p>总计文章：篇</p>
                      <p>本blog已开源点击Fork</p><iframe src="http://ghbtns.com/github-btn.html?user=liberxue&repo=liberxue.github.io&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="95" height="20"></iframe>
                    </div>
                </div>
            </div>
            <div class="meta-item meta-posts">
                <h3 class="meta-title">置顶文章</h3>
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
            </div>
            <div class="meta-item meta-comments">
                <h3 class="meta-title">最新文章</h3>
  
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
</div>
		</div>
    </div>
</footer> -->
<script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.js"></script>
<script async src="/search/js/520.js"></script>
<script async src="/search/js/gtag.js"></script>
<script async src="/search/live2d/autoload.js"></script>
<!-- <script src="/search/js/canvas.js"></script> -->

<script>
    $(function () {
        setTimeout(function () {
            $('code').removeClass('hljs');
            $('code').removeClass('language');
        }, 90);
    });
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    <!--liberxueconnnet-menu-->
    <div id="directory-content" class="directory-content">
        <div id="directory"></div>
    </div>
    <!--liberxueconnnet-menu-->
    <script>
      const directoryContainer = document.getElementById('directory')
      const postTitle = document.getElementsByClassName('post-title')[0]
      var postDirectoryBuild = function () {
        var postChildren = function children(childNodes, reg) {
          var result = [],
              isReg = typeof reg === 'object',
              isStr = typeof reg === 'string',
              node, i, len;
          for (i = 0, len = childNodes.length; i < len; i++) {
            node = childNodes[i];
            if ((node.nodeType === 1 || node.nodeType === 9) &&
              (!reg ||
                  isReg && reg.test(node.tagName.toLowerCase()) ||
                  isStr && node.tagName.toLowerCase() === reg)) {
                result.push(node);
              }
            }
            return result;
          },
          createPostDirectory = function (article, directory, isDirNum) {
            var contentArr = [],
                titleId = [],
                levelArr, root, level,
                currentList, list, li, link, i, len;
            levelArr = (function (article, contentArr, titleId) {
                  var titleElem = postChildren(article.childNodes, /^h\d$/),
                      levelArr = [],
                      lastNum = 1,
                      lastRevNum = 1,
                      count = 0,
                      guid = 1,
                      id = 'directory' + (Math.random() + '').replace(/\D/, ''),
                      lastRevNum, num, elem;
                  while (titleElem.length) {
                      elem = titleElem.shift();
                      contentArr.push(elem.innerHTML);
                      num = +elem.tagName.match(/\d/)[0];
                      if (num > lastNum) {
                          levelArr.push(1);
                          lastRevNum += 1;
                      } else if (num === lastRevNum ||
                          num > lastRevNum && num <= lastNum) {
                          levelArr.push(0);
                          lastRevNum = lastRevNum;
                      } else if (num < lastRevNum) {
                          levelArr.push(num - lastRevNum);
                          lastRevNum = num;
                      }
                      count += levelArr[levelArr.length - 1];
                      lastNum = num;
                      elem.id = elem.id || (id + guid++);
                      titleId.push(elem.id);
                  }
                  if (count !== 0 && levelArr[0] === 1) levelArr[0] = 0;

                  return levelArr;
              })(article, contentArr, titleId);
              currentList = root = document.createElement('ul');
              dirNum = [0];
              for (i = 0, len = levelArr.length; i < len; i++) {
                  level = levelArr[i];
                  if (level === 1) {
                      list = document.createElement('ul');
                      if (!currentList.lastElementChild) {
                          currentList.appendChild(document.createElement('li'));
                      }
                      currentList.lastElementChild.appendChild(list);
                      currentList = list;
                      dirNum.push(0);
                  } else if (level < 0) {
                      level *= 2;
                      while (level++) {
                          if (level % 2) dirNum.pop();
                          currentList = currentList.parentNode;
                      }
                  }
                  dirNum[dirNum.length - 1]++;
                  li = document.createElement('li');
                  link = document.createElement('a');
                  link.name = '#' + titleId[i];
                  link.href = 'Javascript:;'
                  link.className = "post-aside-anchor"
                  link.title = '访问' + titleId[i];
                  link.innerHTML = !isDirNum ? contentArr[i] :
                      dirNum.join('.') + ' ' + contentArr[i];
                  li.appendChild(link);
                  currentList.appendChild(li);
              }
            directory.appendChild(root);
          };
        createPostDirectory(document.getElementById('post-content'), directoryContainer, true);
      };
      postDirectoryBuild();
    </script>
    <script>
      // gtag('config', GA_TRACKING_ID, {
      //   'page_title' : 'Blog',
      //   'page_path': window.location.pathname,
      //   'post_title': 'watttsdfasdf',
      // });

    </script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script>
        lang = hljs.initHighlightingOnLoad();
    </script>
</body>

</html>
