
<!DOCTYPE>
<html lang="zh-cn" data-scribe-reduced-action-queue="true">
<head>
    <meta content='JSBridge - Tate & Snow' name='title' />
    <meta content='JSBridge - Tate & Snow' name='og:title' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <title>JSBridge - Tate & Snow</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>JSBridge - Tate & Snow</title>
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JSBridge - Tate & Snow">
<meta name="twitter:keywords" content="JSBridge - Tate & Snow" property='og:description' />
<meta property="og:type" content="article">
<meta property="og:title" content="JSBridge - Tate & Snow">
<meta name="og:keywords" content="JSBridge - Tate & Snow|JSBridge什么是 JSBridge想当年最开始工作的时候，就是做的移动端 hybrid 混合式开发，里面很重要的一环就是 JS 与原生 Native 的相互通信，而它就是我们今天要介绍的主人翁 - JSBridge。顾名思义，它..."
  property='og:description' />
<link rel="icon" type="image/png" href="http://localhost:2333/style/favicons/favicon.ico" />
<link href="http://localhost:2333/style/favicons/favicon.ico" rel="shortcut icon" type="image/png">
<link rel="canonical" href="http://localhost:2333/">
<link rel="alternate" type="application/rss+xml" title="Liberxue" href="http://localhost:2333/feed.xml">
<meta charset="UTF-8">
<link rel="manifest" href="/manifest.json">
<link rel="shortcut icon" href="http://localhost:2333/style/favicons/favicon.ico" type="image/x-icon">
<meta name="keywords" content="JSBridge什么是 JSBridge想当年最开始工作的时候，就是做的移动端 hybrid 混合式开发，里面很重要的一环就是 JS 与原生 Native 的相互通信，而它就是我们今天要介绍的主人翁 - JSBridge。顾名思义，它..." property='og:description'
/>
<meta name="description" content="Tate & Snow's Github blog" />
<link href="https://cdn.bootcss.com/highlight.js/9.10.0/styles/xcode.min.css" rel="stylesheet">
<link href="http://localhost:2333/style/theme.css" rel="stylesheet"> 
<meta content='http://localhost:2333/2019/12/19/js-bridge.html' property='og:url' />
<meta content="http://localhost:2333/2019/12/19/js-bridge.html|JSBridge什么是 JSBridge想当年最开始工作的时候，就是做的移动端 hybrid 混合式开发，里面很重要的一环就是 JS 与原生 Native 的相互通信，而它就是我们今天要介绍的主人翁 - JSBridge。顾名思义，它..." property='og:description'
/>
<meta content="article" property="og:type" /> 

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-136311746-1"></script>
<!-- <script async src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>
<script>
  window.dataLayer = window.dataLayer || [];
  window.GA_TRACKING_ID = 'UA-136311746-1'
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('set', {
    'country': 'US',
    'currency': 'USD',
    'description': 'fuck',
  });
  gtag('config', GA_TRACKING_ID, {
    'custom_map': {
      'dimension1': 'post_title',
    },
    'post_title': 'test',
  });
</script>
<meta content="" property="fb:app_id" />
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>JSBridge | Tate &amp; Snow</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="JSBridge" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="JSBridge" />
<meta property="og:description" content="JSBridge" />
<link rel="canonical" href="http://localhost:2333/2019/12/19/js-bridge.html" />
<meta property="og:url" content="http://localhost:2333/2019/12/19/js-bridge.html" />
<meta property="og:site_name" content="Tate &amp; Snow" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-12-19T19:53:00+08:00" />
<script type="application/ld+json">
{"description":"JSBridge","@type":"BlogPosting","url":"http://localhost:2333/2019/12/19/js-bridge.html","headline":"JSBridge","dateModified":"2019-12-19T19:53:00+08:00","datePublished":"2019-12-19T19:53:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:2333/2019/12/19/js-bridge.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<script>
  (function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s);
    js.id = id;
    js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

</head>

<body class="dark-theme" gtools_scp_screen_capture_injected="true">
    <header id="header" class="header bg-white">
        <div class="navbar-container">
            <a href="Javascript:;" onclick="onClickLogo()" title="访问 Tate & Snow" class="navbar-logo menu-logo">
                <img src="http://localhost:2333/style/images/tate.png" alt="Tate & Snow"> </a>
            <!-- <a href="/?tate" title="访问 Tate & Snow" class="navbar-logo">Tate & Snow</a>   -->
            <div class="navbar-menu">
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('首页', '/')" title="访问 首页" data-hover="首页">首页</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('前端', '/front')" title="访问 前端" data-hover="前端">前端</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('历史', '/history')" title="访问 历史" data-hover="历史">历史</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('其他', '/other')" title="访问 其他" data-hover="其他">其他</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('标签', '/tags')" title="访问 标签" data-hover="标签">标签</a>
                
                  <a class=" menu-item-about " href="Javascript:;" onclick="onClickMenu('关于', '/README')" title="访问 关于" data-hover="关于">关于</a>
                
            </div>
            <!-- <div class="navbar-menu">
                
                <a href="http://localhost:2333/">首页</a>
                
                <a href="http://localhost:2333/front">前端</a>
                
                <a href="http://localhost:2333/history">历史</a>
                
                <a href="http://localhost:2333/other">其他</a>
                
                <a href="http://localhost:2333/tags">标签</a>
                
                <a href="http://localhost:2333/README">关于</a>
                
            </div> -->
            <div class="navbar-search menu-item-search" onclick="onClickSearch()">
                <span class="icon-search"></span>
                <form id="cb-search-btn" role="search">
                    <span class="search-box">
                        <input type="text" class="input" id="cb-search-content" required="true" placeholder="标题 标签..." maxlength="30" autocomplete="off">
                    </span>
                </form>
            </div>
            <div class="navbar-mobile-menu" onclick="">
                <span class="icon-menu cross">
                    <span class="middle"></span>
                </span>
                <ul>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('首页', 'http://localhost:2333/')">首页</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('前端', 'http://localhost:2333/front')">前端</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('历史', 'http://localhost:2333/history')">历史</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('其他', 'http://localhost:2333/other')">其他</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('标签', 'http://localhost:2333/tags')">标签</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('关于', 'http://localhost:2333/README')">关于</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </header>
    <a href="#header" class="back-to-top" onclick="onClickTop('JSBridge')">⤴Top⤴</a>
    <div class="post-header-thumb bg-white}">
        <div class="post-header-thumb-op"></div>
        <div class="post-header-thumb">
            <div class="post-header-thumb-container">
                <h1 class="post-title" itemprop="name headline">
                    JSBridge</h1>
                <div class="post-data">
                    <time datetime="2019-12-19 19:53:00" itemprop="datePublished">
                      发布时间：2019-12-19 19:53:00
                      &nbsp;&nbsp;&nbsp;
                      
                        修改时间：2019-12-23 11:52:00
                      
                    </time>
                    <a onclick="onClickCategory('前端')" href="Javascript:;" title="访问 前端" data-hover="博客分类: 前端">博客分类: 前端</a>
                    <!-- <a href="#read"> 阅读次数: comments</a>  -->
                </div>
                <div class="post-tags">
                       
                    <a class="menu-item-tags" href="Javascript:;" onclick="onClickTag('JavaScript')" title="访问JavaScript" data-hover="JavaScript">
                        JavaScript
                        <span>(32)</span>
                        
                    </a>
                       
                </div>
            </div>
        </div>
    </div>
    <article class="main-content post-page" itemscope itemtype="http://schema.org/Article">
        <div class="post-header">
            <h1 class="post-title" itemprop="name headline">
                JSBridge</h1>
            <div class="post-data">
                <time datetime="2019-12-19 19:53:00" itemprop="datePublished">2019-12-19 19:53:00</time>
            </div>
        </div>
        <div id="post-content" class="post-content" itemprop="articleBody">
            <p class="post-tags">
                   
                <a href="Javascript:;" onclick="onClickTag('JavaScript')" title="访问JavaScript" data-hover="JavaScript">
                    JavaScript
                    <span>(32)</span>
                    </a>
                   
            </p>
            <h1 id="jsbridge">JSBridge</h1>

<h2 id="什么是-jsbridge">什么是 JSBridge</h2>

<p>想当年最开始工作的时候，就是做的移动端 hybrid 混合式开发，里面很重要的一环就是 JS 与原生 Native 的相互通信，而它就是我们今天要介绍的主人翁 - <strong>JSBridge</strong>。顾名思义，它作为一座桥梁，连接了 JS 与 Native，让前端可以方便地调用原生的摄像头、视频等，而原生也可以接收前端发出的信息而作出相应的处理。准确来讲，它并不是一项技术，而是一套解决方案。在介绍 JSBridge 原理之前，我们先看看传统方式是怎么来使用的。以下主要摘自 <a href="https://blog.csdn.net/xiangzhihong8/article/details/66970600">JSBridge 深度剖析</a>这篇博客:</p>

<h2 id="传统方式">传统方式</h2>

<h3 id="js-调用-native">JS 调用 Native</h3>

<p>JS 调用 Native 主要是通过两种方式:</p>

<ul>
  <li>API 注入</li>
  <li>URL Scheme</li>
</ul>

<h4 id="api-注入">API 注入</h4>

<p>注入 API 方式的主要原理是，通过 WebView 提供的接口，向 JS 的 Context(window) 中注入对象或者方法，让 JS 调用时，直接执行相应的 Native 代码逻辑，这里也对应三个不同平台进行分析:</p>

<p>1、 IOS(UIWebView)</p>

<pre><code class="language-JS">// Native 中通过引入官方提供的 JavaScriptCore 库(iOS7 以上),然后可以将 api 绑定到 JSContext 上
// import &lt;JavaScriptCore/JavaScriptCore.h&gt;

JSContext *context = [uiWebView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"];

// 注册方法为 postBridgeMessage
context[@"postBridgeMessage"] = ^(NSArray&lt;NSArray *&gt; *calls) {
  // Native 逻辑
}
</code></pre>

<p>我们可以看到上面注册了一个名为 <code class="highlighter-rouge">postBridgeMessage</code> 的方法，因此我们可以在前端进行调用:</p>

<pre><code class="language-JS">window.postBridgeMessage(message)
</code></pre>

<blockquote>
  <p>IOS7 才出现这种方式，在这之前，JS 无法直接调用 Native，只能通过 JSBridge 方式间接调用</p>
</blockquote>

<p>2、 IOS(WKWebView)</p>

<p>首先，<strong>WKWebView</strong> 是 ios8 之后推行的，可以替代之前的 <strong>UIWebView</strong> 控件，解决了很多性能和兼容上的问题，那么它又是怎么使用的呢:</p>

<pre><code class="language-JS">@interface WKWebVIewVC ()&lt;WKScriptMessageHandler&gt;

@implementation WKWebVIewVC

- (void)viewDidLoad {
  [super viewDidLoad];

  WKWebViewConfiguration* configuration = [[WKWebViewConfiguration alloc] init];
  configuration.userContentController = [[WKUserContentController alloc] init];
  WKUserContentController *userCC = configuration.userContentController;
  // 注入对象 nativeBridge
  [userCC addScriptMessageHandler:self name:@"nativeBridge"];

  WKWebView wkWebView = [[WKWebView alloc] initWithFrame:self.view.frame configuration:configuration];
  // ...
}

- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message {
  if ([message.name isEqualToString:@"nativeBridge"]) {
    NSLog(@"前端传递的数据 %@: ", message.body);
    // Native 逻辑
  }
}
</code></pre>

<p>我们可以看到上面注册了一个名为 <code class="highlighter-rouge">nativeBridge</code> 的对象，因此我们可以在前端进行调用:</p>

<pre><code class="language-JS">window.webkit.messageHandlers.nativeBridge.postMessage(message)
</code></pre>

<p>3、 Android</p>

<pre><code class="language-JS">public class JavaScriptInterfaceDemoActivity extends Activity {
  private WebView Wv;

  @Override
  publicvoidonCreate(Bundle savedInstanceState){
    super.onCreate(savedInstanceState);

    Wv = (WebView)findViewById(R.id.webView);
    final JavaScriptInterface myJavaScriptInterface = new JavaScriptInterface(this);

    // Android 容器允许 JS 脚本
    Wv.getSettings().setJavaScriptEnabled(true);
    // Android 容器设置侨连对象
    Wv.addJavascriptInterface(myJavaScriptInterface, "nativeBridge");
    // ...
  }

  public class JavaScriptInterface {
    Context mContext;

    JavaScriptInterface(Context c) {
      mContext = c;
    }

    // 暴露出的接口
    @JavascriptInterface
    public void postMessage(String webMessage){
      // Native 逻辑
    }
  }
}
</code></pre>

<p>我们可以看到上面用 <code class="highlighter-rouge">nativeBridge</code> 设置了侨连对象，并且暴露出了 <code class="highlighter-rouge">postMessage</code> 接口，因此我们通过下面方式访问即可:</p>

<pre><code class="language-JS">// 前端调用 nativeBridge
window.nativeBridge.postMessage(message)
</code></pre>

<blockquote>
  <p>在 Android4.2(API17) 以上版本，暴露的接口要加上注解 <code class="highlighter-rouge">@JavascriptInterface</code>，否则会找不到该方法</p>
</blockquote>

<blockquote>
  <p>在 API17 以前，<code class="highlighter-rouge">addJavascriptInterface</code> 是有风险的，黑客可以通过反编译获取 Native 注册的 JS 对象，然后在页面通过反射 Java 的内置静态类，获取一些敏感的信息和破坏</p>
</blockquote>

<h4 id="拦截-url-scheme">拦截 URL Scheme</h4>

<p><strong>url scheme</strong> 是一种类似于 url 的链接，是为了方便 app 直接互相调用设计的。具体来讲如果是系统的 url scheme，比如 <code class="highlighter-rouge">tel://136xxx5495</code> ，则打开系统应用，否则看是否有 app 注册这种 scheme，有则打开对应 app，注意这种 scheme 必须原生 app 注册后才会生效:</p>

<pre><code class="language-TEXT">&lt;!-- 普通的 url --&gt;
https://host:port/path
&lt;!-- url scheme - scheme 这里就相当于协议 --&gt;
scheme://host:port/path
</code></pre>

<p>而我们通过拦截 url scheme，就可以达到传输数据的目的，进而实现两端的通信。在前端，一般是通过 <code class="highlighter-rouge">iframe.src</code> 来发送 url scheme 请求，然后 Native 捕获后，根据定义好的协议，分析当前触发了哪种方法。相较于上面的 API 注入，它的适用性更广，IOS 和安卓都可兼容，但是请求可能会有一些耗时。</p>

<blockquote>
  <p>为什么选择 <code class="highlighter-rouge">iframe.src</code> 不选择 <code class="highlighter-rouge">locaiton.href</code> ？因为如果通过 <code class="highlighter-rouge">location.href</code> 连续调用 Native，在 Native 层只能接收到最后一次请求，从而很容易丢失一些调用</p>
</blockquote>

<h3 id="native-调用-js">Native 调用 JS</h3>

<p>Native 调用 JS 相对较简单一些，只用去执行 JS 暴露出来的全局方法即可。</p>

<p>1、IOS(UIWebView)</p>

<pre><code class="language-JS">[uiWebview stringByEvaluatingJavaScriptFromString:javaScriptString]
</code></pre>

<p>2、IOS(WKWebView)</p>

<pre><code class="language-JS">// completionHandler 会在 JS 方法执行完后执行
[wkWebView evaluateJavaScript:javaScriptString completionHandler:completionHandler]
</code></pre>

<p>3、Android</p>

<pre><code class="language-JS">// 使用 loadUrl 的方式，并不能获取 JavaScript 执行后的结果
webView.loadUrl("javascript:" + javaScriptString);
</code></pre>

<p>而 Kitkat 4.4 之后的版本，也可以用 <code class="highlighter-rouge">evaluateJavascript</code> 方法实现:</p>

<pre><code class="language-JS">webView.evaluateJavascript(javaScriptString, new ValueCallback&lt;String&gt;() {
  @Override
  public void onReceiveValue(String value){
    // 可以拿到 JS 返回值
  }
});
</code></pre>

<h2 id="jsbridge-原理及简单实现">JSBridge 原理及简单实现</h2>

<p>有了上述的双端通信的基础通道，我们就可以基于此去构建一套易用的方法封装，解决一些兼容性或安全问题，更易于维护和扩展，一个简单的通信流程如下:</p>

<p><img src="https://miro.medium.com/max/1400/0*i0r9tA8EGzSBwhAj.png" alt="JSBridge" /></p>

<p>要实现 JSBridge，我们可以按以下步骤分析:</p>

<ol>
  <li>设计出一个 Native 与 JS 交互的全局桥对象</li>
  <li>JS 如何调用 Native</li>
  <li>Native 如何得知 api 被调用</li>
  <li>Native 如何调用 JS</li>
  <li>H5 中 api 方法的注册以及格式</li>
</ol>

<p>1、 <strong>设计出一个 Native 与 JS 交互的全局桥对象</strong></p>

<p>我们首先要定义一个全局变量，并定义一些方法:</p>

<pre><code class="language-JS">const JSBridge = window.JSBridge || (window.JSBridge = {})
</code></pre>

<ul>
  <li>registerHandler - 注册本地 JS 方法，注册后 Native 可通过 JSBridge 调用。调用后会将方法注册到本地变量 <code class="highlighter-rouge">messageHandlers</code> 中</li>
  <li>callHandler - JS 调用原生开放的 api，调用后实际上还是本地通过 url scheme 触发。调用时会将回调 id  存放到本地变量 <code class="highlighter-rouge">responseCallbacks</code> 中</li>
  <li>_handleMessageFromNative - 原生调用 JS 注册的方法，或者通知前端页面执行回调方法</li>
</ul>

<p><img src="https://yqfile.alicdn.com/db68a2b9154d16b09ce8046f369ae34199cf2f01.png" alt="JSBridge props" /></p>

<p>2、<strong>JS 如何调用 Native</strong></p>

<p>其关键就在于 <code class="highlighter-rouge">callHandler</code> 方法，实际执行了以下步骤:</p>

<ol>
  <li>判断是否有回调函数，若有，则生成一个回调函数 id，并将 id 和对应回调添加进入回调函数集合 responseCallbacks 中，其中 handlerName 是和 app 商议好的方法名称</li>
  <li>通过特定的参数转换方法，将传入的数据、方法名一起拼接成一个 url scheme</li>
</ol>

<pre><code class="language-JS">// 调用线程
function callHandler(handlerName, data, responseCallback) {
  _doSend({
    handlerName: handlerName, // 和 app 商议好的方法名称
    data: data // 要传递的数据，结构可以相互约定
  }, responseCallback);
}

// 触发 native 处理 message，如果有回调的话，则会带上生成的回调 id
function _doSend(message, responseCallback) {
  if (responseCallback) {
    const callbackId = generateCallbackId() // 生成一些回调 id
    responseCallbacks[callbackId] = responseCallback
    message.callbackId = callbackId // 发送的 message 中只会传递回调函数的 id
  }

  // 发送的 message 存在一个 sendMessageQueue 队列中
  sendMessageQueue.push(message)
  
  // 通过 iframe.src 发送 url scheme
}
</code></pre>

<p>通过 <code class="highlighter-rouge">iframe.src</code> 发送 url scheme 的实现如下，我们这里的目的只是告诉 Native 有新消息需要处理:</p>

<pre><code class="language-JS">// 定义 url scheme
const uri = CUSTOM_PROTOCOL_SCHEME + '://' + QUEUE_HAS_MESSAGE

// 创建隐藏 iframe 过程
const messagingIframe = document.createElement('iframe')
messagingIframe.style.display = 'none'
document.documentElement.appendChild(messagingIframe)

// 通过 iframe.src 触发 scheme，通知 Native，有新数据(message)需要处理
messagingIframe.src = uri
</code></pre>

<p>3、 <strong>Native 如何得知 api 被调用</strong></p>

<p>上一步，我们已经成功在前端页面中触发 scheme，那么 Native 如何捕获 scheme 被触发呢？安卓和 IOS 捕获方式如下:</p>

<pre><code class="language-JS">// Android
public boolean shouldOverrideUrlLoading(WebView view, String url){
  // 如果返回 false，则 WebView 处理链接 url，如果返回 true，代表 WebView 根据程序来执行 url
  return true;
}
</code></pre>

<pre><code class="language-JS">// ios
- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType {
  NSURL *url = [request URL];

  NSString *requestString = [[request URL] absoluteString];
</code></pre>

<p>既然 Native 已经接收到了 JS 调用的方法，那么会通过 <code class="highlighter-rouge">_fetchQueue</code> 统一处理存储在 <code class="highlighter-rouge">sendMessageQueue</code> 中的数据，并重置为空:</p>

<pre><code class="language-JS">// 获取 sendMessageQueue 返回给 Native
// 由于 Android 不能直接获取返回的内容，所以使用 shouldOverrideUrlLoading 的方式返回内容
function _fetchQueue() {
  const messageQueueString = JSON.stringify(sendMessageQueue);
  sendMessageQueue = [];
  // android can't read directly the return data, so we can reload iframe src to communicate with java
  if (messageQueueString !== '[]') {
    bizMessagingIframe.src = CUSTOM_PROTOCOL_SCHEME + '://return/_fetchQueue/' + encodeURIComponent(messageQueueString);
  }
}
</code></pre>

<p>4、 <strong>Native 如何调用 JS，以及 H5 中 api 方法的注册以及格式</strong></p>

<p>JS 通过 <code class="highlighter-rouge">registerHandler</code> 来注册方法提供给 Native 调用，这些注册的方法会统一放到 <code class="highlighter-rouge">messageHandlers</code> 中管理:</p>

<pre><code class="language-JS">function registerHandler(handlerName, handler) {
  messageHandlers[handlerName] = handler
}
</code></pre>

<p>接下来再看看 <code class="highlighter-rouge">_dispatchMessageFromNative</code> 的实现，主要用于处理前端主动调用时的回调或 Native 主动调用 JS 注册方法:</p>

<pre><code class="language-JS">// 参考 JsBridge 仓库的 assets/WebViewJavascriptBridge 实现
// 提供给 native 使用，对接收到的数据队列进行遍历执行
function _dispatchMessageFromNative(messageJSON) {
  setTimeout(function() {
    var message = JSON.parse(messageJSON);
    var responseCallback;
    // java call finished, now need to call js callback function
    // 处理前端主动调用时的回调
    // responseId 是 java 执行 sendResponse 处理回调信息时赋值的 - response.responseId = callbackId;
    if (message.responseId) {
      // 根据 id 找到 responseCallbacks 对应的回调方法
      responseCallback = responseCallbacks[message.responseId];
      if (!responseCallback) {
        return;
      }
      responseCallback(message.responseData);
      delete responseCallbacks[message.responseId];
    } else {
      // 直接发送，Native 主动调用 JS 注册方法
      if (message.callbackId) {
        var callbackResponseId = message.callbackId;
        responseCallback = function(responseData) {
          _doSend('response', responseData, callbackResponseId);
        };
      }

      var handler = WebViewJavascriptBridge._messageHandler;
      if (message.handlerName) {
        handler = messageHandlers[message.handlerName];
      }
      // 在本地函数集合 messageHandlers 中查找指定 handler 并执行
      try {
        handler(message.data, responseCallback);
      } catch (exception) {
        if (typeof console != 'undefined') {
          console.log("WebViewJavascriptBridge: WARNING: javascript handler threw.", message, exception);
        }
      }
    }
  });
}
</code></pre>

<p>完整的流程如下:</p>

<p><img src="http://localhost:2333/style/images/smms/jsbridge.png" alt="jsbridge whole period" /></p>

<p>在实际的开发中，我们统一出以下方案来针对 IOS 和安卓:</p>

<p><img src="https://miro.medium.com/max/1400/0*gNSgNMbYQaeoFxDA.png" alt="strategy" /></p>

<blockquote>
  <p>更多可以参考 IOS <a href="https://github.com/marcuswestin/WebViewJavascriptBridge"><strong>WebViewJavascriptBridge</strong></a> 和安卓 <a href="https://github.com/lzyzsd/JsBridge">JsBridge</a> 的实现 👈</p>
</blockquote>

<h2 id="参考链接">参考链接</h2>

<ol>
  <li><a href="https://blog.csdn.net/xiangzhihong8/article/details/66970600">JSBridge 深度剖析</a> By xiangzhihong8</li>
  <li><a href="https://www.jianshu.com/p/be491bfbca0d">JSBridge 总结</a> By NowhereToRun</li>
</ol>
 
<div id="gitalk-container"></div>
<script>
    var gitalk = new Gitalk({
      enable: true,
      clientID: '020f142489f80c92b097',
      clientSecret: '1fa083372b44031cf1b8249251515c4e3d54c69d',
      repo: 'tate-young.github.io',
      owner: 'Tate-Young',
      admin: ['Tate-Young'],
      id: location.pathname,      // Ensure uniqueness and length less than 50
      distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script>
<!-- disqus -->
<!-- <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function () {
        this.page.url = 'https://tate-young.github.io/2019/12/19/js-bridge.html';
        this.page.identifier = '/2019/12/19/js-bridge';
        this.page.title = 'JSBridge';
    };

    (function () { // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document,
            s = d.createElement('script');

        s.src = '//tate.disqus.com/embed.js'; // IMPORTANT: Replace EXAMPLE with your forum shortname!

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript> -->


            <!-- <p class="post-info">
			本文由 <a href="/">liberxue</a> 创作，采用 <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external nofollow">知识共享署名4.0</a> 国际许可协议进行许可<br>本站文章除注明转载/出处外，均为本站原创或翻译，转载前请务必署名<br>最后编辑时间为:2019-12-19 19:53:00</p> -->
        </div>
    </article>

    <!-- <div class="related-post-lists">
	<div class="post-lists">
		<div class="post-lists-body">
					<div class="post-list-item">
				<div class="post-list-item-container">
					<div class="item-label">
						<div class="item-title"><a href="induction.html">归纳的随想</a></div>
						<div class="item-meta clearfix">
														<div class="item-meta-ico bg-ico-image" style="background: url('../usr/themes/pinghsu/images/bg-ico.png') no-repeat;background-size: 40px auto;"></div>
	                        							<div class="item-meta-cat"><a href="../category/thoughts/index.html">Thoughts</a></div>
						</div>
					</div>
				</div>
			</div>
				</div>
	</div>
</div> -->

    <!-- <footer class="footer bg-white">
	<div class="footer-social">
		<div class="footer-container clearfix">
			<div class="social-list">
	 <a class="social segmentfault" target="blank" href="https://segmentfault.com/u/liberxue" title="访问 LiberXue_Twitter" data-hover="Segmentfault">Segmentfault</a>
    <a class="social github" target="blank" href="https://github.com/liberxue" title="访问 LiberXue_Twitter" data-hover="GitHub">GitHub</a>
    <a class="social twitter" target="blank" href="http://twitter.com/liberxue" title="访问 LiberXue_Twitter" data-hover="Twitter">Twitter</a>
     <a class="social stackoverflow" target="blank" href="https://stackoverflow.com/users/6902190/liberxue" title="访问 LiberXue_stackoverflow" data-hover="StackOverflow">StackOverflow</a>
          <a class="social oschina" target="blank" href="https://my.oschina.net/bolanzw" title="访问 LiberXue_Oschina" data-hover="Oschina">Oschina</a>
     <a class="social rss" target="blank" href="/feed.xml"title="访问 LiberXue_RSS" data-hover="RSS">RSS</a>
	</div>
		</div>
	</div>
	<div class="footer-meta">
        <div class="footer-container">
            <div class="meta-item meta-copyright">
                <div class="meta-copyright-info">
                    <a href="/" class="info-logo">
                         <img src="http://localhost:2333/style/images/logo-liberxue.png"   title="访问 LiberXue_blog" data-hover="LiberXue_blog" alt="LiberXue_blog" /> </a>
                    <div class="info-text">
                        <p>Theme is <a href="http://www.liberxue.com/2017/08/03/Jekyllthemes.html" title="访问 Jekyll liberxue主题"  data-hover="Jekyll liberxue"target="_blank">Jekyll liberxue</a> by <a href="http://www.liberxue.com/about" target="_blank">liberxue</a></p>
                        <p>Powered by <a href="http://localhost:2333/tags/#Jekyll" title="Jekyll" data-hover="Jekyll" target="_blank" rel="nofollow">Jekyll</a></p>
                        <p>&copy; 2017 <a href="/feed.xml"  title="访问 liberxue blog RSS" data-hover="liberxue blog RSS">liberxue blog RSS</a></p>
                        <p>总计文章：篇</p>
                      <p>本blog已开源点击Fork</p><iframe src="http://ghbtns.com/github-btn.html?user=liberxue&repo=liberxue.github.io&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="95" height="20"></iframe>
                    </div>
                </div>
            </div>
            <div class="meta-item meta-posts">
                <h3 class="meta-title">置顶文章</h3>
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
            </div>
            <div class="meta-item meta-comments">
                <h3 class="meta-title">最新文章</h3>
  
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
</div>
		</div>
    </div>
</footer> -->
<script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.js"></script>
<script async src="/search/js/520.js"></script>
<script async src="/search/js/gtag.js"></script>
<script async src="/search/live2d/autoload.js"></script>
<!-- <script src="/search/js/canvas.js"></script> -->

<script>
    $(function () {
        setTimeout(function () {
            $('code').removeClass('hljs');
            $('code').removeClass('language');
        }, 90);
    });
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    <!--liberxueconnnet-menu-->
    <div id="directory-content" class="directory-content">
        <div id="directory"></div>
    </div>
    <!--liberxueconnnet-menu-->
    <script>
      const directoryContainer = document.getElementById('directory')
      const postTitle = document.getElementsByClassName('post-title')[0]
      var postDirectoryBuild = function () {
        var postChildren = function children(childNodes, reg) {
          var result = [],
              isReg = typeof reg === 'object',
              isStr = typeof reg === 'string',
              node, i, len;
          for (i = 0, len = childNodes.length; i < len; i++) {
            node = childNodes[i];
            if ((node.nodeType === 1 || node.nodeType === 9) &&
              (!reg ||
                  isReg && reg.test(node.tagName.toLowerCase()) ||
                  isStr && node.tagName.toLowerCase() === reg)) {
                result.push(node);
              }
            }
            return result;
          },
          createPostDirectory = function (article, directory, isDirNum) {
            var contentArr = [],
                titleId = [],
                levelArr, root, level,
                currentList, list, li, link, i, len;
            levelArr = (function (article, contentArr, titleId) {
                  var titleElem = postChildren(article.childNodes, /^h\d$/),
                      levelArr = [],
                      lastNum = 1,
                      lastRevNum = 1,
                      count = 0,
                      guid = 1,
                      id = 'directory' + (Math.random() + '').replace(/\D/, ''),
                      lastRevNum, num, elem;
                  while (titleElem.length) {
                      elem = titleElem.shift();
                      contentArr.push(elem.innerHTML);
                      num = +elem.tagName.match(/\d/)[0];
                      if (num > lastNum) {
                          levelArr.push(1);
                          lastRevNum += 1;
                      } else if (num === lastRevNum ||
                          num > lastRevNum && num <= lastNum) {
                          levelArr.push(0);
                          lastRevNum = lastRevNum;
                      } else if (num < lastRevNum) {
                          levelArr.push(num - lastRevNum);
                          lastRevNum = num;
                      }
                      count += levelArr[levelArr.length - 1];
                      lastNum = num;
                      elem.id = elem.id || (id + guid++);
                      titleId.push(elem.id);
                  }
                  if (count !== 0 && levelArr[0] === 1) levelArr[0] = 0;

                  return levelArr;
              })(article, contentArr, titleId);
              currentList = root = document.createElement('ul');
              dirNum = [0];
              for (i = 0, len = levelArr.length; i < len; i++) {
                  level = levelArr[i];
                  if (level === 1) {
                      list = document.createElement('ul');
                      if (!currentList.lastElementChild) {
                          currentList.appendChild(document.createElement('li'));
                      }
                      currentList.lastElementChild.appendChild(list);
                      currentList = list;
                      dirNum.push(0);
                  } else if (level < 0) {
                      level *= 2;
                      while (level++) {
                          if (level % 2) dirNum.pop();
                          currentList = currentList.parentNode;
                      }
                  }
                  dirNum[dirNum.length - 1]++;
                  li = document.createElement('li');
                  link = document.createElement('a');
                  link.name = '#' + titleId[i];
                  link.href = 'Javascript:;'
                  link.className = "post-aside-anchor"
                  link.title = '访问' + titleId[i];
                  link.innerHTML = !isDirNum ? contentArr[i] :
                      dirNum.join('.') + ' ' + contentArr[i];
                  li.appendChild(link);
                  currentList.appendChild(li);
              }
            directory.appendChild(root);
          };
        createPostDirectory(document.getElementById('post-content'), directoryContainer, true);
      };
      postDirectoryBuild();
    </script>
    <script>
      // gtag('config', GA_TRACKING_ID, {
      //   'page_title' : 'Blog',
      //   'page_path': window.location.pathname,
      //   'post_title': 'watttsdfasdf',
      // });

    </script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script>
        lang = hljs.initHighlightingOnLoad();
    </script>
</body>

</html>
