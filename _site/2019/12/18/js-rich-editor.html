
<!DOCTYPE>
<html lang="zh-cn" data-scribe-reduced-action-queue="true">
<head>
    <meta content='å¯Œæ–‡æœ¬åŸç† - Tate & Snow' name='title' />
    <meta content='å¯Œæ–‡æœ¬åŸç† - Tate & Snow' name='og:title' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <title>å¯Œæ–‡æœ¬åŸç† - Tate & Snow</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>å¯Œæ–‡æœ¬åŸç† - Tate & Snow</title>
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="å¯Œæ–‡æœ¬åŸç† - Tate & Snow">
<meta name="twitter:keywords" content="å¯Œæ–‡æœ¬åŸç† - Tate & Snow" property='og:description' />
<meta property="og:type" content="article">
<meta property="og:title" content="å¯Œæ–‡æœ¬åŸç† - Tate & Snow">
<meta name="og:keywords" content="å¯Œæ–‡æœ¬åŸç† - Tate & Snow|å¯Œæ–‡æœ¬åŸç†å¯Œæ–‡æœ¬contenteditablecontenteditable æ˜¯ä¸€ä¸ªæšä¸¾å±æ€§ï¼Œè¡¨ç¤ºå…ƒç´ æ˜¯å¦å¯è¢«ç”¨æˆ·ç¼–è¾‘ã€‚å¦‚æœå¯ä»¥ï¼Œæµè§ˆå™¨ä¼šä¿®æ”¹å…ƒç´ çš„éƒ¨ä»¶ä»¥å…è®¸ç¼–è¾‘:&lt;blockquote contenteditable="tru..."
  property='og:description' />
<link rel="icon" type="image/png" href="http://localhost:2333/style/favicons/favicon.ico" />
<link href="http://localhost:2333/style/favicons/favicon.ico" rel="shortcut icon" type="image/png">
<link rel="canonical" href="http://localhost:2333/">
<link rel="alternate" type="application/rss+xml" title="Liberxue" href="http://localhost:2333/feed.xml">
<meta charset="UTF-8">
<link rel="manifest" href="/manifest.json">
<link rel="shortcut icon" href="http://localhost:2333/style/favicons/favicon.ico" type="image/x-icon">
<meta name="keywords" content="å¯Œæ–‡æœ¬åŸç†å¯Œæ–‡æœ¬contenteditablecontenteditable æ˜¯ä¸€ä¸ªæšä¸¾å±æ€§ï¼Œè¡¨ç¤ºå…ƒç´ æ˜¯å¦å¯è¢«ç”¨æˆ·ç¼–è¾‘ã€‚å¦‚æœå¯ä»¥ï¼Œæµè§ˆå™¨ä¼šä¿®æ”¹å…ƒç´ çš„éƒ¨ä»¶ä»¥å…è®¸ç¼–è¾‘:&lt;blockquote contenteditable="tru..." property='og:description'
/>
<meta name="description" content="Tate & Snow's Github blog" />
<link href="https://cdn.bootcss.com/highlight.js/9.10.0/styles/xcode.min.css" rel="stylesheet">
<link href="http://localhost:2333/style/theme.css" rel="stylesheet"> 
<meta content='http://localhost:2333/2019/12/18/js-rich-editor.html' property='og:url' />
<meta content="http://localhost:2333/2019/12/18/js-rich-editor.html|å¯Œæ–‡æœ¬åŸç†å¯Œæ–‡æœ¬contenteditablecontenteditable æ˜¯ä¸€ä¸ªæšä¸¾å±æ€§ï¼Œè¡¨ç¤ºå…ƒç´ æ˜¯å¦å¯è¢«ç”¨æˆ·ç¼–è¾‘ã€‚å¦‚æœå¯ä»¥ï¼Œæµè§ˆå™¨ä¼šä¿®æ”¹å…ƒç´ çš„éƒ¨ä»¶ä»¥å…è®¸ç¼–è¾‘:&lt;blockquote contenteditable="tru..." property='og:description'
/>
<meta content="article" property="og:type" /> 

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-136311746-1"></script>
<!-- <script async src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>
<script>
  window.dataLayer = window.dataLayer || [];
  window.GA_TRACKING_ID = 'UA-136311746-1'
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('set', {
    'country': 'US',
    'currency': 'USD',
    'description': 'fuck',
  });
  gtag('config', GA_TRACKING_ID, {
    'custom_map': {
      'dimension1': 'post_title',
    },
    'post_title': 'test',
  });
</script>
<meta content="" property="fb:app_id" />
<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>å¯Œæ–‡æœ¬åŸç† | Tate &amp; Snow</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="å¯Œæ–‡æœ¬åŸç†" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="å¯Œæ–‡æœ¬åŸç†" />
<meta property="og:description" content="å¯Œæ–‡æœ¬åŸç†" />
<link rel="canonical" href="http://localhost:2333/2019/12/18/js-rich-editor.html" />
<meta property="og:url" content="http://localhost:2333/2019/12/18/js-rich-editor.html" />
<meta property="og:site_name" content="Tate &amp; Snow" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-12-18T20:22:00+08:00" />
<script type="application/ld+json">
{"description":"å¯Œæ–‡æœ¬åŸç†","@type":"BlogPosting","url":"http://localhost:2333/2019/12/18/js-rich-editor.html","headline":"å¯Œæ–‡æœ¬åŸç†","dateModified":"2019-12-18T20:22:00+08:00","datePublished":"2019-12-18T20:22:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:2333/2019/12/18/js-rich-editor.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<script>
  (function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s);
    js.id = id;
    js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

</head>

<body class="dark-theme" gtools_scp_screen_capture_injected="true">
    <header id="header" class="header bg-white">
        <div class="navbar-container">
            <a href="Javascript:;" onclick="onClickLogo()" title="è®¿é—® Tate & Snow" class="navbar-logo menu-logo">
                <img src="https://i.loli.net/2018/03/13/5aa74f5b4c2c7.png" alt="Tate & Snow"> </a>
            <!-- <a href="/?tate" title="è®¿é—® Tate & Snow" class="navbar-logo">Tate & Snow</a>   -->
            <div class="navbar-menu">
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('é¦–é¡µ', '/')" title="è®¿é—® é¦–é¡µ" data-hover="é¦–é¡µ">é¦–é¡µ</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('å‰ç«¯', '/front')" title="è®¿é—® å‰ç«¯" data-hover="å‰ç«¯">å‰ç«¯</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('å†å²', '/history')" title="è®¿é—® å†å²" data-hover="å†å²">å†å²</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('å…¶ä»–', '/other')" title="è®¿é—® å…¶ä»–" data-hover="å…¶ä»–">å…¶ä»–</a>
                
                  <a class=" menu-item-categories " href="Javascript:;" onclick="onClickMenu('æ ‡ç­¾', '/tags')" title="è®¿é—® æ ‡ç­¾" data-hover="æ ‡ç­¾">æ ‡ç­¾</a>
                
                  <a class=" menu-item-about " href="Javascript:;" onclick="onClickMenu('å…³äº', '/README')" title="è®¿é—® å…³äº" data-hover="å…³äº">å…³äº</a>
                
            </div>
            <!-- <div class="navbar-menu">
                
                <a href="http://localhost:2333/">é¦–é¡µ</a>
                
                <a href="http://localhost:2333/front">å‰ç«¯</a>
                
                <a href="http://localhost:2333/history">å†å²</a>
                
                <a href="http://localhost:2333/other">å…¶ä»–</a>
                
                <a href="http://localhost:2333/tags">æ ‡ç­¾</a>
                
                <a href="http://localhost:2333/README">å…³äº</a>
                
            </div> -->
            <div class="navbar-search menu-item-search" onclick="onClickSearch()">
                <span class="icon-search"></span>
                <form id="cb-search-btn" role="search">
                    <span class="search-box">
                        <input type="text" class="input" id="cb-search-content" required="true" placeholder="æ ‡é¢˜ æ ‡ç­¾..." maxlength="30" autocomplete="off">
                    </span>
                </form>
            </div>
            <div class="navbar-mobile-menu" onclick="">
                <span class="icon-menu cross">
                    <span class="middle"></span>
                </span>
                <ul>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('é¦–é¡µ', 'http://localhost:2333/')">é¦–é¡µ</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å‰ç«¯', 'http://localhost:2333/front')">å‰ç«¯</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å†å²', 'http://localhost:2333/history')">å†å²</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å…¶ä»–', 'http://localhost:2333/other')">å…¶ä»–</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('æ ‡ç­¾', 'http://localhost:2333/tags')">æ ‡ç­¾</a>
                    </li>
                    
                    <li>
                        <a class="menu-item-categories" href="Javascript:;" onclick="onClickMenu('å…³äº', 'http://localhost:2333/README')">å…³äº</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </header>
    <a href="#header" class="back-to-top" onclick="onClickTop('å¯Œæ–‡æœ¬åŸç†')">â¤´Topâ¤´</a>
    <div class="post-header-thumb bg-white}">
        <div class="post-header-thumb-op"></div>
        <div class="post-header-thumb">
            <div class="post-header-thumb-container">
                <h1 class="post-title" itemprop="name headline">
                    å¯Œæ–‡æœ¬åŸç†</h1>
                <div class="post-data">
                    <time datetime="2019-12-18 20:22:00" itemprop="datePublished">
                      å‘å¸ƒæ—¶é—´ï¼š2019-12-18 20:22:00
                      &nbsp;&nbsp;&nbsp;
                      
                        ä¿®æ”¹æ—¶é—´ï¼š2019-12-18 23:34:00
                      
                    </time>
                    <a onclick="onClickCategory('å‰ç«¯')" href="Javascript:;" title="è®¿é—® å‰ç«¯" data-hover="åšå®¢åˆ†ç±»: å‰ç«¯">åšå®¢åˆ†ç±»: å‰ç«¯</a>
                    <!-- <a href="#read"> é˜…è¯»æ¬¡æ•°: comments</a>  -->
                </div>
                <div class="post-tags">
                       
                    <a class="menu-item-tags" href="Javascript:;" onclick="onClickTag('JavaScript')" title="è®¿é—®JavaScript" data-hover="JavaScript">
                        JavaScript
                        <span>(22)</span>
                        
                    </a>
                       
                </div>
            </div>
        </div>
    </div>
    <article class="main-content post-page" itemscope itemtype="http://schema.org/Article">
        <div class="post-header">
            <h1 class="post-title" itemprop="name headline">
                å¯Œæ–‡æœ¬åŸç†</h1>
            <div class="post-data">
                <time datetime="2019-12-18 20:22:00" itemprop="datePublished">2019-12-18 20:22:00</time>
            </div>
        </div>
        <div id="post-content" class="post-content" itemprop="articleBody">
            <p class="post-tags">
                   
                <a href="Javascript:;" onclick="onClickTag('JavaScript')" title="è®¿é—®JavaScript" data-hover="JavaScript">
                    JavaScript
                    <span>(22)</span>
                    </a>
                   
            </p>
            <h1 id="å¯Œæ–‡æœ¬åŸç†">å¯Œæ–‡æœ¬åŸç†</h1>

<h2 id="å¯Œæ–‡æœ¬">å¯Œæ–‡æœ¬</h2>

<h3 id="contenteditable">contenteditable</h3>

<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Global_attributes/contenteditable"><strong>contenteditable</strong></a> æ˜¯ä¸€ä¸ªæšä¸¾å±æ€§ï¼Œè¡¨ç¤ºå…ƒç´ æ˜¯å¦å¯è¢«ç”¨æˆ·ç¼–è¾‘ã€‚å¦‚æœå¯ä»¥ï¼Œæµè§ˆå™¨ä¼šä¿®æ”¹å…ƒç´ çš„éƒ¨ä»¶ä»¥å…è®¸ç¼–è¾‘:</p>

<pre><code class="language-HTML">&lt;blockquote contenteditable="true"&gt;
  &lt;p&gt;Edit this content to add your own quote&lt;/p&gt;
  &lt;!-- å­å…ƒç´ ä¸æƒ³è¢«ç¼–è¾‘ï¼Œæ·»åŠ  false å³å¯ --&gt;
  &lt;p contentEditable="false"&gt;ä¸èƒ½ç¼–è¾‘æˆ‘&lt;/p&gt;
&lt;/blockquote&gt;

&lt;cite contenteditable="true"&gt;-- Write your own name here&lt;/cite&gt;
</code></pre>

<blockquote contenteditable="true">
  <p>Edit this content to add your own quote</p>
  <p contenteditable="false">ä¸èƒ½ç¼–è¾‘æˆ‘</p>
  <cite style="color:white">-- Write your own name here</cite>
</blockquote>

<h3 id="documentexeccommand">document.execCommand</h3>

<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/execCommand"><strong>document.execCommand</strong></a> å…è®¸è¿è¡Œå‘½ä»¤æ¥æ“çºµå¯ç¼–è¾‘å†…å®¹åŒºåŸŸçš„å…ƒç´ ï¼Œè¯´äººè¯ï¼Œå½“ä½¿ç”¨ <code class="highlighter-rouge">contentEditable</code> æ—¶ï¼Œè°ƒç”¨ <code class="highlighter-rouge">execCommand()</code> å°†å½±å“å½“å‰æ´»åŠ¨çš„å¯ç¼–è¾‘å…ƒç´ ã€‚è¯­æ³•å¦‚ä¸‹:</p>

<pre><code class="language-JS">/**
 * è¿”å›ä¸€ä¸ª Boolean ï¼Œå¦‚æœæ˜¯ false åˆ™è¡¨ç¤ºæ“ä½œä¸è¢«æ”¯æŒæˆ–æœªè¢«å¯ç”¨
 *
 * @param {*} aCommandName - ä¸€ä¸ª DOMString ï¼Œå‘½ä»¤çš„åç§°
 * @param {*} aShowDefaultUI - ä¸€ä¸ª Booleanï¼Œ æ˜¯å¦å±•ç¤ºç”¨æˆ·ç•Œé¢ï¼Œä¸€èˆ¬ä¸º false
 * @param {*} aValueArgument - ä¸€äº›å‘½ä»¤ï¼ˆå¦‚ insertImageï¼‰éœ€è¦é¢å¤–çš„å‚æ•°ï¼ˆinsertImage éœ€è¦æä¾›æ’å…¥ image çš„ urlï¼‰ï¼Œé»˜è®¤ä¸º nullã€‚
 */
bool = document.execCommand(aCommandName, aShowDefaultUI, aValueArgument)
</code></pre>

<p>é’ˆå¯¹å‘½ä»¤åç§°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹é»˜è®¤å¸¸ç”¨çš„æœ‰å“ªäº›ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸åŒæµè§ˆå™¨è¡¨ç°å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œä½¿ç”¨çš„è¯è¦è€ƒè™‘åˆ°å…¼å®¹æ€§:</p>

<ul>
  <li>backColor - ä¿®æ”¹æ–‡æ¡£çš„èƒŒæ™¯é¢œè‰²ã€‚åœ¨ styleWithCss æ¨¡å¼ä¸‹ï¼Œåˆ™åªå½±å“å®¹å™¨å…ƒç´ çš„èƒŒæ™¯é¢œè‰²ã€‚è¿™éœ€è¦ä¸€ä¸ª <code class="highlighter-rouge">&lt;color&gt;</code> ç±»å‹çš„å­—ç¬¦ä¸²å€¼ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚æ³¨æ„ï¼ŒIE æµè§ˆå™¨ç”¨è¿™ä¸ªè®¾ç½®æ–‡å­—çš„èƒŒæ™¯é¢œè‰²</li>
  <li>bold - å¼€å¯æˆ–å…³é—­é€‰ä¸­æ–‡å­—æˆ–æ’å…¥ç‚¹çš„ç²—ä½“å­—æ•ˆæœã€‚IE æµè§ˆå™¨ä½¿ç”¨ <code class="highlighter-rouge">&lt;strong&gt;</code> æ ‡ç­¾ï¼Œè€Œä¸æ˜¯ <code class="highlighter-rouge">&lt;b&gt;</code> æ ‡ç­¾</li>
  <li>copy - æ‹·è´å½“å‰é€‰ä¸­å†…å®¹åˆ°å‰ªè´´æ¿</li>
  <li>createLink - å°†é€‰ä¸­å†…å®¹åˆ›å»ºä¸ºä¸€ä¸ªé”šé“¾æ¥ã€‚è¿™ä¸ªå‘½ä»¤éœ€è¦ä¸€ä¸ª hrefURI å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°å€¼ä¼ å…¥ã€‚URI å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå­—ç¬¦ï¼Œä¾‹å¦‚ä¸€ä¸ªç©ºæ ¼ã€‚ï¼ˆæµè§ˆå™¨ä¼šåˆ›å»ºä¸€ä¸ªç©ºé“¾æ¥ï¼‰</li>
  <li>cut - å‰ªè´´å½“å‰é€‰ä¸­çš„æ–‡å­—å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿</li>
  <li>delete - åˆ é™¤é€‰ä¸­éƒ¨åˆ†</li>
  <li>fontName - åœ¨æ’å…¥ç‚¹æˆ–è€…é€‰ä¸­æ–‡å­—éƒ¨åˆ†ä¿®æ”¹å­—ä½“åç§°. éœ€è¦æä¾›ä¸€ä¸ªå­—ä½“åç§°å­—ç¬¦ä¸² (ä¾‹å¦‚ï¼šâ€Arialâ€)ä½œä¸ºå‚æ•°</li>
  <li>fontSize - åœ¨æ’å…¥ç‚¹æˆ–è€…é€‰ä¸­æ–‡å­—éƒ¨åˆ†ä¿®æ”¹å­—ä½“å¤§å°. éœ€è¦æä¾›ä¸€ä¸ª HTML å­—ä½“å°ºå¯¸ (1-7) ä½œä¸ºå‚æ•°</li>
  <li>foreColor - åœ¨æ’å…¥ç‚¹æˆ–è€…é€‰ä¸­æ–‡å­—éƒ¨åˆ†ä¿®æ”¹å­—ä½“é¢œè‰². éœ€è¦æä¾›ä¸€ä¸ªé¢œè‰²å€¼å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ã€‚</li>
  <li>formatBlock - æ·»åŠ ä¸€ä¸ª HTML å—å¼æ ‡ç­¾åœ¨åŒ…å«å½“å‰é€‰æ‹©çš„è¡Œ, å¦‚æœå·²ç»å­˜åœ¨äº†ï¼Œæ›´æ¢åŒ…å«è¯¥è¡Œçš„å—å…ƒç´ ï¼Œéœ€è¦æä¾›ä¸€ä¸ªæ ‡ç­¾åç§°å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°(ä¾‹å¦‚ â€œH1â€, â€œPâ€, â€œDLâ€, â€œBLOCKQUOTEâ€)</li>
  <li>heading - æ·»åŠ ä¸€ä¸ªæ ‡é¢˜æ ‡ç­¾åœ¨å…‰æ ‡å¤„æˆ–è€…æ‰€é€‰æ–‡å­—ä¸Šã€‚ éœ€è¦æä¾›æ ‡ç­¾åç§°å­—ç¬¦ä¸²ä½œä¸ºå‚æ•° (ä¾‹å¦‚. â€œH1â€, â€œH6â€)</li>
  <li>insertImage - åœ¨æ’å…¥ç‚¹æ’å…¥ä¸€å¼ å›¾ç‰‡å¹¶åˆ é™¤é€‰ä¸­çš„éƒ¨åˆ†ã€‚éœ€è¦ä¸€ä¸ª URL å­—ç¬¦ä¸²(å¯ä»¥ä¸º base64)ä½œä¸ºå‚æ•°ã€‚è¿™ä¸ª URL å›¾ç‰‡åœ°å€è‡³å°‘åŒ…å«ä¸€ä¸ªå­—ç¬¦ã€‚ç©ºç™½å­—ç¬¦ä¹Ÿå¯ä»¥</li>
  <li>italic - åœ¨å…‰æ ‡æ’å…¥ç‚¹å¼€å¯æˆ–å…³é—­æ–œä½“å­—ã€‚IE æµè§ˆå™¨ä½¿ç”¨ <code class="highlighter-rouge">&lt;em&gt;</code> æ ‡ç­¾ï¼Œè€Œä¸æ˜¯ <code class="highlighter-rouge">&lt;i&gt;</code></li>
  <li>justifyCenter - å¯¹å…‰æ ‡æ’å…¥ä½ç½®æˆ–è€…æ‰€é€‰å†…å®¹è¿›è¡Œæ–‡å­—å±…ä¸­ã€‚åŒç†è¿˜æœ‰ justifyLeftã€justifyRight ç­‰</li>
  <li>paste - åœ¨å…‰æ ‡ä½ç½®ç²˜è´´å‰ªè´´æ¿çš„å†…å®¹ï¼Œå¦‚æœæœ‰è¢«é€‰ä¸­çš„å†…å®¹ï¼Œä¼šè¢«æ›¿æ¢</li>
  <li>redo - é‡åšè¢«æ’¤é”€çš„æ“ä½œ</li>
  <li>removeFormat - å¯¹æ‰€é€‰å†…å®¹å»é™¤æ‰€æœ‰æ ¼å¼</li>
  <li>underline - åœ¨å…‰æ ‡æ’å…¥ç‚¹å¼€å¯æˆ–å…³é—­ä¸‹åˆ’çº¿</li>
  <li>undo - æ’¤é”€æœ€è¿‘æ‰§è¡Œçš„å‘½ä»¤</li>
  <li>unlink - å»é™¤æ‰€é€‰çš„é”šé“¾æ¥çš„ <code class="highlighter-rouge">&lt;a&gt;</code> æ ‡ç­¾</li>
</ul>

<pre><code class="language-JS">// åŠ ç²—
document.execCommand('bold', false, null)
// æ·»åŠ ä¸€ä¸ªå—æ ‡ç­¾åŒ…è£¹
document.execCommand('formatBlock', false, '&lt;blockquote&gt;')
</code></pre>

<blockquote>
  <p>æµè§ˆå™¨ä¼šå¯¹ <code class="highlighter-rouge">contenteditable</code> ç”Ÿæˆçš„å¯ç¼–è¾‘åŒºç»´æŠ¤ä¸€ä¸ª <code class="highlighter-rouge">undo</code> æ ˆå’Œ <code class="highlighter-rouge">redo</code> æ ˆï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿæ‰§è¡Œå‰è¿›å’Œåé€€çš„æ“ä½œ</p>
</blockquote>

<h3 id="selection--range">Selection / Range</h3>

<p>å½“æˆ‘ä»¬æ‰§è¡Œ <code class="highlighter-rouge">execCommand</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡æ˜å¯¹å“ªäº›é€‰åŒºè¿›è¡Œæ“ä½œï¼Œå³ <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection"><strong>Selection</strong></a>ï¼Œå®ƒè¡¨ç¤ºç”¨æˆ·é€‰æ‹©çš„æ–‡æœ¬èŒƒå›´æˆ–æ’å…¥ç¬¦å·çš„å½“å‰ä½ç½®ã€‚æ–‡æœ¬é€‰åŒºç”±ç”¨æˆ·æ‹–æ‹½é¼ æ ‡ç»è¿‡æ–‡å­—è€Œäº§ç”Ÿï¼Œè¦è·å–ç”¨äºæ£€æŸ¥æˆ–ä¿®æ”¹çš„ Selection å¯¹è±¡ï¼Œè¯·è°ƒç”¨ <code class="highlighter-rouge">window.getSelection()</code>ï¼Œå®ƒåŒ…å«äº†ä»¥ä¸‹æœ¯è¯­:</p>

<ul>
  <li><strong>é”šç‚¹(anchor)</strong> - é”šæŒ‡çš„æ˜¯ä¸€ä¸ªé€‰åŒºçš„èµ·å§‹ç‚¹(æ³¨æ„ä¸åŒäº HTML ä¸­çš„é”šç‚¹é“¾æ¥)ã€‚å½“æˆ‘ä»¬ä½¿ç”¨é¼ æ ‡æ¡†é€‰ä¸€ä¸ªåŒºåŸŸçš„æ—¶å€™ï¼Œé”šç‚¹å°±æ˜¯æˆ‘ä»¬é¼ æ ‡æŒ‰ä¸‹ç¬é—´çš„é‚£ä¸ªç‚¹ã€‚åœ¨ç”¨æˆ·æ‹–åŠ¨é¼ æ ‡æ—¶ï¼Œé”šç‚¹æ˜¯ä¸ä¼šå˜çš„ã€‚</li>
  <li><strong>ç„¦ç‚¹(focus)</strong> - é€‰åŒºçš„ç„¦ç‚¹æ˜¯è¯¥é€‰åŒºçš„ç»ˆç‚¹ï¼Œå½“æ‚¨ç”¨é¼ æ ‡æ¡†é€‰ä¸€ä¸ªé€‰åŒºçš„æ—¶å€™ï¼Œç„¦ç‚¹æ˜¯ä½ çš„é¼ æ ‡æ¾å¼€ç¬é—´æ‰€è®°å½•çš„é‚£ä¸ªç‚¹ã€‚éšç€ç”¨æˆ·æ‹–åŠ¨é¼ æ ‡ï¼Œç„¦ç‚¹çš„ä½ç½®ä¼šéšç€æ”¹å˜ã€‚</li>
  <li><strong>èŒƒå›´(range)</strong> - èŒƒå›´æŒ‡çš„æ˜¯æ–‡æ¡£ä¸­è¿ç»­çš„ä¸€éƒ¨åˆ†ã€‚ä¸€ä¸ªèŒƒå›´åŒ…æ‹¬æ•´ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå¯ä»¥åŒ…å«èŠ‚ç‚¹çš„ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚æ–‡æœ¬èŠ‚ç‚¹çš„ä¸€éƒ¨åˆ†ã€‚ç”¨æˆ·é€šå¸¸ä¸‹åªèƒ½é€‰æ‹©ä¸€ä¸ªèŒƒå›´ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™ç”¨æˆ·ä¹Ÿæœ‰å¯èƒ½é€‰æ‹©å¤šä¸ªèŒƒå›´ã€‚â€œèŒƒå›´â€ä¼šè¢«ä½œä¸º range å¯¹è±¡è¿”å›ã€‚Rangeå¯¹è±¡ä¹Ÿèƒ½é€šè¿‡ DOM åˆ›å»ºã€å¢åŠ ã€åˆ å‡</li>
</ul>

<p>Selection å¯¹è±¡æ‰€å¯¹åº”çš„æ˜¯ç”¨æˆ·æ‰€é€‰æ‹©çš„ <strong>ranges(åŒºåŸŸ)</strong>ï¼Œä¿—ç§°æ‹–è“ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å‡½æ•°åªé’ˆå¯¹ä¸€ä¸ªåŒºåŸŸï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ä½¿ç”¨è¿™ä¸ªå‡½æ•°:</p>

<pre><code class="language-JS">const selObj: Selection = window.getSelection()
const range: Range = selObj.getRangeAt(0) // è·å–æˆ‘ä»¬é€‰ä¸­çš„åŒºé—´
</code></pre>

<p>Selection æ‹¥æœ‰ä»¥ä¸‹å¸¸ç”¨çš„å±æ€§:</p>

<ul>
  <li>anchorNode - è¿”å›è¯¥é€‰åŒºèµ·ç‚¹æ‰€åœ¨çš„èŠ‚ç‚¹ï¼ˆNodeï¼‰</li>
  <li>anchorOffset - è¿”å›ä¸€ä¸ªæ•°å­—ï¼Œå…¶è¡¨ç¤ºçš„æ˜¯é€‰åŒºèµ·ç‚¹åœ¨ anchorNode ä¸­çš„ä½ç½®åç§»é‡</li>
  <li>focusNode - è¿”å›è¯¥é€‰åŒºç»ˆç‚¹æ‰€åœ¨çš„èŠ‚ç‚¹</li>
  <li>focusOffset - è¿”å›ä¸€ä¸ªæ•°å­—ï¼Œå…¶è¡¨ç¤ºçš„æ˜¯é€‰åŒºç»ˆç‚¹åœ¨ focusNode ä¸­çš„ä½ç½®åç§»é‡</li>
  <li>isCollapsed - è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨äºåˆ¤æ–­é€‰åŒºçš„èµ·å§‹ç‚¹å’Œç»ˆç‚¹æ˜¯å¦åœ¨åŒä¸€ä¸ªä½ç½®</li>
  <li>rangeCount - è¿”å›è¯¥é€‰åŒºæ‰€åŒ…å«çš„è¿ç»­èŒƒå›´çš„æ•°é‡</li>
</ul>

<p>å¹¶ä¸”æœ‰ä»¥ä¸‹å¸¸ç”¨æ–¹æ³•:</p>

<ul>
  <li>getRangeAt - è¿”å›é€‰åŒºå¼€å§‹çš„èŠ‚ç‚¹ï¼ˆNodeï¼‰</li>
  <li>collapse - å°†å½“å‰çš„é€‰åŒºæŠ˜å ä¸ºä¸€ä¸ªç‚¹</li>
  <li>addRange - ä¸€ä¸ªåŒºåŸŸï¼ˆRangeï¼‰å¯¹è±¡å°†è¢«åŠ å…¥é€‰åŒº</li>
  <li>removeRange - ä»é€‰åŒºä¸­ç§»é™¤ä¸€ä¸ªåŒºåŸŸ</li>
  <li>removeAllRanges - å°†æ‰€æœ‰çš„åŒºåŸŸéƒ½ä»é€‰åŒºä¸­ç§»é™¤</li>
  <li>deleteFromDocument - ä»é¡µé¢ä¸­åˆ é™¤é€‰åŒºä¸­çš„å†…å®¹</li>
  <li>toString - è¿”å›å½“å‰é€‰åŒºçš„çº¯æ–‡æœ¬å†…å®¹</li>
  <li>containsNode - åˆ¤æ–­æŸä¸€ä¸ª node æ˜¯å¦ä¸ºå½“å‰é€‰åŒºçš„ä¸€éƒ¨åˆ†</li>
</ul>

<blockquote>
  <p>Range å¯¹è±¡ä¹ŸåŒ…å«äº†å¾ˆå¤šå±æ€§å’Œæ–¹æ³•ï¼Œå…·ä½“å¯ä»¥<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range">æŸ¥é˜…è¿™é‡Œ</a> ğŸ‘ˆ</p>
</blockquote>

<p>æˆ‘ä»¬ç›´æ¥ç”¨ä¸€äº›ä¾‹å­æ¥å¯¹æ¯”ä¸‹é€‰åŒºå’Œç›¸åº”çš„å±æ€§å€¼:</p>

<p><img src="https://i.loli.net/2019/12/17/vRNApDcCBuPza65.png" alt="rich-editor-selection.png" /></p>

<blockquote>
  <p>éœ€è¦æ³¨æ„çš„æ˜¯ 2 æ­¥éª¤ä¸­ï¼Œå¦‚æœæœ‰ä¸€æ®µæ–‡æœ¬æœ‰è®¾ç½®å‘½ä»¤ï¼Œåˆ™å®ƒä¼šè¢«åˆ†å‰²æˆå¤šä¸ªç‰‡æ®µ</p>
</blockquote>

<h3 id="setselectionrange">setSelectionRange</h3>

<p>ä¸Šè¿°æ˜¯æˆ‘ä»¬ä¸»åŠ¨å»é€‰æ‹©ä¸€å—å„¿åŒºåŸŸï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <code class="highlighter-rouge">setSelectionRange</code> æ¥åˆ›å»ºä¸€ç‰‡é€‰åŒº:</p>

<pre><code class="language-JS">/**
 * æ¯æ¬¡è°ƒç”¨è¿™ä¸ªè¿™ä¸ªæ–¹æ³•ä¼šæ›´æ–° HTMLInputElement çš„ selectionStart, selectionEnd,å’Œ selectionDirection å±æ€§
 *
 * @param {*} selectionStart - è¢«é€‰ä¸­çš„ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ä½ç½®
 * @param {*} selectionEnd - è¢«é€‰ä¸­çš„æœ€åä¸€ä¸ªå­—ç¬¦çš„ ä¸‹ä¸€ä¸ª ä½ç½®
 * @param {*} selectionDirection - ä¸€ä¸ªæŒ‡æ˜é€‰æ‹©æ–¹å‘çš„å­—ç¬¦ä¸²ï¼Œæœ‰"forward","backward"å’Œ"none" 3ä¸ªå¯é€‰å€¼
 */
inputElement.setSelectionRange(selectionStart, selectionEnd, [optional] selectionDirection);
</code></pre>

<blockquote>
  <p>æ³¨æ„ï¼ŒsetSelectionRange åªèƒ½åœ¨ä¸€ä¸ªè¢« focused çš„ <code class="highlighter-rouge">&lt;input&gt;</code> å…ƒç´ ä¸­é€‰ä¸­ç‰¹å®šèŒƒå›´çš„å†…å®¹ï¼Œå¦åˆ™æ— æ³•é€‰ä¸­</p>
</blockquote>

<script>
  const selectText = () => {
    const input = document.querySelector('#mytextbox')
    input.focus()
    input.setSelectionRange(7, 11) // é€‰æ‹©ç‰¹å®šéƒ¨åˆ†
    // input.setSelectionRange(0, -1) // å…¨é€‰
  }

  const execCopyText = node => {
    let canUserSelect = true
    const selection = window.getSelection()
    const range = document.createRange() // è¿”å›ä¸€ä¸ª Range å¯¹è±¡

    // ä¸è®©é€‰ä¹Ÿè¦é€‰
    if (getComputedStyle(node).userSelect === 'none' || getComputedStyle(node)['-webkit-user-select'] === 'none') {
      canUserSelect = false
      node.style.userSelect = 'text'
      node.style['-webkit-user-select'] = 'text'
    }

    // è®¾ç½® Range ä½¿å…¶åŒ…å«ä¸€ä¸ª Node çš„å†…å®¹
    range.selectNodeContents(node)

    selection.removeAllRanges()
    selection.addRange(range)
    document.execCommand('copy')

    if (!canUserSelect) {
      node.style.userSelect = 'none'
      node.style['-webkit-user-select'] = 'none'
    }
  }

  const copyText = () => {
    const input = document.querySelector('#test')
    input.focus()
    execCopyText(input)
  }
</script>

<body>
  <p><input type="text" id="mytextbox" size="20" value="Tate &amp; Snow" /></p>
  <p id="test" style="user-select:none;-webkit-user-select:none">Tate &amp; Snow Copied</p>
  <p>
    <button style="padding:2px" onclick="selectText()">Select Snow</button>
    <button style="padding:2px" onclick="copyText()">Copy text</button>
  </p>
</body>

<p>å¦‚æœä¸æ˜¯ input æ¡†å‘¢ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼æ¥å®ç°â€éš”ç©ºæ‹·è´â€ã€‚å¯ä»¥çœ‹æ˜¯å¦èƒ½é€‰ä¸­ <code class="highlighter-rouge">Tate &amp; Snow Copied</code>ï¼Œä¸è¡Œçš„è¯è¯•è¯•ç‚¹å‡»ä¸‹ä¸Šé¢çš„ â€œCopy textâ€ æŒ‰é’® ğŸ˜„:</p>

<pre><code class="language-JS">const execCopyText: (node: HTMLElement) =&gt; void = node =&gt; {
  let canUserSelect = true
  const selection = window.getSelection() as Selection
  const range = document.createRange() // è¿”å›ä¸€ä¸ª Range å¯¹è±¡

  // ä¸è®©é€‰ä¹Ÿè¦é€‰
  // å¦‚æœæ˜¯ safari æµè§ˆå™¨ï¼Œåˆ™éœ€è¦åˆ¤æ–­ getComputedStyle(node)['-webkit-user-select']ï¼Œå…¶ä»–åŒç†åšå…¼å®¹æ€§å¤„ç†
  if (getComputedStyle(node).userSelect === 'none') {
    canUserSelect = false
    node.style.userSelect = 'text'
  }

  // è®¾ç½® Range ä½¿å…¶åŒ…å«ä¸€ä¸ª Node çš„å†…å®¹
  range.selectNodeContents(node)

  selection.removeAllRanges()
  selection.addRange(range)
  document.execCommand('copy')

  if (!canUserSelect) {
    node.style.userSelect = 'none'
  }
}
</code></pre>

<h3 id="ç®€å•çš„å¯Œæ–‡æœ¬å®ç°">ç®€å•çš„å¯Œæ–‡æœ¬å®ç°</h3>

<p>æˆ‘ä»¬äº†è§£äº†å…³äºå¯Œæ–‡æœ¬çš„ä¸€äº›æŠ€æœ¯å®ç°åï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥æ‰‹åŠ¨æ’¸ä¸€ä¸ªäº†:</p>

<style>
  .container button {
    padding: 5px;
    cursor: pointer;
  }
  .container label {
    padding: 5px;
    background-color: white;
    cursor: pointer;
  }
  .editor-container {
    display: flex;
  }
  .editor-container div {
    width: 400px;
    height: 200px;
    overflow: auto;
    background-color: white;
  }
  .editor-container div p {
    color: black !important;
  }
  .editor-container div a {
    color: red !important;
  }
</style>

<div>
  <div class="container" role="nav">
    <button onclick="exec('copy')">å¤åˆ¶</button>
    <!-- <button onclick="exec('paste')">ç²˜è´´</button> -->
    <button onclick="exec('bold')">åŠ ç²—</button>
    <button onclick="exec('underline')">ä¸‹åˆ’çº¿</button>
    <button onclick="exec('formatBlock', false, '&lt;p&gt;')">æ®µè½</button>
    <button onclick="createLink()">è®¾ç½®è¶…é“¾æ¥</button>
    <button onclick="createImage()">è®¾ç½®å›¾ç‰‡é“¾æ¥</button>
    <button onclick="clickImage()">æ’å…¥å›¾ç‰‡</button>
    <button onclick="exec('removeFormat')">æ¸…é™¤æ ·å¼</button>
    <button onclick="exec('undo')">æ’¤é”€</button>
    <button onclick="exec('redo')">é‡åš</button>
    <input id="editor-img" style="display:none" type="file" accept="image/gif, image/jpeg, image/png" onchange="insertImage(event)" />
  </div>
  <div role="editor-container" class="editor-container">
    <div style="margin-right:10px" role="editor" oninput="print()" contenteditable="true">ä¸å¦¨æ¥è¯•ä¸€è¯• ğŸ˜œ</div>
    <div role="preview">ä¸å¦¨æ¥è¯•ä¸€è¯• ğŸ˜œ</div>
  </div>
</div>
<script>
  let currentRange = null // å½“å‰é€‰åŒº
  const saveSelection = () => { // ä¿å­˜å½“å‰ Range å¯¹è±¡
    const selection = window.getSelection()
    if (selection.rangeCount > 0) {
      return selection.getRangeAt(0)
    }
    return null
  }
  const restoreSelection = () => {
    const selection = window.getSelection()
    if (currentRange) {
      selection.removeAllRanges()  // æ¸…ç©ºæ‰€æœ‰ Range å¯¹è±¡
      selection.addRange(currentRange) // æ¢å¤ä¿å­˜çš„ Range
    }
  }
  const exec = (aCommandName, aShowDefaultUI = false, aValueArgument = null) => {
    document.execCommand(aCommandName, aShowDefaultUI, aValueArgument)
  }
  const saveCurrentSelection = () => {
    currentRange = saveSelection()
  }
  const createLink = () => {
    const url = window.prompt('è¯·è¾“å…¥è¶…é“¾æ¥')
    if (url) {
      exec('createLink', false, url)
    }
  }
  const clickImage = () => {
    saveCurrentSelection()
    document.querySelector('#editor-img').click()
  }
  const createImage = () => {
    saveCurrentSelection()
    const url = window.prompt('è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥')
    if (url) {
      exec('insertImage', false, url)
    }
  }
  const insertImage = (e) => {
    let reader = new FileReader()
    let file = e.target.files[0]
    // document.querySelector('.editor-container div[role="editor"]').focus()
    reader.onload = () => {
      let base64Img = reader.result
      restoreSelection()
      exec('insertImage', false, base64Img)
      document.querySelector('.editor-img input').value = '' // è§£å†³åŒä¸€å¼ å›¾ç‰‡ä¸Šä¼ æ— æ•ˆçš„é—®é¢˜
    }
    reader.readAsDataURL(file)
  }
  const print = () => {
    document.querySelector("div[role='preview']").innerText = document.querySelector("div[role='editor']").innerHTML
  }
</script>

<p>ä½†æ˜¯æˆ‘ä»¬ä¸€å®šè¦å…³æ³¨ focus çš„çŠ¶æ€ï¼Œåªæœ‰èšç„¦åœ¨ç¼–è¾‘åŒºæ‰èƒ½æ‰§è¡Œç›¸åº”çš„å‘½ä»¤ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€äº›æ–¹æ³•æ¥ä¿å­˜å’Œæ¢å¤é€‰åŒºçš„ Range å¯¹è±¡:</p>

<pre><code class="language-JS">let currentRange = null // å½“å‰é€‰åŒº
const saveSelection = () =&gt; { // ä¿å­˜å½“å‰ Range å¯¹è±¡
  const selection = window.getSelection()
  if (selection.rangeCount &gt; 0) {
    return selection.getRangeAt(0)
  }
  return null
}
const restoreSelection = () =&gt; {
  const selection = window.getSelection()
  if (currentRange) {
    selection.removeAllRanges()  // æ¸…ç©ºæ‰€æœ‰ Range å¯¹è±¡
    selection.addRange(currentRange) // æ¢å¤ä¿å­˜çš„ Range
  }
}
</code></pre>

<h2 id="draftjs">Draft.js</h2>

<p><a href="https://draftjs.org"><strong>Draft.js</strong></a> æ˜¯ facebook æ¨å‡ºçš„ç”¨äº React çš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ¡†æ¶ï¼Œæ˜¯é€šè¿‡ <code class="highlighter-rouge">Immutable.js</code> æ¥ä¿å­˜æ•°æ®çš„ã€‚ä¸€ä¸ªç‚’é¸¡ç®€å•çš„ demo å¦‚ä¸‹:</p>

<p><img src="https://camo.githubusercontent.com/441ad6e66bcdf56276026625ad31a1e7a634d822/68747470733a2f2f6d656469612e67697068792e636f6d2f6d656469612f5848556a6178454c7063313153695253714e2f67697068792e676966" alt="Draft.js" /></p>

<pre><code class="language-JS">import React from 'react'
import ReactDOM from 'react-dom'
import { Editor, EditorState } from 'Draft.js'

function MyEditor() {
  const [editorState, setEditorState] = React.useState(
    EditorState.createEmpty()
  )

  const editor = React.useRef(null)

  function focusEditor() {
    editor.current.focus()
  }

  React.useEffect(() =&gt; {
    focusEditor()
  }, [])

  return (
    &lt;div onClick={focusEditor}&gt;
      &lt;Editor
        ref={editor}
        editorState={editorState}
        onChange={editorState =&gt; setEditorState(editorState)}
      /&gt;
    &lt;/div&gt;
  )
}
</code></pre>

<h3 id="editorstate">EditorState</h3>

<p><a href="https://draftjs.org/docs/api-reference-editor-state"><strong>EditorState</strong></a> æ˜¯ç¼–è¾‘å™¨æœ€é¡¶å±‚çš„çŠ¶æ€å¯¹è±¡ï¼Œå®ƒæ˜¯ä¸€ä¸ª <code class="highlighter-rouge">Immutable Record</code> å¯¹è±¡ï¼Œä¿å­˜äº†ç¼–è¾‘å™¨ä¸­å…¨éƒ¨çš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡æœ¬çŠ¶æ€ã€é€‰ä¸­çŠ¶æ€ç­‰:</p>

<p><img src="http://www.wukai.me/asset/images/2019-07-21-draft-editor-01.png" alt="EditorState" /></p>

<p>å½“æ“ä½œ EditorState å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç›´æ¥é€šè¿‡ Immutable çš„ API æ¥è·å–æƒ³è¦çš„å€¼ï¼Œè€Œæ˜¯é€šè¿‡å®ƒæš´éœ²å‡ºæ¥çš„é™æ€æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•:</p>

<ul>
  <li>getCurrentContent(): ContentState - è¿”å›ä¸€ä¸ª <strong>ContentState</strong> å¯¹è±¡ï¼Œå­˜æ”¾çš„æ˜¯å½“å‰ç¼–è¾‘å™¨ä¸­çš„å†…å®¹</li>
  <li>getSelection(): SelectionState - è¿”å›å½“å‰é€‰ä¸­çš„çŠ¶æ€</li>
  <li>getCurrentInlineStyle(): DraftInlineStyle - è¿”å›ä¸€ä¸ªä»£è¡¨ç€ç¼–è¾‘å™¨â€œå½“å‰â€å†…è”æ ·å¼çš„ <code class="highlighter-rouge">OrderedSet&lt;string&gt;</code></li>
  <li>static createEmpty(?decorator): EditorState - åˆ›å»ºç©ºçš„ EditorState å®ä¾‹</li>
  <li>static createWithContent(contentState, ?decorator): EditorState - åŸºäº ContentState å’Œ decorator è¿”å›ä¸€ä¸ªæ–°çš„ EditorState</li>
  <li>static create(config): EditorState</li>
  <li>static push(editorState, contentState, changeType): EditorState - è¿”å›ä¸€ä¸ªæ–°çš„ EditorState å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä½¿ç”¨æŒ‡å®šçš„ ContentState ä½œä¸ºæ–°çš„å½“å‰å†…å®¹ã€‚åŸºäºchangeTypeï¼Œè¿™ä¸ªContentStateå¯èƒ½ä¼šè¢«è§†ä¸ºæ’¤é”€/é‡åšçš„è¾¹ç•ŒçŠ¶æ€</li>
  <li>static undo(editorState): EditorState - ä» undo æ ˆ pop å‡ºä¸€ä¸ªæ–°çš„ EditorState å¯¹è±¡ï¼Œæ›´æ–°ä¸ºå½“å‰çš„ ContentState å¯¹è±¡</li>
  <li>static redo(editorState): EditorState - åŒä¸Šï¼Œåªä¸è¿‡æ˜¯ redo æ ˆ</li>
  <li>static forceSelection(editorState, selectionState): EditorState - è¿”å›ä¸€ä¸ªæ–°çš„ EditorState å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä½¿ç”¨æŒ‡å®šçš„ SelectionStateï¼Œå¹¶å¼ºåˆ¶é€‰æ‹©è¢«æ¸²æŸ“</li>
  <li>static set(editorState, EditorStateRecordType): EditorState</li>
</ul>

<pre><code class="language-JS">// åˆ›å»ºç©ºçš„ EditorState å®ä¾‹
const createEmptyEditorState: (p?: any) =&gt; EditorState = decorator =&gt;
  EditorState.createEmpty(decorator)

const createEditorState: (state: ContentState, p?: any) =&gt; EditorState = (contentState, decorator) =&gt;
  EditorState.createWithContent(contentState, decorator)

// åŸºäº raw æ¥åˆ›å»º EditorState å¯¹è±¡
const emptyEditorState = isEmptyObject(raw) ? createEmptyEditorState() : createEditorState(convertFromRaw(raw))
</code></pre>

<h3 id="contentstate">ContentState</h3>

<p><a href="https://draftjs.org/docs/api-reference-content-state"><strong>ContentState</strong></a> æ˜¯ç”¨æ¥ä¿å­˜ç¼–è¾‘å™¨é‡Œçš„å…¨éƒ¨å†…å®¹å’Œæ¸²æŸ“å‰åçš„ä¸¤ä¸ªé€‰ä¸­çŠ¶æ€ï¼Œå¸¸ç”¨çš„æ–¹æ³•æœ‰:</p>

<ul>
  <li>getEntityMap(): EntityMap - è¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰å·²åˆ›å»ºçš„ DraftEntity è®°å½•çš„å­˜å‚¨å¯¹è±¡ EntityMap</li>
  <li>getBlockMap(): BlockMap - è·å– BlockMapï¼Œè¡¨ç¤ºæ•´ä¸ªæ–‡æ¡£çŠ¶æ€çš„ ContentBlock å¯¹è±¡ç»„æˆçš„å®Œæ•´æœ‰åºæ˜ å°„</li>
  <li>getBlockForKey(key: string): ContentBlock - æ ¹æ® key è¿”å›å¯¹åº”çš„ ContentBlock å¯¹è±¡</li>
  <li>getFirstBlock() - è·å–ç¬¬ä¸€ä¸ª ContentBlock å¯¹è±¡ï¼ŒåŒç†æœ‰ <code class="highlighter-rouge">getLastBlock</code></li>
  <li>getLastCreatedEntityKey(): string - è¿”å›æœ€è¿‘ä¸€æ¬¡åˆ›å»ºçš„ DraftEntityRecord å¯¹è±¡çš„åº”ç”¨ keyã€‚å› ä¸ºåœ¨ ContentState å¯¹è±¡ä¸­å¯ä»¥é€šè¿‡å­—ç¬¦ä¸² key æ¥å¼•ç”¨å¯¹åº”çš„å®ä½“å¯¹è±¡ã€‚åº”åœ¨ CharacterMetadata å¯¹è±¡ä¸­ä½¿ç”¨å­—ç¬¦ä¸² key æ¥æ ‡è®°å¯¹åº”çš„å­—ç¬¦å®ä½“</li>
  <li>createEntity(type: DraftEntityType, mutability: DraftEntityMutability, data?: Object): ContentState - è¿”å› EntityMap ä¸­åŒ…å«äº†æ–°å»ºçš„ DraftEntity å¯¹è±¡çš„ ContentState å¯¹è±¡</li>
  <li>getEntity(key: string): DraftEntityInstance - æ ¹æ® key è¿”å›å¯¹åº”çš„ DraftEntityInstance å¯¹è±¡</li>
</ul>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code class="highlighter-rouge">EditorState.getCurrentContent()</code> æ¥è·å–å½“å‰çš„ ContentStateï¼Œä½¿ç”¨ <code class="highlighter-rouge">toObject()</code> è½¬æ¢ä¸ºæ™®é€š javascript å¯¹è±¡åï¼Œå¯ä»¥çœ‹åˆ°å®ƒä¸»è¦åŒ…å«äº† <strong>BlockMap</strong> å’Œ <strong>EntityMap</strong> æœ‰åºæ˜ å°„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†åˆ«é€šè¿‡ä¸Šé¢æåˆ°çš„ <code class="highlighter-rouge">getBlockMap</code> å’Œ <code class="highlighter-rouge">getEntityMap</code> æ–¹æ³•æ¥è·å–ä»–ä»¬:</p>

<pre><code class="language-TEXT"># blockMap: OrderedMap {size: 6, _map: Map, _list: List, __ownerID: undefined, __hash: undefined}
# entityMap: {0: "1"}
# selectionAfter: SelectionState {_map: Map, __ownerID: undefined}
# selectionBefore: SelectionState {_map: Map, __ownerID: undefined}
</code></pre>

<p>é‚£ä¹ˆä»–ä»¬åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿé€šè¿‡ <code class="highlighter-rouge">convertToRaw(currentContent)</code> è½¬æ¢åçœ‹çœ‹å…¶ä¸­çš„å†…å®¹ï¼Œè¿™é‡Œåªæœ‰ blocks å’Œ entityMap è¿™ä¸¤é¡¹:</p>

<pre><code class="language-TEXT"># blocks: Array(6)
  0: {key: "dpibs", text: "123", type: "unstyled", depth: "0", inlineStyleRanges: Array(5), â€¦}
  1: {key: "8evo3", text: "", type: "unstyled", depth: "0", inlineStyleRanges: Array(0), â€¦}
  2: {key: "9p4vp", text: "", type: "unstyled", depth: "0", inlineStyleRanges: Array(0), â€¦}
  3: {key: "eigub", text: "tate", type: "unstyled", depth: "0", inlineStyleRanges: Array(2), â€¦}
  4: {key: "607oo", text: "", type: "unstyled", depth: "0", inlineStyleRanges: Array(0), â€¦}
  5:
    data: {}
    depth: "0"
    entityRanges: Array(1)
      0: {offset: 0, length: 4, key: 0}
    inlineStyleRanges: Array(2)
      0: {offset: 0, length: 4, style: "FONTFAMILY-Helvetica"}
      1: {offset: 0, length: 4, style: "LINEHEIGHT-1.5"}
    key: "ff87"
    text: "link"
    type: "unstyled"
# entityMap:
  0:
    data: {url: "www.baidu.com"}
    mutability: "MUTABLE"
    type: "LINK"
</code></pre>

<p>å¯ä»¥çœ‹åˆ° blocks è¿™ä¸ªæ•°ç»„ä¸­ä¾æ¬¡å­˜æ”¾äº†å„ä¸ª block çš„ä¿¡æ¯ï¼Œæ¯ä¸€ä¸ª block éƒ½æ˜¯ä¸€ä¸ª <strong>ContentBlock</strong> å¯¹è±¡ã€‚è€Œ entityMap åˆ™åŒ…å«äº†æ‰€æœ‰å®ä½“ã€‚</p>

<h3 id="contentblock">ContentBlock</h3>

<p><a href="https://draftjs.org/docs/api-reference-content-block"><strong>ContentBlock</strong></a> è¡¨ç¤ºç¼–è¾‘å™¨å†…å®¹ä¸­æ¯ä¸€ä¸ª block çš„å®Œæ•´çŠ¶æ€ï¼Œç±»ä¼¼äºæ®µè½è¿™ç§å—çº§å…ƒç´ ï¼Œä¸»è¦åŒ…å«äº†ä»¥ä¸‹å‡ æ–¹é¢:</p>

<ul>
  <li>key - æ ‡è¯†ç¬¦ï¼Œè·å–æ–¹å¼ä¸º <code class="highlighter-rouge">getKey()</code></li>
  <li>type - è¿™æ˜¯ä½•ç§ç±»å‹çš„ blockï¼Œå¸¸è§çš„æœ‰ <code class="highlighter-rouge">unstyled</code>ã€ <code class="highlighter-rouge">paragragh</code>ã€<code class="highlighter-rouge">atomic</code> ç­‰ï¼Œè·å–æ–¹å¼ä¸º <code class="highlighter-rouge">getType()</code></li>
  <li>text - çº¯æ–‡å­—ï¼Œä¸åŒ…æ‹¬ä»»ä½•æ ·å¼ã€ä¿®é¥°æˆ– HTML ä¿¡æ¯ï¼Œè·å–æ–¹å¼ä¸º <code class="highlighter-rouge">getText()</code></li>
  <li>data - å—çº§å…ƒæ•°æ®ï¼Œè·å–æ–¹å¼ä¸º <code class="highlighter-rouge">getData()</code></li>
  <li>entityRanges - å®ä½“
    <ul>
      <li>type - å®ä½“ç±»å‹</li>
      <li>data - å®ä½“åŒ…å«çš„æ•°æ®</li>
      <li>mutability - æ ‡è¯†å®ä½“åœ¨ç”¨æˆ·ç¼–è¾‘çš„æ—¶å€™å±•ç°å‡ºæ¥çš„ç‰¹æ€§</li>
    </ul>
  </li>
  <li>inlineStyleRanges - æ‰€æœ‰å†…è”æ ·å¼
    <ul>
      <li>offset - åç§»é‡</li>
      <li>length - å­—ç¬¦é•¿åº¦</li>
      <li>style - æ ·å¼ç±»å‹</li>
    </ul>
  </li>
  <li>characterList - æ˜¯ä¸€ä¸ª immutable List åˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«è¯¥å—ä¸­æ¯ä¸ªå­—ç¬¦çš„ <strong>CharacterMetadata</strong> å¯¹è±¡ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ç§æ–¹å¼ç”¨ä»£ç æ¥æ„å»ºå—çš„æ ·å¼å’Œå®ä½“ï¼Œè·å–æ–¹å¼ä¸º <code class="highlighter-rouge">getCharacterList()</code></li>
</ul>

<p>é€šè¿‡åœ¨è¿™äº› characterList åˆ—è¡¨å’Œ CharacterMetadata å¯¹è±¡ä¸Šå¤§é‡ä½¿ç”¨ä¸å¯å˜å’Œæ•°æ®æŒä¹…åŒ–ç‰¹æ€§ï¼Œä½¿å¾—åœ¨ç¼–è¾‘å™¨ä¸­ç¼–è¾‘å†…å®¹å ç”¨å†…å­˜å¾ˆå°ã€‚å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŒ…å« text ä½†ä¸åŒ…å« characterList çš„ ContentBlock å¯¹è±¡æ—¶ï¼Œä¼šé»˜è®¤ä¸ºæä¾›çš„æ–‡æœ¬æ·»åŠ ä¸€ä¸ªå¸¦æœ‰ç©º CharacterMetadata å¯¹è±¡çš„ characterListã€‚</p>

<h3 id="charactermetadata">CharacterMetadata</h3>

<p><strong>CharacterMetadata</strong> è¡¨ç¤ºä¸€ä¸ªåŒ…å«å•ä¸€å­—ç¬¦è¡Œå†…æ ·å¼å’Œå®ä½“ä¿¡æ¯çš„å¯¹è±¡ã€‚CharacterMetadata å¯¹è±¡è¢«å³æ—¶çš„æ±‡æ€»å’Œå…±äº«ã€‚å¦‚æœä¸¤ä¸ªå­—ç¬¦æ‹¥æœ‰ç›¸åŒçš„è¡Œå†…æ ·å¼å’Œå®ä½“ï¼Œå®ƒä»¬ä¼šè¢«è¡¨ç¤ºä¸ºç›¸åŒçš„ CharacterMetadata å¯¹è±¡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦å°½å¯èƒ½å¤šçš„ç»„åˆå¸¦æœ‰å®ä½“ key çš„å†…è”æ ·å¼é›†åˆï¼Œä»¥è¾¾åˆ°å³ä¾¿å†…å®¹çš„å¤§å°å’Œå¤æ‚æ€§å¢åŠ ï¼Œæˆ‘ä»¬çš„å†…å­˜å ç”¨ä¹Ÿå¾ˆå°çš„ç›®çš„ã€‚ä¸ºæ­¤ï¼Œä½ éœ€è¦ç”¨è¿‡æä¾›çš„é™æ€æ–¹æ³•æ¥ä¸º CharacterMetadata å¯¹è±¡åˆ›å»ºæˆ–åº”ç”¨å˜æ›´ï¼Œè¿™èƒ½ç¡®ä¿æœ€å¤§é™åº¦çš„å¤ç”¨:</p>

<ul>
  <li>static create(â€¦): CharacterMetadata - æ ¹æ®æä¾›çš„é…ç½®ä¿¡æ¯ç”Ÿæˆä¸€ä¸ª CharacterMetadata å¯¹è±¡</li>
  <li>static applyStyle(â€¦): CharacterMetadata - åœ¨ CharacterMetadata å¯¹è±¡ä¸Šåº”ç”¨æŒ‡å®šå†…è”æ ·å¼</li>
  <li>static removeStyle(â€¦): CharacterMetadata - ä» CharacterMetadata å¯¹è±¡ä¸­ç§»é™¤æŒ‡å®šå†…è”æ ·å¼</li>
  <li>static applyEntity(â€¦): CharacterMetadata - åœ¨ CharacterMetadata å¯¹è±¡ä¸Šåº”ç”¨ä¸€ä¸ªå®ä½“ key</li>
</ul>

<p>æ¯”å¦‚æˆ‘è¦åšä¸ªé€‰ä¸­åæ¸…é™¤é€‰åŒºæ‰€æœ‰å†…è”æ ·å¼çš„åŠŸèƒ½ï¼Œé‚£æˆ‘å¯èƒ½ä¼šé’ˆå¯¹æ‰€é€‰çš„ block ä¸­ characterList è¿›è¡Œéå†ï¼Œæ¸…é™¤æ¯ä¸€ä¸ª CharacterMetadata å¯¹è±¡åŒ…å«çš„å†…è”æ ·å¼ä¿¡æ¯ï¼Œé‚£ä¹ˆé¦–å…ˆæˆ‘ä»¬è¦ç­›é€‰å‡ºé€‰ä¸­çš„ block èŒ:</p>

<pre><code class="language-JS">const getSelectedBlocks: (state: EditorState) =&gt; ContentBlock[] = editorState =&gt; {
  const selection = editorState.getSelection()
  const contentState = editorState.getCurrentContent()

  const startKey = selection.getStartKey() // åŒ…å«é€‰åŒºèµ·å§‹ä½ç½®çš„ block çš„ key
  const endKey = selection.getEndKey() // åŒ…å«é€‰åŒºç»“æŸä½ç½®çš„ block çš„ key
  const isSameBlock = startKey === endKey
  const startingBlock = contentState.getBlockForKey(startKey)
  const selectedBlocks = [startingBlock]

  if (!isSameBlock) { // å¦‚æœæ˜¯å¥½å¤š block
    let blockKey = startKey

    while (blockKey !== endKey) {
      const nextBlock = contentState.getBlockAfter(blockKey)
      selectedBlocks.push(nextBlock)
      blockKey = nextBlock.getKey()
    }
  }

  return selectedBlocks
}
</code></pre>

<p>ç„¶åæˆ‘ä»¬éœ€è¦æ›´æ–° characterList åˆ—è¡¨ï¼ŒæŠŠç©ºçš„æ ·å¼è¦†ç›–è¿›å»å¹¶æ›´æ–°å½“å‰çš„ EditorState:</p>

<pre><code class="language-JS">// æ›´æ–° characterList åˆ—è¡¨
const updateEachCharacterOfSelection: (state: EditorState, f: any) =&gt; any = (editorState, callback) =&gt; {
  const selection = editorState.getSelection()
  const contentState = editorState.getCurrentContent()
  const contentBlocks = contentState.getBlockMap()
  const selectedBlocks = getSelectedBlocks(editorState)

  if (selectedBlocks.length === 0) {
    return editorState
  }

  const startKey = selection.getStartKey()
  const startOffset = selection.getStartOffset()
  const endKey = selection.getEndKey()
  const endOffset = selection.getEndOffset()

  const nextContentBlocks = contentBlocks.map((block?: ContentBlock | undefined) =&gt; {
    const curBlock = block as ContentBlock
    if (!selectedBlocks.includes(curBlock)) {
      return block
    }

    const blockKey = curBlock.getKey()
    const charactersList = curBlock.getCharacterList()
    let nextCharactersList = null

    if (blockKey === startKey &amp;&amp; blockKey === endKey) {
      nextCharactersList = charactersList.map((character, index) =&gt; {
        const i = index as number
        if (i &gt;= startOffset &amp;&amp; i &lt; endOffset) {
          return callback(character)
        }
        return character
      })
    } else if (blockKey === startKey) {
      nextCharactersList = charactersList.map((character, index) =&gt; {
        const i = index as number
        if (i &gt;= startOffset) {
          return callback(character)
        }
        return character
      })
    } else if (blockKey === endKey) {
      nextCharactersList = charactersList.map((character, index) =&gt; {
        const i = index as number
        if (i &lt; endOffset) {
          return callback(character)
        }
        return character
      })
    } else {
      nextCharactersList = charactersList.map(character =&gt; {
        return callback(character)
      })
    }

    return curBlock.merge({
      characterList: nextCharactersList,
    })
  })

  return EditorState.push(editorState, (contentState as any).merge({
    blockMap: nextContentBlocks,
    selectionBefore: selection,
    selectionAfter: selection,
  }), 'remove-range')
}

// æ¸…é™¤å†…è”æ ·å¼
const removeSelectionInlineStyles: (state: EditorState) =&gt; EditorState = editorState =&gt;
  updateEachCharacterOfSelection(editorState, (characterMetadata: CharacterMetadata) =&gt;
    (characterMetadata as any).merge({
      style: Immutable.OrderedSet([]),
    }),
  )
</code></pre>

<h3 id="entity">Entity</h3>

<p>æ–‡æœ¬ä¸­ä¼šæœ‰è®¸å¤šé«˜çº§çš„å…ƒæ•°æ®ï¼Œ<strong>Entity</strong> å®ä½“å°±æ˜¯ç”¨äºè¡¨ç¤ºè¿™äº›å…ƒæ•°æ®ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨å†…å®¹ä¸­æ·»åŠ é“¾æ¥ï¼Œå›¾ç‰‡ç­‰ï¼Œé“¾æ¥ï¼ŒæåŠå’ŒåµŒå…¥å¼å†…å®¹éƒ½å¯ä»¥ä½¿ç”¨å®ä½“æ¥å®ç°ã€‚åœ¨ä¸Šé¢ ContentBlock é‡Œæœ‰ä»‹ç»åˆ°ï¼Œå®ƒæœ‰ä¸‰ä¸ªå±æ€§:</p>

<ul>
  <li>type - å®ä½“ç±»å‹ï¼Œä¾‹å¦‚â€™LINKâ€™ï¼Œâ€™MENTIONâ€™ï¼Œâ€™PHOTOâ€™ã€‚</li>
  <li>mutability - æ­¤å±æ€§è¡¨ç¤ºåœ¨ç¼–è¾‘å™¨ä¸­ç¼–è¾‘æ–‡æœ¬èŒƒå›´æ—¶ï¼Œä½¿ç”¨æ­¤å®ä½“å¯¹è±¡æ³¨é‡Šçš„ä¸€ç³»åˆ—æ–‡æœ¬çš„è¡Œä¸ºã€‚å®ƒæ‹¥æœ‰ä»¥ä¸‹ä¸‰ç§å€¼:
    <ul>
      <li>IMMUTABLE - å¦‚æœä¸ä»æ–‡æœ¬ä¸­åˆ é™¤å®ä½“æ³¨é‡Šï¼Œåˆ™æ— æ³•æ›´æ”¹æ­¤æ–‡æœ¬ã€‚æ¯”å¦‚ mention</li>
      <li>MUTABLE - å…è®¸è‡ªç”±æ”¹å˜ Entity çš„æ–‡æœ¬ï¼Œå¦‚è¶…é“¾æ¥</li>
      <li>SEGMENTED - â€œåˆ†æ®µâ€çš„å®ä½“ä»¥ä¸â€œä¸å¯å˜â€å®ä½“éå¸¸ç›¸ä¼¼çš„æ–¹å¼ä¸å…¶æ–‡æœ¬ç´§å¯†è€¦åˆï¼Œä½†å…è®¸é€šè¿‡åˆ é™¤è¿›è¡Œè‡ªå®šä¹‰</li>
    </ul>
  </li>
  <li>data - åŒ…å«å®ä½“å…ƒæ•°æ®çš„å¯é€‰å¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œâ€œLINKâ€ å®ä½“å¯¹è±¡å¯èƒ½åŒ…å«è¯¥é“¾æ¥çš„ href çš„å€¼ã€‚</li>
</ul>

<blockquote>
  <p>ä½¿ç”¨ decorator è£…é¥°å™¨æˆ–è‡ªå®šä¹‰å—ç»„ä»¶ï¼Œå¯ä»¥æ ¹æ®å®ä½“å…ƒæ•°æ®å‘ç¼–è¾‘å™¨æ·»åŠ ä¸°å¯Œçš„æ¸²æŸ“æ ·å¼</p>
</blockquote>

<p>Entity æœ¬èº«çš„ <code class="highlighter-rouge">create</code> ç­‰æ–¹æ³•å·²ç»è¢«å¼ƒç”¨ï¼Œç›´æ¥ä½¿ç”¨ä¸Šè¿° ContentState å¯¹è±¡çš„ <code class="highlighter-rouge">createEntity</code> ä»£æ›¿ï¼Œå…¶ä»–åŒç†ã€‚æˆ‘ä»¬å°è¯•åˆ›å»ºå’Œæ£€ç´¢å®ä½“:</p>

<ol>
  <li>é€šè¿‡ <code class="highlighter-rouge">contentState.createEntity</code> æ¥åˆ›å»ºå®ä½“ã€‚</li>
  <li>ä»–æ¥å—ä¸Šé¢ 3 ä¸ªå±æ€§ä½œä¸ºå‚æ•°ã€‚</li>
  <li>æ­¤æ–¹æ³•è¿”å›ä¸€ä¸ª ContentState è®°å½•ã€‚</li>
  <li>é€šè¿‡ <code class="highlighter-rouge">contentState.getLastCreatedEntityKey</code> æ¥è·å–åˆ›å»ºçš„å®ä½“è®°å½•çš„ key</li>
</ol>

<pre><code class="language-JS">const contentState = editorState.getCurrentContent()
const contentStateWithEntity = contentState.createEntity(
  'LINK',
  'MUTABLE',
  { url: 'http://www.baidu.com' }
)
const entityKey = contentStateWithEntity.getLastCreatedEntityKey()
const currentContent = Modifier.applyEntity(
  contentStateWithEntity,
  selectionState,
  entityKey
)
const newEditorState = EditorState.push(editorState, { currentContent })
</code></pre>

<p>å¯¹äºç»™å®šçš„æ–‡æœ¬èŒƒå›´ï¼Œåˆ™å¯ä»¥é€šè¿‡åœ¨ ContentBlock å¯¹è±¡ä¸Šä½¿ç”¨ <code class="highlighter-rouge">getEntityAt()</code> æ–¹æ³•æ¥æå–å…¶å…³è”çš„å®ä½“ keyï¼Œä»è€Œä¼ é€’ç›®æ ‡åç§»å€¼:</p>

<pre><code class="language-JS">const getEntityKey: (state: EditorState, k?: SelectionState) =&gt; string = (editorState, selection) =&gt; {
  const selectionState = selection || editorState.getSelection()
  const startKey = selectionState.getStartKey()
  const startOffset = selectionState.getStartOffset()
  return editorState
    .getCurrentContent()
    .getBlockForKey(startKey)
    .getEntityAt(startOffset)
}
</code></pre>

<h3 id="decorator">Decorator</h3>

<p>å†…è”å’Œå—çº§æ ·å¼å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦æ·»åŠ åˆ°ç¼–è¾‘å™¨çš„å”¯ä¸€å¯Œæ–‡æœ¬æ ·å¼ã€‚ä¾‹å¦‚ï¼ŒFacebook è¯„è®ºè¾“å…¥ç»™æåŠå’Œæ ‡ç­¾æä¾›äº†è“è‰²èƒŒæ™¯é«˜äº®ã€‚ä¸ºäº†æ”¯æŒè‡ªå®šä¹‰å¯Œæ–‡æœ¬çš„çµæ´»æ€§ï¼ŒDraft æä¾›äº†ä¸€ä¸ªâ€œä¿®é¥°å™¨â€ç³»ç»Ÿï¼Œå³ <strong>Decorator</strong>ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä½œæ˜¯ç”¨æ¥æ·»åŠ é«˜çº§å¯Œå†…å®¹çš„ä¸€ç§æ–¹æ³•ã€‚</p>

<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code class="highlighter-rouge">CompositeDecorator</code> ç±»å®šä¹‰æ‰€éœ€çš„ä¿®é¥°å™¨è¡Œä¸ºã€‚è¯¥ç±»å…è®¸æ‚¨æä¾›å¤šä¸ª DraftDecorator å¯¹è±¡ï¼Œå¹¶æ ¹æ®ç­–ç•¥ä¾æ¬¡æœç´¢æ¯ä¸€ç»„æ–‡æœ¬ã€‚ä¿®é¥°å™¨å­˜å‚¨åœ¨ EditorState è®°å½•ä¸­ã€‚å½“åˆ›å»ºä¸€ä¸ªæ–°çš„ EditorState å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼š<code class="highlighter-rouge">EditorState.createEmpty()</code>ï¼‰çš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹©æä¾›ä¿®é¥°å™¨å‚æ•°ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åŠ¨æ€åŒºæ›´æ–°è¿™äº›ä¿®é¥°å™¨:</p>

<pre><code class="language-JS">// è·å– entity type
const getEntityType: (state: ContentState, k: string) =&gt; DraftEntityType = (contentState, entityKey) =&gt;
  contentState
    .getEntity(entityKey)
    .getType()

const getEntityData: (state: ContentState, k: string) =&gt; any = (contentState, entityKey) =&gt;
  contentState
    .getEntity(entityKey)
    .getData()

// è®¾ç½®æ–°çš„ä¿®é¥°å™¨
const turnOffHandleDecorations: (state: EditorState, k: object) =&gt; EditorState = (editorState, decorator) =&gt;
  EditorState.set(editorState, { decorator })

function findLinkEntities(contentBlock: ContentBlock, callback: (start: number, end: number) =&gt; void, contentState: ContentState) {
  contentBlock.findEntityRanges(
    (character: CharacterMetadata) =&gt; {
      const entityKey = character.getEntity()
      return (
        entityKey !== null &amp;&amp; getEntityType(contentState, entityKey) === LINK_ENTITY
      )
    },
    callback,
  )
}

const LinkComponent = (props: ILinkProps) =&gt; {
  const { contentState, children, entityKey } = props
  const { url } = getEntityData(contentState, entityKey) // è·å–å®ä½“å†…å®¹
  return (
    &lt;a target='_blank' onClick={e =&gt; previewLink(e, url)} href={url}&gt;
      {children}
    &lt;/a&gt;
  )
}

// å®šä¹‰ä¸€äº›ä¿®é¥°å™¨
const decorator = new CompositeDecorator([
  {
    strategy: findLinkEntities, // æŒ‡å®šç­–ç•¥
    component: LinkComponent, // æŒ‡å®š React ç»„ä»¶å»æ¸²æŸ“å®ƒä»¬
  },
])

function RichEditor(props: IProps) {
  //...
  const [editorState, setEditorState] = useState&lt;EditorState&gt;(turnOffHandleDecorations(emptyEditorState, decorator))
}
</code></pre>

<h3 id="richutils">RichUtils</h3>

<p><strong>RichUtils</strong> æ˜¯ä¸ºå®ç°å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å‡†å¤‡çš„ä¸€ç»„å®ç”¨çš„é™æ€å‡½æ•°é›†åˆã€‚åœ¨ä½¿ç”¨ä¸­ï¼Œè¿™äº›æ–¹æ³•æ¥æ”¶å¸¦æœ‰ç›¸å…³å‚æ•°çš„ EditorState å¯¹è±¡ï¼Œå¹¶ä¸”è¿”å› EditorState å¯¹è±¡ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„å¦‚ä¸‹:</p>

<ul>
  <li>toggleBlockType(editorState: EditorState, blockType: string): EditorState - åœ¨é€‰ä¸­åŒºåŸŸä¸Šåˆ‡æŒ‡å®šçš„å—çº§æ ·å¼</li>
  <li>toggleInlineStyle(editorState: EditorState, inlineStyle: string): EditorState - åœ¨é€‰ä¸­åŒºåŸŸä¸Šåˆ‡æ¢æŒ‡å®šçš„å†…è”æ ·å¼ã€‚å¦‚æœç”¨æˆ·çš„é€‰åŒºæ˜¯æŠ˜å çš„ï¼Œåˆ™åº”ç”¨æˆ–ç§»é™¤å†…éƒ¨çŠ¶æ€çš„æ ·å¼</li>
  <li>toggleLink(editorState: EditorState, targetSelection: SelectionState, entityKey: string): EditorState - åˆ‡æ¢è¶…é“¾æ¥æ ·å¼ï¼ŒentityKey ä¸º null åˆ™ä¸ºæ¸…é™¤</li>
</ul>

<pre><code class="language-JS">// åˆ‡æ¢å†…è”æ ·å¼ï¼Œæ¯”å¦‚ BOLDã€ITALICã€UNDERLINE ç­‰
const toggleInlineStyle = (inlineStyle: string) =&gt; {
  setEditorState(
    RichUtils.toggleInlineStyle(
      editorState,
      inlineStyle,
    ),
  )
}
</code></pre>

<p>å¯¹äºæˆ‘ä»¬è‡ªå®šä¹‰çš„å†…è”æ ·å¼ï¼Œåˆ‡è®°å¦‚æœç”¨æˆ·çš„é€‰åŒºæ˜¯æŠ˜å çš„ï¼Œåˆ™åº”ç”¨æˆ–ç§»é™¤å†…éƒ¨çŠ¶æ€çš„æ ·å¼:</p>

<pre><code class="language-JS">const toggleSelectionInlineStyle: (state: EditorState, p: string, k: string) =&gt; EditorState = (editorState, style, prefix = '') =&gt; {
  let nextEditorState = editorState
  if (prefix) {
    nextEditorState = updateEachCharacterOfSelection(nextEditorState, (characterMetadata: CharacterMetadata) =&gt; {
      // tslint:disable-next-line:max-line-length
      return (characterMetadata as any).toJS().style.reduce((c: CharacterMetadata, characterStyle: string): CharacterMetadata =&gt; {
        if (characterStyle.startsWith(prefix) &amp;&amp; style !== characterStyle) {
          return CharacterMetadata.removeStyle(c, characterStyle)
        } else {
          return c
        }
      }, characterMetadata)
    })
  }
  return RichUtils.toggleInlineStyle(nextEditorState, style)
}
</code></pre>

<p>RichUtils è¿˜æä¾›æœ‰å…³ Web ç¼–è¾‘å™¨å¯ç”¨çš„æ ¸å¿ƒé”®ç›˜å‘½ä»¤çš„ä¿¡æ¯ï¼Œå¦‚ <code class="highlighter-rouge">Cmd + B</code>ï¼ˆç²—ä½“ï¼‰ï¼Œ<code class="highlighter-rouge">Cmd + I</code>ï¼ˆæ–œä½“ï¼‰ç­‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code class="highlighter-rouge">handleKeyCommand</code> å±æ€§æ¥è§‚å¯Ÿå’Œå¤„ç†é”®ç›˜å‘½ä»¤ï¼Œå¹¶å°†å®ƒä»¬ä¼ å…¥ RichUtils ä¸­æ¥åº”ç”¨æˆ–åˆ é™¤æ‰€éœ€çš„æ ·å¼:</p>

<pre><code class="language-JS">const handleKeyCommand: (p: DraftEditorCommand, k: EditorState) =&gt; DraftHandleValue = (command, state) =&gt; {
  const newState = RichUtils.handleKeyCommand(state, command)
  if (newState) {
    setEditorState(newState)
    return 'handled'
  }
  return 'not-handled'
}

// è¿”å›çš„ Editor ç»„ä»¶
&lt;Editor
  handleKeyCommand={handleKeyCommand}
  onChange={state =&gt; setEditorState(state)}
/&gt;
</code></pre>

<h3 id="modifier">Modifier</h3>

<p><strong>Modifier</strong> æ¨¡å—æ˜¯ä¸€ç»„å®ç”¨çš„é™æ€å‡½æ•°ï¼Œä¸»è¦å°è£… ContentState å¯¹è±¡ä¸Šçš„å„ç§å¸¸ç”¨ç¼–è¾‘æ“ä½œã€‚ä»»ä½•æƒ…å†µä¸‹ï¼Œè¿™äº›æ–¹æ³•éƒ½æ¥æ”¶å…·æœ‰ç›¸å…³å‚æ•°çš„ ContentState å¯¹è±¡ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ ContentState å¯¹è±¡ã€‚å¦‚æœå®é™…å¹¶æœªå‘ç”Ÿä»»ä½•ç¼–è¾‘è¡Œä¸ºï¼Œå°†åŸæ ·è¿”å›è¾“å…¥çš„ ContentState å¯¹è±¡ã€‚å…·ä½“æ–¹æ³•å¯ä»¥æŸ¥çœ‹æ–‡æ¡£ï¼Œæ¯”å¦‚ <code class="highlighter-rouge">removeInlineStyle</code> æ–¹æ³•å¯ä»¥ä»æ•´ä¸ªé€‰ä¸­èŒƒå›´ä¸­ç§»é™¤æŒ‡å®šçš„å†…è”æ ·å¼:</p>

<pre><code class="language-JS">// deprecated å¯ä»¥ç”¨ä¸Šè¿°çš„ toggleSelectionInlineStyle ä¼˜åŒ–
const setNextEditorState: (
  state: EditorState, selection: SelectionState, p: IStyleObject, k: EditorChangeType,
) =&gt; EditorState = (editorState, selection, reduceStyle, changeType) =&gt; {
  // æ¸…é™¤ä¹‹å‰çš„æ ·å¼
  const nextContentState = Object.keys(reduceStyle).reduce(
    (state, font) =&gt; Modifier.removeInlineStyle(
      state, selection, font,
    ), getCurrentContent(editorState),
  )

  // ç”± nextContentState äº§ç”Ÿæ–°çš„ editorState
  return EditorState.push(
    editorState,
    nextContentState,
    changeType,
  )
}
</code></pre>

<h3 id="æ•°æ®è½¬æ¢">æ•°æ®è½¬æ¢</h3>

<p>å› ä¸ºå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ä¸å¯èƒ½å‡­ç©ºå­˜åœ¨ï¼Œå› æ­¤å¯¹å†…å®¹è¿›è¡Œä¿å­˜å’Œä¼ è¾“éå¸¸é‡è¦ï¼Œä½ å¯èƒ½å¸Œæœ›å°† ContentState å¯¹è±¡è½¬æ¢ä¸ºåŸç”Ÿ JSï¼Œæˆ–è€…åè¿‡æ¥å°†åŸç”Ÿ JS è½¬æ¢ä¸º ContentState å¯¹è±¡ã€‚ç›®å‰æä¾›äº†ä¸‰ä¸ªæ–¹æ³•:</p>

<ul>
  <li>convertFromRaw(rawState: RawDraftContentState): ContentState - å°†ä¸€ä¸ªåŸå§‹ state è½¬æ¢ä¸º ContentState å¯¹è±¡</li>
  <li>convertToRaw(contentState: ContentState): RawDraftContentState - å°†ä¸€ä¸ª ContentState å¯¹è±¡è½¬æ¢ä¸ºåŸç”Ÿ JS ç»“æ„ï¼Œå½“éœ€è¦ä¿å­˜ç¼–è¾‘å™¨çŠ¶æ€ã€å°†ç¼–è¾‘æ•°æ®è½¬æ¢ä¸ºå…¶ä»–æ ¼å¼ï¼Œæˆ–åœ¨åº”ç”¨ä¸­å¼€å‘å…¶ä»–åŠŸèƒ½æ—¶ï¼Œéå¸¸æœ‰ç”¨ã€‚</li>
  <li>convertFromHTML - å°†ä¸€æ®µ HTML ç‰‡æ®µè½¬æ¢ä¸ºä¸€ä¸ªåŒ…å«ä¸¤ä¸ª key çš„å¯¹è±¡ã€‚å…¶ä¸­ä¸€ä¸ª(contentBlocks)ä¿å­˜ ContentBlock å¯¹è±¡æ•°ç»„ï¼Œå¦ä¸€ä¸ª(entityMap)ä¿å­˜å¯¹ entityMap çš„å¼•ç”¨ã€‚å†ä» contentBlocks å’Œ entityMap æ„é€  contentStateï¼Œç„¶åä½¿ç”¨è¯¥ contentState æ›´æ–° editorState</li>
</ul>

<pre><code class="language-JS">const sampleMarkup =
  '&lt;b&gt;Bold text&lt;/b&gt;, &lt;i&gt;Italic text&lt;/i&gt;&lt;br/ &gt;&lt;br /&gt;' +
  '&lt;a href="http://www.facebook.com"&gt;Example link&lt;/a&gt;'

const blocksFromHTML = convertFromHTML(sampleMarkup)
const state = ContentState.createFromBlockArray(
  blocksFromHTML.contentBlocks,
  blocksFromHTML.entityMap
)

setEditorState(EditorState.createWithContent(state))
</code></pre>

<blockquote>
  <p>emmmmâ€¦ æ˜¯çš„ä½ æ²¡çœ‹é”™ï¼Œå®ƒå¹¶æ²¡æœ‰è½¬æ¢æˆ html çš„æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬å¸¸å€ŸåŠ©äºä¸€äº›å…¶ä»–åº“ï¼Œæ¯”å¦‚ <a href="https://www.npmjs.com/package/draft-js-export-html">draft-js-export-html</a>ï¼Œä¸‹é¢ä¼šä»‹ç»åˆ°è¯¦ç»†ç”¨æ³•</p>
</blockquote>

<h2 id="draftjs-å®æˆ˜">Draft.js å®æˆ˜</h2>

<h3 id="é»˜è®¤æ ·å¼">é»˜è®¤æ ·å¼</h3>

<p>Draft é‡Œé¢æœ‰é»˜è®¤çš„å—çº§å’Œå†…è”æ ·å¼ï¼Œå—çº§æ¯”å¦‚æœ‰ â€œblockquoteâ€ã€â€code-blockâ€ã€â€ordered-list-itemâ€ ç­‰ï¼›å†…è”æ ·å¼æ¯”å¦‚æœ‰ â€œboldâ€ã€â€italicâ€ã€â€underlineâ€ ç­‰ï¼Œæˆ‘ä»¬çœ‹å…¶ä¸­ä¸€ä¸ªä¾‹å­:</p>

<pre><code class="language-JS">const BLOCK_TYPES: IRichEditorControls[] = [
  { label: 'å¼•ç”¨', style: 'blockquote', icon: FormatQuote },
  { label: 'æ— åºåˆ—è¡¨', style: 'unordered-list-item', icon: FormatListBulleted },
  { label: 'æœ‰åºåˆ—è¡¨', style: 'ordered-list-item', icon: FormatListNumbered },
  { label: 'ä»£ç å—', style: 'code-block', icon: Code },
]

// è·å– block type
const getBlockType: (state: EditorState) =&gt; DraftBlockType = editorState =&gt;
  editorState
    .getCurrentContent()
    .getBlockForKey(editorState.getSelection().getStartKey())
    .getType()

interface IProps {
  editorState: EditorState
  onToggle: (p: DraftBlockType) =&gt; void
  children?: React.ReactNode
}

function BlockStyleControls(props: IProps) {
  const { editorState, onToggle, children } = props
  const blockType = getBlockType(editorState)

  return (
    &lt;div className='RichEditor-controls'&gt;
      {children}
      {BLOCK_TYPES.map(type =&gt; (
        &lt;StyleButton
          key={type.label}
          active={type.style === blockType}
          icon={type.icon}
          label={type.label}
          onToggle={onToggle}
          style={type.style}
        /&gt;
      ))}
    &lt;/div&gt;
  )
}

export default BlockStyleControls
</code></pre>

<p>è¿™é‡Œä»çˆ¶ç»„ä»¶ä¼ å…¥çš„ onToggle å…¶å®å°±æ˜¯ä¸Šè¿°è‡ªå®šä¹‰çš„ <code class="highlighter-rouge">toggleInlineStyle</code> æ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Œè€Œä¸”æˆ‘ä»¬å¯ä»¥ç›´æ¥å®ç° redo/undo æ“ä½œ:</p>

<pre><code class="language-JS">const undo: (state: EditorState) =&gt; EditorState = editorState =&gt;
  EditorState.undo(editorState)

const redo: (state: EditorState) =&gt; EditorState = editorState =&gt;
  EditorState.redo(editorState)

// åªè¦ä¼ è¿‡æ¥ä¸€ä¸ªæ ‡ç¤ºå³å¯
const toggleUndoOrRedo = (doStyle: string) =&gt; {
  if (doStyle === 'undo') {
    setEditorState(undo(editorState))
  } else {
    setEditorState(redo(editorState))
  }
}
</code></pre>

<blockquote>
  <p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å»ä¿®æ”¹é»˜è®¤çš„é…ç½®ï¼Œå°±è¦ç”¨åˆ°ä¸‹é¢è®²åˆ°çš„ Editor å¯¹è±¡å»æ“ä½œ</p>
</blockquote>

<h3 id="è‡ªå®šä¹‰æ ·å¼">è‡ªå®šä¹‰æ ·å¼</h3>

<h4 id="editor">Editor</h4>

<p>åœ¨è‡ªå®šä¹‰æ ·å¼å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆäº†è§£ä¸‹æ ¸å¿ƒå—æ§çš„ contentEditable ç»„ä»¶ï¼Œå³ <strong>Editor</strong> è‡ªèº«çš„ API å’Œ props:</p>

<ul>
  <li>editorState - EditorState å¯¹è±¡ç”± Editor åˆ›å»º</li>
  <li>onChange - åœ¨ Editor ç¼–è¾‘æˆ–æ–‡æœ¬é€‰åŒº(selection)å˜åŒ–çš„æ—¶å€™è§¦å‘</li>
  <li>placeholder</li>
  <li>blockRenderMap - æä¾›äº† block çš„æ¸²æŸ“é…ç½®ï¼Œæ¯ä¸ªå—çº§æ ·å¼æ˜ å°„äº†ä¸€ä¸ªå…ƒç´ æ ‡ç­¾ä»¥åŠä¸€ä¸ªå¯é€‰çš„ wrapper å…ƒç´ åŒ…è£¹èµ·æ¥</li>
  <li>blockRendererFn - å¯é€‰åœ°è®¾ç½®ä¸€ä¸ªå‡½æ•°æ¥å®šä¹‰è‡ªå®šä¹‰å—çš„å‘ˆç°</li>
  <li>customStyleMap - å¯é€‰åœ°è®¾ç½®ä¸€ä¸ªå†…è”æ ·å¼è¡¨ï¼Œä»¥åº”ç”¨åˆ°å…·æœ‰æŒ‡å®šæ ·å¼çš„æ–‡æœ¬èŒƒå›´</li>
  <li>customStyleFn - å¯é€‰åœ°è®¾ç½®ä¸€ä¸ªå‡½æ•°æ¥å°†å†…è”æ ·å¼è½¬æ¢ä¸º CSS æ ·å¼å¹¶åº”ç”¨åˆ°å…·ä½“æŒ‡å®šæ ·å¼çš„æ–‡æœ¬èŒƒå›´</li>
</ul>

<h4 id="å—çº§æ ·å¼">å—çº§æ ·å¼</h4>

<p>è¿™ä¸€èŠ‚ä¸»è¦è®² <code class="highlighter-rouge">blockRenderMap</code> çš„åº”ç”¨ï¼Œä»¥â€œå±…ä¸­ã€å±…å·¦â€è¿™ç§åŠŸèƒ½é¡¹ä¸ºä¾‹ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨é»˜è®¤æ ·å¼é‡Œçš„é…ç½®ä¸ŠåŠ å…¥è¿™å‡ ç§è‡ªå®šä¹‰æ ·å¼:</p>

<pre><code class="language-JS">const BLOCK_TYPES: IRichEditorControls[] = [
  // ...
  { label: 'å±…å·¦', style: ALIGN_KEYS.left, icon: FormatAlignLeft },
  { label: 'å±…ä¸­', style: ALIGN_KEYS.center, icon: FormatAlignCenter },
  { label: 'å±…å³', style: ALIGN_KEYS.right, icon: FormatAlignRight },
]
</code></pre>

<p>ç„¶åæˆ‘ä»¬æ–°å»ºä¸€ä¸ª <code class="highlighter-rouge">Align.ts</code> æ–‡ä»¶æ¥å®šä¹‰æˆ‘ä»¬éœ€è¦ç”¨æ¥æ¸²æŸ“çš„ç»„ä»¶å’Œæ ·å¼:</p>

<pre><code class="language-JS">// Align.ts
function Align(props: IProps) {
  const { type, children } = props
  return (
    &lt;div className={'align-' + type}&gt;
      {/* here, children contains a &lt;section&gt; container, as that was the matching element */}
      {children}
    &lt;/div&gt;
  )
}

export const ALIGN_KEYS = {
  center: 'align-center',
  left: 'align-left',
  right: 'align-right',
}

// https://draftjs.org/docs/advanced-topics-custom-block-render-map
const blockRenderMap = Immutable.Map({
  [ALIGN_KEYS.center]: {
    wrapper: &lt;Align type='center' /&gt;,
  },
  [ALIGN_KEYS.left]: {
    wrapper: &lt;Align type='left' /&gt;,
  },
  [ALIGN_KEYS.right]: {
    wrapper: &lt;Align type='right' /&gt;,
  },
})

export default blockRenderMap
</code></pre>

<p>æˆ‘ä»¬å¯¼å‡ºäº†ä¸€ä¸ª blockRenderMap å¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦ç¼–è¾‘å™¨å»åº”ç”¨æˆ‘ä»¬æ‰€é…ç½®çš„æ ·å¼ï¼Œå› æ­¤è¿™é‡Œéœ€è¦ç”¨åˆ° Editor å¯¹è±¡çš„ <code class="highlighter-rouge">blockRenderMap</code> å±æ€§è¿›è¡Œé…ç½®:</p>

<pre><code class="language-JS">import { DefaultDraftBlockRenderMap } from 'draft-js'

// ä¸é»˜è®¤çš„å—çº§æ ·å¼åˆå¹¶
const extendedBlockRenderMap = DefaultDraftBlockRenderMap.merge(blockRenderMapAlign)

function RichEditor(props: IProps) {
  // ...
  return {
    // ...
    &lt;Editor
      ref={editor}
      blockRenderMap={extendedBlockRenderMap}
      editorState={editorState}
      onChange={state =&gt; setEditorState(state)}
      placeholder='å†™ç‚¹ä»€ä¹ˆå‘¢...'
      spellCheck={true}
    /&gt;
  }
}
</code></pre>

<h4 id="å†…è”æ ·å¼">å†…è”æ ·å¼</h4>

<p>è¿™ä¸€èŠ‚ä¸»è¦è®² <code class="highlighter-rouge">customStyleMap</code> å’Œ <code class="highlighter-rouge">customStyleFn</code> çš„åº”ç”¨ï¼Œä»¥è®¾ç½®å­—ä½“ä¸ºä¾‹ï¼Œæˆ‘ä»¬ä¸å¦¨å…ˆé’ˆå¯¹è¿™ä¸ªæ§ä»¶åˆ›å»ºæ–°çš„æ–‡ä»¶:</p>

<pre><code class="language-JS">// FontFamilyControls
const FONTFAMILY_TYPES = [
  { label: 'é»˜è®¤', style: 'FONTFAMILY-inherit' },
  { label: 'Arial', style: 'FONTFAMILY-Arial' },
  { label: 'Artnext', style: 'FONTFAMILY-Artnext' },
  { label: 'Avenir', style: 'FONTFAMILY-Avenir' },
  { label: 'Banghdad', style: 'FONTFAMILY-Banghdad' },
  { label: 'Helvetica', style: 'FONTFAMILY-Helvetica' },
  { label: 'Muli', style: 'FONTFAMILY-Muli' },
  { label: 'SF ui test', style: 'FONTFAMILY-SF ui test' },
  { label: 'PingFangSC', style: 'FONTFAMILY-PingFangSC' },
  { label: 'æ€æºé»‘ä½“', style: 'FONTFAMILY-Souce Han Sans CN' },
]

const defaultValue = 'FONTFAMILY-inherit'

interface IProps {
  editorState: EditorState
  saveCurrentSelection: () =&gt; void // ä¿å­˜é€‰åŒº
  onToggle(p: string, k: string): void
}

function FontFamilyControls(props: IProps) {
  const { onToggle, saveCurrentSelection, editorState } = props
  const classes = useStyle()
  const [currentValue, setCurrentValue] = useState&lt;string&gt;(defaultValue)
  const inputLabel = useRef&lt;HTMLLabelElement&gt;(null)
  const [labelWidth, setLabelWidth] = useState(0)

  useEffect(() =&gt; {
    setLabelWidth(inputLabel.current!.offsetWidth)
  }, [])

  const getFontFamilyFromStyle: (p: string) =&gt; string = style =&gt; style.replace(fontFamilyKey, '')

  const onChoose = (e: React.ChangeEvent&lt;{ value: unknown }&gt;) =&gt; {
    const { target: { value = '' } = {} } = e
    saveCurrentSelection()
    onToggle(value as string, fontFamilyKey)
  }

  const fontFamilyStyle: (p: string) =&gt; React.CSSProperties = style =&gt; ({
    fontFamily: getFontFamilyFromStyle(style),
  })

  return (
    &lt;FormControl variant='outlined' className={classes.formControl}&gt;
      &lt;InputLabel ref={inputLabel} htmlFor='select-outlined-label'&gt;å­—ä½“&lt;/InputLabel&gt;
      &lt;Select
        value={currentValue}
        onChange={onChoose}
        MenuProps={HigherMenuProps}
        input={&lt;OutlinedInput labelWidth={labelWidth} name='style' id='select-outlined-label' /&gt;}
      &gt;
        {FONTFAMILY_TYPES.map(({ style, label }: IFontSize) =&gt; (
          &lt;MenuItem key={label} style={fontFamilyStyle(style)} value={style}&gt;{label}&lt;/MenuItem&gt;
        ))}
      &lt;/Select&gt;
    &lt;/FormControl&gt;
  )
}
</code></pre>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆå®ç°çš„ä¹Ÿæ˜¯ toggle æ–¹æ³•ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹çˆ¶ç»„ä»¶é‡Œé¢æ€ä¹ˆå®ç°å§:</p>

<pre><code class="language-JS">// åˆ‡æ¢å­—ä½“å¤§å°ï¼Œå°†æ­¤æ–¹æ³•ä¼ å…¥å­ç»„ä»¶ï¼Œå±æ€§ä¸º toggle
const changeFont: (p: string, k: string) =&gt; void = (inlineStyle, key) =&gt; {
  // å‚¨å­˜é€‰æ‹©è¿‡çš„é¢œè‰²ï¼Œæ˜¯ä¸ºäº†åœ¨å»é™¤æ‰ä»¥å‰çš„æ ·å¼ä¸­ç”¨
  let newStyleMap = {}
  const value = getStyleValue(inlineStyle) // æ ¹æ®å†…è”æ ·å¼è·å–å¯¹åº”çš„ css æ ·å¼å€¼

  // å‡è®¾è¿™é‡Œå¯¹å­—ä½“ã€å­—ä½“å¤§å°å’Œè¡Œé«˜ç­‰æ ·å¼è¿›è¡Œå¤„ç†
  if (key === fontSizeKey) {
    newStyleMap = {
      [inlineStyle]: {
        fontSize: `${value}px`,
      },
    }
  } else if (key === fontFamilyKey) {
    newStyleMap = {
      [inlineStyle]: {
        fontFamily: value,
      },
    }
  } else if (key === lineHeightKey) {
    newStyleMap = {
      [inlineStyle]: {
        lineHeight: value,
      },
    }
  }

  // æ›´æ–°è‡ªå®šä¹‰é¢œè‰²
  setCustomStyleMap({ ...customStyleMap, ...newStyleMap })
  // æ¸…é™¤æ—§æ ·å¼å¹¶æ›´æ–°æ–°æ ·å¼
  setEditorState(toggleSelectionInlineStyle(editorState, inlineStyle, key))
  clearCurrentSelection()
}
</code></pre>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†é’©å­ setCustomStyleMap æ¥è®¾ç½®äº†è‡ªå®šä¹‰çš„å†…è”æ ·å¼ï¼Œé‚£ä¹ˆåŒæ ·æˆ‘ä»¬è¿˜æ˜¯éœ€è¦ Editor çš„ <code class="highlighter-rouge">customStyleMap</code> é…ç½®æ¥åº”ç”¨è¿™äº›æ ·å¼:</p>

<pre><code class="language-JS">&lt;Editor
  ref={editor}
  blockRenderMap={extendedBlockRenderMap}
  blockStyleFn={getBlockStyle}
  customStyleMap={customStyleMap}
  customStyleFn={customStyleFn}
  editorState={editorState}
  onChange={state =&gt; setEditorState(state)}
  placeholder='å†™ç‚¹ä»€ä¹ˆå‘¢...'
  spellCheck={true}
/&gt;
</code></pre>

<p>ä½†æ˜¯æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬æ–°å¢çš„è‡ªå®šä¹‰æ ·å¼éƒ½æ˜¯ä¸´æ—¶çš„ï¼Œæ˜¯æ ¹æ®ä¸åŒæ ·å¼ç±»å‹è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå½“æˆ‘ä»¬å…³é—­ç¼–è¾‘å™¨ä¿å­˜å†…å®¹åé‡æ–°æ‰“å¼€æ—¶ï¼Œè¿™äº›æ ·å¼å¦‚æœæ²¡æœ‰è¢«ä¿å­˜çš„è¯ï¼Œå°†æ— æ³•æŒ‰ç…§å®ƒæ¥æ¸²æŸ“ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ <code class="highlighter-rouge">customStyleFn</code> æ¥å®šä¹‰æ¸²æŸ“è§„åˆ™:</p>

<pre><code class="language-JS">// è®¾ç½®æ ·å¼ key
const styleKeys = {
  fontSizeKey: 'FONTSIZE-',
  fontFamilyKey: 'FONTFAMILY-',
  fontColorKey: 'COLOR-',
  fontBgColorKey: 'BGCOLOR-',
  lineHeightKey: 'LINEHEIGHT-',
}

const removeKey: (p: string) =&gt; string = key =&gt; key.replace('Key', '')

const getFirstElement = (styles: DraftInlineStyle) =&gt; {
  const styleElement: IInlineStyleElement = {}
  Object.keys(styleKeys).forEach((key: string) =&gt; {
    // styles is immutable
    (styleElement as any)[removeKey(key)] = styles.filter((value: any) =&gt; value.startsWith((styleKeys as any)[key])).first()
  })
  return styleElement
}

const customStyleFn: (p: DraftInlineStyle) =&gt; any = style =&gt; {
  const output: any = {}
  // styles immutable
  const { getFirstElement, getStyleValue } = stateToHtmlOptions
  const {
    fontColor, fontBgColor, fontSize, fontFamily, lineHeight,
  } = getFirstElement(style)

  if (fontColor) { output.color = getStyleValue(fontColor) }

  if (fontBgColor) { output.backgroundColor = getStyleValue(fontBgColor) }

  if (fontSize) { output.fontSize = `${getStyleValue(fontSize)}px` }

  if (fontFamily) { output.fontFamily = getStyleValue(fontFamily) }

  if (lineHeight) { output.lineHeight = getStyleValue(lineHeight) }

  return output
}
</code></pre>

<p>ok å®Œäº‹ï¼Œè‡³äºå…¶ä»–è¶…é“¾æ¥çš„å®ç°è¿™é‡Œå°±ä¸å±•ç¤ºäº†ï¼Œä¸Šé¢å†è®² entity çš„æ—¶å€™ï¼Œä»£ç å·²ç»è´´çš„å·®ä¸å¤šäº†ã€‚å‰©ä¸‹çš„å°±æ˜¯å¦‚ä½•å¯¼å‡ºæˆ‘ä»¬å†™å¥½çš„å¯Œæ–‡æœ¬äº†ã€‚</p>

<h3 id="å¯¼å‡º-html">å¯¼å‡º html</h3>

<p>å½“æˆ‘ä»¬å¯¼å‡º html æ ‡ç­¾çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆéœ€è¦å¯¹ä¸åŒæ ·å¼ç±»å‹è¿›è¡Œè§£æå’Œè½¬æ¢ï¼Œè¿™é‡Œæ¨èä¸€ä¸ªåº“ <a href="https://www.npmjs.com/package/draft-js-export-html">draft-js-export-html</a>ï¼Œä½¿ç”¨æ–¹æ³•å¾ˆç®€å•:</p>

<pre><code class="language-JS">import {stateToHTML} from 'draft-js-export-html'

const html = stateToHTML(contentState, options)
</code></pre>

<p>å®ƒæ”¯æŒä¼—å¤šçš„ options å¯é€‰é¡¹ï¼Œå…·ä½“å¯ä»¥æŸ¥é˜…æ–‡æ¡£ï¼Œæˆ‘ä»¬è¿™é‡Œç›´æ¥è´´ä¾‹å­:</p>

<pre><code class="language-JS">const options = {
  defaultBlockTag: 'div',
  inlineStyleFn: (styles: DraftInlineStyle) =&gt; {
    // styles immutable
    const {
      fontSize, fontColor, fontBgColor, fontFamily, lineHeight,
    } = getFirstElement(styles)

    let style = {}

    if (fontSize) {
      style = { ...style, 'font-size': getStyleValue(fontSize) }
    }

    if (fontFamily) {
      style = { ...style, 'font-family': getStyleValue(fontFamily) }
    }

    if (fontColor) {
      style = { ...style, color: getStyleValue(fontColor) }
    }

    if (fontBgColor) {
      style = { ...style, 'background-color': getStyleValue(fontBgColor) }
    }

    if (lineHeight) {
      // FIXME: ä¸ºäº†é˜²æ­¢è‡ªåŠ¨åŠ ä¸Š pxï¼Œæ‰€ä»¥æš‚æ—¶é‡‡ç”¨ !important
      style = { ...style, 'line-height': `${getStyleValue(lineHeight)} !important` }
    }

    if (!isEmptyObject(style)) {
      return {
        element: 'span',
        style,
      }
    }

    return styles
  },
  blockStyleFn: (block: ContentBlock) =&gt; {
    let output
    switch (block.getType()) {
      case ALIGN_KEYS.center:
        output = getAlignStyle('center')
        break
      case ALIGN_KEYS.left:
        output = getAlignStyle('left')
        break
      case ALIGN_KEYS.right:
        output = getAlignStyle('right')
        break
      default:
        break
    }

    return output
  },
  entityStyleFn: (entity: EntityInstance) =&gt; {
    if (entity.getType() === LINK_ENTITY) {
      const { url: href } = entity.getData()
      return {
        element: 'a',
        attributes: {
          href,
          target: '_blank',
        },
        // style: {
        //   // Put styles here...
        // },
      }
    }
  },
}
</code></pre>

<p>è¿™æ ·è½¬æ¢ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æˆ‘ä»¬å¿ƒçˆ±çš„ html æ–‡æœ¬å•¦ï¼Œèµ¶ç´§æ‹¿å»å‰å°æ¸²æŸ“å§ ğŸ˜</p>

<blockquote>
  <p>åŸºäº draft.js å¼€å‘çš„ä¹Ÿæœ‰å¥½å¤šå¥½ç”¨çš„æ’ä»¶å’Œæˆç†Ÿçš„å¯Œæ–‡æœ¬å·¥å…·ï¼Œæ¯”å¦‚ <a href="https://braft.margox.cn">braft-editor</a> ç­‰ï¼Œå…¶ä»–å…³äºå¯Œæ–‡æœ¬çš„åº“ä¹Ÿæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ <a href="http://neilj.github.io/Squire/">squire</a> ç­‰ã€‚</p>
</blockquote>

<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h2>

<ol>
  <li><a href="https://juejin.im/post/5cfe4e8a6fb9a07ec63b09a4#heading-0">å¯Œæ–‡æœ¬åŸç†äº†è§£ä¸€ä¸‹ï¼Ÿ</a> By å°¤æ°´å°±ä¸‹</li>
  <li><a href="http://www.wukai.me/2019/07/21/draftjs-editor-tutorial-1/">ä»æ’å…¥å›¾ç‰‡åŠŸèƒ½çš„å®ç°æ¥ä»‹ç»å¦‚ä½•ç”¨ Draft.js ç¼–å†™å¯Œæ–‡æœ¬ç¼–è¾‘å™¨</a> By å´é”´</li>
  <li><a href="http://seejs.me/draft-js-cn/docs/kuai-su-kai-shi/gai-yao.html">Draft.js ä¸­æ–‡ç¿»è¯‘æ–‡æ¡£</a></li>
</ol>
 
<div id="gitalk-container"></div>
<script>
    var gitalk = new Gitalk({
      enable: true,
      clientID: '020f142489f80c92b097',
      clientSecret: '1fa083372b44031cf1b8249251515c4e3d54c69d',
      repo: 'tate-young.github.io',
      owner: 'Tate-Young',
      admin: ['Tate-Young'],
      id: location.pathname,      // Ensure uniqueness and length less than 50
      distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script>
<!-- disqus -->
<!-- <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function () {
        this.page.url = 'https://tate-young.github.io/2019/12/18/js-rich-editor.html';
        this.page.identifier = '/2019/12/18/js-rich-editor';
        this.page.title = 'å¯Œæ–‡æœ¬åŸç†';
    };

    (function () { // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document,
            s = d.createElement('script');

        s.src = '//tate.disqus.com/embed.js'; // IMPORTANT: Replace EXAMPLE with your forum shortname!

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript> -->


            <!-- <p class="post-info">
			æœ¬æ–‡ç”± <a href="/">liberxue</a> åˆ›ä½œï¼Œé‡‡ç”¨ <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external nofollow">çŸ¥è¯†å…±äº«ç½²å4.0</a> å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯<br>æœ¬ç«™æ–‡ç« é™¤æ³¨æ˜è½¬è½½/å‡ºå¤„å¤–ï¼Œå‡ä¸ºæœ¬ç«™åŸåˆ›æˆ–ç¿»è¯‘ï¼Œè½¬è½½å‰è¯·åŠ¡å¿…ç½²å<br>æœ€åç¼–è¾‘æ—¶é—´ä¸º:2019-12-18 20:22:00</p> -->
        </div>
    </article>

    <!-- <div class="related-post-lists">
	<div class="post-lists">
		<div class="post-lists-body">
					<div class="post-list-item">
				<div class="post-list-item-container">
					<div class="item-label">
						<div class="item-title"><a href="induction.html">å½’çº³çš„éšæƒ³</a></div>
						<div class="item-meta clearfix">
														<div class="item-meta-ico bg-ico-image" style="background: url('../usr/themes/pinghsu/images/bg-ico.png') no-repeat;background-size: 40px auto;"></div>
	                        							<div class="item-meta-cat"><a href="../category/thoughts/index.html">Thoughts</a></div>
						</div>
					</div>
				</div>
			</div>
				</div>
	</div>
</div> -->

    <!-- <footer class="footer bg-white">
	<div class="footer-social">
		<div class="footer-container clearfix">
			<div class="social-list">
	 <a class="social segmentfault" target="blank" href="https://segmentfault.com/u/liberxue" title="è®¿é—® LiberXue_Twitter" data-hover="Segmentfault">Segmentfault</a>
    <a class="social github" target="blank" href="https://github.com/liberxue" title="è®¿é—® LiberXue_Twitter" data-hover="GitHub">GitHub</a>
    <a class="social twitter" target="blank" href="http://twitter.com/liberxue" title="è®¿é—® LiberXue_Twitter" data-hover="Twitter">Twitter</a>
     <a class="social stackoverflow" target="blank" href="https://stackoverflow.com/users/6902190/liberxue" title="è®¿é—® LiberXue_stackoverflow" data-hover="StackOverflow">StackOverflow</a>
          <a class="social oschina" target="blank" href="https://my.oschina.net/bolanzw" title="è®¿é—® LiberXue_Oschina" data-hover="Oschina">Oschina</a>
     <a class="social rss" target="blank" href="/feed.xml"title="è®¿é—® LiberXue_RSS" data-hover="RSS">RSS</a>
	</div>
		</div>
	</div>
	<div class="footer-meta">
        <div class="footer-container">
            <div class="meta-item meta-copyright">
                <div class="meta-copyright-info">
                    <a href="/" class="info-logo">
                         <img src="http://localhost:2333/style/images/logo-liberxue.png"   title="è®¿é—® LiberXue_blog" data-hover="LiberXue_blog" alt="LiberXue_blog" /> </a>
                    <div class="info-text">
                        <p>Theme is <a href="http://www.liberxue.com/2017/08/03/Jekyllthemes.html" title="è®¿é—® Jekyll liberxueä¸»é¢˜"  data-hover="Jekyll liberxue"target="_blank">Jekyll liberxue</a> by <a href="http://www.liberxue.com/about" target="_blank">liberxue</a></p>
                        <p>Powered by <a href="http://localhost:2333/tags/#Jekyll" title="Jekyll" data-hover="Jekyll" target="_blank" rel="nofollow">Jekyll</a></p>
                        <p>&copy; 2017 <a href="/feed.xml"  title="è®¿é—® liberxue blog RSS" data-hover="liberxue blog RSS">liberxue blog RSS</a></p>
                        <p>æ€»è®¡æ–‡ç« ï¼šç¯‡</p>
                      <p>æœ¬blogå·²å¼€æºç‚¹å‡»Fork</p><iframe src="http://ghbtns.com/github-btn.html?user=liberxue&repo=liberxue.github.io&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="95" height="20"></iframe>
                    </div>
                </div>
            </div>
            <div class="meta-item meta-posts">
                <h3 class="meta-title">ç½®é¡¶æ–‡ç« </h3>
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
            </div>
            <div class="meta-item meta-comments">
                <h3 class="meta-title">æœ€æ–°æ–‡ç« </h3>
  
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
</div>
		</div>
    </div>
</footer> -->
<script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.js"></script>
<script async src="/search/js/520.js"></script>
<script async src="/search/js/gtag.js"></script>
<script async src="/search/live2d/autoload.js"></script>
<!-- <script src="/search/js/canvas.js"></script> -->

<script>
    $(function () {
        setTimeout(function () {
            $('code').removeClass('hljs');
            $('code').removeClass('language');
        }, 90);
    });
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    <!--liberxueconnnet-menu-->
    <div id="directory-content" class="directory-content">
        <div id="directory"></div>
    </div>
    <!--liberxueconnnet-menu-->
    <script>
      const directoryContainer = document.getElementById('directory')
      const postTitle = document.getElementsByClassName('post-title')[0]
      var postDirectoryBuild = function () {
        var postChildren = function children(childNodes, reg) {
          var result = [],
              isReg = typeof reg === 'object',
              isStr = typeof reg === 'string',
              node, i, len;
          for (i = 0, len = childNodes.length; i < len; i++) {
            node = childNodes[i];
            if ((node.nodeType === 1 || node.nodeType === 9) &&
              (!reg ||
                  isReg && reg.test(node.tagName.toLowerCase()) ||
                  isStr && node.tagName.toLowerCase() === reg)) {
                result.push(node);
              }
            }
            return result;
          },
          createPostDirectory = function (article, directory, isDirNum) {
            var contentArr = [],
                titleId = [],
                levelArr, root, level,
                currentList, list, li, link, i, len;
            levelArr = (function (article, contentArr, titleId) {
                  var titleElem = postChildren(article.childNodes, /^h\d$/),
                      levelArr = [],
                      lastNum = 1,
                      lastRevNum = 1,
                      count = 0,
                      guid = 1,
                      id = 'directory' + (Math.random() + '').replace(/\D/, ''),
                      lastRevNum, num, elem;
                  while (titleElem.length) {
                      elem = titleElem.shift();
                      contentArr.push(elem.innerHTML);
                      num = +elem.tagName.match(/\d/)[0];
                      if (num > lastNum) {
                          levelArr.push(1);
                          lastRevNum += 1;
                      } else if (num === lastRevNum ||
                          num > lastRevNum && num <= lastNum) {
                          levelArr.push(0);
                          lastRevNum = lastRevNum;
                      } else if (num < lastRevNum) {
                          levelArr.push(num - lastRevNum);
                          lastRevNum = num;
                      }
                      count += levelArr[levelArr.length - 1];
                      lastNum = num;
                      elem.id = elem.id || (id + guid++);
                      titleId.push(elem.id);
                  }
                  if (count !== 0 && levelArr[0] === 1) levelArr[0] = 0;

                  return levelArr;
              })(article, contentArr, titleId);
              currentList = root = document.createElement('ul');
              dirNum = [0];
              for (i = 0, len = levelArr.length; i < len; i++) {
                  level = levelArr[i];
                  if (level === 1) {
                      list = document.createElement('ul');
                      if (!currentList.lastElementChild) {
                          currentList.appendChild(document.createElement('li'));
                      }
                      currentList.lastElementChild.appendChild(list);
                      currentList = list;
                      dirNum.push(0);
                  } else if (level < 0) {
                      level *= 2;
                      while (level++) {
                          if (level % 2) dirNum.pop();
                          currentList = currentList.parentNode;
                      }
                  }
                  dirNum[dirNum.length - 1]++;
                  li = document.createElement('li');
                  link = document.createElement('a');
                  link.name = '#' + titleId[i];
                  link.href = 'Javascript:;'
                  link.className = "post-aside-anchor"
                  link.title = 'è®¿é—®' + titleId[i];
                  link.innerHTML = !isDirNum ? contentArr[i] :
                      dirNum.join('.') + ' ' + contentArr[i];
                  li.appendChild(link);
                  currentList.appendChild(li);
              }
            directory.appendChild(root);
          };
        createPostDirectory(document.getElementById('post-content'), directoryContainer, true);
      };
      postDirectoryBuild();
    </script>
    <script>
      // gtag('config', GA_TRACKING_ID, {
      //   'page_title' : 'Blog',
      //   'page_path': window.location.pathname,
      //   'post_title': 'watttsdfasdf',
      // });

    </script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script>
        lang = hljs.initHighlightingOnLoad();
    </script>
</body>

</html>
